cscope 15 $HOME/GitHub/PocketFT8Xcvr/PocketFT8XcvrFW               0000266967
	@AudioStream6400.h

31 #iâdeà
AudioSŒ—m_h


32 
	#AudioSŒ—m_h


	)

34 #iâdeà
__ASSEMBLER__


35 
	~<¡dio.h
>

36 
	~<¡ršg.h
>

53 #iâdeà
AUDIO_BLOCK_SAMPLES


54 
	#AUDIO_BLOCK_SAMPLES
 128

	)

57 #iâdeà
AUDIO_SAMPLE_RATE_EXACT


59 
	#AUDIO_SAMPLE_RATE_EXACT
 6400.0f

	)

63 
	#AUDIO_SAMPLE_RATE
 
AUDIO_SAMPLE_RATE_EXACT


	)

65 
	#noAUDIO_DEBUG_CLASS


66 

	)

67 #iâdeà
__ASSEMBLER__


68 
şass
 
	gAudioSŒ—m
;

69 
şass
 
	gAudioCÚÃùiÚ
;

70 #ià
defšed
(
AUDIO_DEBUG_CLASS
)

71 
şass
 
	gAudioDebug
;

74 
	saudio_block_¡ruù
 {

75 
ušt8_t
 
	m»f_couÁ
;

76 
ušt8_t
 
	m»£rved1
;

77 
ušt16_t
 
	mmemÜy_poŞ_šdex
;

78 
št16_t
 
	md©a
[
AUDIO_BLOCK_SAMPLES
];

79 } 
	taudio_block_t
;

83 şas 
	cAudioCÚÃùiÚ


85 
	mpublic
:

86 
AudioCÚÃùiÚ
();

87 
	$AudioCÚÃùiÚ
(
AudioSŒ—m
 &
sourû
, AudioSŒ—m &
de¡š©iÚ
)

88 : 
	$AudioCÚÃùiÚ
(è{ 
	`cÚÃù
(
sourû
,
de¡š©iÚ
); }

89 
	$AudioCÚÃùiÚ
(
AudioSŒ—m
 &
sourû
, 
sourûOuut
,

90 
AudioSŒ—m
 &
de¡š©iÚ
, 
de¡š©iÚIÅut
)

91 : 
	$AudioCÚÃùiÚ
(è{ 
	`cÚÃù
(
sourû
,
sourûOuut
, 
de¡š©iÚ
,
de¡š©iÚIÅut
); 
	}
}

92 
ä›nd
 
şass
 
	gAudioSŒ—m
;

93 ~
AudioCÚÃùiÚ
();

94 
discÚÃù
();

95 
cÚÃù
();

96 
	$cÚÃù
(
AudioSŒ—m
 &
sourû
, AudioSŒ—m &
de¡š©iÚ
è{ 
	`cÚÃù
(sourû,0,de¡š©iÚ,0);
	}
};

97 
cÚÃù
(
AudioSŒ—m
 &
sourû
, 
sourûOuut
,

98 
AudioSŒ—m
 &
de¡š©iÚ
, 
de¡š©iÚIÅut
);

99 
	g´Ùeùed
:

100 
AudioSŒ—m
* 
¤c
;

101 
AudioSŒ—m
* 
	gd¡
;

102 
	g¤c_šdex
;

103 
	gde¡_šdex
;

104 
AudioCÚÃùiÚ
 *
	gÃxt_de¡
;

105 
boŞ
 
	gisCÚÃùed
;

106 #ià
	$defšed
(
AUDIO_DEBUG_CLASS
)

107 
ä›nd
 
şass
 
AudioDebug
;

109 
	}
};

112 
	#AudioMemÜy
(
num
) ({ \

113 
DMAMEM
 
audio_block_t
 
d©a
[
num
]; \

114 
AudioSŒ—m
::
	`š™Ÿlize_memÜy
(
d©a
, 
num
); \

115 })

	)

117 
	#CYCLE_COUNTER_APPROX_PERCENT
(
n
è((()((
ušt32_t
)Òè* 6400uè* ()(
AUDIO_SAMPLE_RATE_EXACT
 / 
AUDIO_BLOCK_SAMPLES
)è/ ()(
F_CPU_ACTUAL
))

	)

119 
	#AudioProûssÜU§ge
(è(
	`CYCLE_COUNTER_APPROX_PERCENT
(
AudioSŒ—m
::
ıu_cyşes_tÙ®
))

	)

120 
	#AudioProûssÜU§geMax
(è(
	`CYCLE_COUNTER_APPROX_PERCENT
(
AudioSŒ—m
::
ıu_cyşes_tÙ®_max
))

	)

121 
	#AudioProûssÜU§geMaxRe£t
(è(
AudioSŒ—m
::
ıu_cyşes_tÙ®_max
 = AudioSŒ—m::
ıu_cyşes_tÙ®
)

	)

122 
	#AudioMemÜyU§ge
(è(
AudioSŒ—m
::
memÜy_u£d
)

	)

123 
	#AudioMemÜyU§geMax
(è(
AudioSŒ—m
::
memÜy_u£d_max
)

	)

124 
	#AudioMemÜyU§geMaxRe£t
(è(
AudioSŒ—m
::
memÜy_u£d_max
 = AudioSŒ—m::
memÜy_u£d
)

	)

126 şas 
	cAudioSŒ—m


128 
	mpublic
:

129 
	$AudioSŒ—m
(
nšput
, 
audio_block_t
 **
iqueue
) :

130 
	`num_šputs
(
nšput
), 
	$šputQueue
(
iqueue
) {

131 
aùive
 = 
çl£
;

132 
de¡š©iÚ_li¡
 = 
NULL
;

133 
i
=0; i < 
num_šputs
; i++) {

134 
šputQueue
[
i
] = 
NULL
;

138 ià(
fœ¡_upd©e
 =ğ
NULL
) {

139 
fœ¡_upd©e
 = 
this
;

141 
AudioSŒ—m
 *
p
;

142 
p
=
fœ¡_upd©e
;…->
Ãxt_upd©e
;… =…->next_update) ;

143 
p
->
Ãxt_upd©e
 = 
this
;

145 
Ãxt_upd©e
 = 
NULL
;

146 
ıu_cyşes
 = 0;

147 
ıu_cyşes_max
 = 0;

148 
numCÚÃùiÚs
 = 0;

150 
	`š™Ÿlize_memÜy
(
audio_block_t
 *
d©a
, 
num
);

151 
	$´oûssÜU§ge
(è{  
	`CYCLE_COUNTER_APPROX_PERCENT
(
ıu_cyşes
); 
	}
}

152 
	$´oûssÜU§geMax
(è{  
	`CYCLE_COUNTER_APPROX_PERCENT
(
ıu_cyşes_max
); 
	}
}

153 
	$´oûssÜU§geMaxRe£t
(è{ 
ıu_cyşes_max
 = 
ıu_cyşes
; 
	}
}

154 
boŞ
 
	$isAùive
(è{  
aùive
; 
	}
}

155 
ušt16_t
 
	gıu_cyşes
;

156 
ušt16_t
 
	gıu_cyşes_max
;

157 
ušt16_t
 
	gıu_cyşes_tÙ®
;

158 
ušt16_t
 
	gıu_cyşes_tÙ®_max
;

159 
ušt16_t
 
	gmemÜy_u£d
;

160 
ušt16_t
 
	gmemÜy_u£d_max
;

161 
	g´Ùeùed
:

162 
boŞ
 
aùive
;

163 
	gnum_šputs
;

164 
audio_block_t
 * 
®loÿ‹
();

165 
»Ëa£
(
audio_block_t
 * 
block
);

166 
Œªsm™
(
audio_block_t
 *
block
, 
šdex
 = 0);

167 
audio_block_t
 * 
»ûiveR—dOÆy
(
šdex
 = 0);

168 
audio_block_t
 * 
»ûiveWr™abË
(
šdex
 = 0);

169 
boŞ
 
upd©e_£tup
();

170 
upd©e_¡İ
();

171 
	$upd©e_®l
(è{ 
	`NVIC_SET_PENDING
(
IRQ_SOFTWARE
); 
	}
}

172 
ä›nd
 
soáw¬e_i¤
();

173 
ä›nd
 
şass
 
	gAudioCÚÃùiÚ
;

174 #ià
	$defšed
(
AUDIO_DEBUG_CLASS
)

175 
ä›nd
 
şass
 
AudioDebug
;

177 
ušt8_t
 
numCÚÃùiÚs
;

178 
´iv©e
:

179 
AudioCÚÃùiÚ
* 
unu£d
;

180 
AudioCÚÃùiÚ
 *
de¡š©iÚ_li¡
;

181 
audio_block_t
 **
šputQueue
;

182 
boŞ
 
upd©e_scheduËd
;

183 
vœtu®
 
	`upd©e
() = 0;

184 
AudioSŒ—m
 *
fœ¡_upd©e
;

185 
AudioSŒ—m
 *
Ãxt_upd©e
;

186 
audio_block_t
 *
memÜy_poŞ
;

187 
ušt32_t
 
memÜy_poŞ_avaabË_mask
[];

188 
ušt16_t
 
memÜy_poŞ_fœ¡_mask
;

189 
	}
};

191 #ià
defšed
(
AUDIO_DEBUG_CLASS
)

195 şas 
	cAudioDebug


197 
	mpublic
:

199 
AudioSŒ—m
* 
	$g‘Src
(
AudioCÚÃùiÚ
& 
c
è{  c.
¤c
;};

200 
AudioSŒ—m
* 
	$g‘D¡
(
AudioCÚÃùiÚ
& 
c
è{  c.
d¡
;
	}
};

201 
	$g‘SrcN
(
AudioCÚÃùiÚ
& 
c
è{  c.
¤c_šdex
;
	}
};

202 
	$g‘D¡N
(
AudioCÚÃùiÚ
& 
c
è{  c.
de¡_šdex
;
	}
};

203 
AudioCÚÃùiÚ
* 
	$g‘Next
(
AudioCÚÃùiÚ
& 
c
è{  c.
Ãxt_de¡
;
	}
};

204 
boŞ
 
	$isCÚÃùed
(
AudioCÚÃùiÚ
& 
c
è{  c.
isCÚÃùed
;
	}
};

205 
AudioCÚÃùiÚ
* 
	$unu£dLi¡
(è{  
AudioSŒ—m
::
unu£d
;
	}
};

208 
AudioCÚÃùiÚ
* 
	$d¡Li¡
(
AudioSŒ—m
& 
s
è{  s.
de¡š©iÚ_li¡
;
	}
};

209 
audio_block_t
 ** 
	$šqLi¡
(
AudioSŒ—m
& 
s
è{  s.
šputQueue
;
	}
};

210 
ušt8_t
 
	$g‘NumIÅuts
(
AudioSŒ—m
& 
s
è{  s.
num_šputs
;
	}
};

211 
AudioSŒ—m
* 
	$fœ¡Upd©e
(
AudioSŒ—m
& 
s
è{  s.
fœ¡_upd©e
;
	}
};

212 
AudioSŒ—m
* 
	$ÃxtUpd©e
(
AudioSŒ—m
& 
s
è{  s.
Ãxt_upd©e
;
	}
};

213 
ušt8_t
 
	$g‘NumCÚÃùiÚs
(
AudioSŒ—m
& 
s
è{  s.
numCÚÃùiÚs
;
	}
};

214 
boŞ
 
	$isAùive
(
AudioSŒ—m
& 
s
è{  s.
aùive
;
	}
};

	@DEBUG.h

26 
	#__SOURCEFILE__
 (
	`¡¼chr
(
__FILE__
, '/'è? sŒrchr(__FILE__, '/'è+ 1 : __FILE__)

	)

28 
	#DEBUG_STREAM
 
S”Ÿl


	)

30 
	#DPRINTF
(...è{
DEBUG_STREAM
.
	`´štf
("%s:%u ",
__SOURCEFILE__
,
__LINE__
); DEBUG_STREAM.´štf(
__VA_ARGS__
 );}

	)

31 
	#DTRACE
(è{
DEBUG_STREAM
.
	`´štf
("%s:%u\n",
__SOURCEFILE__
,
__LINE__
);}

	)

32 
	#D1PRINTF
(...è{
boŞ
 
D1F__LINE__
=
Œue
; ià(D1F__LINE__è{
DEBUG_STREAM
.
	`´štf
("%s:%u ",
__SOURCEFILE__
,
__LINE__
); DEBUG_STREAM.´štf(
__VA_ARGS__
); D1F__LINE__=
çl£
;}}

	)

33 
	#D1TRACE
(è{
boŞ
 
D1T__LINE__
=
Œue
; ià(D1T__LINE__è{
DEBUG_STREAM
.
	`´štf
("%s:%u\n",
__SOURCEFILE__
,
__LINE__
); D1T__LINE__=
çl£
;}}

	)

	@HX8357_t3n.cpp

50 
	~"HX8357_t3n.h
"

51 
	~<SPI.h
>

55 #ifdeà
DEBUG_ASYNC_LEDS


56 
	#DEBUG_PIN_1
 4

	)

57 
	#DEBUG_PIN_2
 5

	)

58 
	#DEBUG_PIN_3
 6

	)

61 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


62 
	#CBALLOC
 (
HX8357_TFTHEIGHT
 * 
HX8357_TFTWIDTH
 * 2)

	)

63 
	#COUNT_WORDS_WRITE
 ((
HX8357_TFTHEIGHT
 * 
HX8357_TFTWIDTH
è/ 
SCREEN_DMA_NUM_SETTINGS
)

64 

	)

65 #ià
defšed
(
__MK66FX1M0__
)

67 
DMAS‘tšg
 
	gHX8357_t3n
::
_dma£‰šgs
[4];

68 
DMAChªÃl
 
	gHX8357_t3n
::
_dm©x
;

69 #–ià
defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

76 
DMAChªÃl
 
	gHX8357_t3n
::
_dm©x
;

77 
DMAChªÃl
 
	gHX8357_t3n
::
_dm¬x
;

78 
ušt16_t
 
	gHX8357_t3n
::
_dma_couÁ_»maššg
;

79 
ušt16_t
 
	gHX8357_t3n
::
_dma_wr™e_size_wÜds
;

80 vŞ©
	g_dma_dummy_rx
;

83 #ià
defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

84 
HX8357_t3n
 *
	gHX8357_t3n
::
_dmaAùiveDi¥Ïy
[3] = { 0, 0, 0 };

86 
HX8357_t3n
 *
	gHX8357_t3n
::
_dmaAùiveDi¥Ïy
 = 0;

93 #ià
defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

94 
	gHX8357_t3n
::
	$dmaIÁ”ru±
() {

95 ià(
_dmaAùiveDi¥Ïy
[0]) {

96 
_dmaAùiveDi¥Ïy
[0]->
	`´oûss_dma_š‹¼u±
();

98 
	}
}

99 
	gHX8357_t3n
::
	$dmaIÁ”ru±1
() {

100 ià(
_dmaAùiveDi¥Ïy
[1]) {

101 
_dmaAùiveDi¥Ïy
[1]->
	`´oûss_dma_š‹¼u±
();

103 
	}
}

104 
	gHX8357_t3n
::
	$dmaIÁ”ru±2
() {

105 ià(
_dmaAùiveDi¥Ïy
[2]) {

106 
_dmaAùiveDi¥Ïy
[2]->
	`´oûss_dma_š‹¼u±
();

108 
	}
}

112 
	gHX8357_t3n
::
	$dmaIÁ”ru±
() {

113 ià(
_dmaAùiveDi¥Ïy
) {

114 
_dmaAùiveDi¥Ïy
->
	`´oûss_dma_š‹¼u±
();

116 
	}
}

119 #ifdeà
DEBUG_ASYNC_UPDATE


120 
dumpDMA_TCD
(
DMABa£CÏss
 *
dmabc
);

123 
	gHX8357_t3n
::
	$´oûss_dma_š‹¼u±
() {

124 #ifdeà
DEBUG_ASYNC_LEDS


125 
	`dig™®Wr™eFa¡
(
DEBUG_PIN_2
, 
HIGH
);

127 #ià
	`defšed
(
__MK66FX1M0__
)

129 
_dma_äame_couÁ
++;

130 
_dm©x
.
	`ş—rIÁ”ru±
();

133 ià((
_dma_¡©e
 & 
HX8357_DMA_CONT
) == 0) {

136 
	`wa™FifoNÙFuÎ
();

137 
	`wr™ecommªd_Ï¡
(
HX8357_NOP
);

138 
	`’dSPIT¿n§ùiÚ
();

139 
_dma_¡©e
 &ğ~
HX8357_DMA_ACTIVE
;

140 
_dmaAùiveDi¥Ïy
 = 0;

142 #–ià
	`defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

144 #ià
	`defšed
(
TRY_FULL_DMA_CHAIN
)

145 
_dma_äame_couÁ
++;

146 
_dm©x
.
	`ş—rIÁ”ru±
();

148 #ifdeà
DEBUG_ASYNC_LEDS


149 
	`dig™®Wr™eFa¡
(
DEBUG_PIN_3
, 
HIGH
);

152 ià((
_dma_¡©e
 & 
HX8357_DMA_CONT
) == 0) {

156 
_pimx¹_¥i
->
FSR
 & 0x1f)

160 
_pimx¹_¥i
->
SR
 & 
LPSPI_SR_MBF
)

163 
_dm©x
.
	`ş—rCom¶‘e
();

165 
_pimx¹_¥i
->
FCR
 = 
	`LPSPI_FCR_TXWATER
(15);

166 
_pimx¹_¥i
->
DER
 = 0;

168 
_pimx¹_¥i
->
CR
 = 
LPSPI_CR_MEN
 | 
LPSPI_CR_RRF
 | 
LPSPI_CR_RTF
;

169 
_pimx¹_¥i
->
SR
 = 0x3f00;

171 
	`maybeUpd©eTCR
(
_tü_dc_as£¹
 | 
	`LPSPI_TCR_FRAMESZ
(7));

174 
	`wr™ecommªd_Ï¡
(
HX8357_NOP
);

175 
	`’dSPIT¿n§ùiÚ
();

176 
_dma_¡©e
 &ğ~
HX8357_DMA_ACTIVE
;

177 
_dmaAùiveDi¥Ïy
[
_¥i_num
] = 0;

180 ià((
ušt32_t
)
_pfbtá
 >ğ0x20200000uè
	`¬m_dÿche_æush
(_pfbtá, 
CBALLOC
);

182 #ifdeà
DEBUG_ASYNC_LEDS


183 
	`dig™®Wr™eFa¡
(
DEBUG_PIN_3
, 
LOW
);

186 
boŞ
 
¡l_mÜe_dma
 = 
Œue
;

187 
_dma_sub_äame_couÁ
++;

189 ià(
_dma_sub_äame_couÁ
 =ğ
_dma_út_sub_äames_³r_äame
) {

190 #ifdeà
DEBUG_ASYNC_LEDS


191 
	`dig™®Wr™eFa¡
(
DEBUG_PIN_3
, 
HIGH
);

195 
_dma_äame_couÁ
++;

197 ià(
_dma_¡©e
 & 
HX8357_DMA_FINISH
) {

199 
¡l_mÜe_dma
 = 
çl£
;

205 
_pimx¹_¥i
->
FSR
 & 0x1f)

209 
_pimx¹_¥i
->
SR
 & 
LPSPI_SR_MBF
)

212 
_dm©x
.
	`ş—rCom¶‘e
();

214 
_pimx¹_¥i
->
FCR
 = 
	`LPSPI_FCR_TXWATER
(15);

215 
_pimx¹_¥i
->
DER
 = 0;

217 
_pimx¹_¥i
->
CR
 = 
LPSPI_CR_MEN
 | 
LPSPI_CR_RRF
 | 
LPSPI_CR_RTF
;

218 
_pimx¹_¥i
->
SR
 = 0x3f00;

221 
	`maybeUpd©eTCR
(
_tü_dc_as£¹
 | 
	`LPSPI_TCR_FRAMESZ
(7));

224 
	`wr™ecommªd_Ï¡
(
HX8357_NOP
);

227 
	`’dSPIT¿n§ùiÚ
();

228 
_dma_¡©e
 &ğ~(
HX8357_DMA_ACTIVE
 | 
HX8357_DMA_FINISH
);

229 
_dmaAùiveDi¥Ïy
[
_¥i_num
] = 0;

234 
_dma_sub_äame_couÁ
 = 0;

235 #ifdeà
DEBUG_ASYNC_LEDS


236 
	`dig™®Wr™eFa¡
(
DEBUG_PIN_3
, 
LOW
);

240 ià(
¡l_mÜe_dma
) {

242 ià(
_dma_sub_äame_couÁ
 =ğ(
_dma_út_sub_äames_³r_äame
 - 2)) {

243 ià((
_dma_¡©e
 & 
HX8357_DMA_CONT
) == 0) {

244 ià(
_dma_sub_äame_couÁ
 & 1è
_dma£‰šgs
[0].
	`di§bËOnCom¶‘iÚ
();

245 
_dma£‰šgs
[1].
	`di§bËOnCom¶‘iÚ
();

247 
_dma_¡©e
 |ğ
HX8357_DMA_FINISH
;

250 ià(
_dma_sub_äame_couÁ
 & 1) {

251 
	`memıy
(
_dma_bufãr1
, &
_pfbtá_async
[
_dma_pix–_šdex
], 
_dma_bufãr_size
 * 2);

253 
	`memıy
(
_dma_bufãr2
, &
_pfbtá_async
[
_dma_pix–_šdex
], 
_dma_bufãr_size
 * 2);

255 
_dma_pix–_šdex
 +ğ
_dma_bufãr_size
;

256 ià(
_dma_pix–_šdex
 >ğ(
_couÁ_pix–s
))

257 
_dma_pix–_šdex
 = 0;

259 
_dm©x
.
	`ş—rIÁ”ru±
();

260 
_dm©x
.
	`ş—rCom¶‘e
();

262 
	`asm
("dsb");

266 
_dm¬x
.
	`ş—rIÁ”ru±
();

267 
_dm©x
.
	`ş—rCom¶‘e
();

268 
_dm¬x
.
	`ş—rCom¶‘e
();

270 ià(!
_dma_couÁ_»maššg
 && !(
_dma_¡©e
 & 
HX8357_DMA_CONT
)) {

272 
_dma_äame_couÁ
++;

273 #ifdeà
DEBUG_ASYNC_LEDS


274 
	`dig™®Wr™eFa¡
(
DEBUG_PIN_3
, 
HIGH
);

277 
_pkš‘isk_¥i
->
RSER
 = 0;

279 
_pkš‘isk_¥i
->
SR
 = 0xFF0F0000;

280 
_pkš‘isk_¥i
->
CTAR0
 &ğ~(
	`SPI_CTAR_FMSZ
(8));

282 
	`wr™ecommªd_Ï¡
(
HX8357_NOP
);

283 
	`’dSPIT¿n§ùiÚ
();

284 
_dma_¡©e
 &ğ~
HX8357_DMA_ACTIVE
;

285 
_dmaAùiveDi¥Ïy
 = 0;

286 #ifdeà
DEBUG_ASYNC_LEDS


287 
	`dig™®Wr™eFa¡
(
DEBUG_PIN_3
, 
LOW
);

291 
ušt16_t
 
w
;

292 ià(
_dma_couÁ_»maššg
) {

293 
_dma_couÁ_»maššg
 -ğ
_dma_wr™e_size_wÜds
;

294 
w
 = *((
ušt16_t
 *)
_dm©x
.
TCD
->
SADDR
);

295 
_dm©x
.
TCD
->
SADDR
 = (vŞ©
ušt8_t
 *)(_dmatx.TCD->SADDR) + 2;

297 
_dma_äame_couÁ
++;

298 
_dm©x
.
	`sourûBufãr
(&
_pfbtá
[1], (
_dma_wr™e_size_wÜds
 - 1) * 2);

299 
_dm©x
.
TCD
->
SLAST
 = 0;

300 
w
 = 
_pfbtá
[0];

301 
_dma_couÁ_»maššg
 = 
CBALLOC
 / 2 - 
_dma_wr™e_size_wÜds
;

303 #ifdeà
DEBUG_ASYNC_UPDATE


307 
_pkš‘isk_¥i
->
PUSHR
 = (
w
 | 
	`SPI_PUSHR_CTAS
(0è| 
SPI_PUSHR_CONT
);

308 
_dm¬x
.
	`’abË
();

309 
_dm©x
.
	`’abË
();

313 #ifdeà
DEBUG_ASYNC_LEDS


314 
	`dig™®Wr™eFa¡
(
DEBUG_PIN_2
, 
LOW
);

316 
	}
}

321 
	#WIDTH
 
HX8357_TFTWIDTH


	)

322 
	#HEIGHT
 
HX8357_TFTHEIGHT


	)

326 
	gHX8357_t3n
::
	$HX8357_t3n
(
ušt8_t
 
cs
, ušt8_ˆ
dc
, ušt8_ˆ
r¡
,

327 
ušt8_t
 
mosi
, ušt8_ˆ
sşk
, ušt8_ˆ
miso
) {

328 
_cs
 = 
cs
;

329 
_dc
 = 
dc
;

330 
_r¡
 = 
r¡
;

331 
_mosi
 = 
mosi
;

332 
_sşk
 = 
sşk
;

333 
_miso
 = 
miso
;

334 
_width
 = 
WIDTH
;

335 
_height
 = 
HEIGHT
;

337 
rÙ©iÚ
 = 0;

338 
cursÜ_y
 = 
cursÜ_x
 = 0;

339 
‹xtsize_x
 = 
‹xtsize_y
 = 1;

340 
‹xtcŞÜ
 = 
‹xtbgcŞÜ
 = 0xFFFF;

341 
w¿p
 = 
Œue
;

342 
fÚt
 = 
NULL
;

343 
gfxFÚt
 = 
NULL
;

344 
	`£tClReù
();

345 
	`£tOrigš
();

348 
_c¥šmask
 = 0;

349 
_c¥Üt
 = 
NULL
;

351 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


352 
_pfbtá
 = 
NULL
;

353 
_u£_fbtá
 = 0;

354 
_we_®loÿ‹d_bufãr
 = 
NULL
;

356 
	}
}

361 
	gHX8357_t3n
::
	$£tF¿meBufãr
(
ušt16_t
 *
äame_bufãr
) {

362 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


363 
_pfbtá
 = 
äame_bufãr
;

369 
_dma_¡©e
 &ğ~
HX8357_DMA_INIT
;

372 
	}
}

374 
ušt8_t
 
	gHX8357_t3n
::
	$u£F¿meBufãr
(
boŞ—n
 
b
)

376 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


378 ià(
b
) {

380 ià(
_pfbtá
 =ğ
NULL
) {

382 
_we_®loÿ‹d_bufãr
 = (
ušt16_t
 *)
	`m®loc
(
CBALLOC
 + 32);

383 ià(
_we_®loÿ‹d_bufãr
 =ğ
NULL
)

385 
_pfbtá
 = (
ušt16_t
 *)(((
ušŒ_t
)
_we_®loÿ‹d_bufãr
 + 32) & ~((uintptr_t)(31)));

386 
	`mem£t
(
_pfbtá
, 0, 
CBALLOC
);

388 
_u£_fbtá
 = 1;

389 
	`ş—rChªgedRªge
();

391 
_u£_fbtá
 = 0;

393  
_u£_fbtá
;

397 
	}
}

399 
	gHX8357_t3n
::
	$ä“F¿meBufãr
()

401 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


402 ià(
_we_®loÿ‹d_bufãr
) {

403 
	`ä“
(
_we_®loÿ‹d_bufãr
);

404 
_pfbtá
 = 
NULL
;

405 
_u£_fbtá
 = 0;

406 
_we_®loÿ‹d_bufãr
 = 
NULL
;

409 
	}
}

410 
	gHX8357_t3n
::
	$upd©eSü“n
()

414 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


415 ià(
_u£_fbtá
) {

416 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

417 ià(
_¡ªd¬d
 && !
_upd©eChªgedA»asOÆy
) {

419 
	`£tAddr
(0, 0, 
_width
 - 1, 
_height
 - 1);

420 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

424 
ušt16_t
 *
pfbtá_’d
 = &
_pfbtá
[(
HX8357_TFTWIDTH
 * 
HX8357_TFTHEIGHT
) - 1];

425 
ušt16_t
 *
pábá
 = 
_pfbtá
;

428 
pábá
 < 
pfbtá_’d
) {

429 
	`wr™ed©a16_cÚt
(*
pábá
++);

431 
	`wr™ed©a16_Ï¡
(*
pábá
);

434 
št16_t
 
¡¬t_x
 = 
_di¥Ïyşx1
;

435 
št16_t
 
¡¬t_y
 = 
_di¥Ïyşy1
;

436 
št16_t
 
’d_x
 = 
_di¥Ïyşx2
 - 1;

437 
št16_t
 
’d_y
 = 
_di¥Ïyşy2
 - 1;

439 ià(
_upd©eChªgedA»asOÆy
) {

441 ià(
_chªged_mš_x
 > 
¡¬t_x
) start_x = _changed_min_x;

442 ià(
_chªged_mš_y
 > 
¡¬t_y
) start_y = _changed_min_y;

443 ià(
_chªged_max_x
 < 
’d_x
)ƒnd_x = _changed_max_x;

444 ià(
_chªged_max_y
 < 
’d_y
)ƒnd_y = _changed_max_y;

448 ià((
¡¬t_x
 <ğ
’d_x
è&& (
¡¬t_y
 <ğ
’d_y
)) {

449 
	`£tAddr
(
¡¬t_x
, 
¡¬t_y
, 
’d_x
, 
’d_y
);

450 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

454 
ušt16_t
 *
pfbPix–_row
 = &
_pfbtá
[
¡¬t_y
 * 
_width
 + 
¡¬t_x
];

455 
ušt16_t
 
y
 = 
¡¬t_y
; y <ğ
’d_y
; y++) {

456 
ušt16_t
 *
pfbPix–
 = 
pfbPix–_row
;

457 
ušt16_t
 
x
 = 
¡¬t_x
; x < 
’d_x
; x++) {

458 
	`wr™ed©a16_cÚt
(*
pfbPix–
++);

460 ià(
y
 < (
’d_y
))

461 
	`wr™ed©a16_cÚt
(*
pfbPix–
);

463 
	`wr™ed©a16_Ï¡
(*
pfbPix–
);

464 
pfbPix–_row
 +ğ
_width
;

468 
	`’dSPIT¿n§ùiÚ
();

470 
	`ş—rChªgedRªge
();

472 
	}
}

474 #ifdeà
DEBUG_ASYNC_UPDATE


475 
	$dumpDMA_TCD
(
DMABa£CÏss
 *
dmabc
) {

476 
S”Ÿl
.
	`´štf
("%x %x:", (
ušt32_t
)
dmabc
, (ušt32_t)dmabc->
TCD
);

478 
S”Ÿl
.
	`´štf
("SA:%x SO:%d AT:%x NB:%x SL:%d DA:%x DO: %d CI:%x DL:%x CS:%x BI:%x\n", (
ušt32_t
)
dmabc
->
TCD
->
SADDR
,

479 
dmabc
->
TCD
->
SOFF
, dmabc->TCD->
ATTR
, dmabc->TCD->
NBYTES
, dmabc->TCD->
SLAST
, (
ušt32_t
)dmabc->TCD->
DADDR
,

480 
dmabc
->
TCD
->
DOFF
, dmabc->TCD->
CITER
, dmabc->TCD->
DLASTSGA
, dmabc->TCD->
CSR
, dmabc->TCD->
BITER
);

481 
	}
}

484 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


486 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


487 
	gHX8357_t3n
::
	$š™DMAS‘tšgs
() {

489 ià(
_dma_¡©e
 & 
HX8357_DMA_INIT
) {

494 
ušt8_t
 
dmaTXev’t
 = 
_¥i_h¬dw¬e
->
tx_dma_chªÃl
;

495 #ià
	`defšed
(
__MK66FX1M0__
)

504 
_dma£‰šgs
[0].
	`sourûBufãr
(&
_pfbtá
[1], (
COUNT_WORDS_WRITE
 - 1) * 2);

505 
_dma£‰šgs
[0].
	`de¡š©iÚ
(
_pkš‘isk_¥i
->
PUSHR
);

508 
_dma£‰šgs
[0].
TCD
->
ATTR_DST
 = 1;

509 
_dma£‰šgs
[0].
	`»¶aûS‘tšgsOnCom¶‘iÚ
(_dmasettings[1]);

511 
_dma£‰šgs
[1].
	`sourûBufãr
(&
_pfbtá
[
COUNT_WORDS_WRITE
], COUNT_WORDS_WRITE * 2);

512 
_dma£‰šgs
[1].
	`de¡š©iÚ
(
_pkš‘isk_¥i
->
PUSHR
);

513 
_dma£‰šgs
[1].
TCD
->
ATTR_DST
 = 1;

514 
_dma£‰šgs
[1].
	`»¶aûS‘tšgsOnCom¶‘iÚ
(_dmasettings[2]);

516 
_dma£‰šgs
[2].
	`sourûBufãr
(&
_pfbtá
[
COUNT_WORDS_WRITE
 * 2], COUNT_WORDS_WRITE * 2);

517 
_dma£‰šgs
[2].
	`de¡š©iÚ
(
_pkš‘isk_¥i
->
PUSHR
);

518 
_dma£‰šgs
[2].
TCD
->
ATTR_DST
 = 1;

519 
_dma£‰šgs
[2].
	`»¶aûS‘tšgsOnCom¶‘iÚ
(_dmasettings[3]);

522 
_dma£‰šgs
[3].
	`sourûBufãr
(
_pfbtá
, 2);

523 
_dma£‰šgs
[3].
	`de¡š©iÚ
(
_pkš‘isk_¥i
->
PUSHR
);

524 
_dma£‰šgs
[3].
TCD
->
ATTR_DST
 = 1;

525 
_dma£‰šgs
[3].
	`»¶aûS‘tšgsOnCom¶‘iÚ
(_dmasettings[0]);

529 
_dm©x
.
	`begš
(
Œue
);

530 
_dm©x
.
	`Œigg”AtH¬dw¬eEv’t
(
dmaTXev’t
);

531 
_dm©x
 = 
_dma£‰šgs
[0];

532 
_dm©x
.
	`©chIÁ”ru±
(
dmaIÁ”ru±
);

533 #–ià
	`defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

536 #ià
	`defšed
(
TRY_FULL_DMA_CHAIN
)

539 
_dma£‰šgs
[0].
	`sourûBufãr
(
_pfbtá
, (
COUNT_WORDS_WRITE
)*2);

540 
_dma£‰šgs
[0].
	`de¡š©iÚ
(
_pimx¹_¥i
->
TDR
);

541 
_dma£‰šgs
[0].
TCD
->
ATTR_DST
 = 1;

542 
_dma£‰šgs
[0].
	`»¶aûS‘tšgsOnCom¶‘iÚ
(_dmasettings[1]);

544 
_dma£‰šgs
[1].
	`sourûBufãr
(&
_pfbtá
[
COUNT_WORDS_WRITE
], COUNT_WORDS_WRITE * 2);

545 
_dma£‰šgs
[1].
	`de¡š©iÚ
(
_pimx¹_¥i
->
TDR
);

546 
_dma£‰šgs
[1].
TCD
->
ATTR_DST
 = 1;

547 
_dma£‰šgs
[1].
	`»¶aûS‘tšgsOnCom¶‘iÚ
(_dmasettings[2]);

549 
_dma£‰šgs
[2].
	`sourûBufãr
(&
_pfbtá
[
COUNT_WORDS_WRITE
 * 2], COUNT_WORDS_WRITE * 2);

550 
_dma£‰šgs
[2].
	`de¡š©iÚ
(
_pimx¹_¥i
->
TDR
);

551 
_dma£‰šgs
[2].
TCD
->
ATTR_DST
 = 1;

552 
_dma£‰šgs
[2].
	`»¶aûS‘tšgsOnCom¶‘iÚ
(_dmasettings[3]);

554 
_dma£‰šgs
[3].
	`sourûBufãr
(&
_pfbtá
[
COUNT_WORDS_WRITE
 * 3], COUNT_WORDS_WRITE * 2);

555 
_dma£‰šgs
[3].
	`de¡š©iÚ
(
_pimx¹_¥i
->
TDR
);

556 
_dma£‰šgs
[3].
TCD
->
ATTR_DST
 = 1;

557 
_dma£‰šgs
[3].
	`»¶aûS‘tšgsOnCom¶‘iÚ
(_dmasettings[4]);

559 
_dma£‰šgs
[4].
	`sourûBufãr
(&
_pfbtá
[
COUNT_WORDS_WRITE
 * 4], COUNT_WORDS_WRITE * 2);

560 
_dma£‰šgs
[4].
	`de¡š©iÚ
(
_pimx¹_¥i
->
TDR
);

561 
_dma£‰šgs
[4].
TCD
->
ATTR_DST
 = 1;

562 
_dma£‰šgs
[4].
	`»¶aûS‘tšgsOnCom¶‘iÚ
(_dmasettings[0]);

563 
_dma£‰šgs
[4].
	`š‹¼u±AtCom¶‘iÚ
();

566 
_dma_bufãr_size
 = 
DMA_BUFFER_SIZE
;

567 
_dma_út_sub_äames_³r_äame
 = (
_couÁ_pix–s
è/ 
_dma_bufãr_size
;

568 (
_dma_út_sub_äames_³r_äame
 * 
_dma_bufãr_size
è!ğ(
_couÁ_pix–s
)) {

569 
_dma_bufãr_size
--;

570 
_dma_út_sub_äames_³r_äame
 = (
_couÁ_pix–s
è/ 
_dma_bufãr_size
;

573 
S”Ÿl
.
	`´štf
("DMA In™ buàsize: %d sub f¿mes:%d\n", 
_dma_bufãr_size
, 
_dma_út_sub_äames_³r_äame
);

575 
_dma£‰šgs
[0].
	`sourûBufãr
(
_dma_bufãr1
, 
_dma_bufãr_size
 * 2);

576 
_dma£‰šgs
[0].
	`de¡š©iÚ
(
_pimx¹_¥i
->
TDR
);

577 
_dma£‰šgs
[0].
TCD
->
ATTR_DST
 = 1;

578 
_dma£‰šgs
[0].
	`»¶aûS‘tšgsOnCom¶‘iÚ
(_dmasettings[1]);

579 
_dma£‰šgs
[0].
	`š‹¼u±AtCom¶‘iÚ
();

581 
_dma£‰šgs
[1].
	`sourûBufãr
(
_dma_bufãr2
, 
_dma_bufãr_size
 * 2);

582 
_dma£‰šgs
[1].
	`de¡š©iÚ
(
_pimx¹_¥i
->
TDR
);

583 
_dma£‰šgs
[1].
TCD
->
ATTR_DST
 = 1;

584 
_dma£‰šgs
[1].
	`»¶aûS‘tšgsOnCom¶‘iÚ
(_dmasettings[0]);

585 
_dma£‰šgs
[1].
	`š‹¼u±AtCom¶‘iÚ
();

590 
_dm©x
.
	`begš
(
Œue
);

591 
_dm©x
.
	`Œigg”AtH¬dw¬eEv’t
(
dmaTXev’t
);

592 
_dm©x
 = 
_dma£‰šgs
[0];

593 ià(
_¥i_num
 =ğ0è
_dm©x
.
	`©chIÁ”ru±
(
dmaIÁ”ru±
);

594 ià(
_¥i_num
 =ğ1è
_dm©x
.
	`©chIÁ”ru±
(
dmaIÁ”ru±1
);

595 
_dm©x
.
	`©chIÁ”ru±
(
dmaIÁ”ru±2
);

601 
_dm¬x
.
	`di§bË
();

602 
_dm¬x
.
	`sourû
(
_pkš‘isk_¥i
->
POPR
);

603 
_dm¬x
.
TCD
->
ATTR_SRC
 = 1;

604 
_dm¬x
.
	`de¡š©iÚ
(
_dma_dummy_rx
);

605 
_dm¬x
.
	`di§bËOnCom¶‘iÚ
();

606 
_dm¬x
.
	`Œigg”AtH¬dw¬eEv’t
(
_¥i_h¬dw¬e
->
rx_dma_chªÃl
);

607 
_dm¬x
.
	`©chIÁ”ru±
(
dmaIÁ”ru±
);

608 
_dm¬x
.
	`š‹¼u±AtCom¶‘iÚ
();

613 
_dm©x
.
	`di§bË
();

614 
_dm©x
.
	`de¡š©iÚ
(
_pkš‘isk_¥i
->
PUSHR
);

615 
_dm©x
.
TCD
->
ATTR_DST
 = 1;

616 
_dm©x
.
	`di§bËOnCom¶‘iÚ
();

618 ià(
_¥i_num
 == 0) {

619 
_dm©x
.
	`Œigg”AtH¬dw¬eEv’t
(
dmaTXev’t
);

620 
_dma_wr™e_size_wÜds
 = 
COUNT_WORDS_WRITE
;

622 
_dma_wr™e_size_wÜds
 = 480;

623 
_dm©x
.
	`Œigg”AtT¿nsãrsOf
(
_dm¬x
);

628 
_dma_¡©e
 = 
HX8357_DMA_INIT
;

630 
	}
}

633 
	gHX8357_t3n
::
	$dumpDMAS‘tšgs
() {

634 #ifdeà
DEBUG_ASYNC_UPDATE


635 #ià
	`defšed
(
__MK66FX1M0__
)

637 
S”Ÿl
.
	`´štf
("DMA dum°TCD %d\n", 
_dm©x
.
chªÃl
);

638 
	`dumpDMA_TCD
(&
_dm©x
);

639 
	`dumpDMA_TCD
(&
_dma£‰šgs
[0]);

640 
	`dumpDMA_TCD
(&
_dma£‰šgs
[1]);

641 
	`dumpDMA_TCD
(&
_dma£‰šgs
[2]);

642 
	`dumpDMA_TCD
(&
_dma£‰šgs
[3]);

643 #–ià
	`defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

645 
	`dumpDMA_TCD
(&
_dm©x
);

646 
	`dumpDMA_TCD
(&
_dma£‰šgs
[0]);

647 
	`dumpDMA_TCD
(&
_dma£‰šgs
[1]);

648 #ià
	`defšed
(
TRY_FULL_DMA_CHAIN
)

649 
	`dumpDMA_TCD
(&
_dma£‰šgs
[2]);

650 
	`dumpDMA_TCD
(&
_dma£‰šgs
[3]);

651 
	`dumpDMA_TCD
(&
_dma£‰šgs
[4]);

654 
S”Ÿl
.
	`´štf
("DMA dum°TX:%d RX:%d\n", 
_dm©x
.
chªÃl
, 
_dm¬x
.channel);

655 
	`dumpDMA_TCD
(&
_dm©x
);

656 
	`dumpDMA_TCD
(&
_dm¬x
);

659 
	}
}

661 
boŞ
 
	gHX8357_t3n
::
	$upd©eSü“nAsync
(
boŞ
 
upd©e_cÚt
)

666 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


667 ià(!
_u£_fbtá
è 
çl£
;

670 #ià
	`defšed
(
__MK64FX512__
)

674 ià(!
_c¥Üt
) {

675 
pcs_d©a
 = 0;

676 
pcs_commªd
 = 
pcs_d©a
 | 
_p¥i
->
	`£tCS
(
_dc
);

677 
	`pšMode
(
_cs
, 
OUTPUT
);

678 
_c¥Üt
 = 
	`pÜtOuutRegi¡”
(
	`dig™®PšToPÜt
(
_cs
));

679 
_c¥šmask
 = 
	`dig™®PšToB™Mask
(
_cs
);

680 *
_c¥Üt
 |ğ
_c¥šmask
;

684 #ifdeà
DEBUG_ASYNC_LEDS


685 
	`dig™®Wr™eFa¡
(
DEBUG_PIN_1
, 
HIGH
);

688 
	`š™DMAS‘tšgs
();

691 ià(
_dma_¡©e
 & 
HX8357_DMA_ACTIVE
) {

692 #ifdeà
DEBUG_ASYNC_LEDS


693 
	`dig™®Wr™eFa¡
(
DEBUG_PIN_1
, 
LOW
);

695  
çl£
;

698 #ià
	`defšed
(
__MK66FX1M0__
)

702 ià(
upd©e_cÚt
) {

704 
_dma£‰šgs
[2].
	`»¶aûS‘tšgsOnCom¶‘iÚ
(_dmasettings[3]);

705 
_dma£‰šgs
[2].
TCD
->
CSR
 &ğ~(
DMA_TCD_CSR_INTMAJOR
 | 
DMA_TCD_CSR_DREQ
);

706 
_dma£‰šgs
[3].
	`š‹¼u±AtCom¶‘iÚ
();

707 
_dma£‰šgs
[3].
TCD
->
CSR
 &ğ~(
DMA_TCD_CSR_DREQ
);

708 
_dma_¡©e
 |ğ
HX8357_DMA_CONT
;

711 
_dma£‰šgs
[2].
	`»¶aûS‘tšgsOnCom¶‘iÚ
(_dmasettings[0]);

712 
_dma£‰šgs
[2].
	`š‹¼u±AtCom¶‘iÚ
();

713 
_dma£‰šgs
[2].
	`di§bËOnCom¶‘iÚ
();

714 
_dma_¡©e
 &ğ~
HX8357_DMA_CONT
;

718 #ifdeà
DEBUG_ASYNC_UPDATE


719 
	`dumpDMAS‘tšgs
();

721 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

724 
	`£tAddr
(0, 0, 
_width
 - 1, 
_height
 - 1);

725 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

728 
	`wr™ed©a16_cÚt
(*
_pfbtá
);

734 
_dma_äame_couÁ
 = 0;

735 
_dmaAùiveDi¥Ïy
 = 
this
;

736 
_dma_¡©e
 |ğ
HX8357_DMA_ACTIVE
;

737 
_pkš‘isk_¥i
->
RSER
 |ğ
SPI_RSER_TFFF_DIRS
 | 
SPI_RSER_TFFF_RE
;

738 
_pkš‘isk_¥i
->
MCR
 &ğ~
SPI_MCR_HALT
;

739 
_dm©x
.
	`’abË
();

743 #–ià
	`defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

744 #ià
	`defšed
(
TRY_FULL_DMA_CHAIN
)

749 ià((
ušt32_t
)
_pfbtá
 >ğ0x20200000uè
	`¬m_dÿche_æush
(_pfbtá, 
CBALLOC
);

751 
_dma£‰šgs
[4].
TCD
->
CSR
 &ğ~(
DMA_TCD_CSR_DREQ
);

752 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

754 
	`£tAddr
(0, 0, 
_width
 - 1, 
_height
 - 1);

755 
	`wr™ecommªd_Ï¡
(
HX8357_RAMWR
);

758 
_¥i_fü_§ve
 = 
_pimx¹_¥i
->
FCR
;

759 
_pimx¹_¥i
->
FCR
 = 0;

760 
	`maybeUpd©eTCR
(
_tü_dc_nÙ_as£¹
 | 
	`LPSPI_TCR_FRAMESZ
(15è| 
LPSPI_TCR_RXMSK
 );

761 
_pimx¹_¥i
->
DER
 = 
LPSPI_DER_TDDE
;

762 
_pimx¹_¥i
->
SR
 = 0x3f00;

764 
_dm©x
.
	`Œigg”AtH¬dw¬eEv’t
(
_¥i_h¬dw¬e
->
tx_dma_chªÃl
);

766 
_dm©x
 = 
_dma£‰šgs
[0];

768 
_dm©x
.
	`begš
(
çl£
);

769 
_dm©x
.
	`’abË
();

771 #ifdeà
DEBUG_ASYNC_UPDATE


772 
	`dumpDMAS‘tšgs
();

775 
_dma_äame_couÁ
 = 0;

776 
_dmaAùiveDi¥Ïy
[
_¥i_num
] = 
this
;

777 ià(
upd©e_cÚt
) {

778 
_dma_¡©e
 |ğ
HX8357_DMA_CONT
;

780 
_dma£‰šgs
[4].
	`di§bËOnCom¶‘iÚ
();

781 
_dma_¡©e
 &ğ~
HX8357_DMA_CONT
;

784 
_dma_¡©e
 |ğ
HX8357_DMA_ACTIVE
;

790 
_dma£‰šgs
[0].
TCD
->
CSR
 &ğ~(
DMA_TCD_CSR_DREQ
);

791 
_dma£‰šgs
[1].
TCD
->
CSR
 &ğ~(
DMA_TCD_CSR_DREQ
);

793 #ifdeà
DEBUG_ASYNC_UPDATE


794 
	`dumpDMAS‘tšgs
();

797 
_pfbtá_async
 = 
_pfbtá
;

798 
	`memıy
(
_dma_bufãr1
, 
_pfbtá_async
, 
_dma_bufãr_size
 * 2);

799 
	`memıy
(
_dma_bufãr2
, &
_pfbtá_async
[
_dma_bufãr_size
], _dma_buffer_size * 2);

800 
_dma_pix–_šdex
 = 
_dma_bufãr_size
 * 2;

801 
_dma_sub_äame_couÁ
 = 0;

803 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

805 
	`£tAddr
(0, 0, 
_width
 - 1, 
_height
 - 1);

806 
	`wr™ecommªd_Ï¡
(
HX8357_RAMWR
);

809 
_¥i_fü_§ve
 = 
_pimx¹_¥i
->
FCR
;

810 
_pimx¹_¥i
->
FCR
 = 0;

811 
	`maybeUpd©eTCR
(
_tü_dc_nÙ_as£¹
 | 
	`LPSPI_TCR_FRAMESZ
(15è| 
LPSPI_TCR_RXMSK
 );

812 
_pimx¹_¥i
->
DER
 = 
LPSPI_DER_TDDE
;

813 
_pimx¹_¥i
->
SR
 = 0x3f00;

815 
_dm©x
.
	`Œigg”AtH¬dw¬eEv’t
(
_¥i_h¬dw¬e
->
tx_dma_chªÃl
);

817 
_dm©x
 = 
_dma£‰šgs
[0];

819 
_dm©x
.
	`begš
(
çl£
);

820 
_dm©x
.
	`’abË
();

822 
_dma_äame_couÁ
 = 0;

823 
_dmaAùiveDi¥Ïy
[
_¥i_num
] = 
this
;

824 ià(
upd©e_cÚt
) {

825 
_dma_¡©e
 |ğ
HX8357_DMA_CONT
;

827 
_dma_¡©e
 &ğ~
HX8357_DMA_CONT
;

830 
_dma_¡©e
 |ğ
HX8357_DMA_ACTIVE
;

838 
_dm©x
.
	`sourûBufãr
(&
_pfbtá
[1], (
_dma_wr™e_size_wÜds
 - 1) * 2);

839 
_dm©x
.
TCD
->
SLAST
 = 0;

840 
_dm¬x
.
	`ŒªsãrCouÁ
(
_dma_wr™e_size_wÜds
);

841 
_dma_couÁ_»maššg
 = 
CBALLOC
 / 2 - 
_dma_wr™e_size_wÜds
;

844 #ifdeà
DEBUG_ASYNC_UPDATE


845 
	`dumpDMAS‘tšgs
();

848 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

850 
	`£tAddr
(0, 0, 
_width
 - 1, 
_height
 - 1);

851 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

855 
_pkš‘isk_¥i
->
CTAR0
 |ğ
	`SPI_CTAR_FMSZ
(8);

857 
_pkš‘isk_¥i
->
MCR
 = 
SPI_MCR_MSTR
 | 
SPI_MCR_CLR_RXF
 | 
	`SPI_MCR_PCSIS
(0x1F);

859 
_pkš‘isk_¥i
->
SR
 = 0xFF0F0000;

862 
_pkš‘isk_¥i
->
PUSHR
 = *
_pfbtá
 | 
	`SPI_PUSHR_CTAS
(0è| 
SPI_PUSHR_CONT
;

864 ià(
_¥i_num
 == 0) {

866 
_pkš‘isk_¥i
->
RSER
 = 
SPI_RSER_RFDF_RE
 | 
SPI_RSER_RFDF_DIRS
 | 
SPI_RSER_TFFF_RE
 | 
SPI_RSER_TFFF_DIRS
;

868 
_dm¬x
.
	`’abË
();

869 
_dm©x
.
	`’abË
();

871 
_pkš‘isk_¥i
->
RSER
 = 
SPI_RSER_RFDF_RE
 | 
SPI_RSER_RFDF_DIRS
;

872 
_dm©x
.
	`Œigg”AtT¿nsãrsOf
(
_dm¬x
);

873 
_dm©x
.
	`’abË
();

874 
_dm¬x
.
	`’abË
();

877 
_dma_äame_couÁ
 = 0;

878 
_dmaAùiveDi¥Ïy
 = 
this
;

879 ià(
upd©e_cÚt
) {

880 
_dma_¡©e
 |ğ
HX8357_DMA_CONT
;

882 
_dma_¡©e
 &ğ~
HX8357_DMA_CONT
;

885 
_dma_¡©e
 |ğ
HX8357_DMA_ACTIVE
;

887 #ifdeà
DEBUG_ASYNC_LEDS


888 
	`dig™®Wr™eFa¡
(
DEBUG_PIN_1
, 
LOW
);

890  
Œue
;

892  
çl£
;

894 
	}
}

896 
	gHX8357_t3n
::
	$’dUpd©eAsync
() {

898 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


899 ià(
_dma_¡©e
 & 
HX8357_DMA_CONT
) {

900 
_dma_¡©e
 &ğ~
HX8357_DMA_CONT
;

901 #ià
	`defšed
(
TRY_FULL_DMA_CHAIN
)

902 
_dma£‰šgs
[4].
	`di§bËOnCom¶‘iÚ
();

907 
	}
}

909 
	gHX8357_t3n
::
	$wa™Upd©eAsyncCom¶‘e
() {

910 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


911 #ifdeà
DEBUG_ASYNC_LEDS


912 
	`dig™®Wr™eFa¡
(
DEBUG_PIN_3
, 
HIGH
);

915 (
_dma_¡©e
 & 
HX8357_DMA_ACTIVE
)) {

918 #ifdeà
DEBUG_ASYNC_LEDS


919 
	`dig™®Wr™eFa¡
(
DEBUG_PIN_3
, 
LOW
);

922 
	}
}

927 
	gHX8357_t3n
::
	$£tAddrWšdow
(
ušt16_t
 
x0
, ušt16_ˆ
y0
, ušt16_ˆ
x1
, ušt16_ˆ
y1
) {

928 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

929 
	`£tAddr
(
x0
, 
y0
, 
x1
, 
y1
);

930 
	`wr™ecommªd_Ï¡
(
HX8357_RAMWR
);

931 
	`’dSPIT¿n§ùiÚ
();

932 
	}
}

934 
	gHX8357_t3n
::
	$pushCŞÜ
(
ušt16_t
 
cŞÜ
) {

935 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

936 
	`wr™ed©a16_Ï¡
(
cŞÜ
);

937 
	`’dSPIT¿n§ùiÚ
();

938 
	}
}

940 
	gHX8357_t3n
::
	$d¿wPix–
(
št16_t
 
x
, iÁ16_ˆ
y
, 
ušt16_t
 
cŞÜ
) {

941 
x
 +ğ
_Üigšx
;

942 
y
 +ğ
_Üigšy
;

943 ià((
x
 < 
_di¥Ïyşx1
è|| (x >ğ
_di¥Ïyşx2
è|| (
y
 < 
_di¥Ïyşy1
è|| (y >ğ
_di¥Ïyşy2
)) ;

945 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


946 ià(
_u£_fbtá
) {

947 
	`upd©eChªgedRªge
(
x
, 
y
);

948 
_pfbtá
[
y
 * 
_width
 + 
x
] = 
cŞÜ
;

953 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

954 
	`£tAddr
(
x
, 
y
, x, y);

955 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

956 
	`wr™ed©a16_Ï¡
(
cŞÜ
);

957 
	`’dSPIT¿n§ùiÚ
();

959 
	}
}

961 
	gHX8357_t3n
::
	$d¿wFa¡VLše
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
h
, 
ušt16_t
 
cŞÜ
) {

962 
x
 +ğ
_Üigšx
;

963 
y
 +ğ
_Üigšy
;

965 ià((
x
 < 
_di¥Ïyşx1
è|| (x >ğ
_di¥Ïyşx2
è|| (
y
 >ğ
_di¥Ïyşy2
)) ;

966 ià(
y
 < 
_di¥Ïyşy1
) {

967 
h
 = h - (
_di¥Ïyşy1
 - 
y
);

968 
y
 = 
_di¥Ïyşy1
;

970 ià((
y
 + 
h
 - 1è>ğ
_di¥Ïyşy2
) h = _displayclipy2 - y;

971 ià(
h
 < 1) ;

973 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


974 ià(
_u£_fbtá
) {

975 
	`upd©eChªgedRªge
(
x
, 
y
, 1, 
h
);

976 
ušt16_t
 *
pfbPix–
 = &
_pfbtá
[
y
 * 
_width
 + 
x
];

977 
h
--) {

978 *
pfbPix–
 = 
cŞÜ
;

979 
pfbPix–
 +ğ
_width
;

984 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

985 
	`£tAddr
(
x
, 
y
, x, y + 
h
 - 1);

986 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

987 
h
-- > 1) {

988 
	`wr™ed©a16_cÚt
(
cŞÜ
);

990 
	`wr™ed©a16_Ï¡
(
cŞÜ
);

991 
	`’dSPIT¿n§ùiÚ
();

993 
	}
}

995 
	gHX8357_t3n
::
	$d¿wFa¡HLše
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, 
ušt16_t
 
cŞÜ
) {

996 
x
 +ğ
_Üigšx
;

997 
y
 +ğ
_Üigšy
;

1000 ià((
y
 < 
_di¥Ïyşy1
è|| (
x
 >ğ
_di¥Ïyşx2
è|| (y >ğ
_di¥Ïyşy2
)) ;

1001 ià(
x
 < 
_di¥Ïyşx1
) {

1002 
w
 = w - (
_di¥Ïyşx1
 - 
x
);

1003 
x
 = 
_di¥Ïyşx1
;

1005 ià((
x
 + 
w
 - 1è>ğ
_di¥Ïyşx2
) w = _displayclipx2 - x;

1006 ià(
w
 < 1) ;

1008 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


1009 ià(
_u£_fbtá
) {

1010 
	`upd©eChªgedRªge
(
x
, 
y
, 
w
, 1);

1011 ià((
x
 & 1è|| (
w
 & 1)) {

1012 
ušt16_t
 *
pfbPix–
 = &
_pfbtá
[
y
 * 
_width
 + 
x
];

1013 
w
--) {

1014 *
pfbPix–
++ = 
cŞÜ
;

1018 
ušt32_t
 
cŞÜ32
 = (
cŞÜ
 << 16) | color;

1019 
ušt32_t
 *
pfbPix–
 = (ušt32_ˆ*)((
ušt16_t
 *)&
_pfbtá
[
y
 * 
_width
 + 
x
]);

1020 
w
) {

1021 *
pfbPix–
++ = 
cŞÜ32
;

1022 
w
 -= 2;

1028 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

1029 
	`£tAddr
(
x
, 
y
, x + 
w
 - 1, y);

1030 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

1031 
w
-- > 1) {

1032 
	`wr™ed©a16_cÚt
(
cŞÜ
);

1034 
	`wr™ed©a16_Ï¡
(
cŞÜ
);

1035 
	`’dSPIT¿n§ùiÚ
();

1037 
	}
}

1039 
	gHX8357_t3n
::
	$flSü“n
(
ušt16_t
 
cŞÜ
) {

1040 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


1041 ià(
_u£_fbtá
 && 
_¡ªd¬d
) {

1043 
	`upd©eChªgedRªge
(0, 0, 
_width
, 
_height
);

1044 
ušt32_t
 
cŞÜ32
 = (
cŞÜ
 << 16) | color;

1046 
ušt32_t
 *
pfbPix–
 = (ušt32_ˆ*)
_pfbtá
;

1047 
ušt32_t
 *
pfbtá_’d
 = (ušt32_ˆ*)((
ušt16_t
 *)&
_pfbtá
[(
HX8357_TFTWIDTH
 * 
HX8357_TFTHEIGHT
)]);

1048 
pfbPix–
 < 
pfbtá_’d
) {

1049 *
pfbPix–
++ = 
cŞÜ32
;

1050 *
pfbPix–
++ = 
cŞÜ32
;

1051 *
pfbPix–
++ = 
cŞÜ32
;

1052 *
pfbPix–
++ = 
cŞÜ32
;

1053 *
pfbPix–
++ = 
cŞÜ32
;

1054 *
pfbPix–
++ = 
cŞÜ32
;

1055 *
pfbPix–
++ = 
cŞÜ32
;

1056 *
pfbPix–
++ = 
cŞÜ32
;

1057 *
pfbPix–
++ = 
cŞÜ32
;

1058 *
pfbPix–
++ = 
cŞÜ32
;

1059 *
pfbPix–
++ = 
cŞÜ32
;

1060 *
pfbPix–
++ = 
cŞÜ32
;

1061 *
pfbPix–
++ = 
cŞÜ32
;

1062 *
pfbPix–
++ = 
cŞÜ32
;

1063 *
pfbPix–
++ = 
cŞÜ32
;

1064 *
pfbPix–
++ = 
cŞÜ32
;

1065 *
pfbPix–
++ = 
cŞÜ32
;

1066 *
pfbPix–
++ = 
cŞÜ32
;

1067 *
pfbPix–
++ = 
cŞÜ32
;

1068 *
pfbPix–
++ = 
cŞÜ32
;

1069 *
pfbPix–
++ = 
cŞÜ32
;

1070 *
pfbPix–
++ = 
cŞÜ32
;

1071 *
pfbPix–
++ = 
cŞÜ32
;

1072 *
pfbPix–
++ = 
cŞÜ32
;

1073 *
pfbPix–
++ = 
cŞÜ32
;

1074 *
pfbPix–
++ = 
cŞÜ32
;

1075 *
pfbPix–
++ = 
cŞÜ32
;

1076 *
pfbPix–
++ = 
cŞÜ32
;

1077 *
pfbPix–
++ = 
cŞÜ32
;

1078 *
pfbPix–
++ = 
cŞÜ32
;

1079 *
pfbPix–
++ = 
cŞÜ32
;

1080 *
pfbPix–
++ = 
cŞÜ32
;

1086 
	`flReù
(0, 0, 
_width
, 
_height
, 
cŞÜ
);

1088 
	}
}

1091 
	gHX8357_t3n
::
	$flReù
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, 
ušt16_t
 
cŞÜ
) {

1092 
x
 +ğ
_Üigšx
;

1093 
y
 +ğ
_Üigšy
;

1096 ià((
x
 >ğ
_di¥Ïyşx2
è|| (
y
 >ğ
_di¥Ïyşy2
)) ;

1097 ià(((
x
 + 
w
è<ğ
_di¥Ïyşx1
è|| ((
y
 + 
h
è<ğ
_di¥Ïyşy1
)) ;

1098 ià(
x
 < 
_di¥Ïyşx1
) {

1099 
w
 -ğ(
_di¥Ïyşx1
 - 
x
);

1100 
x
 = 
_di¥Ïyşx1
;

1102 ià(
y
 < 
_di¥Ïyşy1
) {

1103 
h
 -ğ(
_di¥Ïyşy1
 - 
y
);

1104 
y
 = 
_di¥Ïyşy1
;

1106 ià((
x
 + 
w
 - 1è>ğ
_di¥Ïyşx2
) w = _displayclipx2 - x;

1107 ià((
y
 + 
h
 - 1è>ğ
_di¥Ïyşy2
) h = _displayclipy2 - y;

1109 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


1110 ià(
_u£_fbtá
) {

1111 
	`upd©eChªgedRªge
(
x
, 
y
, 
w
, 
h
);

1112 ià((
x
 & 1è|| (
w
 & 1)) {

1113 
ušt16_t
 *
pfbPix–_row
 = &
_pfbtá
[
y
 * 
_width
 + 
x
];

1114 ; 
h
 > 0; h--) {

1115 
ušt16_t
 *
pfbPix–
 = 
pfbPix–_row
;

1116 
i
 = 0; i < 
w
; i++) {

1117 *
pfbPix–
++ = 
cŞÜ
;

1119 
pfbPix–_row
 +ğ
_width
;

1123 
ušt32_t
 
cŞÜ32
 = (
cŞÜ
 << 16) | color;

1124 
ušt32_t
 *
pfbPix–_row
 = (ušt32_ˆ*)((
ušt16_t
 *)&
_pfbtá
[
y
 * 
_width
 + 
x
]);

1125 
w
 = w / 2;

1126 ; 
h
 > 0; h--) {

1127 
ušt32_t
 *
pfbPix–
 = 
pfbPix–_row
;

1128 
i
 = 0; i < 
w
; i++) {

1129 *
pfbPix–
++ = 
cŞÜ32
;

1131 
pfbPix–_row
 +ğ(
_width
 / 2);

1141 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

1142 
	`£tAddr
(
x
, 
y
, x + 
w
 - 1, y + 
h
 - 1);

1143 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

1144 
y
 = 
h
; y > 0; y--) {

1145 
x
 = 
w
; x > 1; x--) {

1146 
	`wr™ed©a16_cÚt
(
cŞÜ
);

1148 
	`wr™ed©a16_Ï¡
(
cŞÜ
);

1150 ià(
y
 > 1 && (y & 1)) {

1151 
	`’dSPIT¿n§ùiÚ
();

1152 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

1156 
	`’dSPIT¿n§ùiÚ
();

1158 
	}
}

1161 
	gHX8357_t3n
::
	$flReùVG¿d›Á
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, 
ušt16_t
 
cŞÜ1
, ušt16_ˆ
cŞÜ2
) {

1162 
x
 +ğ
_Üigšx
;

1163 
y
 +ğ
_Üigšy
;

1166 ià((
x
 >ğ
_di¥Ïyşx2
è|| (
y
 >ğ
_di¥Ïyşy2
)) ;

1167 ià(
x
 < 
_di¥Ïyşx1
) {

1168 
w
 -ğ(
_di¥Ïyşx1
 - 
x
);

1169 
x
 = 
_di¥Ïyşx1
;

1171 ià(
y
 < 
_di¥Ïyşy1
) {

1172 
h
 -ğ(
_di¥Ïyşy1
 - 
y
);

1173 
y
 = 
_di¥Ïyşy1
;

1175 ià((
x
 + 
w
 - 1è>ğ
_di¥Ïyşx2
) w = _displayclipx2 - x;

1176 ià((
y
 + 
h
 - 1è>ğ
_di¥Ïyşy2
) h = _displayclipy2 - y;

1178 
št16_t
 
r1
, 
g1
, 
b1
, 
r2
, 
g2
, 
b2
, 
dr
, 
dg
, 
db
, 
r
, 
g
, 
b
;

1179 
	`cŞÜ565toRGB14
(
cŞÜ1
, 
r1
, 
g1
, 
b1
);

1180 
	`cŞÜ565toRGB14
(
cŞÜ2
, 
r2
, 
g2
, 
b2
);

1181 
dr
 = (
r2
 - 
r1
è/ 
h
;

1182 
dg
 = (
g2
 - 
g1
è/ 
h
;

1183 
db
 = (
b2
 - 
b1
è/ 
h
;

1184 
r
 = 
r1
;

1185 
g
 = 
g1
;

1186 
b
 = 
b1
;

1188 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


1189 ià(
_u£_fbtá
) {

1190 
	`upd©eChªgedRªge
(
x
, 
y
, 
w
, 
h
);

1191 ià((
x
 & 1è|| (
w
 & 1)) {

1192 
ušt16_t
 *
pfbPix–_row
 = &
_pfbtá
[
y
 * 
_width
 + 
x
];

1193 ; 
h
 > 0; h--) {

1194 
ušt16_t
 
cŞÜ
 = 
	`RGB14tocŞÜ565
(
r
, 
g
, 
b
);

1195 
ušt16_t
 *
pfbPix–
 = 
pfbPix–_row
;

1196 
i
 = 0; i < 
w
; i++) {

1197 *
pfbPix–
++ = 
cŞÜ
;

1199 
r
 +ğ
dr
;

1200 
g
 +ğ
dg
;

1201 
b
 +ğ
db
;

1202 
pfbPix–_row
 +ğ
_width
;

1206 
ušt32_t
 *
pfbPix–_row
 = (ušt32_ˆ*)((
ušt16_t
 *)&
_pfbtá
[
y
 * 
_width
 + 
x
]);

1207 
w
 = w / 2;

1208 ; 
h
 > 0; h--) {

1209 
ušt32_t
 *
pfbPix–
 = 
pfbPix–_row
;

1210 
ušt16_t
 
cŞÜ
 = 
	`RGB14tocŞÜ565
(
r
, 
g
, 
b
);

1211 
ušt32_t
 
cŞÜ32
 = (
cŞÜ
 << 16) | color;

1212 
i
 = 0; i < 
w
; i++) {

1213 *
pfbPix–
++ = 
cŞÜ32
;

1215 
pfbPix–_row
 +ğ(
_width
 / 2);

1216 
r
 +ğ
dr
;

1217 
g
 +ğ
dg
;

1218 
b
 +ğ
db
;

1224 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

1225 
	`£tAddr
(
x
, 
y
, x + 
w
 - 1, y + 
h
 - 1);

1226 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

1227 
y
 = 
h
; y > 0; y--) {

1228 
ušt16_t
 
cŞÜ
 = 
	`RGB14tocŞÜ565
(
r
, 
g
, 
b
);

1230 
x
 = 
w
; x > 1; x--) {

1231 
	`wr™ed©a16_cÚt
(
cŞÜ
);

1233 
	`wr™ed©a16_Ï¡
(
cŞÜ
);

1234 ià(
y
 > 1 && (y & 1)) {

1235 
	`’dSPIT¿n§ùiÚ
();

1236 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

1238 
r
 +ğ
dr
;

1239 
g
 +ğ
dg
;

1240 
b
 +ğ
db
;

1242 
	`’dSPIT¿n§ùiÚ
();

1244 
	}
}

1247 
	gHX8357_t3n
::
	$flReùHG¿d›Á
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, 
ušt16_t
 
cŞÜ1
, ušt16_ˆ
cŞÜ2
) {

1248 
x
 +ğ
_Üigšx
;

1249 
y
 +ğ
_Üigšy
;

1252 ià((
x
 >ğ
_di¥Ïyşx2
è|| (
y
 >ğ
_di¥Ïyşy2
)) ;

1253 ià(
x
 < 
_di¥Ïyşx1
) {

1254 
w
 -ğ(
_di¥Ïyşx1
 - 
x
);

1255 
x
 = 
_di¥Ïyşx1
;

1257 ià(
y
 < 
_di¥Ïyşy1
) {

1258 
h
 -ğ(
_di¥Ïyşy1
 - 
y
);

1259 
y
 = 
_di¥Ïyşy1
;

1261 ià((
x
 + 
w
 - 1è>ğ
_di¥Ïyşx2
) w = _displayclipx2 - x;

1262 ià((
y
 + 
h
 - 1è>ğ
_di¥Ïyşy2
) h = _displayclipy2 - y;

1264 
št16_t
 
r1
, 
g1
, 
b1
, 
r2
, 
g2
, 
b2
, 
dr
, 
dg
, 
db
, 
r
, 
g
, 
b
;

1265 
ušt16_t
 
cŞÜ
;

1266 
	`cŞÜ565toRGB14
(
cŞÜ1
, 
r1
, 
g1
, 
b1
);

1267 
	`cŞÜ565toRGB14
(
cŞÜ2
, 
r2
, 
g2
, 
b2
);

1268 
dr
 = (
r2
 - 
r1
è/ 
w
;

1269 
dg
 = (
g2
 - 
g1
è/ 
w
;

1270 
db
 = (
b2
 - 
b1
è/ 
w
;

1271 
r
 = 
r1
;

1272 
g
 = 
g1
;

1273 
b
 = 
b1
;

1274 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


1275 ià(
_u£_fbtá
) {

1276 
	`upd©eChªgedRªge
(
x
, 
y
, 
w
, 
h
);

1277 
ušt16_t
 *
pfbPix–_row
 = &
_pfbtá
[
y
 * 
_width
 + 
x
];

1278 ; 
h
 > 0; h--) {

1279 
ušt16_t
 *
pfbPix–
 = 
pfbPix–_row
;

1280 
i
 = 0; i < 
w
; i++) {

1281 *
pfbPix–
++ = 
	`RGB14tocŞÜ565
(
r
, 
g
, 
b
);

1282 
r
 +ğ
dr
;

1283 
g
 +ğ
dg
;

1284 
b
 +ğ
db
;

1286 
pfbPix–_row
 +ğ
_width
;

1287 
r
 = 
r1
;

1288 
g
 = 
g1
;

1289 
b
 = 
b1
;

1294 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

1295 
	`£tAddr
(
x
, 
y
, x + 
w
 - 1, y + 
h
 - 1);

1296 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

1297 
y
 = 
h
; y > 0; y--) {

1298 
x
 = 
w
; x > 1; x--) {

1299 
cŞÜ
 = 
	`RGB14tocŞÜ565
(
r
, 
g
, 
b
);

1300 
	`wr™ed©a16_cÚt
(
cŞÜ
);

1301 
r
 +ğ
dr
;

1302 
g
 +ğ
dg
;

1303 
b
 +ğ
db
;

1305 
cŞÜ
 = 
	`RGB14tocŞÜ565
(
r
, 
g
, 
b
);

1306 
	`wr™ed©a16_Ï¡
(
cŞÜ
);

1307 ià(
y
 > 1 && (y & 1)) {

1308 
	`’dSPIT¿n§ùiÚ
();

1309 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

1311 
r
 = 
r1
;

1312 
g
 = 
g1
;

1313 
b
 = 
b1
;

1315 
	`’dSPIT¿n§ùiÚ
();

1317 
	}
}

1320 
	gHX8357_t3n
::
	$flSü“nVG¿d›Á
(
ušt16_t
 
cŞÜ1
, ušt16_ˆ
cŞÜ2
) {

1321 
	`flReùVG¿d›Á
(0, 0, 
_width
, 
_height
, 
cŞÜ1
, 
cŞÜ2
);

1322 
	}
}

1325 
	gHX8357_t3n
::
	$flSü“nHG¿d›Á
(
ušt16_t
 
cŞÜ1
, ušt16_ˆ
cŞÜ2
) {

1326 
	`flReùHG¿d›Á
(0, 0, 
_width
, 
_height
, 
cŞÜ1
, 
cŞÜ2
);

1327 
	}
}

1329 
	#MADCTL_MY
 0x80

1330 
	#MADCTL_MX
 0x40

1331 
	#MADCTL_MV
 0x20

1332 
	#MADCTL_ML
 0x10

1333 
	#MADCTL_RGB
 0x00

1334 
	#MADCTL_BGR
 0x08

1335 
	#MADCTL_MH
 0x04

1336 

	)

1337 
	gHX8357_t3n
::
	$£tRÙ©iÚ
(
ušt8_t
 
m
) {

1338 
rÙ©iÚ
 = 
m
 & 3;

1339 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

1340 
	`wr™ecommªd_cÚt
(
HX8357_MADCTL
);

1341 
rÙ©iÚ
) {

1343 
	`wr™ed©a8_Ï¡
(
MADCTL_MX
 | 
MADCTL_MY
 | 
MADCTL_RGB
);

1344 
_width
 = 
HX8357_TFTWIDTH
;

1345 
_height
 = 
HX8357_TFTHEIGHT
;

1348 
	`wr™ed©a8_Ï¡
(
MADCTL_MV
 | 
MADCTL_MY
 | 
MADCTL_RGB
);

1349 
_width
 = 
HX8357_TFTHEIGHT
;

1350 
_height
 = 
HX8357_TFTWIDTH
;

1353 
	`wr™ed©a8_Ï¡
(
MADCTL_RGB
);

1354 
_width
 = 
HX8357_TFTWIDTH
;

1355 
_height
 = 
HX8357_TFTHEIGHT
;

1358 
	`wr™ed©a8_Ï¡
(
MADCTL_MX
 | 
MADCTL_MV
 | 
MADCTL_RGB
);

1359 
_width
 = 
HX8357_TFTHEIGHT
;

1360 
_height
 = 
HX8357_TFTWIDTH
;

1363 
	`’dSPIT¿n§ùiÚ
();

1364 
	`£tClReù
();

1365 
	`£tOrigš
();

1367 
cursÜ_x
 = 0;

1368 
cursÜ_y
 = 0;

1369 
	}
}

1371 
	gHX8357_t3n
::
	$£tSüŞl
(
ušt16_t
 
off£t
) {

1372 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

1373 
	`wr™ecommªd_cÚt
(
HX8357_VSCRSADD
);

1374 
	`wr™ed©a16_Ï¡
(
off£t
);

1375 
	`’dSPIT¿n§ùiÚ
();

1376 
	}
}

1378 
	gHX8357_t3n
::
	$šv”tDi¥Ïy
(
boŞ—n
 
i
) {

1379 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

1380 
	`wr™ecommªd_Ï¡
(
i
 ? 
HX8357_INVON
 : 
HX8357_INVOFF
);

1381 
	`’dSPIT¿n§ùiÚ
();

1382 
	}
}

1416 
ušt8_t
 
	gHX8357_t3n
::
	$»adcommªd8
(
ušt8_t
 
c
, ušt8_ˆ
šdex
) {

1418 ià(
_miso
 == 0xff)  0;

1420 #ifdeà
KINETISK


1421 
ušt16_t
 
wTimeout
 = 0xffff;

1422 
ušt8_t
 
r
 = 0;

1424 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

1425 ià(
_¥i_num
 == 0) {

1427 ((
_pkš‘isk_¥i
->
SR
è& (15 << 12)è&& (--
wTimeout
))

1431 
_pkš‘isk_¥i
->
SR
 = 
SPI_SR_TCF
;

1432 
wTimeout
 = 0xffff;

1433 !((
_pkš‘isk_¥i
->
SR
è& 
SPI_SR_TCF
è&& (--
wTimeout
))

1437 
wTimeout
 = 0x10;

1438 (((
_pkš‘isk_¥i
->
SR
è>> 4è& 0xfè&& (--
wTimeout
)) {

1439 
r
 = 
_pkš‘isk_¥i
->
POPR
;

1443 
_pkš‘isk_¥i
->
PUSHR
 = 0xD9 | (
pcs_commªd
 << 16è| 
	`SPI_PUSHR_CTAS
(0è| 
SPI_PUSHR_CONT
;

1447 
_pkš‘isk_¥i
->
PUSHR
 = (0x10 + 
šdex
è| (
pcs_d©a
 << 16è| 
	`SPI_PUSHR_CTAS
(0);

1450 
_pkš‘isk_¥i
->
PUSHR
 = 
c
 | (
pcs_commªd
 << 16è| 
	`SPI_PUSHR_CTAS
(0è| 
SPI_PUSHR_CONT
;

1454 
_pkš‘isk_¥i
->
PUSHR
 = 0 | (
pcs_d©a
 << 16è| 
	`SPI_PUSHR_CTAS
(0);

1458 
wTimeout
 = 0xffff;

1459 ((
_pkš‘isk_¥i
->
SR
è& (15 << 12)è&& (--
wTimeout
))

1463 
_pkš‘isk_¥i
->
SR
 = 
SPI_SR_TCF
;

1464 
wTimeout
 = 0xffff;

1465 !((
_pkš‘isk_¥i
->
SR
è& 
SPI_SR_TCF
è&& (--
wTimeout
))

1468 
wTimeout
 = 0x10;

1470 (((
_pkš‘isk_¥i
->
SR
è>> 4è& 0xfè&& (--
wTimeout
)) {

1471 
r
 = 
_pkš‘isk_¥i
->
POPR
;

1474 ((
_pkš‘isk_¥i
->
SR
è& (15 << 12)è&& (--
wTimeout
))

1478 
_pkš‘isk_¥i
->
SR
 = 
SPI_SR_TCF
;

1479 
wTimeout
 = 0xffff;

1480 !((
_pkš‘isk_¥i
->
SR
è& 
SPI_SR_TCF
è&& (--
wTimeout
))

1484 
wTimeout
 = 0x10;

1485 (((
_pkš‘isk_¥i
->
SR
è>> 4è& 0xfè&& (--
wTimeout
)) {

1486 
r
 = 
_pkš‘isk_¥i
->
POPR
;

1490 
_pkš‘isk_¥i
->
PUSHR
 = 0xD9 | (
pcs_commªd
 << 16è| 
	`SPI_PUSHR_CTAS
(0è| 
SPI_PUSHR_CONT
;

1491 ((
_pkš‘isk_¥i
->
SR
) & (15 << 12)) > (0 << 12))

1495 
_pkš‘isk_¥i
->
PUSHR
 = (0x10 + 
šdex
è| (
pcs_d©a
 << 16è| 
	`SPI_PUSHR_CTAS
(0);

1496 ((
_pkš‘isk_¥i
->
SR
) & (15 << 12)) > (0 << 12))

1500 ((
_pkš‘isk_¥i
->
SR
) >> 4) & 0xf) {

1501 
r
 = 
_pkš‘isk_¥i
->
POPR
;

1505 
_pkš‘isk_¥i
->
PUSHR
 = 
c
 | (
pcs_commªd
 << 16è| 
	`SPI_PUSHR_CTAS
(0è| 
SPI_PUSHR_CONT
;

1506 ((
_pkš‘isk_¥i
->
SR
) & (15 << 12)) > (0 << 12))

1510 ((
_pkš‘isk_¥i
->
SR
) >> 4) & 0xf) {

1511 
r
 = 
_pkš‘isk_¥i
->
POPR
;

1515 
_pkš‘isk_¥i
->
PUSHR
 = 0 | (
pcs_d©a
 << 16è| 
	`SPI_PUSHR_CTAS
(0);

1516 ((
_pkš‘isk_¥i
->
SR
) & (15 << 12)) > (0 << 12))

1520 ((
_pkš‘isk_¥i
->
SR
) >> 4) & 0xf) {

1521 
r
 = 
_pkš‘isk_¥i
->
POPR
;

1524 
wTimeout
 = 0xffff;

1525 ((
_pkš‘isk_¥i
->
SR
è& (15 << 12)è&& (--
wTimeout
))

1529 
_pkš‘isk_¥i
->
SR
 = 
SPI_SR_TCF
;

1530 
wTimeout
 = 0xffff;

1531 !((
_pkš‘isk_¥i
->
SR
è& 
SPI_SR_TCF
è&& (--
wTimeout
))

1534 
wTimeout
 = 0x10;

1536 (((
_pkš‘isk_¥i
->
SR
è>> 4è& 0xfè&& (--
wTimeout
)) {

1537 
r
 = 
_pkš‘isk_¥i
->
POPR
;

1540 
	`’dSPIT¿n§ùiÚ
();

1541  
r
;

1542 #–ià
	`defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

1543 
ušt16_t
 
wTimeout
 = 0xffff;

1544 
ušt8_t
 
r
 = 0;

1546 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK_READ
);

1548 
_pimx¹_¥i
->
CR
 = 
LPSPI_CR_MEN
 | 
LPSPI_CR_RRF
 ;

1550 
	`maybeUpd©eTCR
(
_tü_dc_as£¹
 | 
	`LPSPI_TCR_FRAMESZ
(7è| 
LPSPI_TCR_CONT
);

1551 
_pimx¹_¥i
->
TDR
 = 0xD9;

1554 
	`maybeUpd©eTCR
(
_tü_dc_nÙ_as£¹
 | 
	`LPSPI_TCR_FRAMESZ
(7è| 
LPSPI_TCR_CONT
);

1555 
_pimx¹_¥i
->
TDR
 = 0x10 + 
šdex
;

1558 
	`maybeUpd©eTCR
(
_tü_dc_as£¹
 | 
	`LPSPI_TCR_FRAMESZ
(7è| 
LPSPI_TCR_CONT
);

1559 
_pimx¹_¥i
->
TDR
 = 
c
;

1562 
	`maybeUpd©eTCR
(
_tü_dc_nÙ_as£¹
 | 
	`LPSPI_TCR_FRAMESZ
(7));

1563 
_pimx¹_¥i
->
TDR
 = 0;

1566 
wTimeout
 = 0xffff;

1567 
ušt8_t
 
rx_couÁ
 = 4;

1568 
rx_couÁ
 && 
wTimeout
) {

1569 ià((
_pimx¹_¥i
->
RSR
 & 
LPSPI_RSR_RXEMPTY
) == 0) {

1570 
r
 = 
_pimx¹_¥i
->
RDR
;

1571 
rx_couÁ
--;

1574 
	`’dSPIT¿n§ùiÚ
();

1575  
r
;

1577 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

1578 
	`wr™ecommªd_cÚt
(0xD9);

1579 
	`wr™ed©a8_cÚt
(0x10 + 
šdex
);

1581 
	`wr™ecommªd_cÚt
(
c
);

1582 
	`wr™ed©a8_cÚt
(0);

1583 
ušt8_t
 
r
 = 
	`wa™T¿nsm™Com¶‘eR‘uºLa¡
();

1584 
	`’dSPIT¿n§ùiÚ
();

1585  
r
;

1588 
	}
}

1591 
	#READ_PIXEL_PUSH_BYTE
 0x3f

	)

1592 
ušt16_t
 
	gHX8357_t3n
::
	$»adPix–
(
št16_t
 
x
, iÁ16_ˆ
y
) {

1593 #ifdeà
KINETISK


1596 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


1597 ià(
_u£_fbtá
) {

1598 
x
 +ğ
_Üigšx
;

1599 
y
 +ğ
_Üigšy
;

1601  
_pfbtá
[
y
 * 
_width
 + 
x
];

1605 ià(
_miso
 == 0xff)  0xffff;

1608 ià(
_¥i_num
 != 0) {

1610 
ušt16_t
 
cŞÜs
;

1611 
	`»adReù
(
x
, 
y
, 1, 1, &
cŞÜs
);

1612  
cŞÜs
;

1615 
ušt8_t
 
dummy
 
	`__©Œibu‹__
((
unu£d
));

1616 
ušt8_t
 
r
, 
g
, 
b
;

1618 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK_READ
);

1621 
x
 +ğ
_Üigšx
;

1622 
y
 +ğ
_Üigšy
;

1624 
	`£tAddr
(
x
, 
y
, x, y);

1625 
	`wr™ecommªd_cÚt
(
HX8357_RAMRD
);

1626 
	`wa™T¿nsm™Com¶‘e
();

1629 
_pkš‘isk_¥i
->
PUSHR
 = 0 | (
pcs_d©a
 << 16è| 
	`SPI_PUSHR_CTAS
(0è| 
SPI_PUSHR_CONT
;

1630 
	`wa™FifoEm±y
();

1632 
_pkš‘isk_¥i
->
PUSHR
 = 0 | (
pcs_d©a
 << 16è| 
	`SPI_PUSHR_CTAS
(0è| 
SPI_PUSHR_CONT
;

1633 
_pkš‘isk_¥i
->
PUSHR
 = 0 | (
pcs_d©a
 << 16è| 
	`SPI_PUSHR_CTAS
(0è| 
SPI_PUSHR_CONT
;

1634 
_pkš‘isk_¥i
->
PUSHR
 = 0 | (
pcs_d©a
 << 16è| 
	`SPI_PUSHR_CTAS
(0è| 
SPI_PUSHR_EOQ
;

1637 (
_pkš‘isk_¥i
->
SR
 & 
SPI_SR_EOQF
) == 0)

1639 
_pkš‘isk_¥i
->
SR
 = 
SPI_SR_EOQF
;

1642 
dummy
 = 
_pkš‘isk_¥i
->
POPR
;

1643 
r
 = 
_pkš‘isk_¥i
->
POPR
;

1644 
g
 = 
_pkš‘isk_¥i
->
POPR
;

1645 
b
 = 
_pkš‘isk_¥i
->
POPR
;

1647 
	`’dSPIT¿n§ùiÚ
();

1648  
	`cŞÜ565
(
r
, 
g
, 
b
);

1651 
ušt16_t
 
cŞÜs
 = 0;

1652 
	`»adReù
(
x
, 
y
, 1, 1, &
cŞÜs
);

1653  
cŞÜs
;

1655 
	}
}

1658 #ifdeà
KINETISK


1659 
	gHX8357_t3n
::
	$»adReù
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, 
ušt16_t
 *
pcŞÜs
) {

1661 
x
 +ğ
_Üigšx
;

1662 
y
 +ğ
_Üigšy
;

1665 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


1666 ià(
_u£_fbtá
) {

1667 
ušt16_t
 *
pfbPix–_row
 = &
_pfbtá
[
y
 * 
_width
 + 
x
];

1668 ; 
h
 > 0; h--) {

1669 
ušt16_t
 *
pfbPix–
 = 
pfbPix–_row
;

1670 
i
 = 0; i < 
w
; i++) {

1671 *
pcŞÜs
++ = *
pfbPix–
++;

1673 
pfbPix–_row
 +ğ
_width
;

1679 ià(
_miso
 == 0xff) ;

1681 
ušt8_t
 
rgb
[3];

1682 
ušt8_t
 
rgbIdx
 = 0;

1683 
ušt32_t
 
txCouÁ
 = 
w
 * 
h
 * 3;

1684 
ušt32_t
 
rxCouÁ
 = 
txCouÁ
;

1686 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK_READ
);

1688 
	`£tAddr
(
x
, 
y
, x + 
w
 - 1, y + 
h
 - 1);

1689 
	`wr™ecommªd_cÚt
(
HX8357_RAMRD
);

1692 
_pkš‘isk_¥i
->
PUSHR
 = 0 | (
pcs_d©a
 << 16è| 
	`SPI_PUSHR_CTAS
(0è| 
SPI_PUSHR_CONT
;

1695 
ušt32_t
 
¤
 = 
_pkš‘isk_¥i
->
SR
;

1696 
ušt8_t
 
skCouÁ
 = ((
¤
 >> 4) & 0xF) + ((sr >> 12) & 0xF) + 1;

1698 
txCouÁ
 || 
rxCouÁ
) {

1700 ià(
txCouÁ
 && (
_pkš‘isk_¥i
->
SR
 & 0xF000è<ğ
_fifo_fuÎ_‹¡
) {

1701 
txCouÁ
--;

1702 ià(
txCouÁ
) {

1703 
_pkš‘isk_¥i
->
PUSHR
 = 
READ_PIXEL_PUSH_BYTE
 | (
pcs_d©a
 << 16è| 
	`SPI_PUSHR_CTAS
(0è| 
SPI_PUSHR_CONT
;

1705 
_pkš‘isk_¥i
->
PUSHR
 = 
READ_PIXEL_PUSH_BYTE
 | (
pcs_d©a
 << 16è| 
	`SPI_PUSHR_CTAS
(0è| 
SPI_PUSHR_EOQ
;

1710 ià(
rxCouÁ
 && (
_pkš‘isk_¥i
->
SR
 & 0xF0)) {

1711 
rgb
[
rgbIdx
] = 
_pkš‘isk_¥i
->
POPR
;

1713 ià(
skCouÁ
) {

1714 
skCouÁ
--;

1716 
rxCouÁ
--;

1717 
rgbIdx
++;

1718 ià(
rgbIdx
 == 3) {

1719 
rgbIdx
 = 0;

1720 *
pcŞÜs
++ = 
	`cŞÜ565
(
rgb
[0],„gb[1],„gb[2]);

1727 (
_pkš‘isk_¥i
->
SR
 & 
SPI_SR_EOQF
) == 0)

1729 
_pkš‘isk_¥i
->
SR
 = 
SPI_SR_EOQF
;

1730 
	`’dSPIT¿n§ùiÚ
();

1731 
	}
}

1732 #–ià
defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

1733 
	gHX8357_t3n
::
	$»adReù
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, 
ušt16_t
 *
pcŞÜs
) {

1735 
x
 +ğ
_Üigšx
;

1736 
y
 +ğ
_Üigšy
;

1739 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


1740 ià(
_u£_fbtá
) {

1741 
ušt16_t
 *
pfbPix–_row
 = &
_pfbtá
[
y
 * 
_width
 + 
x
];

1742 ; 
h
 > 0; h--) {

1743 
ušt16_t
 *
pfbPix–
 = 
pfbPix–_row
;

1744 
i
 = 0; i < 
w
; i++) {

1745 *
pcŞÜs
++ = *
pfbPix–
++;

1747 
pfbPix–_row
 +ğ
_width
;

1753 ià(
_miso
 == 0xff) ;

1755 
ušt8_t
 
rgb
[3];

1756 
ušt8_t
 
rgbIdx
 = 0;

1757 
ušt32_t
 
txCouÁ
 = 
w
 * 
h
 * 3;

1758 
ušt32_t
 
rxCouÁ
 = 
txCouÁ
;

1760 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK_READ
);

1762 
	`£tAddr
(
x
, 
y
, x + 
w
 - 1, y + 
h
 - 1);

1763 
	`wr™ecommªd_cÚt
(
HX8357_RAMRD
);

1767 
	`wr™ed©a8_Ï¡
(0);

1769 
txCouÁ
 || 
rxCouÁ
) {

1771 ià(
txCouÁ
 && (
_pimx¹_¥i
->
SR
 & 
LPSPI_SR_TDF
)) {

1772 
txCouÁ
--;

1773 ià(
txCouÁ
) {

1774 
_pimx¹_¥i
->
TDR
 = 0;

1776 
	`maybeUpd©eTCR
(
_tü_dc_nÙ_as£¹
 | 
	`LPSPI_TCR_FRAMESZ
(7));

1777 (
_pimx¹_¥i
->
SR
 & 
LPSPI_SR_TDF
) == 0)

1779 
_pimx¹_¥i
->
TDR
 = 0;

1784 ià(
rxCouÁ
 && !(
_pimx¹_¥i
->
RSR
 & 
LPSPI_RSR_RXEMPTY
)) {

1785 
rgb
[
rgbIdx
] = 
_pimx¹_¥i
->
RDR
;

1787 
rxCouÁ
--;

1788 
rgbIdx
++;

1789 ià(
rgbIdx
 == 3) {

1790 
rgbIdx
 = 0;

1791 *
pcŞÜs
++ = 
	`cŞÜ565
(
rgb
[0],„gb[1],„gb[2]);

1797 
	`’dSPIT¿n§ùiÚ
();

1798 
	}
}

1803 
	gHX8357_t3n
::
	$»adReù
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, 
ušt16_t
 *
pcŞÜs
) {

1805 
x
 +ğ
_Üigšx
;

1806 
y
 +ğ
_Üigšy
;

1809 ià(
_miso
 == 0xff) ;

1811 
ušt8_t
 
rgb
[3];

1812 
ušt8_t
 
rgbIdx
 = 0;

1813 
ušt32_t
 
txCouÁ
 = 
w
 * 
h
 * 3;

1814 
ušt32_t
 
rxCouÁ
 = 
txCouÁ
;

1816 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK_READ
);

1818 
	`£tAddr
(
x
, 
y
, x + 
w
 - 1, y + 
h
 - 1);

1819 
	`wr™ecommªd_cÚt
(
HX8357_RAMRD
);

1822 
	`wr™ed©a8_cÚt
(0);

1825 
	`wa™T¿nsm™Com¶‘e
();

1828 
	#RRECT_TIMEOUT
 0xffff

	)

1829 #undeà
READ_PIXEL_PUSH_BYTE


1830 
	#READ_PIXEL_PUSH_BYTE
 0

1831 
ušt16_t
 
timeout_couÁdown
 = 
RRECT_TIMEOUT
;

	)

1832 
ušt16_t
 
dl_š
;

1835 !(
_pkš‘i¦_¥i
->
S
 & 
SPI_S_SPTEF
))

1837 
_pkš‘i¦_¥i
->
DL
 = 
READ_PIXEL_PUSH_BYTE
;

1839 
rxCouÁ
 && 
timeout_couÁdown
) {

1841 
dl_š
 = 0xffff;

1842 ià(
rxCouÁ
 > 1) {

1843 !(
_pkš‘i¦_¥i
->
S
 & 
SPI_S_SPTEF
))

1845 ià(
_pkš‘i¦_¥i
->
S
 & 
SPI_S_SPRF
)

1846 
dl_š
 = 
_pkš‘i¦_¥i
->
DL
;

1847 
_pkš‘i¦_¥i
->
DL
 = 
READ_PIXEL_PUSH_BYTE
;

1851 (
dl_š
 !ğ0xffffè&& !(
_pkš‘i¦_¥i
->
S
 & 
SPI_S_SPRF
è&& --
timeout_couÁdown
)

1853 ià(
timeout_couÁdown
) {

1854 
rxCouÁ
--;

1855 
rgb
[
rgbIdx
] = (
dl_š
 !ğ0xffffè? dl_š : 
_pkš‘i¦_¥i
->
DL
;

1856 
rgbIdx
++;

1857 ià(
rgbIdx
 == 3) {

1858 
rgbIdx
 = 0;

1859 *
pcŞÜs
++ = 
	`cŞÜ565
(
rgb
[0],„gb[1],„gb[2]);

1861 
timeout_couÁdown
 =imeout_countdown;

1870 
	`’dSPIT¿n§ùiÚ
();

1871 
	}
}

1875 
	gHX8357_t3n
::
	$wr™eReù
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, cÚ¡ 
ušt16_t
 *
pcŞÜs
) {

1877 ià(
x
 =ğ
CENTER
èx = (
_width
 - 
w
) / 2;

1878 ià(
y
 =ğ
CENTER
èy = (
_height
 - 
h
) / 2;

1879 
x
 +ğ
_Üigšx
;

1880 
y
 +ğ
_Üigšy
;

1881 
ušt16_t
 
x_ş_Ëá
 = 0;

1882 
ušt16_t
 
x_ş_right
 = 0;

1886 ià((
x
 >ğ
_di¥Ïyşx2
è|| (
y
 >ğ
_di¥Ïyşy2
)) ;

1887 ià(((
x
 + 
w
è<ğ
_di¥Ïyşx1
è|| ((
y
 + 
h
è<ğ
_di¥Ïyşy1
)) ;

1892 ià(
y
 < 
_di¥Ïyşy1
) {

1893 
dy
 = (
_di¥Ïyşy1
 - 
y
);

1894 
h
 -ğ
dy
;

1895 
pcŞÜs
 +ğ(
dy
 * 
w
);

1896 
y
 = 
_di¥Ïyşy1
;

1899 ià((
y
 + 
h
 - 1è>ğ
_di¥Ïyşy2
) h = _displayclipy2 - y;

1902 ià(
x
 < 
_di¥Ïyşx1
) {

1903 
x_ş_Ëá
 = 
_di¥Ïyşx1
 - 
x
;

1904 
w
 -ğ
x_ş_Ëá
;

1905 
x
 = 
_di¥Ïyşx1
;

1907 ià((
x
 + 
w
 - 1è>ğ
_di¥Ïyşx2
) {

1908 
x_ş_right
 = 
w
;

1909 
w
 = 
_di¥Ïyşx2
 - 
x
;

1910 
x_ş_right
 -ğ
w
;

1913 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


1914 ià(
_u£_fbtá
) {

1915 
	`upd©eChªgedRªge
(
x
, 
y
, 
w
, 
h
);

1916 
ušt16_t
 *
pfbPix–_row
 = &
_pfbtá
[
y
 * 
_width
 + 
x
];

1917 ; 
h
 > 0; h--) {

1918 
ušt16_t
 *
pfbPix–
 = 
pfbPix–_row
;

1919 
pcŞÜs
 +ğ
x_ş_Ëá
;

1920 
i
 = 0; i < 
w
; i++) {

1921 *
pfbPix–
++ = *
pcŞÜs
++;

1923 
pfbPix–_row
 +ğ
_width
;

1924 
pcŞÜs
 +ğ
x_ş_right
;

1930 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

1931 
	`£tAddr
(
x
, 
y
, x + 
w
 - 1, y + 
h
 - 1);

1932 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

1933 
y
 = 
h
; y > 0; y--) {

1934 
pcŞÜs
 +ğ
x_ş_Ëá
;

1935 
x
 = 
w
; x > 1; x--) {

1936 
	`wr™ed©a16_cÚt
(*
pcŞÜs
++);

1938 
	`wr™ed©a16_Ï¡
(*
pcŞÜs
++);

1939 
pcŞÜs
 +ğ
x_ş_right
;

1941 
	`’dSPIT¿n§ùiÚ
();

1942 
	}
}

1947 
	gHX8357_t3n
::
	$wr™eReù8BPP
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, cÚ¡ 
ušt8_t
 *
pix–s
, cÚ¡ 
ušt16_t
 *
·Ë‰e
) {

1949 
x
 +ğ
_Üigšx
;

1950 
y
 +ğ
_Üigšy
;

1952 
ušt16_t
 
x_ş_Ëá
 = 0;

1953 
ušt16_t
 
x_ş_right
 = 0;

1957 ià((
x
 >ğ
_di¥Ïyşx2
è|| (
y
 >ğ
_di¥Ïyşy2
)) ;

1958 ià(((
x
 + 
w
è<ğ
_di¥Ïyşx1
è|| ((
y
 + 
h
è<ğ
_di¥Ïyşy1
)) ;

1963 ià(
y
 < 
_di¥Ïyşy1
) {

1964 
dy
 = (
_di¥Ïyşy1
 - 
y
);

1965 
h
 -ğ
dy
;

1966 
pix–s
 +ğ(
dy
 * 
w
);

1967 
y
 = 
_di¥Ïyşy1
;

1970 ià((
y
 + 
h
 - 1è>ğ
_di¥Ïyşy2
) h = _displayclipy2 - y;

1973 ià(
x
 < 
_di¥Ïyşx1
) {

1974 
x_ş_Ëá
 = 
_di¥Ïyşx1
 - 
x
;

1975 
w
 -ğ
x_ş_Ëá
;

1976 
x
 = 
_di¥Ïyşx1
;

1978 ià((
x
 + 
w
 - 1è>ğ
_di¥Ïyşx2
) {

1979 
x_ş_right
 = 
w
;

1980 
w
 = 
_di¥Ïyşx2
 - 
x
;

1981 
x_ş_right
 -ğ
w
;

1984 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


1985 ià(
_u£_fbtá
) {

1986 
	`upd©eChªgedRªge
(
x
, 
y
, 
w
, 
h
);

1987 
ušt16_t
 *
pfbPix–_row
 = &
_pfbtá
[
y
 * 
_width
 + 
x
];

1988 ; 
h
 > 0; h--) {

1989 
pix–s
 +ğ
x_ş_Ëá
;

1990 
ušt16_t
 *
pfbPix–
 = 
pfbPix–_row
;

1991 
i
 = 0; i < 
w
; i++) {

1992 *
pfbPix–
++ = 
·Ë‰e
[*
pix–s
++];

1994 
pix–s
 +ğ
x_ş_right
;

1995 
pfbPix–_row
 +ğ
_width
;

2001 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

2002 
	`£tAddr
(
x
, 
y
, x + 
w
 - 1, y + 
h
 - 1);

2003 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

2004 
y
 = 
h
; y > 0; y--) {

2005 
pix–s
 +ğ
x_ş_Ëá
;

2007 
x
 = 
w
; x > 1; x--) {

2009 
	`wr™ed©a16_cÚt
(
·Ë‰e
[*
pix–s
++]);

2012 
	`wr™ed©a16_Ï¡
(
·Ë‰e
[*
pix–s
++]);

2013 
pix–s
 +ğ
x_ş_right
;

2015 
	`’dSPIT¿n§ùiÚ
();

2016 
	}
}

2022 
	gHX8357_t3n
::
	$wr™eReù4BPP
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, cÚ¡ 
ušt8_t
 *
pix–s
, cÚ¡ 
ušt16_t
 *
·Ë‰e
) {

2024 
	`wr™eReùNBPP
(
x
, 
y
, 
w
, 
h
, 4, 
pix–s
, 
·Ë‰e
);

2025 
	}
}

2031 
	gHX8357_t3n
::
	$wr™eReù2BPP
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, cÚ¡ 
ušt8_t
 *
pix–s
, cÚ¡ 
ušt16_t
 *
·Ë‰e
) {

2033 
	`wr™eReùNBPP
(
x
, 
y
, 
w
, 
h
, 2, 
pix–s
, 
·Ë‰e
);

2034 
	}
}

2041 
	gHX8357_t3n
::
	$wr™eReù1BPP
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, cÚ¡ 
ušt8_t
 *
pix–s
, cÚ¡ 
ušt16_t
 *
·Ë‰e
) {

2043 
	`wr™eReùNBPP
(
x
, 
y
, 
w
, 
h
, 1, 
pix–s
, 
·Ë‰e
);

2044 
	}
}

2052 
	gHX8357_t3n
::
	$wr™eReùNBPP
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, 
ušt8_t
 
b™s_³r_pix–
,

2053 cÚ¡ 
ušt8_t
 *
pix–s
, cÚ¡ 
ušt16_t
 *
·Ë‰e
) {

2055 
x
 +ğ
_Üigšx
;

2056 
y
 +ğ
_Üigšy
;

2057 
ušt8_t
 
pix–s_³r_by‹
 = 8 / 
b™s_³r_pix–
;

2058 
ušt16_t
 
couÁ_of_by‹s_³r_row
 = (
w
 + 
pix–s_³r_by‹
 - 1) /…ixels_per_byte;

2059 
ušt8_t
 
row_shiá_š™
 = 8 - 
b™s_³r_pix–
;

2060 
ušt8_t
 
pix–_b™_mask
 = (1 << 
b™s_³r_pix–
) - 1;

2064 ià((
x
 >ğ
_di¥Ïyşx2
è|| (
y
 >ğ
_di¥Ïyşy2
)) ;

2065 ià(((
x
 + 
w
è<ğ
_di¥Ïyşx1
è|| ((
y
 + 
h
è<ğ
_di¥Ïyşy1
)) ;

2071 ià(
y
 < 
_di¥Ïyşy1
) {

2072 
dy
 = (
_di¥Ïyşy1
 - 
y
);

2073 
h
 -ğ
dy
;

2074 
pix–s
 +ğ
dy
 * 
couÁ_of_by‹s_³r_row
;

2075 
y
 = 
_di¥Ïyşy1
;

2078 ià((
y
 + 
h
 - 1è>ğ
_di¥Ïyşy2
) h = _displayclipy2 - y;

2081 ià(
x
 < 
_di¥Ïyşx1
) {

2082 
ušt16_t
 
x_ş_Ëá
 = 
_di¥Ïyşx1
 - 
x
;

2083 
w
 -ğ
x_ş_Ëá
;

2084 
x
 = 
_di¥Ïyşx1
;

2086 
ušt8_t
 
x_ş_Ëá_by‹s_šü
 = 
x_ş_Ëá
 / 
pix–s_³r_by‹
;

2087 
pix–s
 +ğ
x_ş_Ëá_by‹s_šü
;

2088 
row_shiá_š™
 = 8 - (
x_ş_Ëá
 - (
x_ş_Ëá_by‹s_šü
 * 
pix–s_³r_by‹
è+ 1è* 
b™s_³r_pix–
;

2091 ià((
x
 + 
w
 - 1è>ğ
_di¥Ïyşx2
) {

2092 
w
 = 
_di¥Ïyşx2
 - 
x
;

2095 cÚ¡ 
ušt8_t
 *
pix–s_row_¡¬t
 = 
pix–s
;

2097 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


2098 ià(
_u£_fbtá
) {

2099 
	`upd©eChªgedRªge
(
x
, 
y
, 
w
, 
h
);

2100 
ušt16_t
 *
pfbPix–_row
 = &
_pfbtá
[
y
 * 
_width
 + 
x
];

2101 ; 
h
 > 0; h--) {

2102 
ušt16_t
 *
pfbPix–
 = 
pfbPix–_row
;

2103 
pix–s
 = 
pix–s_row_¡¬t
;

2104 
ušt8_t
 
pix–_shiá
 = 
row_shiá_š™
;

2106 
i
 = 0; i < 
w
; i++) {

2107 *
pfbPix–
++ = 
·Ë‰e
[((*
pix–s
è>> 
pix–_shiá
è& 
pix–_b™_mask
];

2108 ià(!
pix–_shiá
) {

2109 
pix–_shiá
 = 8 - 
b™s_³r_pix–
;

2110 
pix–s
++;

2112 
pix–_shiá
 -ğ
b™s_³r_pix–
;

2115 
pfbPix–_row
 +ğ
_width
;

2116 
pix–s_row_¡¬t
 +ğ
couÁ_of_by‹s_³r_row
;

2122 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

2123 
	`£tAddr
(
x
, 
y
, x + 
w
 - 1, y + 
h
 - 1);

2124 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

2125 ; 
h
 > 0; h--) {

2126 
pix–s
 = 
pix–s_row_¡¬t
;

2127 
ušt8_t
 
pix–_shiá
 = 
row_shiá_š™
;

2129 
i
 = 0; i < 
w
; i++) {

2130 
	`wr™ed©a16_cÚt
(
·Ë‰e
[((*
pix–s
è>> 
pix–_shiá
è& 
pix–_b™_mask
]);

2131 ià(!
pix–_shiá
) {

2132 
pix–_shiá
 = 8 - 
b™s_³r_pix–
;

2133 
pix–s
++;

2135 
pix–_shiá
 -ğ
b™s_³r_pix–
;

2138 
pix–s_row_¡¬t
 +ğ
couÁ_of_by‹s_³r_row
;

2140 
	`wr™ecommªd_Ï¡
(
HX8357_NOP
);

2141 
	`’dSPIT¿n§ùiÚ
();

2142 
	}
}

2144 cÚ¡ 
ušt8_t
 
	gš™_commªds
[] = {

2145 1, 
HX8357_SWRESET
,

2147 4, 
HX8357D_SETC
, 0xFF, 0x83, 0x57,

2149 5, 
HX8357_SETRGB
, 0x80, 0x00, 0X06, 0X06,

2150 2, 
HX8357D_SETCOM
, 0x25,

2151 2, 
HX8357_SETOSC
, 0x68,

2152 2, 
HX8357_SETPANEL
, 0x05,

2153 7, 
HX8357_SETPWR1
, 0x00, 0x15, 0x1C, 0x1C, 0x83, 0xAA,

2154 7, 
HX8357D_SETSTBA
, 0x50, 0x50, 0x01, 0x3C, 0x1E, 0x08,

2155 8, 
HX8357D_SETCYC
, 0x02, 0x40, 0x00, 0x2A, 0x2A, 0x0D, 0x78,

2156 35, 
HX8357D_SETGAMMA
, 0x02, 0x0A, 0x11, 0x1d, 0x23, 0x35, 0x41,

2161 2, 
HX8357_COLMOD
, 0x55,

2162 2, 
HX8357_MADCTL
, 0xC0,

2163 2, 
HX8357_TEON
, 0x00,

2164 3, 
HX8357_TEARLINE
, 0x00, 0x02,

2165 1, 
HX8357_SLPOUT
,

2167 1, 
HX8357_DISPON
,

2173 
	gHX8357_t3n
::
	$begš
(
ušt32_t
 
¥i_şock
, ušt32_ˆ
¥i_şock_»ad
) {

2176 
_SPI_CLOCK
 = 
¥i_şock
;

2177 
_SPI_CLOCK_READ
 = 
¥i_şock_»ad
;

2182 ià(
SPI
.
	`pšIsMOSI
(
_mosi
è&& ((
_miso
 =ğ0xffè|| SPI.
	`pšIsMISO
(_miso)è&& SPI.
	`pšIsSCK
(
_sşk
)) {

2183 
_p¥i
 = &
SPI
;

2184 
_¥i_num
 = 0;

2185 #ifdeà
KINETISK


2186 
_pkš‘isk_¥i
 = &
KINETISK_SPI0
;

2187 
_fifo_fuÎ_‹¡
 = (3 << 12);

2188 #–ià
	`defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

2189 
_pimx¹_¥i
 = &
IMXRT_LPSPI4_S
;

2191 
_pkš‘i¦_¥i
 = &
KINETISL_SPI0
;

2194 #ià
	`defšed
(
__MK64FX512__
è|| defšed(
__MK66FX1M0__
è|| defšed(
__IMXRT1062__
è|| defšed(
__MKL26Z64__
)

2195 } ià(
SPI1
.
	`pšIsMOSI
(
_mosi
è&& ((
_miso
 =ğ0xffè|| SPI1.
	`pšIsMISO
(_miso)è&& SPI1.
	`pšIsSCK
(
_sşk
)) {

2196 
_p¥i
 = &
SPI1
;

2197 
_¥i_num
 = 1;

2198 #ifdeà
KINETISK


2199 
_pkš‘isk_¥i
 = &
KINETISK_SPI1
;

2200 
_fifo_fuÎ_‹¡
 = (0 << 12);

2201 #–ià
	`defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

2202 
_pimx¹_¥i
 = &
IMXRT_LPSPI3_S
;

2204 
_pkš‘i¦_¥i
 = &
KINETISL_SPI1
;

2206 #ià!
	`defšed
(
__MKL26Z64__
)

2207 } ià(
SPI2
.
	`pšIsMOSI
(
_mosi
è&& ((
_miso
 =ğ0xffè|| SPI2.
	`pšIsMISO
(_miso)è&& SPI2.
	`pšIsSCK
(
_sşk
)) {

2208 
_p¥i
 = &
SPI2
;

2209 
_¥i_num
 = 2;

2210 #ifdeà
KINETISK


2211 
_pkš‘isk_¥i
 = &
KINETISK_SPI2
;

2212 
_fifo_fuÎ_‹¡
 = (0 << 12);

2213 #–ià
	`defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

2214 
_pimx¹_¥i
 = &
IMXRT_LPSPI1_S
;

2219 
S”Ÿl
.
	`´šn
("HX8357_t3n: The IO…ins onhe constructor‡re‚ot valid SPI…ins");

2221 
S”Ÿl
.
	`´štf
(" mosi:%d miso:%d SCLK:%d CS:%d DC:%d\n", 
_mosi
, 
_miso
, 
_sşk
, 
_cs
, 
_dc
);

2222 
S”Ÿl
.
	`æush
();

2226 
_p¥i
->
	`£tMOSI
(
_mosi
);

2227 
_p¥i
->
	`£tSCK
(
_sşk
);

2228 ià(
_miso
 !ğ0xffè
_p¥i
->
	`£tMISO
(_miso);

2231 
ušt32_t
 *
·
 = (ušt32_ˆ*)((*)
_p¥i
);

2232 
_¥i_h¬dw¬e
 = (
SPICÏss
::
SPI_H¬dw¬e_t
 *)(*)
·
[1];

2234 
_p¥i
->
	`begš
();

2235 #ifdeà
KINETISK


2236 ià(
_p¥i
->
	`pšIsChS–eù
(
_cs
, 
_dc
)) {

2237 
pcs_d©a
 = 
_p¥i
->
	`£tCS
(
_cs
);

2238 
pcs_commªd
 = 
pcs_d©a
 | 
_p¥i
->
	`£tCS
(
_dc
);

2241 ià(
_p¥i
->
	`pšIsChS–eù
(
_dc
)) {

2242 
pcs_d©a
 = 0;

2243 
pcs_commªd
 = 
pcs_d©a
 | 
_p¥i
->
	`£tCS
(
_dc
);

2244 
	`pšMode
(
_cs
, 
OUTPUT
);

2245 
_c¥Üt
 = 
	`pÜtOuutRegi¡”
(
	`dig™®PšToPÜt
(
_cs
));

2246 
_c¥šmask
 = 
	`dig™®PšToB™Mask
(
_cs
);

2247 *
_c¥Üt
 |ğ
_c¥šmask
;

2249 
pcs_d©a
 = 0;

2250 
pcs_commªd
 = 0;

2251 
S”Ÿl
.
	`´šn
("HX8357_t3n: Error‚ot DC is‚ot valid hardware CS…in");

2255 #–ià
	`defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

2258 
_c¥Üt
 = 
	`pÜtOuutRegi¡”
(
_cs
);

2259 
_c¥šmask
 = 
	`dig™®PšToB™Mask
(
_cs
);

2260 
	`pšMode
(
_cs
, 
OUTPUT
);

2261 
	`DIRECT_WRITE_HIGH
(
_c¥Üt
, 
_c¥šmask
);

2262 
_¥i_tü_cu¼’t
 = 
_pimx¹_¥i
->
TCR
;

2265 ià(
_p¥i
->
	`pšIsChS–eù
(
_dc
)) {

2266 
ušt8_t
 
dc_cs_šdex
 = 
_p¥i
->
	`£tCS
(
_dc
);

2268 
_dıÜt
 = 0;

2269 
_dıšmask
 = 0;

2271 
dc_cs_šdex
--;

2272 
_tü_dc_as£¹
 = 
	`LPSPI_TCR_PCS
(
dc_cs_šdex
);

2273 
_tü_dc_nÙ_as£¹
 = 
	`LPSPI_TCR_PCS
(3);

2276 
_dıÜt
 = 
	`pÜtOuutRegi¡”
(
_dc
);

2277 
_dıšmask
 = 
	`dig™®PšToB™Mask
(
_dc
);

2278 
	`pšMode
(
_dc
, 
OUTPUT
);

2279 
	`DIRECT_WRITE_HIGH
(
_dıÜt
, 
_dıšmask
);

2280 
_tü_dc_as£¹
 = 
	`LPSPI_TCR_PCS
(0);

2281 
_tü_dc_nÙ_as£¹
 = 
	`LPSPI_TCR_PCS
(1);

2283 
	`maybeUpd©eTCR
(
_tü_dc_nÙ_as£¹
 | 
	`LPSPI_TCR_FRAMESZ
(7));

2287 
pcs_d©a
 = 0;

2288 
pcs_commªd
 = 0;

2289 
	`pšMode
(
_cs
, 
OUTPUT
);

2290 
_c¥Üt
 = 
	`pÜtOuutRegi¡”
(
	`dig™®PšToPÜt
(
_cs
));

2291 
_c¥šmask
 = 
	`dig™®PšToB™Mask
(
_cs
);

2292 *
_c¥Üt
 |ğ
_c¥šmask
;

2293 
	`pšMode
(
_dc
, 
OUTPUT
);

2294 
_dıÜt
 = 
	`pÜtOuutRegi¡”
(
	`dig™®PšToPÜt
(
_dc
));

2295 
_dıšmask
 = 
	`dig™®PšToB™Mask
(
_dc
);

2296 *
_dıÜt
 |ğ
_dıšmask
;

2297 
_dıšAs£¹ed
 = 0;

2301 ià(
_r¡
 < 255) {

2302 
	`pšMode
(
_r¡
, 
OUTPUT
);

2303 
	`dig™®Wr™e
(
_r¡
, 
HIGH
);

2304 
	`d–ay
(5);

2305 
	`dig™®Wr™e
(
_r¡
, 
LOW
);

2306 
	`d–ay
(20);

2307 
	`dig™®Wr™e
(
_r¡
, 
HIGH
);

2308 
	`d–ay
(150);

2322 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

2323 cÚ¡ 
ušt8_t
 *
addr
 = 
š™_commªds
;

2325 
ušt8_t
 
couÁ
 = *
addr
++;

2326 ià(
couÁ
 == 0x80) {

2327 
	`d–ay
(*
addr
++ * 5);

2329 ià(
couÁ
-- == 0) ;

2330 
	`wr™ecommªd_cÚt
(*
addr
++);

2331 
couÁ
-- > 0) {

2332 
	`wr™ed©a8_cÚt
(*
addr
++);

2337 
	`’dSPIT¿n§ùiÚ
();

2338 
	`d–ay
(20);

2340 #ifdeà
DEBUG_ASYNC_LEDS


2341 
	`pšMode
(
DEBUG_PIN_1
, 
OUTPUT
);

2342 
	`pšMode
(
DEBUG_PIN_2
, 
OUTPUT
);

2343 
	`pšMode
(
DEBUG_PIN_3
, 
OUTPUT
);

2347 
	}
}

2386 "C" cÚ¡ 
glcdfÚt
[];

2389 
	gHX8357_t3n
::
	$d¿wCœşe
(
št16_t
 
x0
, iÁ16_ˆ
y0
, iÁ16_ˆ
r
,

2390 
ušt16_t
 
cŞÜ
) {

2391 
št16_t
 
f
 = 1 - 
r
;

2392 
št16_t
 
ddF_x
 = 1;

2393 
št16_t
 
ddF_y
 = -2 * 
r
;

2394 
št16_t
 
x
 = 0;

2395 
št16_t
 
y
 = 
r
;

2397 
	`d¿wPix–
(
x0
, 
y0
 + 
r
, 
cŞÜ
);

2398 
	`d¿wPix–
(
x0
, 
y0
 - 
r
, 
cŞÜ
);

2399 
	`d¿wPix–
(
x0
 + 
r
, 
y0
, 
cŞÜ
);

2400 
	`d¿wPix–
(
x0
 - 
r
, 
y0
, 
cŞÜ
);

2402 
x
 < 
y
) {

2403 ià(
f
 >= 0) {

2404 
y
--;

2405 
ddF_y
 += 2;

2406 
f
 +ğ
ddF_y
;

2408 
x
++;

2409 
ddF_x
 += 2;

2410 
f
 +ğ
ddF_x
;

2412 
	`d¿wPix–
(
x0
 + 
x
, 
y0
 + 
y
, 
cŞÜ
);

2413 
	`d¿wPix–
(
x0
 - 
x
, 
y0
 + 
y
, 
cŞÜ
);

2414 
	`d¿wPix–
(
x0
 + 
x
, 
y0
 - 
y
, 
cŞÜ
);

2415 
	`d¿wPix–
(
x0
 - 
x
, 
y0
 - 
y
, 
cŞÜ
);

2416 
	`d¿wPix–
(
x0
 + 
y
, 
y0
 + 
x
, 
cŞÜ
);

2417 
	`d¿wPix–
(
x0
 - 
y
, 
y0
 + 
x
, 
cŞÜ
);

2418 
	`d¿wPix–
(
x0
 + 
y
, 
y0
 - 
x
, 
cŞÜ
);

2419 
	`d¿wPix–
(
x0
 - 
y
, 
y0
 - 
x
, 
cŞÜ
);

2421 
	}
}

2423 
	gHX8357_t3n
::
	$d¿wCœşeH–³r
(
št16_t
 
x0
, iÁ16_ˆ
y0
,

2424 
št16_t
 
r
, 
ušt8_t
 
cÜÃºame
, 
ušt16_t
 
cŞÜ
) {

2425 
št16_t
 
f
 = 1 - 
r
;

2426 
št16_t
 
ddF_x
 = 1;

2427 
št16_t
 
ddF_y
 = -2 * 
r
;

2428 
št16_t
 
x
 = 0;

2429 
št16_t
 
y
 = 
r
;

2431 
x
 < 
y
) {

2432 ià(
f
 >= 0) {

2433 
y
--;

2434 
ddF_y
 += 2;

2435 
f
 +ğ
ddF_y
;

2437 
x
++;

2438 
ddF_x
 += 2;

2439 
f
 +ğ
ddF_x
;

2440 ià(
cÜÃºame
 & 0x4) {

2441 
	`d¿wPix–
(
x0
 + 
x
, 
y0
 + 
y
, 
cŞÜ
);

2442 
	`d¿wPix–
(
x0
 + 
y
, 
y0
 + 
x
, 
cŞÜ
);

2444 ià(
cÜÃºame
 & 0x2) {

2445 
	`d¿wPix–
(
x0
 + 
x
, 
y0
 - 
y
, 
cŞÜ
);

2446 
	`d¿wPix–
(
x0
 + 
y
, 
y0
 - 
x
, 
cŞÜ
);

2448 ià(
cÜÃºame
 & 0x8) {

2449 
	`d¿wPix–
(
x0
 - 
y
, 
y0
 + 
x
, 
cŞÜ
);

2450 
	`d¿wPix–
(
x0
 - 
x
, 
y0
 + 
y
, 
cŞÜ
);

2452 ià(
cÜÃºame
 & 0x1) {

2453 
	`d¿wPix–
(
x0
 - 
y
, 
y0
 - 
x
, 
cŞÜ
);

2454 
	`d¿wPix–
(
x0
 - 
x
, 
y0
 - 
y
, 
cŞÜ
);

2457 
	}
}

2459 
	gHX8357_t3n
::
	$flCœşe
(
št16_t
 
x0
, iÁ16_ˆ
y0
, iÁ16_ˆ
r
,

2460 
ušt16_t
 
cŞÜ
) {

2461 
	`d¿wFa¡VLše
(
x0
, 
y0
 - 
r
, 2 *„ + 1, 
cŞÜ
);

2462 
	`flCœşeH–³r
(
x0
, 
y0
, 
r
, 3, 0, 
cŞÜ
);

2463 
	}
}

2466 
	gHX8357_t3n
::
	$flCœşeH–³r
(
št16_t
 
x0
, iÁ16_ˆ
y0
, iÁ16_ˆ
r
,

2467 
ušt8_t
 
cÜÃºame
, 
št16_t
 
d–
, 
ušt16_t
 
cŞÜ
) {

2469 
št16_t
 
f
 = 1 - 
r
;

2470 
št16_t
 
ddF_x
 = 1;

2471 
št16_t
 
ddF_y
 = -2 * 
r
;

2472 
št16_t
 
x
 = 0;

2473 
št16_t
 
y
 = 
r
;

2475 
x
 < 
y
) {

2476 ià(
f
 >= 0) {

2477 
y
--;

2478 
ddF_y
 += 2;

2479 
f
 +ğ
ddF_y
;

2481 
x
++;

2482 
ddF_x
 += 2;

2483 
f
 +ğ
ddF_x
;

2485 ià(
cÜÃºame
 & 0x1) {

2486 
	`d¿wFa¡VLše
(
x0
 + 
x
, 
y0
 - 
y
, 2 * y + 1 + 
d–
, 
cŞÜ
);

2487 
	`d¿wFa¡VLše
(
x0
 + 
y
, 
y0
 - 
x
, 2 * x + 1 + 
d–
, 
cŞÜ
);

2489 ià(
cÜÃºame
 & 0x2) {

2490 
	`d¿wFa¡VLše
(
x0
 - 
x
, 
y0
 - 
y
, 2 * y + 1 + 
d–
, 
cŞÜ
);

2491 
	`d¿wFa¡VLše
(
x0
 - 
y
, 
y0
 - 
x
, 2 * x + 1 + 
d–
, 
cŞÜ
);

2494 
	}
}

2498 
	gHX8357_t3n
::
	$d¿wLše
(
št16_t
 
x0
, iÁ16_ˆ
y0
,

2499 
št16_t
 
x1
, iÁ16_ˆ
y1
, 
ušt16_t
 
cŞÜ
) {

2500 ià(
y0
 =ğ
y1
) {

2501 ià(
x1
 > 
x0
) {

2502 
	`d¿wFa¡HLše
(
x0
, 
y0
, 
x1
 - x0 + 1, 
cŞÜ
);

2503 } ià(
x1
 < 
x0
) {

2504 
	`d¿wFa¡HLše
(
x1
, 
y0
, 
x0
 - x1 + 1, 
cŞÜ
);

2506 
	`d¿wPix–
(
x0
, 
y0
, 
cŞÜ
);

2509 } ià(
x0
 =ğ
x1
) {

2510 ià(
y1
 > 
y0
) {

2511 
	`d¿wFa¡VLše
(
x0
, 
y0
, 
y1
 - y0 + 1, 
cŞÜ
);

2513 
	`d¿wFa¡VLše
(
x0
, 
y1
, 
y0
 - y1 + 1, 
cŞÜ
);

2518 
boŞ
 
¡“p
 = 
	`abs
(
y1
 - 
y0
è>‡bs(
x1
 - 
x0
);

2519 ià(
¡“p
) {

2520 
	`hx8357_sw­
(
x0
, 
y0
);

2521 
	`hx8357_sw­
(
x1
, 
y1
);

2523 ià(
x0
 > 
x1
) {

2524 
	`hx8357_sw­
(
x0
, 
x1
);

2525 
	`hx8357_sw­
(
y0
, 
y1
);

2528 
št16_t
 
dx
, 
dy
;

2529 
dx
 = 
x1
 - 
x0
;

2530 
dy
 = 
	`abs
(
y1
 - 
y0
);

2532 
št16_t
 
”r
 = 
dx
 / 2;

2533 
št16_t
 
y¡•
;

2535 ià(
y0
 < 
y1
) {

2536 
y¡•
 = 1;

2538 
y¡•
 = -1;

2541 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


2542 ià(!
_u£_fbtá
è
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

2544 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

2546 
št16_t
 
xbegš
 = 
x0
;

2547 ià(
¡“p
) {

2548 ; 
x0
 <ğ
x1
; x0++) {

2549 
”r
 -ğ
dy
;

2550 ià(
”r
 < 0) {

2551 
št16_t
 
Ën
 = 
x0
 - 
xbegš
;

2552 ià(
Ën
) {

2553 
	`VLše
(
y0
, 
xbegš
, 
Ën
 + 1, 
cŞÜ
);

2555 
	`Pix–
(
y0
, 
x0
, 
cŞÜ
);

2557 
xbegš
 = 
x0
 + 1;

2558 
y0
 +ğ
y¡•
;

2559 
”r
 +ğ
dx
;

2562 ià(
x0
 > 
xbegš
 + 1) {

2563 
	`VLše
(
y0
, 
xbegš
, 
x0
 - xbegš, 
cŞÜ
);

2567 ; 
x0
 <ğ
x1
; x0++) {

2568 
”r
 -ğ
dy
;

2569 ià(
”r
 < 0) {

2570 
št16_t
 
Ën
 = 
x0
 - 
xbegš
;

2571 ià(
Ën
) {

2572 
	`HLše
(
xbegš
, 
y0
, 
Ën
 + 1, 
cŞÜ
);

2574 
	`Pix–
(
x0
, 
y0
, 
cŞÜ
);

2576 
xbegš
 = 
x0
 + 1;

2577 
y0
 +ğ
y¡•
;

2578 
”r
 +ğ
dx
;

2581 ià(
x0
 > 
xbegš
 + 1) {

2582 
	`HLše
(
xbegš
, 
y0
, 
x0
 - xbegš, 
cŞÜ
);

2585 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


2586 ià(!
_u£_fbtá
) {

2587 
	`wr™ecommªd_Ï¡
(
HX8357_NOP
);

2588 
	`’dSPIT¿n§ùiÚ
();

2591 
	`wr™ecommªd_Ï¡
(
HX8357_NOP
);

2592 
	`’dSPIT¿n§ùiÚ
();

2594 
	}
}

2597 
	gHX8357_t3n
::
	$d¿wReù
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, 
ušt16_t
 
cŞÜ
) {

2598 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


2599 ià(
_u£_fbtá
) {

2600 
	`d¿wFa¡HLše
(
x
, 
y
, 
w
, 
cŞÜ
);

2601 
	`d¿wFa¡HLše
(
x
, 
y
 + 
h
 - 1, 
w
, 
cŞÜ
);

2602 
	`d¿wFa¡VLše
(
x
, 
y
, 
h
, 
cŞÜ
);

2603 
	`d¿wFa¡VLše
(
x
 + 
w
 - 1, 
y
, 
h
, 
cŞÜ
);

2607 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

2608 
	`HLše
(
x
, 
y
, 
w
, 
cŞÜ
);

2609 
	`HLše
(
x
, 
y
 + 
h
 - 1, 
w
, 
cŞÜ
);

2610 
	`VLše
(
x
, 
y
, 
h
, 
cŞÜ
);

2611 
	`VLše
(
x
 + 
w
 - 1, 
y
, 
h
, 
cŞÜ
);

2612 
	`wr™ecommªd_Ï¡
(
HX8357_NOP
);

2613 
	`’dSPIT¿n§ùiÚ
();

2615 
	}
}

2618 
	gHX8357_t3n
::
	$d¿wRoundReù
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
,

2619 
št16_t
 
h
, iÁ16_ˆ
r
, 
ušt16_t
 
cŞÜ
) {

2621 
	`d¿wFa¡HLše
(
x
 + 
r
, 
y
, 
w
 - 2 *„, 
cŞÜ
);

2622 
	`d¿wFa¡HLše
(
x
 + 
r
, 
y
 + 
h
 - 1, 
w
 - 2 *„, 
cŞÜ
);

2623 
	`d¿wFa¡VLše
(
x
, 
y
 + 
r
, 
h
 - 2 *„, 
cŞÜ
);

2624 
	`d¿wFa¡VLše
(
x
 + 
w
 - 1, 
y
 + 
r
, 
h
 - 2 *„, 
cŞÜ
);

2626 
	`d¿wCœşeH–³r
(
x
 + 
r
, 
y
 +„,„, 1, 
cŞÜ
);

2627 
	`d¿wCœşeH–³r
(
x
 + 
w
 - 
r
 - 1, 
y
 +„,„, 2, 
cŞÜ
);

2628 
	`d¿wCœşeH–³r
(
x
 + 
w
 - 
r
 - 1, 
y
 + 
h
 -„ - 1,„, 4, 
cŞÜ
);

2629 
	`d¿wCœşeH–³r
(
x
 + 
r
, 
y
 + 
h
 -„ - 1,„, 8, 
cŞÜ
);

2630 
	}
}

2633 
	gHX8357_t3n
::
	$flRoundReù
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
,

2634 
št16_t
 
h
, iÁ16_ˆ
r
, 
ušt16_t
 
cŞÜ
) {

2636 
	`flReù
(
x
 + 
r
, 
y
, 
w
 - 2 *„, 
h
, 
cŞÜ
);

2639 
	`flCœşeH–³r
(
x
 + 
w
 - 
r
 - 1, 
y
 +„,„, 1, 
h
 - 2 *„ - 1, 
cŞÜ
);

2640 
	`flCœşeH–³r
(
x
 + 
r
, 
y
 +„,„, 2, 
h
 - 2 *„ - 1, 
cŞÜ
);

2641 
	}
}

2644 
	gHX8357_t3n
::
	$d¿wTrŸngË
(
št16_t
 
x0
, iÁ16_ˆ
y0
,

2645 
št16_t
 
x1
, iÁ16_ˆ
y1
,

2646 
št16_t
 
x2
, iÁ16_ˆ
y2
, 
ušt16_t
 
cŞÜ
) {

2647 
	`d¿wLše
(
x0
, 
y0
, 
x1
, 
y1
, 
cŞÜ
);

2648 
	`d¿wLše
(
x1
, 
y1
, 
x2
, 
y2
, 
cŞÜ
);

2649 
	`d¿wLše
(
x2
, 
y2
, 
x0
, 
y0
, 
cŞÜ
);

2650 
	}
}

2653 
	gHX8357_t3n
::
	$flTrŸngË
(
št16_t
 
x0
, iÁ16_ˆ
y0
,

2654 
št16_t
 
x1
, iÁ16_ˆ
y1
,

2655 
št16_t
 
x2
, iÁ16_ˆ
y2
, 
ušt16_t
 
cŞÜ
) {

2657 
št16_t
 
a
, 
b
, 
y
, 
Ï¡
;

2660 ià(
y0
 > 
y1
) {

2661 
	`hx8357_sw­
(
y0
, 
y1
);

2662 
	`hx8357_sw­
(
x0
, 
x1
);

2664 ià(
y1
 > 
y2
) {

2665 
	`hx8357_sw­
(
y2
, 
y1
);

2666 
	`hx8357_sw­
(
x2
, 
x1
);

2668 ià(
y0
 > 
y1
) {

2669 
	`hx8357_sw­
(
y0
, 
y1
);

2670 
	`hx8357_sw­
(
x0
, 
x1
);

2673 ià(
y0
 =ğ
y2
) {

2674 
a
 = 
b
 = 
x0
;

2675 ià(
x1
 < 
a
)‡ = x1;

2676 ià(
x1
 > 
b
) b = x1;

2677 ià(
x2
 < 
a
)‡ = x2;

2678 ià(
x2
 > 
b
) b = x2;

2679 
	`d¿wFa¡HLše
(
a
, 
y0
, 
b
 -‡ + 1, 
cŞÜ
);

2683 
št32_t


2684 
dx01
 = 
x1
 - 
x0
,

2685 
dy01
 = 
y1
 - 
y0
,

2686 
dx02
 = 
x2
 - 
x0
,

2687 
dy02
 = 
y2
 - 
y0
,

2688 
dx12
 = 
x2
 - 
x1
,

2689 
dy12
 = 
y2
 - 
y1
,

2690 
§
 = 0,

2691 
sb
 = 0;

2699 ià(
y1
 =ğ
y2
è
Ï¡
 = y1;

2700 
Ï¡
 = 
y1
 - 1;

2702 
y
 = 
y0
; y <ğ
Ï¡
; y++) {

2703 
a
 = 
x0
 + 
§
 / 
dy01
;

2704 
b
 = 
x0
 + 
sb
 / 
dy02
;

2705 
§
 +ğ
dx01
;

2706 
sb
 +ğ
dx02
;

2711 ià(
a
 > 
b
è
	`hx8357_sw­
(a, b);

2712 
	`d¿wFa¡HLše
(
a
, 
y
, 
b
 -‡ + 1, 
cŞÜ
);

2717 
§
 = 
dx12
 * (
y
 - 
y1
);

2718 
sb
 = 
dx02
 * (
y
 - 
y0
);

2719 ; 
y
 <ğ
y2
; y++) {

2720 
a
 = 
x1
 + 
§
 / 
dy12
;

2721 
b
 = 
x0
 + 
sb
 / 
dy02
;

2722 
§
 +ğ
dx12
;

2723 
sb
 +ğ
dx02
;

2728 ià(
a
 > 
b
è
	`hx8357_sw­
(a, b);

2729 
	`d¿wFa¡HLše
(
a
, 
y
, 
b
 -‡ + 1, 
cŞÜ
);

2731 
	}
}

2733 
	gHX8357_t3n
::
	$d¿wB™m­
(
št16_t
 
x
, iÁ16_ˆ
y
,

2734 cÚ¡ 
ušt8_t
 *
b™m­
, 
št16_t
 
w
, iÁ16_ˆ
h
,

2735 
ušt16_t
 
cŞÜ
) {

2737 
št16_t
 
i
, 
j
, 
by‹Width
 = (
w
 + 7) / 8;

2739 
j
 = 0; j < 
h
; j++) {

2740 
i
 = 0; i < 
w
; i++) {

2741 ià(
	`pgm_»ad_by‹
(
b™m­
 + 
j
 * 
by‹Width
 + 
i
 / 8) & (128 >> (i & 7))) {

2742 
	`d¿wPix–
(
x
 + 
i
, 
y
 + 
j
, 
cŞÜ
);

2746 
	}
}

2750 
size_t
 
	gHX8357_t3n
::
	$wr™e
(
ušt8_t
 
c
) {

2751  
	`wr™e
(&
c
, 1);

2752 
	}
}

2754 
size_t
 
	gHX8357_t3n
::
	$wr™e
(cÚ¡ 
ušt8_t
 *
bufãr
, 
size_t
 
size
) {

2756 ià(
_ûÁ”_x_‹xt
 || 
_ûÁ”_y_‹xt
) {

2757 
št16_t
 
x
, 
y
;

2758 
ušt16_t
 
¡ºgWidth
, 
¡ºgHeight
;

2759 
	`g‘TextBounds
(
bufãr
, 
size
, 0, 0, &
x
, &
y
, &
¡ºgWidth
, &
¡ºgHeight
);

2762 ià(
_ûÁ”_x_‹xt
 && 
¡ºgWidth
 > 0) {

2763 
cursÜ_x
 -ğ(
x
 + 
¡ºgWidth
 / 2);

2765 ià(
_ûÁ”_y_‹xt
 && 
¡ºgHeight
 > 0) {

2766 
cursÜ_y
 -ğ(
y
 + 
¡ºgHeight
 / 2);

2768 
_ûÁ”_x_‹xt
 = 
çl£
;

2769 
_ûÁ”_y_‹xt
 = 
çl£
;

2772 
size_t
 
cb
 = 
size
;

2773 
cb
) {

2774 
ušt8_t
 
c
 = *
bufãr
++;

2775 
cb
--;

2777 ià(
fÚt
) {

2778 ià(
c
 == '\n') {

2779 
cursÜ_y
 +ğ
fÚt
->
lše_¥aû
;

2780 ià(
süŞlEÇbË
 && 
isWr™šgSüŞlA»a
) {

2781 
cursÜ_x
 = 
süŞl_x
;

2783 
cursÜ_x
 = 0;

2786 
	`d¿wFÚtCh¬
(
c
);

2788 } ià(
gfxFÚt
) {

2789 ià(
c
 == '\n') {

2790 
cursÜ_y
 +ğ(
št16_t
)
‹xtsize_y
 * 
gfxFÚt
->
yAdvªû
;

2791 ià(
süŞlEÇbË
 && 
isWr™šgSüŞlA»a
) {

2792 
cursÜ_x
 = 
süŞl_x
;

2794 
cursÜ_x
 = 0;

2797 
	`d¿wGFXFÚtCh¬
(
c
);

2800 ià(
c
 == '\n') {

2801 
cursÜ_y
 +ğ
‹xtsize_y
 * 8;

2802 ià(
süŞlEÇbË
 && 
isWr™šgSüŞlA»a
) {

2803 
cursÜ_x
 = 
süŞl_x
;

2805 
cursÜ_x
 = 0;

2807 } ià(
c
 == '\r') {

2810 ià(
süŞlEÇbË
 && 
isWr™šgSüŞlA»a
 && (
cursÜ_y
 > (
süŞl_y
 + 
süŞl_height
 - 
‹xtsize_y
 * 8))) {

2811 
	`süŞlTextA»a
(
‹xtsize_y
 * 8);

2812 
cursÜ_y
 -ğ
‹xtsize_y
 * 8;

2813 
cursÜ_x
 = 
süŞl_x
;

2815 
	`d¿wCh¬
(
cursÜ_x
, 
cursÜ_y
, 
c
, 
‹xtcŞÜ
, 
‹xtbgcŞÜ
, 
‹xtsize_x
, 
‹xtsize_y
);

2816 
cursÜ_x
 +ğ
‹xtsize_x
 * 6;

2817 ià(
w¿p
 && 
süŞlEÇbË
 && 
isWr™šgSüŞlA»a
 && (
cursÜ_x
 > (
süŞl_x
 + 
süŞl_width
 - 
‹xtsize_x
 * 6))) {

2818 
cursÜ_y
 +ğ
‹xtsize_y
 * 8;

2819 
cursÜ_x
 = 
süŞl_x
;

2820 } ià(
w¿p
 && (
cursÜ_x
 > (
_width
 - 
‹xtsize_x
 * 6))) {

2821 
cursÜ_y
 +ğ
‹xtsize_y
 * 6;

2822 
cursÜ_x
 = 0;

2827  
size
;

2828 
	}
}

2831 
	gHX8357_t3n
::
	$d¿wCh¬
(
št16_t
 
x
, iÁ16_ˆ
y
, 
c
,

2832 
ušt16_t
 
fgcŞÜ
, ušt16_ˆ
bgcŞÜ
, 
ušt8_t
 
size_x
, ušt8_ˆ
size_y
) {

2833 ià((
x
 >ğ
_width
) ||

2834 (
y
 >ğ
_height
) ||

2835 ((
x
 + 6 * 
size_x
 - 1) < 0) ||

2836 ((
y
 + 8 * 
size_y
 - 1) < 0))

2840 ià(
fgcŞÜ
 =ğ
bgcŞÜ
) {

2842 ià((
size_x
 =ğ1è&& (
size_y
 == 1)) {

2843 
ušt8_t
 
mask
 = 0x01;

2844 
št16_t
 
xoff
, 
yoff
;

2845 
yoff
 = 0; yoff < 8; yoff++) {

2846 
ušt8_t
 
lše
 = 0;

2847 
xoff
 = 0; xoff < 5; xoff++) {

2848 ià(
glcdfÚt
[
c
 * 5 + 
xoff
] & 
mask
è
lše
 |= 1;

2849 
lše
 <<= 1;

2851 
lše
 >>= 1;

2852 
xoff
 = 0;

2853 
lše
) {

2854 ià(
lše
 == 0x1F) {

2855 
	`d¿wFa¡HLše
(
x
 + 
xoff
, 
y
 + 
yoff
, 5, 
fgcŞÜ
);

2857 } ià(
lše
 == 0x1E) {

2858 
	`d¿wFa¡HLše
(
x
 + 
xoff
, 
y
 + 
yoff
, 4, 
fgcŞÜ
);

2860 } ià((
lše
 & 0x1C) == 0x1C) {

2861 
	`d¿wFa¡HLše
(
x
 + 
xoff
, 
y
 + 
yoff
, 3, 
fgcŞÜ
);

2862 
lše
 <<= 4;

2863 
xoff
 += 4;

2864 } ià((
lše
 & 0x18) == 0x18) {

2865 
	`d¿wFa¡HLše
(
x
 + 
xoff
, 
y
 + 
yoff
, 2, 
fgcŞÜ
);

2866 
lše
 <<= 3;

2867 
xoff
 += 3;

2868 } ià((
lše
 & 0x10) == 0x10) {

2869 
	`d¿wPix–
(
x
 + 
xoff
, 
y
 + 
yoff
, 
fgcŞÜ
);

2870 
lše
 <<= 2;

2871 
xoff
 += 2;

2873 
lše
 <<= 1;

2874 
xoff
 += 1;

2877 
mask
 = mask << 1;

2880 
ušt8_t
 
mask
 = 0x01;

2881 
št16_t
 
xoff
, 
yoff
;

2882 
yoff
 = 0; yoff < 8; yoff++) {

2883 
ušt8_t
 
lše
 = 0;

2884 
xoff
 = 0; xoff < 5; xoff++) {

2885 ià(
glcdfÚt
[
c
 * 5 + 
xoff
] & 
mask
è
lše
 |= 1;

2886 
lše
 <<= 1;

2888 
lše
 >>= 1;

2889 
xoff
 = 0;

2890 
lše
) {

2891 ià(
lše
 == 0x1F) {

2892 
	`flReù
(
x
 + 
xoff
 * 
size_x
, 
y
 + 
yoff
 * 
size_y
,

2893 5 * 
size_x
, 
size_y
, 
fgcŞÜ
);

2895 } ià(
lše
 == 0x1E) {

2896 
	`flReù
(
x
 + 
xoff
 * 
size_x
, 
y
 + 
yoff
 * 
size_y
,

2897 4 * 
size_x
, 
size_y
, 
fgcŞÜ
);

2899 } ià((
lše
 & 0x1C) == 0x1C) {

2900 
	`flReù
(
x
 + 
xoff
 * 
size_x
, 
y
 + 
yoff
 * 
size_y
,

2901 3 * 
size_x
, 
size_y
, 
fgcŞÜ
);

2902 
lše
 <<= 4;

2903 
xoff
 += 4;

2904 } ià((
lše
 & 0x18) == 0x18) {

2905 
	`flReù
(
x
 + 
xoff
 * 
size_x
, 
y
 + 
yoff
 * 
size_y
,

2906 2 * 
size_x
, 
size_y
, 
fgcŞÜ
);

2907 
lše
 <<= 3;

2908 
xoff
 += 3;

2909 } ià((
lše
 & 0x10) == 0x10) {

2910 
	`flReù
(
x
 + 
xoff
 * 
size_x
, 
y
 + 
yoff
 * 
size_y
,

2911 
size_x
, 
size_y
, 
fgcŞÜ
);

2912 
lše
 <<= 2;

2913 
xoff
 += 2;

2915 
lše
 <<= 1;

2916 
xoff
 += 1;

2919 
mask
 = mask << 1;

2924 
ušt8_t
 
xc
, 
yc
;

2925 
ušt8_t
 
xr
, 
yr
;

2926 
ušt8_t
 
mask
 = 0x01;

2927 
ušt16_t
 
cŞÜ
;

2930 
x
 +ğ
_Üigšx
;

2931 
y
 +ğ
_Üigšy
;

2932 
št16_t
 
x_ch¬_¡¬t
 = 
x
;

2934 ià((
x
 >ğ
_di¥Ïyşx2
) ||

2935 (
y
 >ğ
_di¥Ïyşy2
) ||

2936 ((
x
 + 6 * 
size_x
 - 1è< 
_di¥Ïyşx1
) ||

2937 ((
y
 + 8 * 
size_y
 - 1è< 
_di¥Ïyşy1
))

2941 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


2942 ià(
_u£_fbtá
) {

2943 
	`upd©eChªgedRªge
(
x
, 
y
, 6 * 
size_x
, 8 * 
size_y
);

2944 
ušt16_t
 *
pfbPix–_row
 = &
_pfbtá
[
y
 * 
_width
 + 
x
];

2945 
yc
 = 0; (yø< 8è&& (
y
 < 
_di¥Ïyşy2
); yc++) {

2946 
yr
 = 0; (y¸< 
size_y
è&& (
y
 < 
_di¥Ïyşy2
); yr++) {

2947 
x
 = 
x_ch¬_¡¬t
;

2948 ià(
y
 >ğ
_di¥Ïyşy1
) {

2949 
ušt16_t
 *
pfbPix–
 = 
pfbPix–_row
;

2950 
xc
 = 0; xc < 5; xc++) {

2951 ià(
glcdfÚt
[
c
 * 5 + 
xc
] & 
mask
) {

2952 
cŞÜ
 = 
fgcŞÜ
;

2954 
cŞÜ
 = 
bgcŞÜ
;

2956 
xr
 = 0; x¸< 
size_x
; xr++) {

2957 ià((
x
 >ğ
_di¥Ïyşx1
è&& (x < 
_di¥Ïyşx2
)) {

2958 *
pfbPix–
 = 
cŞÜ
;

2960 
pfbPix–
++;

2961 
x
++;

2964 
xr
 = 0; x¸< 
size_x
; xr++) {

2965 ià((
x
 >ğ
_di¥Ïyşx1
è&& (x < 
_di¥Ïyşx2
)) {

2966 *
pfbPix–
 = 
bgcŞÜ
;

2968 
pfbPix–
++;

2969 
x
++;

2972 
pfbPix–_row
 +ğ
_width
;

2973 
y
++;

2975 
mask
 = mask << 1;

2982 
št16_t
 
y_ch¬_tİ
 = 
y
;

2983 
št16_t
 
w
 = 6 * 
size_x
;

2984 
št16_t
 
h
 = 8 * 
size_y
;

2986 ià(
x
 < 
_di¥Ïyşx1
) {

2987 
w
 -ğ(
_di¥Ïyşx1
 - 
x
);

2988 
x
 = 
_di¥Ïyşx1
;

2990 ià((
x
 + 
w
 - 1è>ğ
_di¥Ïyşx2
) w = _displayclipx2 - x;

2991 ià(
y
 < 
_di¥Ïyşy1
) {

2992 
h
 -ğ(
_di¥Ïyşy1
 - 
y
);

2993 
y
 = 
_di¥Ïyşy1
;

2995 ià((
y
 + 
h
 - 1è>ğ
_di¥Ïyşy2
) h = _displayclipy2 - y;

2997 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

2998 
	`£tAddr
(
x
, 
y
, x + 
w
 - 1, y + 
h
 - 1);

3000 
y
 = 
y_ch¬_tİ
;

3001 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

3002 
yc
 = 0; (yø< 8è&& (
y
 < 
_di¥Ïyşy2
); yc++) {

3003 
yr
 = 0; (y¸< 
size_y
è&& (
y
 < 
_di¥Ïyşy2
); yr++) {

3004 
x
 = 
x_ch¬_¡¬t
;

3005 ià(
y
 >ğ
_di¥Ïyşy1
) {

3006 
xc
 = 0; xc < 5; xc++) {

3007 ià(
glcdfÚt
[
c
 * 5 + 
xc
] & 
mask
) {

3008 
cŞÜ
 = 
fgcŞÜ
;

3010 
cŞÜ
 = 
bgcŞÜ
;

3012 
xr
 = 0; x¸< 
size_x
; xr++) {

3013 ià((
x
 >ğ
_di¥Ïyşx1
è&& (x < 
_di¥Ïyşx2
)) {

3014 
	`wr™ed©a16_cÚt
(
cŞÜ
);

3016 
x
++;

3019 
xr
 = 0; x¸< 
size_x
; xr++) {

3020 ià((
x
 >ğ
_di¥Ïyşx1
è&& (x < 
_di¥Ïyşx2
)) {

3021 
	`wr™ed©a16_cÚt
(
bgcŞÜ
);

3023 
x
++;

3026 
y
++;

3028 
mask
 = mask << 1;

3030 
	`wr™ecommªd_Ï¡
(
HX8357_NOP
);

3031 
	`’dSPIT¿n§ùiÚ
();

3034 
	}
}

3036 
	gHX8357_t3n
::
	$£tFÚt
(cÚ¡ 
ILI9341_t3_fÚt_t
 &
f
) {

3037 
fÚt
 = &
f
;

3038 
_gfx_Ï¡_ch¬_x_wr™e
 = 0;

3039 ià(
gfxFÚt
) {

3040 
cursÜ_y
 -= 6;

3041 
gfxFÚt
 = 
NULL
;

3043 
fÚtbµ
 = 1;

3045 ià(
fÚt
 && fÚt->
v”siÚ
 == 23) {

3046 
fÚtbµ
 = (
fÚt
->
»£rved
 & 0b000011) + 1;

3047 
fÚtbµšdex
 = (
fÚtbµ
 >> 2) + 1;

3048 
fÚtbµmask
 = (1 << (
fÚtbµšdex
 + 1)) - 1;

3049 
fÚpb
 = 8 / 
fÚtbµ
;

3050 
fÚÍhamx
 = 31 / ((1 << 
fÚtbµ
) - 1);

3052 ià(
‹xtcŞÜ
 =ğ
‹xtbgcŞÜ
)extbgcolor = (textcolor == 0x0000) ? 0xFFFF : 0x0000;

3054 
	}
}

3057 
	gHX8357_t3n
::
	$£tFÚt
(cÚ¡ 
GFXfÚt
 *
f
) {

3058 
fÚt
 = 
NULL
;

3059 
_gfx_Ï¡_ch¬_x_wr™e
 = 0;

3060 ià(
f
 =ğ
gfxFÚt
) ;

3062 ià(
f
) {

3063 ià(!
gfxFÚt
) {

3066 
cursÜ_y
 += 6;

3070 
št8_t
 
mšy_off£t
 = 0;

3072 
ušt8_t
 
i
 = 0; i <ğ(
f
->
Ï¡
 - f->
fœ¡
); i++) {

3073 ià(
f
->
glyph
[
i
].
yOff£t
 < 
mšy_off£t
) {

3074 
mšy_off£t
 = 
f
->
glyph
[
i
].
yOff£t
;

3078 
max_d–
 = 0;

3079 
ušt8_t
 
šdex_mš
 = 0;

3080 
ušt8_t
 
šdex_max
 = 0;

3082 
št8_t
 
mšx_off£t
 = 127;

3083 
št8_t
 
maxx_ov”Ïp
 = 0;

3084 
ušt8_t
 
šdexx_mš
 = 0;

3085 
ušt8_t
 
šdexx_max
 = 0;

3086 
ušt8_t
 
i
 = 0; i <ğ(
f
->
Ï¡
 - f->
fœ¡
); i++) {

3087 ià(
f
->
glyph
[
i
].
yOff£t
 < 
mšy_off£t
) {

3088 
mšy_off£t
 = 
f
->
glyph
[
i
].
yOff£t
;

3089 
šdex_mš
 = 
i
;

3092 ià(
f
->
glyph
[
i
].
xOff£t
 < 
mšx_off£t
) {

3093 
mšx_off£t
 = 
f
->
glyph
[
i
].
xOff£t
;

3094 
šdexx_mš
 = 
i
;

3096 ià((
f
->
glyph
[
i
].
yOff£t
 + f->glyph[i].
height
è> 
max_d–
) {

3097 
max_d–
 = (
f
->
glyph
[
i
].
yOff£t
 + f->glyph[i].
height
);

3098 
šdex_max
 = 
i
;

3100 
št8_t
 
x_ov”Ïp
 = 
f
->
glyph
[
i
].
xOff£t
 + f->glyph[i].
width
 - f->glyph[i].
xAdvªû
;

3101 ià(
x_ov”Ïp
 > 
maxx_ov”Ïp
) {

3102 
maxx_ov”Ïp
 = 
x_ov”Ïp
;

3103 
šdexx_max
 = 
i
;

3106 
S”Ÿl
.
	`´štf
("S‘ GFX FÚt(%x): Y: %d %d(%cè%d(%cèX: %d(%cè%d(%c)\n", (
ušt32_t
)
f
, f->
yAdvªû
,

3107 
mšy_off£t
, 
šdex_mš
 + 
f
->
fœ¡
, 
max_d–
, 
šdex_max
 + f->first,

3108 
mšx_off£t
, 
šdexx_mš
 + 
f
->
fœ¡
, 
maxx_ov”Ïp
, 
šdexx_max
 + f->first);

3110 
_gfxFÚt_mš_yOff£t
 = 
mšy_off£t
;

3112 } ià(
gfxFÚt
) {

3115 
cursÜ_y
 -= 6;

3117 
gfxFÚt
 = 
f
;

3118 
	}
}

3121 
ušt32_t
 
	$ãtchb™
(cÚ¡ 
ušt8_t
 *
p
, 
ušt32_t
 
šdex
) {

3122 ià(
p
[
šdex
 >> 3] & (1 << (7 - (index & 7))))  1;

3124 
	}
}

3126 
ušt32_t
 
	$ãtchb™s_unsigÃd
(cÚ¡ 
ušt8_t
 *
p
, 
ušt32_t
 
šdex
, ušt32_ˆ
»quœed
) {

3127 
ušt32_t
 
v®
 = 0;

3129 
ušt8_t
 
b
 = 
p
[
šdex
 >> 3];

3130 
ušt32_t
 
ava
 = 8 - (
šdex
 & 7);

3131 ià(
ava
 <ğ
»quœed
) {

3132 
v®
 <<ğ
ava
;

3133 
v®
 |ğ
b
 & ((1 << 
ava
) - 1);

3134 
šdex
 +ğ
ava
;

3135 
»quœed
 -ğ
ava
;

3137 
b
 >>ğ
ava
 - 
»quœed
;

3138 
v®
 <<ğ
»quœed
;

3139 
v®
 |ğ
b
 & ((1 << 
»quœed
) - 1);

3142 } 
»quœed
);

3143  
v®
;

3144 
	}
}

3146 
ušt32_t
 
	$ãtchb™s_sigÃd
(cÚ¡ 
ušt8_t
 *
p
, 
ušt32_t
 
šdex
, ušt32_ˆ
»quœed
) {

3147 
ušt32_t
 
v®
 = 
	`ãtchb™s_unsigÃd
(
p
, 
šdex
, 
»quœed
);

3148 ià(
v®
 & (1 << (
»quœed
 - 1))) {

3149  (
št32_t
)
v®
 - (1 << 
»quœed
);

3151  (
št32_t
)
v®
;

3152 
	}
}

3154 
ušt32_t
 
	gHX8357_t3n
::
	$ãtchpix–
(cÚ¡ 
ušt8_t
 *
p
, 
ušt32_t
 
šdex
, ušt32_ˆ
x
) {

3156 
ušt8_t
 
b
 = 
p
[
šdex
 >> 3];

3158 
ušt8_t
 
s
 = ((
fÚpb
 - (
x
 % fÚpbè- 1è* 
fÚtbµ
);

3160  (
b
 >> 
s
è& 
fÚtbµmask
;

3161 
	}
}

3163 
	gHX8357_t3n
::
	$d¿wFÚtCh¬
(
c
) {

3164 
ušt32_t
 
b™off£t
;

3165 cÚ¡ 
ušt8_t
 *
d©a
;

3169 ià(
c
 >ğ
fÚt
->
šdex1_fœ¡
 && c <ğfÚt->
šdex1_Ï¡
) {

3170 
b™off£t
 = 
c
 - 
fÚt
->
šdex1_fœ¡
;

3171 
b™off£t
 *ğ
fÚt
->
b™s_šdex
;

3172 } ià(
c
 >ğ
fÚt
->
šdex2_fœ¡
 && c <ğfÚt->
šdex2_Ï¡
) {

3173 
b™off£t
 = 
c
 - 
fÚt
->
šdex2_fœ¡
 + fÚt->
šdex1_Ï¡
 - fÚt->
šdex1_fœ¡
 + 1;

3174 
b™off£t
 *ğ
fÚt
->
b™s_šdex
;

3175 } ià(
fÚt
->
unicode
) {

3181 
d©a
 = 
fÚt
->d©¨+ 
	`ãtchb™s_unsigÃd
(fÚt->
šdex
, 
b™off£t
, fÚt->
b™s_šdex
);

3183 
ušt32_t
 
’codšg
 = 
	`ãtchb™s_unsigÃd
(
d©a
, 0, 3);

3184 ià(
’codšg
 != 0) ;

3185 
ušt32_t
 
width
 = 
	`ãtchb™s_unsigÃd
(
d©a
, 3, 
fÚt
->
b™s_width
);

3186 
b™off£t
 = 
fÚt
->
b™s_width
 + 3;

3187 
ušt32_t
 
height
 = 
	`ãtchb™s_unsigÃd
(
d©a
, 
b™off£t
, 
fÚt
->
b™s_height
);

3188 
b™off£t
 +ğ
fÚt
->
b™s_height
;

3192 
št32_t
 
xoff£t
 = 
	`ãtchb™s_sigÃd
(
d©a
, 
b™off£t
, 
fÚt
->
b™s_xoff£t
);

3193 
b™off£t
 +ğ
fÚt
->
b™s_xoff£t
;

3194 
št32_t
 
yoff£t
 = 
	`ãtchb™s_sigÃd
(
d©a
, 
b™off£t
, 
fÚt
->
b™s_yoff£t
);

3195 
b™off£t
 +ğ
fÚt
->
b™s_yoff£t
;

3198 
ušt32_t
 
d–
 = 
	`ãtchb™s_unsigÃd
(
d©a
, 
b™off£t
, 
fÚt
->
b™s_d–
);

3199 
b™off£t
 +ğ
fÚt
->
b™s_d–
;

3205 ià(
cursÜ_x
 < 0) cursor_x = 0;

3206 
št32_t
 
Üigš_x
 = 
cursÜ_x
 + 
xoff£t
;

3207 ià(
Üigš_x
 < 0) {

3208 
cursÜ_x
 -ğ
xoff£t
;

3209 
Üigš_x
 = 0;

3211 ià(
Üigš_x
 + ()
width
 > 
_width
) {

3212 ià(!
w¿p
) ;

3213 
Üigš_x
 = 0;

3214 ià(
xoff£t
 >= 0) {

3215 
cursÜ_x
 = 0;

3217 
cursÜ_x
 = -
xoff£t
;

3219 
cursÜ_y
 +ğ
fÚt
->
lše_¥aû
;

3221 ià(
w¿p
 && 
süŞlEÇbË
 && 
isWr™šgSüŞlA»a
 && ((
Üigš_x
 + ()
width
è> (
süŞl_x
 + 
süŞl_width
))) {

3222 
Üigš_x
 = 0;

3223 ià(
xoff£t
 >= 0) {

3224 
cursÜ_x
 = 
süŞl_x
;

3226 
cursÜ_x
 = -
xoff£t
;

3228 
cursÜ_y
 +ğ
fÚt
->
lše_¥aû
;

3231 ià(
süŞlEÇbË
 && 
isWr™šgSüŞlA»a
 && (
cursÜ_y
 > (
süŞl_y
 + 
süŞl_height
 - 
fÚt
->
ÿp_height
))) {

3232 
	`süŞlTextA»a
(
fÚt
->
lše_¥aû
);

3233 
cursÜ_y
 -ğ
fÚt
->
lše_¥aû
;

3234 
cursÜ_x
 = 
süŞl_x
;

3236 ià(
cursÜ_y
 >ğ
_height
) ;

3239 
št32_t
 
Üigš_y
 = 
cursÜ_y
 + 
fÚt
->
ÿp_height
 - 
height
 - 
yoff£t
;

3243 
št32_t
 
lšecouÁ
 = 
height
;

3245 
št32_t
 
y
 = 
Üigš_y
;

3246 
boŞ
 
İaque
 = (
‹xtbgcŞÜ
 !ğ
‹xtcŞÜ
);

3249 ià(!
İaque
) {

3252 ià(
fÚtbµ
 > 1) {

3258 
b™off£t
 = ((bitoffset + 7) & (-8));

3259 
ušt32_t
 
xp
 = 0;

3260 
ušt8_t
 
h®çÍha
 = 1 << (
fÚtbµ
 - 1);

3261 
lšecouÁ
) {

3262 
ušt32_t
 
x
 = 0;

3263 
x
 < 
width
) {

3265 ià(
	`ãtchpix–
(
d©a
, 
b™off£t
, 
xp
è>ğ
h®çÍha
) {

3266 
	`Pix–
(
Üigš_x
 + 
x
, 
y
, 
‹xtcŞÜ
);

3268 
b™off£t
 +ğ
fÚtbµ
;

3269 
x
++;

3270 
xp
++;

3272 
y
++;

3273 
lšecouÁ
--;

3280 
lšecouÁ
 > 0) {

3282 
ušt32_t
 
n
 = 1;

3283 ià(
	`ãtchb™
(
d©a
, 
b™off£t
++) != 0) {

3284 
n
 = 
	`ãtchb™s_unsigÃd
(
d©a
, 
b™off£t
, 3) + 2;

3285 
b™off£t
 += 3;

3287 
ušt32_t
 
x
 = 0;

3289 
št32_t
 
xsize
 = 
width
 - 
x
;

3290 ià(
xsize
 > 32) xsize = 32;

3291 
ušt32_t
 
b™s
 = 
	`ãtchb™s_unsigÃd
(
d©a
, 
b™off£t
, 
xsize
);

3293 
	`d¿wFÚtB™s
(
İaque
, 
b™s
, 
xsize
, 
Üigš_x
 + 
x
, 
y
, 
n
);

3294 
b™off£t
 +ğ
xsize
;

3295 
x
 +ğ
xsize
;

3296 } 
x
 < 
width
);

3299 
y
 +ğ
n
;

3300 
lšecouÁ
 -ğ
n
;

3316 
cursÜ_x_Üigš
 = 
cursÜ_x
 + 
_Üigšx
;

3317 
cursÜ_y_Üigš
 = 
cursÜ_y
 + 
_Üigšy
;

3318 
Üigš_x
 +ğ
_Üigšx
;

3319 
Üigš_y
 +ğ
_Üigšy
;

3321 
¡¬t_x
 = (
Üigš_x
 < 
cursÜ_x_Üigš
) ? origin_x : cursor_x_origin;

3322 ià(
¡¬t_x
 < 0) start_x = 0;

3324 
¡¬t_y
 = (
Üigš_y
 < 
cursÜ_y_Üigš
) ? origin_y : cursor_y_origin;

3325 ià(
¡¬t_y
 < 0) start_y = 0;

3326 
’d_x
 = 
cursÜ_x_Üigš
 + 
d–
;

3327 ià((
Üigš_x
 + ()
width
è> 
’d_x
)

3328 
’d_x
 = 
Üigš_x
 + ()
width
;

3329 ià(
’d_x
 >ğ
_di¥Ïyşx2
)ƒnd_x = _displayclipx2;

3330 
’d_y
 = 
cursÜ_y_Üigš
 + 
fÚt
->
lše_¥aû
;

3331 ià((
Üigš_y
 + ()
height
è> 
’d_y
)

3332 
’d_y
 = 
Üigš_y
 + ()
height
;

3333 ià(
’d_y
 >ğ
_di¥Ïyşy2
)ƒnd_y = _displayclipy2;

3334 
’d_x
--;

3335 
’d_y
--;

3336 
¡¬t_x_mš
 = (
¡¬t_x
 >ğ
_di¥Ïyşx1
) ? start_x : _displayclipx1;

3337 
¡¬t_y_mš
 = (
¡¬t_y
 >ğ
_di¥Ïyşy1
) ? start_y : _displayclipy1;

3340 ià((
’d_x
 < 
_di¥Ïyşx1
è|| (
¡¬t_x
 >ğ
_di¥Ïyşx2
è|| (
’d_y
 < 
_di¥Ïyşy1
è|| (
¡¬t_y
 >ğ
_di¥Ïyşy2
)) {

3341 
cursÜ_x
 +ğ
d–
;

3356 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


3357 ià(
_u£_fbtá
) {

3358 
	`upd©eChªgedRªge
(
¡¬t_x
, 
¡¬t_y
);

3359 
	`upd©eChªgedRªge
(
’d_x
, 
’d_y
);

3360 
ušt16_t
 *
pfbPix–_row
 = &
_pfbtá
[
¡¬t_y
 * 
_width
 + 
¡¬t_x
];

3361 
ušt16_t
 *
pfbPix–
;

3362 
sü“n_y
 = 
¡¬t_y
;

3363 
sü“n_x
;

3366 
sü“n_y
 < 
Üigš_y
) {

3367 
pfbPix–
 = 
pfbPix–_row
;

3369 ià((
sü“n_y
 >ğ
_di¥Ïyşy1
è&& (sü“n_y < 
_di¥Ïyşy2
)) {

3370 
sü“n_x
 = 
¡¬t_x
; sü“n_x <ğ
’d_x
; screen_x++) {

3371 ià(
sü“n_x
 >ğ
_di¥Ïyşx1
) {

3372 *
pfbPix–
 = 
‹xtbgcŞÜ
;

3374 
pfbPix–
++;

3377 
sü“n_y
++;

3378 
pfbPix–_row
 +ğ
_width
;

3382 ià(
fÚtbµ
 > 1) {

3383 
sü“n_y
 = 
Üigš_y
;

3384 
b™off£t
 = ((bitoffset + 7) & (-8));

3385 
ušt32_t
 
xp
 = 0;

3386 
glyph’d_x
 = 
Üigš_x
 + 
width
;

3387 
lšecouÁ
) {

3388 
pfbPix–
 = 
pfbPix–_row
;

3389 
sü“n_x
 = 
¡¬t_x
;

3390 
sü“n_x
 <ğ
’d_x
) {

3392 ià((
sü“n_x
 >ğ
_di¥Ïyşx1
è&& (sü“n_x < 
_di¥Ïyşx2
è&& (
sü“n_y
 >ğ
_di¥Ïyşy1
è&& (sü“n_y < 
_di¥Ïyşy2
)) {

3394 ià((
sü“n_x
 < 
Üigš_x
è|| (sü“n_x >ğ
glyph’d_x
)) {

3395 *
pfbPix–
 = 
‹xtbgcŞÜ
;

3399 
ušt8_t
 
®pha
 = 
	`ãtchpix–
(
d©a
, 
b™off£t
, 
xp
);

3400 *
pfbPix–
 = 
	`®phaBËndRGB565P»muÉl›d
(
‹xtcŞÜP»x·nded
, 
‹xtbgcŞÜP»x·nded
, (
ušt8_t
)(
®pha
 * 
fÚÍhamx
));

3401 
b™off£t
 +ğ
fÚtbµ
;

3402 
xp
++;

3405 
sü“n_x
++;

3406 
pfbPix–
++;

3408 
pfbPix–_row
 +ğ
_width
;

3409 
sü“n_y
++;

3410 
lšecouÁ
--;

3419 
sü“n_y
 = 
Üigš_y
;

3420 
lšecouÁ
 > 0) {

3422 
ušt32_t
 
b
 = 
	`ãtchb™
(
d©a
, 
b™off£t
++);

3423 
ušt32_t
 
n
;

3424 ià(
b
 == 0) {

3426 
n
 = 1;

3429 
n
 = 
	`ãtchb™s_unsigÃd
(
d©a
, 
b™off£t
, 3) + 2;

3430 
b™off£t
 += 3;

3432 
ušt32_t
 
b™off£t_row_¡¬t
 = 
b™off£t
;

3433 
n
--) {

3434 
pfbPix–
 = 
pfbPix–_row
;

3437 ià((
sü“n_y
 >ğ
_di¥Ïyşy1
è&& (sü“n_y < 
_di¥Ïyşy2
)) {

3438 
b™off£t
 = 
b™off£t_row_¡¬t
;

3439 
sü“n_x
 = 
¡¬t_x
; sü“n_x < 
Üigš_x
; screen_x++) {

3440 ià(
sü“n_x
 >ğ
_di¥Ïyşx1
) {

3441 *
pfbPix–
 = 
‹xtbgcŞÜ
;

3443 
pfbPix–
++;

3448 
sü“n_x
 = 
Üigš_x
;

3449 
ušt32_t
 
x
 = 0;

3451 
ušt32_t
 
xsize
 = 
width
 - 
x
;

3452 ià(
xsize
 > 32) xsize = 32;

3453 
ušt32_t
 
b™s
 = 
	`ãtchb™s_unsigÃd
(
d©a
, 
b™off£t
, 
xsize
);

3454 
ušt32_t
 
b™_mask
 = 1 << (
xsize
 - 1);

3456 ià((
sü“n_y
 >ğ
_di¥Ïyşy1
è&& (sü“n_y < 
_di¥Ïyşy2
)) {

3457 
b™_mask
 && (
sü“n_x
 <ğ
’d_x
)) {

3458 ià((
sü“n_x
 >ğ
_di¥Ïyşx1
è&& (sü“n_x < 
_di¥Ïyşx2
)) {

3459 *
pfbPix–
 = (
b™s
 & 
b™_mask
è? 
‹xtcŞÜ
 : 
‹xtbgcŞÜ
;

3461 
pfbPix–
++;

3462 
b™_mask
 = bit_mask >> 1;

3463 
sü“n_x
++;

3466 
b™off£t
 +ğ
xsize
;

3467 
x
 +ğ
xsize
;

3468 } 
x
 < 
width
);

3471 ià((
sü“n_y
 >ğ
_di¥Ïyşy1
è&& (sü“n_y < 
_di¥Ïyşy2
)) {

3473 
sü“n_x
++ <ğ
’d_x
) {

3474 *
pfbPix–
++ = 
‹xtbgcŞÜ
;

3477 
sü“n_y
++;

3478 
pfbPix–_row
 +ğ
_width
;

3479 
lšecouÁ
--;

3486 
sü“n_y
++ <ğ
’d_y
) {

3487 ià((
sü“n_y
 >ğ
_di¥Ïyşy1
è&& (sü“n_y < 
_di¥Ïyşy2
)) {

3488 
pfbPix–
 = 
pfbPix–_row
;

3489 
sü“n_x
 = 
¡¬t_x
; sü“n_x <ğ
’d_x
; screen_x++) {

3490 ià(
sü“n_x
 >ğ
_di¥Ïyşx1
) {

3491 *
pfbPix–
 = 
‹xtbgcŞÜ
;

3493 
pfbPix–
++;

3496 
pfbPix–_row
 +ğ
_width
;

3503 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

3506 
	`£tAddr
(
¡¬t_x
, 
¡¬t_y_mš
, 
’d_x
, 
’d_y
);

3507 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

3508 
sü“n_y
 = 
¡¬t_y_mš
;

3509 
sü“n_x
;

3512 
sü“n_y
 < 
Üigš_y
) {

3513 
sü“n_x
 = 
¡¬t_x_mš
; sü“n_x <ğ
’d_x
; screen_x++) {

3514 
	`wr™ed©a16_cÚt
(
‹xtbgcŞÜ
);

3516 
sü“n_y
++;

3520 ià(
fÚtbµ
 > 1) {

3521 
sü“n_y
 = 
Üigš_y
;

3522 
b™off£t
 = ((bitoffset + 7) & (-8));

3523 
glyph’d_x
 = 
Üigš_x
 + 
width
;

3524 
ušt32_t
 
xp
 = 0;

3525 
lšecouÁ
) {

3526 
sü“n_x
 = 
¡¬t_x
;

3527 
sü“n_x
 <ğ
’d_x
) {

3529 ià((
sü“n_x
 >ğ
_di¥Ïyşx1
è&& (sü“n_x < 
_di¥Ïyşx2
è&& (
sü“n_y
 >ğ
_di¥Ïyşy1
è&& (sü“n_y < 
_di¥Ïyşy2
)) {

3531 ià((
sü“n_x
 < 
Üigš_x
è|| (sü“n_x >ğ
glyph’d_x
)) {

3532 
	`wr™ed©a16_cÚt
(
‹xtbgcŞÜ
);

3536 
ušt8_t
 
®pha
 = 
	`ãtchpix–
(
d©a
, 
b™off£t
, 
xp
);

3537 
	`wr™ed©a16_cÚt
(
	`®phaBËndRGB565P»muÉl›d
(
‹xtcŞÜP»x·nded
, 
‹xtbgcŞÜP»x·nded
, (
ušt8_t
)(
®pha
 * 
fÚÍhamx
)));

3538 
b™off£t
 +ğ
fÚtbµ
;

3539 
xp
++;

3542 
sü“n_x
++;

3544 
sü“n_y
++;

3545 
lšecouÁ
--;

3554 
sü“n_y
 = 
Üigš_y
;

3555 
lšecouÁ
 > 0) {

3557 
ušt32_t
 
b
 = 
	`ãtchb™
(
d©a
, 
b™off£t
++);

3558 
ušt32_t
 
n
;

3559 ià(
b
 == 0) {

3561 
n
 = 1;

3564 
n
 = 
	`ãtchb™s_unsigÃd
(
d©a
, 
b™off£t
, 3) + 2;

3565 
b™off£t
 += 3;

3567 
ušt32_t
 
b™off£t_row_¡¬t
 = 
b™off£t
;

3568 
n
--) {

3570 
b™off£t
 = 
b™off£t_row_¡¬t
;

3574 ià((
sü“n_y
 >ğ
_di¥Ïyşy1
è&& (sü“n_y < 
_di¥Ïyşy2
)) {

3575 
sü“n_x
 = 
¡¬t_x
; sü“n_x < 
Üigš_x
; screen_x++) {

3576 ià((
sü“n_x
 >ğ
_di¥Ïyşx1
è&& (sü“n_x < 
_di¥Ïyşx2
)) {

3578 
	`wr™ed©a16_cÚt
(
‹xtbgcŞÜ
);

3582 
ušt32_t
 
x
 = 0;

3583 
sü“n_x
 = 
Üigš_x
;

3585 
ušt32_t
 
xsize
 = 
width
 - 
x
;

3586 ià(
xsize
 > 32) xsize = 32;

3587 
ušt32_t
 
b™s
 = 
	`ãtchb™s_unsigÃd
(
d©a
, 
b™off£t
, 
xsize
);

3588 
ušt32_t
 
b™_mask
 = 1 << (
xsize
 - 1);

3590 ià((
sü“n_y
 >ğ
_di¥Ïyşy1
è&& (sü“n_y < 
_di¥Ïyşy2
)) {

3591 
b™_mask
) {

3592 ià((
sü“n_x
 >ğ
_di¥Ïyşx1
è&& (sü“n_x < 
_di¥Ïyşx2
)) {

3593 
	`wr™ed©a16_cÚt
((
b™s
 & 
b™_mask
è? 
‹xtcŞÜ
 : 
‹xtbgcŞÜ
);

3596 
b™_mask
 = bit_mask >> 1;

3597 
sü“n_x
++;

3600 
b™off£t
 +ğ
xsize
;

3602 
x
 +ğ
xsize
;

3603 } 
x
 < 
width
);

3604 ià((
sü“n_y
 >ğ
_di¥Ïyşy1
è&& (sü“n_y < 
_di¥Ïyşy2
)) {

3606 
sü“n_x
++ <ğ
’d_x
) {

3607 
	`wr™ed©a16_cÚt
(
‹xtbgcŞÜ
);

3612 
sü“n_y
++;

3613 
lšecouÁ
--;

3619 
sü“n_x
 = (
’d_y
 + 1 - 
sü“n_y
è* (
’d_x
 + 1 - 
¡¬t_x_mš
);

3621 
sü“n_x
-- > 1) {

3622 
	`wr™ed©a16_cÚt
(
‹xtbgcŞÜ
);

3624 
	`wr™ed©a16_Ï¡
(
‹xtbgcŞÜ
);

3625 
	`’dSPIT¿n§ùiÚ
();

3629 
cursÜ_x
 +ğ
d–
;

3630 
	}
}

3633 
št16_t
 
	gHX8357_t3n
::
	$¡rPix–L’
(cÚ¡ *
¡r
, 
ušt16_t
 
cb
) {

3635 ià(!
¡r
)  (0);

3636 ià(
gfxFÚt
) {

3638 
št16_t
 
x
, 
y
;

3639 
ušt16_t
 
w
, 
h
;

3640 ià(
cb
 =ğ0xffffè
	`g‘TextBounds
(
¡r
, 
cursÜ_x
, 
cursÜ_y
, &
x
, &
y
, &
w
, &
h
);

3641 
	`g‘TextBounds
((cÚ¡ 
ušt8_t
 *)
¡r
, 
cb
, 
cursÜ_x
, 
cursÜ_y
, &
x
, &
y
, &
w
, &
h
);

3642  
w
;

3645 
ušt16_t
 
Ën
 = 0, 
maxËn
 = 0;

3646 *
¡r
 && 
cb
) {

3647 ià(*
¡r
 == '\n') {

3648 ià(
Ën
 > 
maxËn
) {

3649 
maxËn
 = 
Ën
;

3650 
Ën
 = 0;

3653 ià(!
fÚt
) {

3654 
Ën
 +ğ
‹xtsize_x
 * 6;

3657 
ušt32_t
 
b™off£t
;

3658 cÚ¡ 
ušt8_t
 *
d©a
;

3659 
ušt16_t
 
c
 = *
¡r
;

3663 ià(
c
 >ğ
fÚt
->
šdex1_fœ¡
 && c <ğfÚt->
šdex1_Ï¡
) {

3664 
b™off£t
 = 
c
 - 
fÚt
->
šdex1_fœ¡
;

3665 
b™off£t
 *ğ
fÚt
->
b™s_šdex
;

3666 } ià(
c
 >ğ
fÚt
->
šdex2_fœ¡
 && c <ğfÚt->
šdex2_Ï¡
) {

3667 
b™off£t
 = 
c
 - 
fÚt
->
šdex2_fœ¡
 + fÚt->
šdex1_Ï¡
 - fÚt->
šdex1_fœ¡
 + 1;

3668 
b™off£t
 *ğ
fÚt
->
b™s_šdex
;

3669 } ià(
fÚt
->
unicode
) {

3675 
d©a
 = 
fÚt
->d©¨+ 
	`ãtchb™s_unsigÃd
(fÚt->
šdex
, 
b™off£t
, fÚt->
b™s_šdex
);

3677 
ušt32_t
 
’codšg
 = 
	`ãtchb™s_unsigÃd
(
d©a
, 0, 3);

3678 ià(
’codšg
 != 0) ;

3681 
b™off£t
 = 
fÚt
->
b™s_width
 + 3;

3682 
b™off£t
 +ğ
fÚt
->
b™s_height
;

3686 
b™off£t
 +ğ
fÚt
->
b™s_xoff£t
;

3687 
b™off£t
 +ğ
fÚt
->
b™s_yoff£t
;

3689 
ušt32_t
 
d–
 = 
	`ãtchb™s_unsigÃd
(
d©a
, 
b™off£t
, 
fÚt
->
b™s_d–
);

3690 
b™off£t
 +ğ
fÚt
->
b™s_d–
;

3693 
Ën
 +ğ
d–
;

3697 ià(
Ën
 > 
maxËn
) {

3698 
maxËn
 = 
Ën
;

3702 
¡r
++;

3705  (
maxËn
);

3706 
	}
}

3708 
	gHX8357_t3n
::
	$ch¬Bounds
(
c
, 
št16_t
 *
x
, iÁ16_ˆ*
y
,

3709 
št16_t
 *
mšx
, iÁ16_ˆ*
mšy
, iÁ16_ˆ*
maxx
, iÁ16_ˆ*
maxy
) {

3712 ià(
fÚt
) {

3713 ià(
c
 == '\n') {

3714 *
x
 = 0;

3715 *
y
 +ğ
fÚt
->
lše_¥aû
;

3716 } ià(
c
 != '\r') {

3717 
ušt32_t
 
b™off£t
;

3718 cÚ¡ 
ušt8_t
 *
d©a
;

3719 ià(
c
 >ğ
fÚt
->
šdex1_fœ¡
 && c <ğfÚt->
šdex1_Ï¡
) {

3720 
b™off£t
 = 
c
 - 
fÚt
->
šdex1_fœ¡
;

3721 
b™off£t
 *ğ
fÚt
->
b™s_šdex
;

3722 } ià(
c
 >ğ
fÚt
->
šdex2_fœ¡
 && c <ğfÚt->
šdex2_Ï¡
) {

3723 
b™off£t
 = 
c
 - 
fÚt
->
šdex2_fœ¡
 + fÚt->
šdex1_Ï¡
 - fÚt->
šdex1_fœ¡
 + 1;

3724 
b™off£t
 *ğ
fÚt
->
b™s_šdex
;

3725 } ià(
fÚt
->
unicode
) {

3731 
d©a
 = 
fÚt
->d©¨+ 
	`ãtchb™s_unsigÃd
(fÚt->
šdex
, 
b™off£t
, fÚt->
b™s_šdex
);

3733 
ušt32_t
 
’codšg
 = 
	`ãtchb™s_unsigÃd
(
d©a
, 0, 3);

3734 ià(
’codšg
 != 0) ;

3735 
ušt32_t
 
width
 = 
	`ãtchb™s_unsigÃd
(
d©a
, 3, 
fÚt
->
b™s_width
);

3736 
b™off£t
 = 
fÚt
->
b™s_width
 + 3;

3737 
ušt32_t
 
height
 = 
	`ãtchb™s_unsigÃd
(
d©a
, 
b™off£t
, 
fÚt
->
b™s_height
);

3738 
b™off£t
 +ğ
fÚt
->
b™s_height
;

3742 
št32_t
 
xoff£t
 = 
	`ãtchb™s_sigÃd
(
d©a
, 
b™off£t
, 
fÚt
->
b™s_xoff£t
);

3743 
b™off£t
 +ğ
fÚt
->
b™s_xoff£t
;

3744 
št32_t
 
yoff£t
 = 
	`ãtchb™s_sigÃd
(
d©a
, 
b™off£t
, 
fÚt
->
b™s_yoff£t
);

3745 
b™off£t
 +ğ
fÚt
->
b™s_yoff£t
;

3747 
ušt32_t
 
d–
 = 
	`ãtchb™s_unsigÃd
(
d©a
, 
b™off£t
, 
fÚt
->
b™s_d–
);

3748 
b™off£t
 +ğ
fÚt
->
b™s_d–
;

3750 
št16_t


3751 
x1
 = *
x
 + 
xoff£t
,

3752 
y1
 = *
y
 + 
fÚt
->
ÿp_height
 - 
height
 - 
yoff£t
,

3753 
x2
 = 
x1
 + 
width
,

3754 
y2
 = 
y1
 + 
height
;

3756 ià(
w¿p
 && (
x2
 > 
_width
)) {

3757 *
x
 = 0;

3758 *
y
 +ğ
fÚt
->
lše_¥aû
;

3759 
x1
 = *
x
 + 
xoff£t
,

3760 
y1
 = *
y
 + 
yoff£t
,

3761 
x2
 = 
x1
 + 
width
,

3762 
y2
 = 
y1
 + 
height
;

3764 ià(
x1
 < *
mšx
) *minx = x1;

3765 ià(
y1
 < *
mšy
) *miny = y1;

3766 ià(
x2
 > *
maxx
) *maxx = x2;

3767 ià(
y2
 > *
maxy
) *maxy = y2;

3768 *
x
 +ğ
d–
;

3772 ià(
gfxFÚt
) {

3774 ià(
c
 == '\n') {

3775 *
x
 = 0;

3776 *
y
 +ğ
‹xtsize_y
 * 
gfxFÚt
->
yAdvªû
;

3777 } ià(
c
 != '\r') {

3778 
ušt8_t
 
fœ¡
 = 
gfxFÚt
->first,

3779 
Ï¡
 = 
gfxFÚt
->last;

3780 ià((
c
 >ğ
fœ¡
è&& (ø<ğ
Ï¡
)) {

3781 
GFXglyph
 *
glyph
 = 
gfxFÚt
->glyph + (
c
 - 
fœ¡
);

3782 
ušt8_t
 
gw
 = 
glyph
->
width
,

3783 
gh
 = 
glyph
->
height
,

3784 
xa
 = 
glyph
->
xAdvªû
;

3785 
št8_t
 
xo
 = 
glyph
->
xOff£t
,

3786 
yo
 = 
glyph
->
yOff£t
 + 
gfxFÚt
->
yAdvªû
 / 2;

3787 ià(
w¿p
 && ((*
x
 + (((
št16_t
)
xo
 + 
gw
è* 
‹xtsize_x
)è> 
_width
)) {

3788 *
x
 = 0;

3789 *
y
 +ğ
‹xtsize_y
 * 
gfxFÚt
->
yAdvªû
;

3791 
št16_t
 
tsx
 = (št16_t)
‹xtsize_x
,

3792 
tsy
 = (
št16_t
)
‹xtsize_y
,

3793 
x1
 = *
x
 + 
xo
 * 
tsx
,

3794 
y1
 = *
y
 + 
yo
 * 
tsy
,

3795 
x2
 = 
x1
 + 
gw
 * 
tsx
 - 1,

3796 
y2
 = 
y1
 + 
gh
 * 
tsy
 - 1;

3797 ià(
x1
 < *
mšx
) *minx = x1;

3798 ià(
y1
 < *
mšy
) *miny = y1;

3799 ià(
x2
 > *
maxx
) *maxx = x2;

3800 ià(
y2
 > *
maxy
) *maxy = y2;

3801 *
x
 +ğ
xa
 * 
tsx
;

3807 ià(
c
 == '\n') {

3808 *
x
 = 0;

3809 *
y
 +ğ
‹xtsize_y
 * 8;

3811 } ià(
c
 != '\r') {

3812 ià(
w¿p
 && ((*
x
 + 
‹xtsize_x
 * 6è> 
_width
)) {

3813 *
x
 = 0;

3814 *
y
 +ğ
‹xtsize_y
 * 8;

3816 
x2
 = *
x
 + 
‹xtsize_x
 * 6 - 1,

3817 
y2
 = *
y
 + 
‹xtsize_y
 * 8 - 1;

3818 ià(
x2
 > *
maxx
) *maxx = x2;

3819 ià(
y2
 > *
maxy
) *maxy = y2;

3820 ià(*
x
 < *
mšx
) *minx = *x;

3821 ià(*
y
 < *
mšy
) *miny = *y;

3822 *
x
 +ğ
‹xtsize_x
 * 6;

3825 
	}
}

3828 
	gHX8357_t3n
::
	$g‘TextBounds
(cÚ¡ 
ušt8_t
 *
bufãr
, 
ušt16_t
 
Ën
, 
št16_t
 
x
, iÁ16_ˆ
y
,

3829 
št16_t
 *
x1
, iÁ16_ˆ*
y1
, 
ušt16_t
 *
w
, ušt16_ˆ*
h
) {

3830 *
x1
 = 
x
;

3831 *
y1
 = 
y
;

3832 *
w
 = *
h
 = 0;

3834 
št16_t
 
mšx
 = 
_width
, 
mšy
 = 
_height
, 
maxx
 = -1, 
maxy
 = -1;

3836 
Ën
--)

3837 
	`ch¬Bounds
(*
bufãr
++, &
x
, &
y
, &
mšx
, &
mšy
, &
maxx
, &
maxy
);

3839 ià(
maxx
 >ğ
mšx
) {

3840 *
x1
 = 
mšx
;

3841 *
w
 = 
maxx
 - 
mšx
 + 1;

3843 ià(
maxy
 >ğ
mšy
) {

3844 *
y1
 = 
mšy
;

3845 *
h
 = 
maxy
 - 
mšy
 + 1;

3847 
	}
}

3849 
	gHX8357_t3n
::
	$g‘TextBounds
(cÚ¡ *
¡r
, 
št16_t
 
x
, iÁ16_ˆ
y
,

3850 
št16_t
 *
x1
, iÁ16_ˆ*
y1
, 
ušt16_t
 *
w
, ušt16_ˆ*
h
) {

3851 
ušt8_t
 
c
;

3853 *
x1
 = 
x
;

3854 *
y1
 = 
y
;

3855 *
w
 = *
h
 = 0;

3857 
št16_t
 
mšx
 = 
_width
, 
mšy
 = 
_height
, 
maxx
 = -1, 
maxy
 = -1;

3859 (
c
 = *
¡r
++))

3860 
	`ch¬Bounds
(
c
, &
x
, &
y
, &
mšx
, &
mšy
, &
maxx
, &
maxy
);

3862 ià(
maxx
 >ğ
mšx
) {

3863 *
x1
 = 
mšx
;

3864 *
w
 = 
maxx
 - 
mšx
 + 1;

3866 ià(
maxy
 >ğ
mšy
) {

3867 *
y1
 = 
mšy
;

3868 *
h
 = 
maxy
 - 
mšy
 + 1;

3870 
	}
}

3872 
	gHX8357_t3n
::
	$g‘TextBounds
(cÚ¡ 
SŒšg
 &
¡r
, 
št16_t
 
x
, iÁ16_ˆ
y
,

3873 
št16_t
 *
x1
, iÁ16_ˆ*
y1
, 
ušt16_t
 *
w
, ušt16_ˆ*
h
) {

3874 ià(
¡r
.
	`Ëngth
() != 0) {

3875 
	`g‘TextBounds
(
cÚ¡_ÿ¡
<*>(
¡r
.
	`c_¡r
()), 
x
, 
y
, 
x1
, 
y1
, 
w
, 
h
);

3877 
	}
}

3880 
	gHX8357_t3n
::
	$d¿wFÚtPix–
(
ušt8_t
 
®pha
, 
ušt32_t
 
x
, ušt32_ˆ
y
) {

3883 
®pha
 = (
ušt8_t
)×Íh¨* 
fÚÍhamx
);

3884 
ušt32_t
 
»suÉ
 = ((((
‹xtcŞÜP»x·nded
 - 
‹xtbgcŞÜP»x·nded
è* 
®pha
) >> 5) +extbgcolorPrexpanded) & 0b00000111111000001111100000011111;

3885 
	`Pix–
(
x
, 
y
, (
ušt16_t
)((
»suÉ
 >> 16) |„esult));

3886 
	}
}

3888 
	gHX8357_t3n
::
	$d¿wFÚtB™s
(
boŞ
 
İaque
, 
ušt32_t
 
b™s
, ušt32_ˆ
numb™s
, 
št32_t
 
x
, iÁ32_ˆ
y
, ušt32_ˆ
»³©
) {

3889 ià(
b™s
 == 0) {

3890 ià(
İaque
) {

3891 
	`flReù
(
x
, 
y
, 
numb™s
, 
»³©
, 
‹xtbgcŞÜ
);

3894 
št32_t
 
x1
 = 
x
;

3895 
ušt32_t
 
n
 = 
numb™s
;

3896 
w
;

3897 
bgw
;

3899 
w
 = 0;

3900 
bgw
 = 0;

3903 
n
--;

3904 ià(
b™s
 & (1 << 
n
)) {

3905 ià(
bgw
 > 0) {

3906 ià(
İaque
) {

3907 
	`flReù
(
x1
 - 
bgw
, 
y
, bgw, 
»³©
, 
‹xtbgcŞÜ
);

3909 
bgw
 = 0;

3911 
w
++;

3913 ià(
w
 > 0) {

3914 
	`flReù
(
x1
 - 
w
, 
y
, w, 
»³©
, 
‹xtcŞÜ
);

3915 
w
 = 0;

3917 
bgw
++;

3919 
x1
++;

3920 } 
n
 > 0);

3922 ià(
w
 > 0) {

3923 
	`flReù
(
x1
 - 
w
, 
y
, w, 
»³©
, 
‹xtcŞÜ
);

3926 ià(
bgw
 > 0) {

3927 ià(
İaque
) {

3928 
	`flReù
(
x1
 - 
bgw
, 
y
, bgw, 
»³©
, 
‹xtbgcŞÜ
);

3932 
	}
}

3934 
	gHX8357_t3n
::
	$d¿wGFXFÚtCh¬
(
c
) {

3936 ià(
c
 == '\r') ;

3939 
ušt8_t
 
fœ¡
 = 
gfxFÚt
->first;

3940 ià((
c
 < 
fœ¡
è|| (ø> 
gfxFÚt
->
Ï¡
)) ;

3942 
GFXglyph
 *
glyph
 = 
gfxFÚt
->glyph + (
c
 - 
fœ¡
);

3943 
ušt8_t
 
w
 = 
glyph
->
width
,

3944 
h
 = 
glyph
->
height
;

3946 ià((
w
 =ğ0 || 
h
 =ğ0è&& (
c
 != 32)) ;

3948 
št16_t
 
xo
 = 
glyph
->
xOff£t
;

3949 
št16_t
 
yo
 = 
glyph
->
yOff£t
 + 
gfxFÚt
->
yAdvªû
 / 2;

3951 ià(
w¿p
 && ((
cursÜ_x
 + 
‹xtsize_x
 * (
xo
 + 
w
)è> 
_width
)) {

3952 
cursÜ_x
 = 0;

3953 
cursÜ_y
 +ğ(
št16_t
)
‹xtsize_y
 * 
gfxFÚt
->
yAdvªû
;

3957 
ušt8_t
 *
b™m­
 = 
gfxFÚt
->bitmap;

3959 
ušt16_t
 
bo
 = 
glyph
->
b™m­Off£t
;

3960 
ušt8_t
 
xx
, 
yy
, 
b™s
 = 0, 
b™
 = 0;

3964 ià(
‹xtcŞÜ
 =ğ
‹xtbgcŞÜ
) {

3976 
yy
 = 0; yy < 
h
; yy++) {

3977 
ušt8_t
 
w_Ëá
 = 
w
;

3978 
xx
 = 0;

3979 
w_Ëá
) {

3980 ià(!(
b™
 & 7)) {

3981 
b™s
 = 
b™m­
[
bo
++];

3984 
ušt8_t
 
xCouÁ
;

3985 ià((
w_Ëá
 >ğ8è&& ((
b™s
 & 0xff) == 0xff)) {

3986 
xCouÁ
 = 8;

3988 
	`flReù
(
cursÜ_x
 + (
xo
 + 
xx
è* 
‹xtsize_x
, 
cursÜ_y
 + (
yo
 + 
yy
è* 
‹xtsize_y
,

3989 
xCouÁ
 * 
‹xtsize_x
, 
‹xtsize_y
, 
‹xtcŞÜ
);

3990 } ià((
w_Ëá
 >ğ4è&& ((
b™s
 & 0xf0) == 0xf0)) {

3991 
xCouÁ
 = 4;

3993 
	`flReù
(
cursÜ_x
 + (
xo
 + 
xx
è* 
‹xtsize_x
, 
cursÜ_y
 + (
yo
 + 
yy
è* 
‹xtsize_y
,

3994 
xCouÁ
 * 
‹xtsize_x
, 
‹xtsize_y
, 
‹xtcŞÜ
);

3995 } ià((
w_Ëá
 >ğ3è&& ((
b™s
 & 0xe0) == 0xe0)) {

3997 
xCouÁ
 = 3;

3998 
	`flReù
(
cursÜ_x
 + (
xo
 + 
xx
è* 
‹xtsize_x
, 
cursÜ_y
 + (
yo
 + 
yy
è* 
‹xtsize_y
,

3999 
xCouÁ
 * 
‹xtsize_x
, 
‹xtsize_y
, 
‹xtcŞÜ
);

4000 } ià((
w_Ëá
 >ğ2è&& ((
b™s
 & 0xc0) == 0xc0)) {

4002 
xCouÁ
 = 2;

4003 
	`flReù
(
cursÜ_x
 + (
xo
 + 
xx
è* 
‹xtsize_x
, 
cursÜ_y
 + (
yo
 + 
yy
è* 
‹xtsize_y
,

4004 
xCouÁ
 * 
‹xtsize_x
, 
‹xtsize_y
, 
‹xtcŞÜ
);

4006 
xCouÁ
 = 1;

4007 ià(
b™s
 & 0x80) {

4008 ià((
‹xtsize_x
 =ğ1è&& (
‹xtsize_y
 == 1)) {

4009 
	`d¿wPix–
(
cursÜ_x
 + 
xo
 + 
xx
, 
cursÜ_y
 + 
yo
 + 
yy
, 
‹xtcŞÜ
);

4011 
	`flReù
(
cursÜ_x
 + (
xo
 + 
xx
è* 
‹xtsize_x
, 
cursÜ_y
 + (
yo
 + 
yy
è* 
‹xtsize_y
,

4012 
‹xtsize_x
, 
‹xtsize_y
, 
‹xtcŞÜ
);

4016 
xx
 +ğ
xCouÁ
;

4017 
w_Ëá
 -ğ
xCouÁ
;

4018 
b™
 +ğ
xCouÁ
;

4019 
b™s
 <<ğ
xCouÁ
;

4022 
_gfx_Ï¡_ch¬_x_wr™e
 = 0;

4030 
št16_t
 
x_off£t_cursÜ
 = 
cursÜ_x
 + 
_Üigšx
;

4031 
št16_t
 
x_¡¬t
 = 
x_off£t_cursÜ
;

4032 
št16_t
 
x_’d
 = 
x_off£t_cursÜ
 + (
glyph
->
xAdvªû
 * 
‹xtsize_x
);

4033 ià(
glyph
->
xAdvªû
 < (
xo
 + 
w
)è
x_’d
 = 
x_off£t_cursÜ
 + ((xØ+ wè* 
‹xtsize_x
);

4034 
št16_t
 
x_Ëá_fl
 = 
x_off£t_cursÜ
 + 
xo
 * 
‹xtsize_x
;

4035 
št16_t
 
x
;

4037 ià(
xo
 < 0) {

4040 
x_¡¬t
 +ğ
xo
 * 
‹xtsize_x
;

4041 
x_Ëá_fl
 = 0;

4044 
št16_t
 
y_¡¬t
 = 
cursÜ_y
 + 
_Üigšy
 + (
_gfxFÚt_mš_yOff£t
 * 
‹xtsize_y
è+ 
gfxFÚt
->
yAdvªû
 *extsize_y / 2;

4045 
št16_t
 
y_’d
 = 
y_¡¬t
 + 
gfxFÚt
->
yAdvªû
 * 
‹xtsize_y
;

4046 
št16_t
 
y
 = 
y_¡¬t
;

4048 
št8_t
 
y_tİ_fl
 = (
yo
 - 
gfxFÚt
->
yAdvªû
 / 2 - 
_gfxFÚt_mš_yOff£t
è* 
‹xtsize_y
;

4051 ià((
x_¡¬t
 >ğ
_di¥Ïyşx2
) ||

4052 (
y_¡¬t
 >ğ
_di¥Ïyşy2
) ||

4053 (
x_’d
 < 
_di¥Ïyşx1
) ||

4054 (
y_’d
 < 
_di¥Ïyşy1
))

4057 
cursÜ_x
 +ğ
glyph
->
xAdvªû
 * (
št16_t
)
‹xtsize_x
;

4062 ià(
y_’d
 > 
_di¥Ïyşy2
) y_end = _displayclipy2;

4063 ià(
x_’d
 > 
_di¥Ïyşx2
) x_end = _displayclipx2;

4066 ià(
_gfx_Ï¡_cursÜ_y
 !ğ(
cursÜ_y
 + 
_Üigšy
)è
_gfx_Ï¡_ch¬_x_wr™e
 = 0;

4068 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


4069 ià(
_u£_fbtá
) {

4071 
	`upd©eChªgedRªge
(
x_¡¬t
, 
y_¡¬t
);

4072 
	`upd©eChªgedRªge
(
x_’d
, 
y_’d
);

4073 
ušt16_t
 *
pfbPix–_row
 = &
_pfbtá
[
y_¡¬t
 * 
_width
 + 
x_¡¬t
];

4074 
ušt16_t
 *
pfbPix–
;

4076 
y_tİ_fl
--) {

4077 
pfbPix–
 = 
pfbPix–_row
;

4078 ià((
y
 >ğ
_di¥Ïyşy1
è&& (y < 
_di¥Ïyşy2
)) {

4079 
št16_t
 
xx
 = 
x_¡¬t
; xx < 
x_’d
; xx++) {

4080 ià((
xx
 >ğ
_di¥Ïyşx1
è&& (xx >ğ
x_off£t_cursÜ
)) {

4081 ià((
xx
 >ğ
_gfx_Ï¡_ch¬_x_wr™e
è|| (*
pfbPix–
 !ğ
_gfx_Ï¡_ch¬_‹xtcŞÜ
))

4082 *
pfbPix–
 = 
‹xtbgcŞÜ
;

4084 
pfbPix–
++;

4087 
pfbPix–_row
 +ğ
_width
;

4088 
y
++;

4091 
yy
 = 0; (yy < 
h
è&& (
y
 < 
_di¥Ïyşy2
); yy++) {

4092 
ušt16_t
 
bo_§ve
 = 
bo
;

4093 
ušt8_t
 
b™_§ve
 = 
b™
;

4094 
ušt8_t
 
b™s_§ve
 = 
b™s
;

4095 
ušt8_t
 
yts
 = 0; (yt < 
‹xtsize_y
è&& (
y
 < 
_di¥Ïyşy2
); yts++) {

4096 
pfbPix–
 = 
pfbPix–_row
;

4098 
bo
 = 
bo_§ve
;

4099 
b™
 = 
b™_§ve
;

4100 
b™s
 = 
b™s_§ve
;

4101 
x
 = 
x_¡¬t
;

4102 ià(
y
 >ğ
_di¥Ïyşy1
) {

4103 
x
 < 
x_Ëá_fl
) {

4104 ià((
x
 >ğ
_di¥Ïyşx1
è&& (x < 
_di¥Ïyşx2
)) {

4105 ià((
x
 >ğ
_gfx_Ï¡_ch¬_x_wr™e
è|| (*
pfbPix–
 !ğ
_gfx_Ï¡_ch¬_‹xtcŞÜ
))

4106 *
pfbPix–
 = 
‹xtbgcŞÜ
;

4108 
pfbPix–
++;

4109 
x
++;

4111 
xx
 = 0; xx < 
w
; xx++) {

4112 ià(!(
b™
++ & 7)) {

4113 
b™s
 = 
b™m­
[
bo
++];

4115 
ušt8_t
 
xts
 = 0; xt < 
‹xtsize_x
; xts++) {

4116 ià((
x
 >ğ
_di¥Ïyşx1
è&& (x < 
_di¥Ïyşx2
)) {

4117 ià(
b™s
 & 0x80)

4118 *
pfbPix–
 = 
‹xtcŞÜ
;

4119 ià(
x
 >ğ
x_off£t_cursÜ
) {

4120 ià((
x
 >ğ
_gfx_Ï¡_ch¬_x_wr™e
è|| (*
pfbPix–
 !ğ
_gfx_Ï¡_ch¬_‹xtcŞÜ
))

4121 *
pfbPix–
 = 
‹xtbgcŞÜ
;

4124 
pfbPix–
++;

4125 
x
++;

4127 
b™s
 <<= 1;

4130 
x
++ < 
x_’d
) {

4131 ià(
x
 >ğ
_di¥Ïyşx1
) {

4132 *
pfbPix–
 = 
‹xtbgcŞÜ
;

4134 
pfbPix–
++;

4137 
y
++;

4138 
pfbPix–_row
 +ğ
_width
;

4142 
y
 < 
y_’d
) {

4143 ià(
y
 >ğ
_di¥Ïyşy1
) {

4144 
pfbPix–
 = 
pfbPix–_row
;

4145 
št16_t
 
xx
 = 
x_¡¬t
; xx < 
x_’d
; xx++) {

4146 ià((
xx
 >ğ
_di¥Ïyşx1
è&& (xx >ğ
x_off£t_cursÜ
)) {

4147 ià((
xx
 >ğ
_gfx_Ï¡_ch¬_x_wr™e
è|| (*
pfbPix–
 !ğ
_gfx_Ï¡_ch¬_‹xtcŞÜ
))

4148 *
pfbPix–
 = 
‹xtbgcŞÜ
;

4150 
pfbPix–
++;

4153 
pfbPix–_row
 +ğ
_width
;

4154 
y
++;

4163 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

4165 
	`£tAddr
((
x_¡¬t
 >ğ
_di¥Ïyşx1
) ? x_start : _displayclipx1,

4166 (
y_¡¬t
 >ğ
_di¥Ïyşy1
) ? y_start : _displayclipy1,

4167 
x_’d
 - 1, 
y_’d
 - 1);

4168 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

4174 
y_tİ_fl
--) {

4175 ià((
y
 >ğ
_di¥Ïyşy1
è&& (y < 
_di¥Ïyşy2
)) {

4176 
št16_t
 
xx
 = 
x_¡¬t
; xx < 
x_’d
; xx++) {

4177 ià(
xx
 >ğ
_di¥Ïyşx1
) {

4178 
	`wr™ed©a16_cÚt
(
	`gfxFÚtLa¡Ch¬PosFG
(
xx
, 
y
è? 
_gfx_Ï¡_ch¬_‹xtcŞÜ
 : (xx < 
x_off£t_cursÜ
è? 
_gfx_Ï¡_ch¬_‹xtbgcŞÜ


4179 : 
‹xtbgcŞÜ
);

4183 
y
++;

4187 
yy
 = 0; (yy < 
h
è&& (
y
 < 
_di¥Ïyşy2
); yy++) {

4188 
ušt16_t
 
bo_§ve
 = 
bo
;

4189 
ušt8_t
 
b™_§ve
 = 
b™
;

4190 
ušt8_t
 
b™s_§ve
 = 
b™s
;

4191 
ušt8_t
 
yts
 = 0; (yt < 
‹xtsize_y
è&& (
y
 < 
_di¥Ïyşy2
); yts++) {

4193 
bo
 = 
bo_§ve
;

4194 
b™
 = 
b™_§ve
;

4195 
b™s
 = 
b™s_§ve
;

4196 
x
 = 
x_¡¬t
;

4197 ià(
y
 >ğ
_di¥Ïyşy1
) {

4198 
x
 < 
x_Ëá_fl
) {

4199 ià((
x
 >ğ
_di¥Ïyşx1
è&& (x < 
_di¥Ïyşx2
)) {

4201 
	`wr™ed©a16_cÚt
(
	`gfxFÚtLa¡Ch¬PosFG
(
x
, 
y
è? 
_gfx_Ï¡_ch¬_‹xtcŞÜ
 : 
‹xtbgcŞÜ
);

4203 
x
++;

4205 
xx
 = 0; xx < 
w
; xx++) {

4206 ià(!(
b™
++ & 7)) {

4207 
b™s
 = 
b™m­
[
bo
++];

4209 
ušt8_t
 
xts
 = 0; xt < 
‹xtsize_x
; xts++) {

4210 ià((
x
 >ğ
_di¥Ïyşx1
è&& (x < 
_di¥Ïyşx2
)) {

4211 ià(
b™s
 & 0x80)

4212 
	`wr™ed©a16_cÚt
(
‹xtcŞÜ
);

4214 
	`wr™ed©a16_cÚt
(
	`gfxFÚtLa¡Ch¬PosFG
(
x
, 
y
è? 
_gfx_Ï¡_ch¬_‹xtcŞÜ
 : (x < 
x_off£t_cursÜ
è? 
_gfx_Ï¡_ch¬_‹xtbgcŞÜ


4215 : 
‹xtbgcŞÜ
);

4217 
x
++;

4219 
b™s
 <<= 1;

4222 
x
 < 
x_’d
) {

4223 ià(
x
 >ğ
_di¥Ïyşx1
) {

4224 
	`wr™ed©a16_cÚt
(
	`gfxFÚtLa¡Ch¬PosFG
(
x
, 
y
è? 
_gfx_Ï¡_ch¬_‹xtcŞÜ
 : (x < 
x_off£t_cursÜ
è? 
_gfx_Ï¡_ch¬_‹xtbgcŞÜ


4225 : 
‹xtbgcŞÜ
);

4227 
x
++;

4230 
y
++;

4235 
y
 < 
y_’d
) {

4236 ià(
y
 >ğ
_di¥Ïyşy1
) {

4237 
št16_t
 
xx
 = 
x_¡¬t
; xx < 
x_’d
; xx++) {

4238 ià(
xx
 >ğ
_di¥Ïyşx1
) {

4239 
	`wr™ed©a16_cÚt
(
	`gfxFÚtLa¡Ch¬PosFG
(
xx
, 
y
è? 
_gfx_Ï¡_ch¬_‹xtcŞÜ
 : (xx < 
x_off£t_cursÜ
è? 
_gfx_Ï¡_ch¬_‹xtbgcŞÜ


4240 : 
‹xtbgcŞÜ
);

4244 
y
++;

4246 
	`wr™ecommªd_Ï¡
(
HX8357_NOP
);

4247 
	`’dSPIT¿n§ùiÚ
();

4250 
_gfx_c_Ï¡
 = 
c
;

4251 
_gfx_Ï¡_cursÜ_x
 = 
cursÜ_x
 + 
_Üigšx
;

4252 
_gfx_Ï¡_cursÜ_y
 = 
cursÜ_y
 + 
_Üigšy
;

4253 
_gfx_Ï¡_ch¬_x_wr™e
 = 
x_’d
;

4254 
_gfx_Ï¡_ch¬_‹xtcŞÜ
 = 
‹xtcŞÜ
;

4255 
_gfx_Ï¡_ch¬_‹xtbgcŞÜ
 = 
‹xtbgcŞÜ
;

4258 
cursÜ_x
 +ğ
glyph
->
xAdvªû
 * (
št16_t
)
‹xtsize_x
;

4259 
	}
}

4269 
boŞ
 
	gHX8357_t3n
::
	$gfxFÚtLa¡Ch¬PosFG
(
št16_t
 
x
, iÁ16_ˆ
y
) {

4270 
GFXglyph
 *
glyph
 = 
gfxFÚt
->glyph + (
_gfx_c_Ï¡
 - gfxFÚt->
fœ¡
);

4272 
ušt8_t
 
w
 = 
glyph
->
width
,

4273 
h
 = 
glyph
->
height
;

4276 
št16_t
 
xo
 = 
glyph
->
xOff£t
;

4277 
št16_t
 
yo
 = 
glyph
->
yOff£t
 + 
gfxFÚt
->
yAdvªû
 / 2;

4278 ià(
x
 >ğ
_gfx_Ï¡_ch¬_x_wr™e
è 
çl£
;

4279 ià(
y
 < (
_gfx_Ï¡_cursÜ_y
 + (
yo
 * 
‹xtsize_y
))è 
çl£
;

4280 ià(
y
 >ğ(
_gfx_Ï¡_cursÜ_y
 + (
yo
 + 
h
è* 
‹xtsize_y
)è 
çl£
;

4284 
št16_t
 
y_b™m­
 = (
y
 - ((
_gfx_Ï¡_cursÜ_y
 + (
yo
 * 
‹xtsize_y
))) +extsize_y - 1) /extsize_y;

4285 
št16_t
 
x_b™m­
 = (
x
 - ((
_gfx_Ï¡_cursÜ_x
 + (
xo
 * 
‹xtsize_x
))) +extsize_x - 1) /extsize_x;

4286 
ušt16_t
 
pix–_b™_off£t
 = 
y_b™m­
 * 
w
 + 
x_b™m­
;

4288  ((
gfxFÚt
->
b™m­
[
glyph
->
b™m­Off£t
 + (
pix–_b™_off£t
 >> 3)]) & (0x80 >> (pixel_bit_offset & 0x7)));

4289 
	}
}

4293 
	gHX8357_t3n
::
	$£tCursÜ
(
št16_t
 
x
, iÁ16_ˆ
y
, 
boŞ
 
autoC’‹r
) {

4294 
_ûÁ”_x_‹xt
 = 
autoC’‹r
;

4295 
_ûÁ”_y_‹xt
 = 
autoC’‹r
;

4296 ià(
x
 =ğ
HX8357_t3n
::
CENTER
) {

4297 
_ûÁ”_x_‹xt
 = 
Œue
;

4298 
x
 = 
_width
 / 2;

4300 ià(
y
 =ğ
HX8357_t3n
::
CENTER
) {

4301 
_ûÁ”_y_‹xt
 = 
Œue
;

4302 
y
 = 
_height
 / 2;

4304 ià(
x
 < 0) x = 0;

4305 ià(
x
 >ğ
_width
) x = _width - 1;

4306 
cursÜ_x
 = 
x
;

4307 ià(
y
 < 0) y = 0;

4308 ià(
y
 >ğ
_height
) y = _height - 1;

4309 
cursÜ_y
 = 
y
;

4311 ià(
x
 >ğ
süŞl_x
 && x <ğ(süŞl_x + 
süŞl_width
è&& 
y
 >ğ
süŞl_y
 && y <ğ(süŞl_y + 
süŞl_height
)) {

4312 
isWr™šgSüŞlA»a
 = 
Œue
;

4314 
isWr™šgSüŞlA»a
 = 
çl£
;

4316 
_gfx_Ï¡_ch¬_x_wr™e
 = 0;

4317 
	}
}

4319 
	gHX8357_t3n
::
	$g‘CursÜ
(
št16_t
 *
x
, iÁ16_ˆ*
y
) {

4320 *
x
 = 
cursÜ_x
;

4321 *
y
 = 
cursÜ_y
;

4322 
	}
}

4324 
	gHX8357_t3n
::
	$£tTextSize
(
ušt8_t
 
s_x
, ušt8_ˆ
s_y
) {

4325 
‹xtsize_x
 = (
s_x
 > 0) ? s_x : 1;

4326 
‹xtsize_y
 = (
s_y
 > 0) ? s_y : 1;

4327 
_gfx_Ï¡_ch¬_x_wr™e
 = 0;

4328 
	}
}

4330 
ušt8_t
 
	gHX8357_t3n
::
	$g‘TextSize
() {

4331  
‹xtsize_x
;

4332 
	}
}

4334 
	gHX8357_t3n
::
	$£tTextCŞÜ
(
ušt16_t
 
c
) {

4337 
‹xtcŞÜ
 = 
‹xtbgcŞÜ
 = 
c
;

4338 
	}
}

4340 
	gHX8357_t3n
::
	$£tTextCŞÜ
(
ušt16_t
 
c
, ušt16_ˆ
b
) {

4341 
‹xtcŞÜ
 = 
c
;

4342 
‹xtbgcŞÜ
 = 
b
;

4344 
‹xtcŞÜP»x·nded
 = (
‹xtcŞÜ
 | (textcolor << 16)) & 0b00000111111000001111100000011111;

4345 
‹xtbgcŞÜP»x·nded
 = (
‹xtbgcŞÜ
 | (textbgcolor << 16)) & 0b00000111111000001111100000011111;

4346 
	}
}

4348 
	gHX8357_t3n
::
	$£tTextW¿p
(
boŞ—n
 
w
) {

4349 
w¿p
 = 
w
;

4350 
	}
}

4352 
boŞ—n
 
	gHX8357_t3n
::
	$g‘TextW¿p
() {

4353  
w¿p
;

4354 
	}
}

4356 
ušt8_t
 
	gHX8357_t3n
::
	$g‘RÙ©iÚ
() {

4357  
rÙ©iÚ
;

4358 
	}
}

4360 
	gHX8357_t3n
::
	$¦“p
(
boŞ
 
’abË
) {

4361 
	`begšSPIT¿n§ùiÚ
(
_SPI_CLOCK
);

4362 ià(
’abË
) {

4363 
	`wr™ecommªd_cÚt
(
HX8357_DISPOFF
);

4364 
	`wr™ecommªd_Ï¡
(
HX8357_SLPIN
);

4365 
	`’dSPIT¿n§ùiÚ
();

4367 
	`wr™ecommªd_cÚt
(
HX8357_DISPON
);

4368 
	`wr™ecommªd_Ï¡
(
HX8357_SLPOUT
);

4369 
	`’dSPIT¿n§ùiÚ
();

4370 
	`d–ay
(5);

4372 
	}
}

4380 
	gHX8357_t3n
::
	$£tTextD©um
(
ušt8_t
 
d
) {

4381 
‹xtd©um
 = 
d
;

4382 
	}
}

4389 
št16_t
 
	gHX8357_t3n
::
	$d¿wNumb”
(
lÚg_num
, 
poX
, 
poY
) {

4390 
¡r
[14];

4391 
	`Éß
(
lÚg_num
, 
¡r
, 10);

4392  
	`d¿wSŒšg
(
¡r
, 
poX
, 
poY
);

4393 
	}
}

4396 
št16_t
 
	gHX8357_t3n
::
	$d¿wFlßt
(
æßtNumb”
, 
dp
, 
poX
, 
poY
) {

4397 
¡r
[14];

4398 
ušt8_t
 
±r
 = 0;

4399 
št8_t
 
dig™s
 = 1;

4400 
roundšg
 = 0.5;

4402 ià(
dp
 > 7) dp = 7;

4405 
ušt8_t
 
i
 = 0; i < 
dp
; ++iè
roundšg
 /= 10.0;

4407 ià(
æßtNumb”
 < -
roundšg
)

4409 
¡r
[
±r
++] = '-';

4410 
¡r
[
±r
] = 0;

4411 
dig™s
 = 0;

4412 
æßtNumb”
 = -floatNumber;

4415 
æßtNumb”
 +ğ
roundšg
;

4418 ià(
æßtNumb”
 >= 2147483647) {

4419 
	`¡rıy
(
¡r
, "...");

4425 
‹mp
 = ()
æßtNumb”
;

4428 
	`Éß
(
‹mp
, 
¡r
 + 
±r
, 10);

4431 (
ušt8_t
)
¡r
[
±r
] != 0)…tr++;

4432 
dig™s
 +ğ
±r
;

4434 
¡r
[
±r
++] = '.';

4435 
¡r
[
±r
] = '0';

4436 
¡r
[
±r
 + 1] = 0;

4439 
æßtNumb”
 = flßtNumb” - 
‹mp
;

4443 
ušt8_t
 
i
 = 0;

4444 (
i
 < 
dp
è&& (
dig™s
 < 9))

4446 
i
++;

4447 
æßtNumb”
 *= 10;

4448 
‹mp
 = 
æßtNumb”
;

4449 
	`Éß
(
‹mp
, 
¡r
 + 
±r
, 10);

4450 
±r
++;

4451 
dig™s
++;

4452 
æßtNumb”
 -ğ
‹mp
;

4456  
	`d¿wSŒšg
(
¡r
, 
poX
, 
poY
);

4457 
	}
}

4464 
št16_t
 
	gHX8357_t3n
::
	$d¿wSŒšg
(cÚ¡ 
SŒšg
 &
¡ršg
, 
poX
, 
poY
) {

4465 
št16_t
 
Ën
 = 
¡ršg
.
	`Ëngth
() + 2;

4466 
bufãr
[
Ën
];

4467 
¡ršg
.
	`toCh¬A¼ay
(
bufãr
, 
Ën
);

4468  
	`d¿wSŒšg
(
bufãr
, 
Ën
 - 2, 
poX
, 
poY
);

4469 
	}
}

4471 
št16_t
 
	gHX8357_t3n
::
	$d¿wSŒšg
(cÚ¡ 
¡ršg
[], 
št16_t
 
Ën
, 
poX
, 
poY
) {

4472 
št16_t
 
sumX
 = 0;

4473 
ušt8_t
 
·ddšg
 = 1 ;

4475 
ušt16_t
 
cwidth
 =

4476 
	`¡rPix–L’
(
¡ršg
, 
Ën
);

4477 
ušt16_t
 
cheight
 = 
‹xtsize_y
 * 6;

4480 ià(
‹xtd©um
 || 
·dX
) {

4481 
‹xtd©um
) {

4482 
TC_DATUM
:

4483 
poX
 -ğ
cwidth
 / 2;

4484 
·ddšg
 += 1;

4486 
TR_DATUM
:

4487 
poX
 -ğ
cwidth
;

4488 
·ddšg
 += 2;

4490 
ML_DATUM
:

4491 
poY
 -ğ
cheight
 / 2;

4494 
MC_DATUM
:

4495 
poX
 -ğ
cwidth
 / 2;

4496 
poY
 -ğ
cheight
 / 2;

4497 
·ddšg
 += 1;

4499 
MR_DATUM
:

4500 
poX
 -ğ
cwidth
;

4501 
poY
 -ğ
cheight
 / 2;

4502 
·ddšg
 += 2;

4504 
BL_DATUM
:

4505 
poY
 -ğ
cheight
;

4508 
BC_DATUM
:

4509 
poX
 -ğ
cwidth
 / 2;

4510 
poY
 -ğ
cheight
;

4511 
·ddšg
 += 1;

4513 
BR_DATUM
:

4514 
poX
 -ğ
cwidth
;

4515 
poY
 -ğ
cheight
;

4516 
·ddšg
 += 2;

4536 ià(
poX
 < 0)…oX = 0;

4537 ià(
poX
 + 
cwidth
 > 
	`width
())…oX = width() - cwidth;

4538 ià(
poY
 < 0)…oY = 0;

4541 ià(
fÚt
 =ğ
NULL
) {

4542 
ušt8_t
 
i
 = 0; i < 
Ën
; i++) {

4543 
	`d¿wCh¬
((
št16_t
)(
poX
 + 
sumX
), (št16_t)
poY
, 
¡ršg
[
i
], 
‹xtcŞÜ
, 
‹xtbgcŞÜ
, 
‹xtsize_x
, 
‹xtsize_y
);

4544 
sumX
 +ğ
cwidth
 / (
Ën
 - 2è+ 
·ddšg
;

4547 
	`£tCursÜ
(
poX
, 
poY
);

4548 
ušt8_t
 
i
 = 0; i < 
Ën
; i++) {

4549 
	`d¿wFÚtCh¬
(
¡ršg
[
i
]);

4550 
	`£tCursÜ
(
cursÜ_x
, 
cursÜ_y
);

4553  
sumX
;

4554 
	}
}

4557 
	gHX8357_t3n
::
	$süŞlTextA»a
(
ušt8_t
 
süŞlSize
) {

4558 
ušt16_t
 
awCŞÜs
[
süŞl_width
];

4559 
y
 = 
süŞl_y
 + 
süŞlSize
; y < (süŞl_y + 
süŞl_height
); y++) {

4560 
	`»adReù
(
süŞl_x
, 
y
, 
süŞl_width
, 1, 
awCŞÜs
);

4561 
	`wr™eReù
(
süŞl_x
, 
y
 - 
süŞlSize
, 
süŞl_width
, 1, 
awCŞÜs
);

4563 
	`flReù
(
süŞl_x
, (
süŞl_y
 + 
süŞl_height
è- 
süŞlSize
, 
süŞl_width
, süŞlSize, 
süŞlbgcŞÜ
);

4564 
	}
}

4566 
	gHX8357_t3n
::
	$£tSüŞlTextA»a
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
) {

4567 
süŞl_x
 = 
x
;

4568 
süŞl_y
 = 
y
;

4569 
süŞl_width
 = 
w
;

4570 
süŞl_height
 = 
h
;

4571 
	}
}

4573 
	gHX8357_t3n
::
	$£tSüŞlBackgroundCŞÜ
(
ušt16_t
 
cŞÜ
) {

4574 
süŞlbgcŞÜ
 = 
cŞÜ
;

4575 
	`flReù
(
süŞl_x
, 
süŞl_y
, 
süŞl_width
, 
süŞl_height
, 
süŞlbgcŞÜ
);

4576 
	}
}

4578 
	gHX8357_t3n
::
	$’abËSüŞl
() {

4579 
süŞlEÇbË
 = 
Œue
;

4580 
	}
}

4582 
	gHX8357_t3n
::
	$di§bËSüŞl
() {

4583 
süŞlEÇbË
 = 
çl£
;

4584 
	}
}

4586 
	gHX8357_t3n
::
	$»£tSüŞlBackgroundCŞÜ
(
ušt16_t
 
cŞÜ
) {

4587 
süŞlbgcŞÜ
 = 
cŞÜ
;

4588 
	}
}

4594 #ià
defšed
(
KINETISK
)

4595 
	gHX8357_t3n
::
	$wa™FifoNÙFuÎ
() {

4596 
ušt32_t
 
¤
;

4597 
ušt32_t
 
tmp
 
	`__©Œibu‹__
((
unu£d
));

4599 
¤
 = 
_pkš‘isk_¥i
->
SR
;

4600 ià(
¤
 & 0xF0è
tmp
 = 
_pkš‘isk_¥i
->
POPR
;

4601 } (
ušt32_t
)(
¤
 & (15 << 12)è> 
_fifo_fuÎ_‹¡
);

4602 
	}
}

4603 
	gHX8357_t3n
::
	$wa™FifoEm±y
() {

4604 
ušt32_t
 
¤
;

4605 
ušt32_t
 
tmp
 
	`__©Œibu‹__
((
unu£d
));

4607 
¤
 = 
_pkš‘isk_¥i
->
SR
;

4608 ià(
¤
 & 0xF0è
tmp
 = 
_pkš‘isk_¥i
->
POPR
;

4609 } (
¤
 & 0xF0F0) > 0);

4610 
	}
}

4611 
	gHX8357_t3n
::
	$wa™T¿nsm™Com¶‘e
() {

4612 
ušt32_t
 
tmp
 
	`__©Œibu‹__
((
unu£d
));

4613 !(
_pkš‘isk_¥i
->
SR
 & 
SPI_SR_TCF
))

4615 
tmp
 = 
_pkš‘isk_¥i
->
POPR
;

4616 
	}
}

4617 
	gHX8357_t3n
::
	$wa™T¿nsm™Com¶‘e
(
ušt32_t
 
mü
) {

4618 
ušt32_t
 
tmp
 
	`__©Œibu‹__
((
unu£d
));

4620 
ušt32_t
 
¤
 = 
_pkš‘isk_¥i
->
SR
;

4621 ià(
¤
 & 
SPI_SR_EOQF
) ;

4622 ià(
¤
 & 0xF0è
tmp
 = 
_pkš‘isk_¥i
->
POPR
;

4624 
_pkš‘isk_¥i
->
SR
 = 
SPI_SR_EOQF
;

4625 
_pkš‘isk_¥i
->
MCR
 = 
mü
;

4626 
_pkš‘isk_¥i
->
SR
 & 0xF0) {

4627 
tmp
 = 
_pkš‘isk_¥i
->
POPR
;

4629 
	}
}

4631 #–ià
defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

4632 
	gHX8357_t3n
::
	$wa™FifoNÙFuÎ
() {

4633 
ušt32_t
 
tmp
 
	`__©Œibu‹__
((
unu£d
));

4635 ià((
_pimx¹_¥i
->
RSR
 & 
LPSPI_RSR_RXEMPTY
) == 0) {

4636 
tmp
 = 
_pimx¹_¥i
->
RDR
;

4637 ià(
³ndšg_rx_couÁ
)…ending_rx_count--;

4639 } (
_pimx¹_¥i
->
SR
 & 
LPSPI_SR_TDF
) == 0);

4640 
	}
}

4641 
	gHX8357_t3n
::
	$wa™FifoEm±y
() {

4642 
ušt32_t
 
tmp
 
	`__©Œibu‹__
((
unu£d
));

4644 ià((
_pimx¹_¥i
->
RSR
 & 
LPSPI_RSR_RXEMPTY
) == 0) {

4645 
tmp
 = 
_pimx¹_¥i
->
RDR
;

4646 ià(
³ndšg_rx_couÁ
)…ending_rx_count--;

4648 } (
_pimx¹_¥i
->
SR
 & 
LPSPI_SR_TCF
) == 0);

4649 
	}
}

4650 
	gHX8357_t3n
::
	$wa™T¿nsm™Com¶‘e
() {

4651 
ušt32_t
 
tmp
 
	`__©Œibu‹__
((
unu£d
));

4654 
³ndšg_rx_couÁ
) {

4655 ià((
_pimx¹_¥i
->
RSR
 & 
LPSPI_RSR_RXEMPTY
) == 0) {

4656 
tmp
 = 
_pimx¹_¥i
->
RDR
;

4657 
³ndšg_rx_couÁ
--;

4660 
_pimx¹_¥i
->
CR
 = 
LPSPI_CR_MEN
 | 
LPSPI_CR_RRF
;

4662 
	}
}

4664 
	gHX8357_t3n
::
	$wa™T¿nsm™Com¶‘e
(
ušt32_t
 
mü
) {

4666 
	`wa™T¿nsm™Com¶‘e
();

4667 
	}
}

	@HX8357_t3n.h

59 #iâdeà
_HX8357_t3NH_


60 
	#_HX8357_t3NH_


	)

61 #ifdeà
_SPIN_H_INCLUDED


64 
	#_SPIN_H_INCLUDED


65 

	)

66 
	#HX8357_USE_DMAMEM


	)

69 #iâdeà
DISABLE_HX8357_FRAMEBUFFER


70 #ià
defšed
(
__MK64FX512__
è|| defšed(
__MK66FX1M0__
)

71 
	#ENABLE_HX8357_FRAMEBUFFER


	)

73 
	#SCREEN_DMA_NUM_SETTINGS
 3

74 #–ià
	`defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

	)

75 
	#SCREEN_DMA_NUM_SETTINGS
 5

76 
	#ENABLE_HX8357_FRAMEBUFFER


	)

77 
	#TRY_FULL_DMA_CHAIN


	)

83 #ifdeà
__ılu¥lus


84 
	~"Ardušo.h
"

85 
	~<SPI.h
>

86 
	~<DMAChªÃl.h
>

89 
	~<¡dšt.h
>

91 
	~"ILI9341_fÚts.h
"

93 
	#HX8357D
 0xD

	)

94 
	#HX8357B
 0xB

	)

97 
	#HX8357_TFTWIDTH
 320

	)

98 
	#HX8357_TFTHEIGHT
 480

	)

100 
	#HX8357_NOP
 0x00

	)

101 
	#HX8357_SWRESET
 0x01

	)

102 
	#HX8357_RDDID
 0x04

	)

103 
	#HX8357_RDDST
 0x09

	)

105 
	#HX8357_SLPIN
 0x10

	)

106 
	#HX8357_SLPOUT
 0x11

	)

107 
	#HX8357B_PTLON
 0x12

	)

108 
	#HX8357B_NORON
 0x13

	)

110 
	#HX8357_RDMODE
 0x0A

	)

111 
	#HX8357_RDMADCTL
 0x0B

	)

112 
	#HX8357_RDPIXFMT
 0x0C

	)

113 
	#HX8357_RDIMGFMT
 0x0D

	)

114 
	#HX8357_RDSELFDIAG
 0x0F

	)

116 
	#HX8357_INVOFF
 0x20

	)

117 
	#HX8357_INVON
 0x21

	)

118 
	#HX8357_GAMMASET
 0x26

	)

119 
	#HX8357_DISPOFF
 0x28

	)

120 
	#HX8357_DISPON
 0x29

	)

122 
	#HX8357_CASET
 0x2A

	)

123 
	#HX8357_PASET
 0x2B

	)

124 
	#HX8357_RAMWR
 0x2C

	)

125 
	#HX8357_RAMRD
 0x2E

	)

127 
	#HX8357B_PTLAR
 0x30

	)

128 
	#HX8357_TEON
 0x35

	)

129 
	#HX8357_TEARLINE
 0x44

	)

130 
	#HX8357_MADCTL
 0x36

	)

131 
	#HX8357_VSCRSADD
 0x37

	)

132 
	#HX8357_COLMOD
 0x3A

	)

134 
	#HX8357_SETOSC
 0xB0

	)

135 
	#HX8357_SETPWR1
 0xB1

	)

136 
	#HX8357B_SETDISPLAY
 0xB2

	)

137 
	#HX8357_SETRGB
 0xB3

	)

138 
	#HX8357D_SETCOM
 0xB6

	)

140 
	#HX8357B_SETDISPMODE
 0xB4

	)

141 
	#HX8357D_SETCYC
 0xB4

	)

142 
	#HX8357B_SETOTP
 0xB7

	)

143 
	#HX8357D_SETC
 0xB9

	)

145 
	#HX8357B_SET_PANEL_DRIVING
 0xC0

	)

146 
	#HX8357D_SETSTBA
 0xC0

	)

147 
	#HX8357B_SETDGC
 0xC1

	)

148 
	#HX8357B_SETID
 0xC3

	)

149 
	#HX8357B_SETDDB
 0xC4

	)

150 
	#HX8357B_SETDISPLAYFRAME
 0xC5

	)

151 
	#HX8357B_GAMMASET
 0xC8

	)

152 
	#HX8357B_SETCABC
 0xC9

	)

153 
	#HX8357_SETPANEL
 0xCC

	)

155 
	#HX8357B_SETPOWER
 0xD0

	)

156 
	#HX8357B_SETVCOM
 0xD1

	)

157 
	#HX8357B_SETPWRNORMAL
 0xD2

	)

159 
	#HX8357B_RDID1
 0xDA

	)

160 
	#HX8357B_RDID2
 0xDB

	)

161 
	#HX8357B_RDID3
 0xDC

	)

162 
	#HX8357B_RDID4
 0xDD

	)

164 
	#HX8357D_SETGAMMA
 0xE0

	)

165 
	#HX8357B_SETGAMMA
 0xC8

	)

166 
	#HX8357B_SETPANELRELATED
 0xE9

	)

173 
	#HX8357_BLACK
 0x0000

	)

174 
	#HX8357_NAVY
 0x000F

	)

175 
	#HX8357_DARKGREEN
 0x03E0

	)

176 
	#HX8357_DARKCYAN
 0x03EF

	)

177 
	#HX8357_MAROON
 0x7800

	)

178 
	#HX8357_PURPLE
 0x780F

	)

179 
	#HX8357_OLIVE
 0x7BE0

	)

180 
	#HX8357_LIGHTGREY
 0xC618

	)

181 
	#HX8357_DARKGREY
 0x7BEF

	)

182 
	#HX8357_BLUE
 0x001F

	)

183 
	#HX8357_GREEN
 0x07E0

	)

184 
	#HX8357_CYAN
 0x07FF

	)

185 
	#HX8357_RED
 0xF800

	)

186 
	#HX8357_MAGENTA
 0xF81F

	)

187 
	#HX8357_YELLOW
 0xFFE0

	)

188 
	#HX8357_WHITE
 0xFFFF

	)

189 
	#HX8357_ORANGE
 0xFD20

	)

190 
	#HX8357_GREENYELLOW
 0xAFE5

	)

191 
	#HX8357_PINK
 0xF81F

	)

193 
	#CL
(
_r
, 
_g
, 
_b
è((((_r)&0xF8è<< 8è| (((_g)&0xFCè<< 3è| ((_bè>> 3))

	)

195 
	#sšt16_t
 
št16_t


	)

198 #ià
__has_šşude
(<
gfxfÚt
.
h
>)

199 
	~<gfxfÚt.h
>

203 #iâdeà
_GFXFONT_H_


204 
	#_GFXFONT_H_


	)

208 
ušt16_t
 
	mb™m­Off£t
;

209 
ušt8_t
 
	mwidth
;

210 
ušt8_t
 
	mheight
;

211 
ušt8_t
 
	mxAdvªû
;

212 
št8_t
 
	mxOff£t
;

213 
št8_t
 
	myOff£t
;

214 } 
	tGFXglyph
;

218 
ušt8_t
 *
	mb™m­
;

219 
GFXglyph
 *
	mglyph
;

220 
ušt8_t
 
	mfœ¡
;

221 
ušt8_t
 
	mÏ¡
;

222 
ušt8_t
 
	myAdvªû
;

223 } 
	tGFXfÚt
;

228 
	#TL_DATUM
 0

229 
	#TC_DATUM
 1

230 
	#TR_DATUM
 2

231 
	#ML_DATUM
 3

232 
	#CL_DATUM
 3

233 
	#MC_DATUM
 4

234 
	#CC_DATUM
 4

235 
	#MR_DATUM
 5

236 
	#CR_DATUM
 5

237 
	#BL_DATUM
 6

238 
	#BC_DATUM
 7

239 
	#BR_DATUM
 8

243 

	)

245 #ifdeà
__ılu¥lus


247 #ifdeà
KINETISK


248 
	#HX8357_SPICLOCK
 26000000

	)

249 
	#HX8357_SPICLOCK_READ
 2000000

	)

250 #–ià
defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

251 
	#HX8357_SPICLOCK
 26000000u

	)

252 
	#HX8357_SPICLOCK_READ
 2000000

	)

254 
	#HX8357_SPICLOCK
 26000000

	)

255 
	#HX8357_SPICLOCK_READ
 2000000

	)

258 şas 
	cHX8357_t3n
 : 
public
 
Pršt
 {

259 
public
:

260 
HX8357_t3n
(
ušt8_t
 
_CS
, ušt8_ˆ
_DC
, ušt8_ˆ
_RST
 = 255,

261 
ušt8_t
 
_MOSI
 = 11, ušt8_ˆ
_SCLK
 = 13, ušt8_ˆ
_MISO
 = 12);

262 
begš
(
ušt32_t
 
¥i_şock
 = 
HX8357_SPICLOCK
, ušt32_ˆ
¥i_şock_»ad
 = 
HX8357_SPICLOCK_READ
);

263 
¦“p
(
boŞ
 
’abË
);

264 
pushCŞÜ
(
ušt16_t
 
cŞÜ
);

265 
flSü“n
(
ušt16_t
 
cŞÜ
);

266 
šlše
 
	$flWšdow
(
ušt16_t
 
cŞÜ
) {

267 
	`flSü“n
(
cŞÜ
);

269 
	`d¿wPix–
(
št16_t
 
x
, iÁ16_ˆ
y
, 
ušt16_t
 
cŞÜ
);

270 
	`d¿wFa¡VLše
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
h
, 
ušt16_t
 
cŞÜ
);

271 
	`d¿wFa¡HLše
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, 
ušt16_t
 
cŞÜ
);

272 
	`flReù
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, 
ušt16_t
 
cŞÜ
);

274 
	`flReùHG¿d›Á
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, 
ušt16_t
 
cŞÜ1
, ušt16_ˆ
cŞÜ2
);

275 
	`flReùVG¿d›Á
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, 
ušt16_t
 
cŞÜ1
, ušt16_ˆ
cŞÜ2
);

276 
	`flSü“nVG¿d›Á
(
ušt16_t
 
cŞÜ1
, ušt16_ˆ
cŞÜ2
);

277 
	`flSü“nHG¿d›Á
(
ušt16_t
 
cŞÜ1
, ušt16_ˆ
cŞÜ2
);

279 
	`£tRÙ©iÚ
(
ušt8_t
 
r
);

280 
	`£tSüŞl
(
ušt16_t
 
off£t
);

281 
	`šv”tDi¥Ïy
(
boŞ—n
 
i
);

282 
	`£tAddrWšdow
(
ušt16_t
 
x0
, ušt16_ˆ
y0
, ušt16_ˆ
x1
, ušt16_ˆ
y1
);

284 
ušt16_t
 
	$cŞÜ565
(
ušt8_t
 
r
, ušt8_ˆ
g
, ušt8_ˆ
b
) {

285  ((
r
 & 0xF8è<< 8è| ((
g
 & 0xFCè<< 3è| (
b
 >> 3);

286 
	}
}

289 
	$cŞÜ565toRGB
(
ušt16_t
 
cŞÜ
, 
ušt8_t
 &
r
, ušt8_ˆ&
g
, ušt8_ˆ&
b
) {

290 
r
 = (
cŞÜ
 >> 8) & 0x00F8;

291 
g
 = (
cŞÜ
 >> 3) & 0x00FC;

292 
b
 = (
cŞÜ
 << 3) & 0x00F8;

293 
	}
}

298 
	$cŞÜ565toRGB14
(
ušt16_t
 
cŞÜ
, 
št16_t
 &
r
, iÁ16_ˆ&
g
, iÁ16_ˆ&
b
) {

299 
r
 = (
cŞÜ
 >> 2) & 0x3E00;

300 
g
 = (
cŞÜ
 << 3) & 0x3F00;

301 
b
 = (
cŞÜ
 << 9) & 0x3E00;

302 
	}
}

305 
ušt16_t
 
	$RGB14tocŞÜ565
(
št16_t
 
r
, iÁ16_ˆ
g
, iÁ16_ˆ
b
) {

306  (((
r
 & 0x3E00è<< 2è| ((
g
 & 0x3F00è>> 3è| ((
b
 & 0x3E00) >> 9));

307 
	}
}

310 
ušt8_t
 
»adcommªd8
(ušt8_ˆ
»g
, ušt8_ˆ
šdex
 = 0);

313 
ušt16_t
 
»adPix–
(
št16_t
 
x
, iÁ16_ˆ
y
);

314 
»adReù
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, 
ušt16_t
 *
pcŞÜs
);

315 
wr™eReù
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, cÚ¡ 
ušt16_t
 *
pcŞÜs
);

320 
wr™eReù8BPP
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, cÚ¡ 
ušt8_t
 *
pix–s
, cÚ¡ 
ušt16_t
 *
·Ë‰e
);

326 
wr™eReù4BPP
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, cÚ¡ 
ušt8_t
 *
pix–s
, cÚ¡ 
ušt16_t
 *
·Ë‰e
);

332 
wr™eReù2BPP
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, cÚ¡ 
ušt8_t
 *
pix–s
, cÚ¡ 
ušt16_t
 *
·Ë‰e
);

338 
wr™eReù1BPP
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, cÚ¡ 
ušt8_t
 *
pix–s
, cÚ¡ 
ušt16_t
 *
·Ë‰e
);

344 
wr™eReùNBPP
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, 
ušt8_t
 
b™s_³r_pix–
,

345 cÚ¡ 
ušt8_t
 *
pix–s
, cÚ¡ 
ušt16_t
 *
·Ë‰e
);

348 
d¿wCœşe
(
št16_t
 
x0
, iÁ16_ˆ
y0
, iÁ16_ˆ
r
, 
ušt16_t
 
cŞÜ
);

349 
d¿wCœşeH–³r
(
št16_t
 
x0
, iÁ16_ˆ
y0
, iÁ16_ˆ
r
, 
ušt8_t
 
cÜÃºame
, 
ušt16_t
 
cŞÜ
);

350 
flCœşe
(
št16_t
 
x0
, iÁ16_ˆ
y0
, iÁ16_ˆ
r
, 
ušt16_t
 
cŞÜ
);

351 
flCœşeH–³r
(
št16_t
 
x0
, iÁ16_ˆ
y0
, iÁ16_ˆ
r
, 
ušt8_t
 
cÜÃºame
, iÁ16_ˆ
d–
, 
ušt16_t
 
cŞÜ
);

352 
d¿wTrŸngË
(
št16_t
 
x0
, iÁ16_ˆ
y0
, iÁ16_ˆ
x1
, iÁ16_ˆ
y1
, iÁ16_ˆ
x2
, iÁ16_ˆ
y2
, 
ušt16_t
 
cŞÜ
);

353 
flTrŸngË
(
št16_t
 
x0
, iÁ16_ˆ
y0
, iÁ16_ˆ
x1
, iÁ16_ˆ
y1
, iÁ16_ˆ
x2
, iÁ16_ˆ
y2
, 
ušt16_t
 
cŞÜ
);

354 
d¿wRoundReù
(
št16_t
 
x0
, iÁ16_ˆ
y0
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, iÁ16_ˆ
¿dius
, 
ušt16_t
 
cŞÜ
);

355 
flRoundReù
(
št16_t
 
x0
, iÁ16_ˆ
y0
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, iÁ16_ˆ
¿dius
, 
ušt16_t
 
cŞÜ
);

356 
d¿wB™m­
(
št16_t
 
x
, iÁ16_ˆ
y
, cÚ¡ 
ušt8_t
 *
b™m­
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, 
ušt16_t
 
cŞÜ
);

357 
d¿wCh¬
(
št16_t
 
x
, iÁ16_ˆ
y
, 
c
, 
ušt16_t
 
cŞÜ
, ušt16_ˆ
bg
, 
ušt8_t
 
size_x
, ušt8_ˆ
size_y
);

358 
šlše
 
	$d¿wCh¬
(
št16_t
 
x
, iÁ16_ˆ
y
, 
c
, 
ušt16_t
 
cŞÜ
, ušt16_ˆ
bg
, 
ušt8_t
 
size
) {

359 
	`d¿wCh¬
(
x
, 
y
, 
c
, 
cŞÜ
, 
bg
, 
size
);

360 
	}
}

361 cÚ¡ 
št16_t
 
	gCENTER
 = 9998;

362 
£tCursÜ
(
št16_t
 
x
, iÁ16_ˆ
y
, 
boŞ
 
autoC’‹r
 = 
çl£
);

363 
g‘CursÜ
(
št16_t
 *
x
, iÁ16_ˆ*
y
);

364 
£tTextCŞÜ
(
ušt16_t
 
c
);

365 
£tTextCŞÜ
(
ušt16_t
 
c
, ušt16_ˆ
bg
);

366 
£tTextSize
(
ušt8_t
 
sx
, ušt8_ˆ
sy
);

367 
šlše
 
	$£tTextSize
(
ušt8_t
 
s
) {

368 
	`£tTextSize
(
s
, s);

369 
	}
}

370 
ušt8_t
 
g‘TextSizeX
();

371 
ušt8_t
 
g‘TextSizeY
();

372 
ušt8_t
 
g‘TextSize
();

373 
£tTextW¿p
(
boŞ—n
 
w
);

374 
boŞ—n
 
g‘TextW¿p
();

378 
	$£tOrigš
(
št16_t
 
x
 = 0, iÁ16_ˆ
y
 = 0) {

379 
_Üigšx
 = 
x
;

380 
_Üigšy
 = 
y
;

382 
	`upd©eDi¥ÏyCl
();

383 
	}
}

384 
	$g‘Origš
(
št16_t
 *
x
, iÁ16_ˆ*
y
) {

385 *
x
 = 
_Üigšx
;

386 *
y
 = 
_Üigšy
;

387 
	}
}

392 
	$£tClReù
(
št16_t
 
x1
, iÁ16_ˆ
y1
, iÁ16_ˆ
w
, iÁ16_ˆ
h
) {

393 
_şx1
 = 
x1
;

394 
_şy1
 = 
y1
;

395 
_şx2
 = 
x1
 + 
w
;

396 
_şy2
 = 
y1
 + 
h
;

398 
	`upd©eDi¥ÏyCl
();

399 
	}
}

400 
	$£tClReù
() {

401 
_şx1
 = 0;

402 
_şy1
 = 0;

403 
_şx2
 = 
_width
;

404 
_şy2
 = 
_height
;

406 
	`upd©eDi¥ÏyCl
();

407 
	}
}

410 
vœtu®
 
size_t
 
wr™e
(
ušt8_t
);

411 
vœtu®
 
size_t
 
wr™e
(cÚ¡ 
ušt8_t
 *
bufãr
, size_ˆ
size
);

413 
št16_t
 
	$width
() {

414  
_width
;

415 
	}
}

416 
št16_t
 
	$height
() {

417  
_height
;

418 
	}
}

419 
ušt8_t
 
g‘RÙ©iÚ
();

420 
d¿wLše
(
št16_t
 
x0
, iÁ16_ˆ
y0
, iÁ16_ˆ
x1
, iÁ16_ˆ
y1
, 
ušt16_t
 
cŞÜ
);

421 
d¿wReù
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
, 
ušt16_t
 
cŞÜ
);

422 
št16_t
 
	$g‘CursÜX
() const {

423  
cursÜ_x
;

424 
	}
}

425 
št16_t
 
	$g‘CursÜY
() const {

426  
cursÜ_y
;

427 
	}
}

428 
£tFÚt
(cÚ¡ 
ILI9341_t3_fÚt_t
 &
f
);

429 
£tFÚt
(cÚ¡ 
GFXfÚt
 *
f
 = 
NULL
);

430 
	$£tFÚtAdaäu™
() {

431 
	`£tFÚt
();

432 
	}
}

433 
d¿wFÚtCh¬
(
c
);

434 
d¿wGFXFÚtCh¬
(
c
);

436 
g‘TextBounds
(cÚ¡ 
ušt8_t
 *
bufãr
, 
ušt16_t
 
Ën
, 
št16_t
 
x
, iÁ16_ˆ
y
,

437 
št16_t
 *
x1
, iÁ16_ˆ*
y1
, 
ušt16_t
 *
w
, ušt16_ˆ*
h
);

438 
g‘TextBounds
(cÚ¡ *
¡ršg
, 
št16_t
 
x
, iÁ16_ˆ
y
,

439 
št16_t
 *
x1
, iÁ16_ˆ*
y1
, 
ušt16_t
 *
w
, ušt16_ˆ*
h
);

440 
g‘TextBounds
(cÚ¡ 
SŒšg
 &
¡r
, 
št16_t
 
x
, iÁ16_ˆ
y
,

441 
št16_t
 *
x1
, iÁ16_ˆ*
y1
, 
ušt16_t
 *
w
, ušt16_ˆ*
h
);

442 
št16_t
 
¡rPix–L’
(cÚ¡ *
¡r
, 
ušt16_t
 
cb
);

447 
št16_t
 
d¿wNumb”
(
lÚg_num
, 
poX
, 
poY
);

448 
št16_t
 
d¿wFlßt
(
æßtNumb”
, 
decim®
, 
poX
, 
poY
);

450 
št16_t
 
d¿wSŒšg
(cÚ¡ 
SŒšg
 &
¡ršg
, 
poX
, 
poY
);

451 
št16_t
 
d¿wSŒšg
(cÚ¡ 
¡ršg
[], iÁ16_ˆ
Ën
, 
poX
, 
poY
);

453 
£tTextD©um
(
ušt8_t
 
d©um
);

460 
£tSüŞlTextA»a
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
);

461 
£tSüŞlBackgroundCŞÜ
(
ušt16_t
 
cŞÜ
);

462 
’abËSüŞl
();

463 
di§bËSüŞl
();

464 
süŞlTextA»a
(
ušt8_t
 
süŞlSize
);

465 
»£tSüŞlBackgroundCŞÜ
(
ušt16_t
 
cŞÜ
);

468 ’um { 
	gHX8357_DMA_INIT
 = 0x01,

469 
	gHX8357_DMA_CONT
 = 0x02,

470 
	gHX8357_DMA_FINISH
 = 0x04,

471 
	gHX8357_DMA_ACTIVE
 = 0x80 };

472 
£tF¿meBufãr
(
ušt16_t
 *
äame_bufãr
);

473 
ušt8_t
 
u£F¿meBufãr
(
boŞ—n
 
b
);

474 
ä“F¿meBufãr
();

475 
upd©eSü“n
();

476 
boŞ
 
upd©eSü“nAsync
(boŞ 
upd©e_cÚt
 = 
çl£
);

477 
wa™Upd©eAsyncCom¶‘e
();

478 
’dUpd©eAsync
();

479 
dumpDMAS‘tšgs
();

480 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


481 
ušt16_t
 *
	$g‘F¿meBufãr
() {

482  
_pfbtá
;

483 
	}
}

484 
ušt32_t
 
	$äameCouÁ
() {

485  
_dma_äame_couÁ
;

486 
	}
}

487 
boŞ—n
 
	$asyncUpd©eAùive
() {

488  (
_dma_¡©e
 & 
HX8357_DMA_ACTIVE
);

489 
	}
}

490 
š™DMAS‘tšgs
();

492 
ušt32_t
 
	$äameCouÁ
() {

494 
	}
}

495 
ušt16_t
 *
	$g‘F¿meBufãr
() {

496  
NULL
;

497 
	}
}

498 
boŞ—n
 
	$asyncUpd©eAùive
() {

499  
çl£
;

500 
	}
}

502 
	g´Ùeùed
:

503 
SPICÏss
 *
_p¥i
 = 
nuÎ±r
;

504 
	gSPICÏss
::
SPI_H¬dw¬e_t
 *
_¥i_h¬dw¬e
;

506 
ušt8_t
 
	g_¥i_num
;

507 
ušt32_t
 
	g_SPI_CLOCK
;

508 
ušt32_t
 
	g_SPI_CLOCK_READ
;

510 #ià
	$defšed
(
KINETISK
)

511 
KINETISK_SPI_t
 *
_pkš‘isk_¥i
;

512 #–ià
	`defšed
(
__IMXRT1052__
è|| 
	$defšed
(
__IMXRT1062__
)

513 
IMXRT_LPSPI_t
 *
_pimx¹_¥i
;

515 #–ià
	$defšed
(
KINETISL
)

516 
KINETISL_SPI_t
 *
_pkš‘i¦_¥i
;

519 
št16_t
 
_width
, 
_height
;

520 
št16_t
 
cursÜ_x
, 
cursÜ_y
;

521 
boŞ
 
_ûÁ”_x_‹xt
 = 
çl£
;

522 
boŞ
 
_ûÁ”_y_‹xt
 = 
çl£
;

523 
št16_t
 
_şx1
, 
_şy1
, 
_şx2
, 
_şy2
;

524 
št16_t
 
_Üigšx
, 
_Üigšy
;

525 
št16_t
 
_di¥Ïyşx1
, 
_di¥Ïyşy1
, 
_di¥Ïyşx2
, 
_di¥Ïyşy2
;

526 
boŞ
 
_švisibË
 = 
çl£
;

527 
boŞ
 
_¡ªd¬d
 = 
Œue
;

529 
šlše
 
	$upd©eDi¥ÏyCl
() {

530 
_di¥Ïyşx1
 = 
	`max
(0, 
	`mš
(
_şx1
 + 
_Üigšx
, 
	`width
()));

531 
_di¥Ïyşx2
 = 
	`max
(0, 
	`mš
(
_şx2
 + 
_Üigšx
, 
	`width
()));

533 
_di¥Ïyşy1
 = 
	`max
(0, 
	`mš
(
_şy1
 + 
_Üigšy
, 
	`height
()));

534 
_di¥Ïyşy2
 = 
	`max
(0, 
	`mš
(
_şy2
 + 
_Üigšy
, 
	`height
()));

535 
_švisibË
 = (
_di¥Ïyşx1
 =ğ
_di¥Ïyşx2
 || 
_di¥Ïyşy1
 =ğ
_di¥Ïyşy2
);

536 
_¡ªd¬d
 = (
_di¥Ïyşx1
 =ğ0è&& (
_di¥Ïyşx2
 =ğ
_width
è&& (
_di¥Ïyşy1
 =ğ0è&& (
_di¥Ïyşy2
 =ğ
_height
);

537 ià(
S”Ÿl
) {

541 
	}
}

543 
št16_t
 
	gsüŞl_x
, 
	gsüŞl_y
, 
	gsüŞl_width
, 
	gsüŞl_height
;

544 
boŞ—n
 
	gsüŞlEÇbË
, 
	gisWr™šgSüŞlA»a
;

546 
ušt16_t
 
	g‹xtcŞÜ
, 
	g‹xtbgcŞÜ
, 
	gsüŞlbgcŞÜ
;

547 
ušt32_t
 
	g‹xtcŞÜP»x·nded
, 
	g‹xtbgcŞÜP»x·nded
;

548 
ušt8_t
 
	g‹xtsize_x
, 
	g‹xtsize_y
, 
	grÙ©iÚ
, 
	g‹xtd©um
;

549 
boŞ—n
 
	gw¿p
;

550 cÚ¡ 
ILI9341_t3_fÚt_t
 *
	gfÚt
;

552 
ušt8_t
 
	gfÚtbµ
 = 1;

553 
ušt8_t
 
	gfÚtbµšdex
 = 0;

554 
ušt8_t
 
	gfÚtbµmask
 = 1;

555 
ušt8_t
 
	gfÚpb
 = 8;

556 
ušt8_t
 *
	gfÚÍh®ut
;

557 
	gfÚÍhamx
 = 1;

559 
ušt32_t
 
	g·dX
;

562 cÚ¡ 
GFXfÚt
 *
	ggfxFÚt
 = 
nuÎ±r
;

563 
št8_t
 
	g_gfxFÚt_mš_yOff£t
 = 0;

566 
	g_gfx_c_Ï¡
;

567 
št16_t
 
	g_gfx_Ï¡_cursÜ_x
, 
	g_gfx_Ï¡_cursÜ_y
;

568 
št16_t
 
	g_gfx_Ï¡_ch¬_x_wr™e
 = 0;

569 
ušt16_t
 
	g_gfx_Ï¡_ch¬_‹xtcŞÜ
;

570 
ušt16_t
 
	g_gfx_Ï¡_ch¬_‹xtbgcŞÜ
;

571 
boŞ
 
gfxFÚtLa¡Ch¬PosFG
(
št16_t
 
x
, iÁ16_ˆ
y
);

574 
ušt8_t
 
	g_r¡
;

575 
ušt8_t
 
	g_cs
, 
	g_dc
;

576 
ušt8_t
 
	gpcs_d©a
, 
	gpcs_commªd
;

577 
ušt8_t
 
	g_miso
, 
	g_mosi
, 
	g_sşk
;

581 #ià
	$defšed
(
KINETISK
)

583 
ušt32_t
 
_fifo_fuÎ_‹¡
;

584 
	`wa™FifoNÙFuÎ
();

585 
	`wa™FifoEm±y
();

586 
	`wa™T¿nsm™Com¶‘e
();

587 
	`wa™T¿nsm™Com¶‘e
(
ušt32_t
 
mü
);

589 #–ià
	`defšed
(
__IMXRT1052__
è|| 
	$defšed
(
__IMXRT1062__
)

590 
ušt8_t
 
³ndšg_rx_couÁ
 = 0;

591 
	`wa™FifoNÙFuÎ
();

592 
	`wa™FifoEm±y
();

593 
	`wa™T¿nsm™Com¶‘e
();

594 
	`wa™T¿nsm™Com¶‘e
(
ušt32_t
 
mü
);

595 #–ià
	$defšed
(
KINETISL
)

601 #ià
	`defšed
(
__IMXRT1052__
è|| 
	$defšed
(
__IMXRT1062__
)

602 
ušt32_t
 
_c¥šmask
;

603 vŞ©
ušt32_t
 *
_c¥Üt
;

604 
ušt32_t
 
_¥i_tü_cu¼’t
;

605 
ušt32_t
 
_dıšmask
;

606 
ušt32_t
 
_tü_dc_as£¹
;

607 
ušt32_t
 
_tü_dc_nÙ_as£¹
;

608 vŞ©
ušt32_t
 *
_dıÜt
;

610 
ušt8_t
 
_c¥šmask
;

611 vŞ©
ušt8_t
 *
_c¥Üt
;

613 #ifdeà
KINETISL


614 vŞ©
ušt8_t
 *
_dıÜt
;

615 
ušt8_t
 
_dıšmask
;

617 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


619 
ušt16_t
 *
_pfbtá
;

620 
ušt8_t
 
_u£_fbtá
;

621 
ušt16_t
 *
_we_®loÿ‹d_bufãr
;

622 
št16_t
 
_chªged_mš_x
, 
_chªged_max_x
, 
_chªged_mš_y
, 
_chªged_max_y
;

623 
boŞ
 
_upd©eChªgedA»asOÆy
 = 
çl£
;

625 #ià
	`defšed
(
__IMXRT1052__
è|| 
	$defšed
(
__IMXRT1062__
)

626 
ušt16_t
 *
_pfbtá_async
;

627 
HX8357_t3n
 *
_dmaAùiveDi¥Ïy
[3];

629 
HX8357_t3n
 *
_dmaAùiveDi¥Ïy
;

631 vŞ©
ušt8_t
 
_dma_¡©e
 = 0;

632 vŞ©
ušt32_t
 
_dma_äame_couÁ
 = 0;

633 #ià
	$defšed
(
__MK66FX1M0__
)

635 
DMAS‘tšg
 
_dma£‰šgs
[4];

636 
DMAChªÃl
 
_dm©x
;

637 #–ià
	`defšed
(
__IMXRT1052__
è|| 
	$defšed
(
__IMXRT1062__
)

641 cÚ¡ 
ušt32_t
 
_couÁ_pix–s
 = 
HX8357_TFTWIDTH
 * 
HX8357_TFTHEIGHT
;

643 #ià
	$defšed
(
TRY_FULL_DMA_CHAIN
)

644 
DMAS‘tšg
 
_dma£‰šgs
[6];

647 
DMAS‘tšg
 
_dma£‰šgs
[2];

648 
ušt16_t
 
_dma_út_sub_äames_³r_äame
;

649 cÚ¡ 
ušt16_t
 
DMA_BUFFER_SIZE
 = 960;

650 
ušt16_t
 
_dma_bufãr1
[
DMA_BUFFER_SIZE
] 
	`__©Œibu‹__
((
	`®igÃd
(4)));

651 
ušt16_t
 
_dma_bufãr2
[
DMA_BUFFER_SIZE
] 
	`__©Œibu‹__
((
	`®igÃd
(4)));

654 
DMAChªÃl
 
_dm©x
;

655 vŞ©
ušt32_t
 
_dma_pix–_šdex
 = 0;

656 vŞ©
ušt16_t
 
_dma_sub_äame_couÁ
 = 0;

657 
ušt16_t
 
_dma_bufãr_size
;

658 
ušt32_t
 
_¥i_fü_§ve
;

659 
	`dmaIÁ”ru±1
();

660 
	`dmaIÁ”ru±2
();

664 
DMAChªÃl
 
_dm©x
;

665 
DMAChªÃl
 
_dm¬x
;

666 
ušt16_t
 
_dma_couÁ_»maššg
;

667 
ušt16_t
 
_dma_wr™e_size_wÜds
;

669 
	`dmaIÁ”ru±
();

670 
	`´oûss_dma_š‹¼u±
();

672 
	`ch¬Bounds
(
c
, 
št16_t
 *
x
, iÁ16_ˆ*
y
,

673 
št16_t
 *
mšx
, iÁ16_ˆ*
mšy
, iÁ16_ˆ*
maxx
, iÁ16_ˆ*
maxy
);

675 
ušt16_t
 
_´evious_addr_x0
 = 0xffff;

676 
ušt16_t
 
_´evious_addr_x1
 = 0xffff;

677 
ušt16_t
 
_´evious_addr_y0
 = 0xffff;

678 
ušt16_t
 
_´evious_addr_y1
 = 0xffff;

680 
	$£tAddr
(
ušt16_t
 
x0
, ušt16_ˆ
y0
, ušt16_ˆ
x1
, ušt16_ˆ
y1
)

681 
	`__©Œibu‹__
((
®ways_šlše
)) {

682 ià((
x0
 !ğ
_´evious_addr_x0
è|| (
x1
 !ğ
_´evious_addr_x1
)) {

683 
	`wr™ecommªd_cÚt
(
HX8357_CASET
);

684 
	`wr™ed©a16_cÚt
(
x0
);

685 
	`wr™ed©a16_cÚt
(
x1
);

686 
_´evious_addr_x0
 = 
x0
;

687 
_´evious_addr_x1
 = 
x1
;

689 ià((
y0
 !ğ
_´evious_addr_y0
è|| (
y1
 !ğ
_´evious_addr_y1
)) {

690 
	`wr™ecommªd_cÚt
(
HX8357_PASET
);

691 
	`wr™ed©a16_cÚt
(
y0
);

692 
	`wr™ed©a16_cÚt
(
y1
);

693 
_´evious_addr_y0
 = 
y0
;

694 
_´evious_addr_y1
 = 
y1
;

696 
	}
}

698 #ià
defšed
(
__IMXRT1052__
è|| 
	$defšed
(
__IMXRT1062__
)

701 
	$DIRECT_WRITE_LOW
(vŞ©
ušt32_t
 *
ba£
, ušt32_ˆ
mask
è
	`__©Œibu‹__
((
®ways_šlše
)) {

702 *(
ba£
 + 34èğ
mask
;

703 
	}
}

704 
	$DIRECT_WRITE_HIGH
(vŞ©
ušt32_t
 *
ba£
, ušt32_ˆ
mask
è
	`__©Œibu‹__
((
®ways_šlše
)) {

705 *(
ba£
 + 33èğ
mask
;

706 
	}
}

709 
	$begšSPIT¿n§ùiÚ
(
ušt32_t
 
şock
è
	`__©Œibu‹__
((
®ways_šlše
)) {

710 
_p¥i
->
	`begšT¿n§ùiÚ
(
	`SPIS‘tšgs
(
şock
, 
MSBFIRST
, 
SPI_MODE0
));

711 #ià
	`defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

712 ià(!
_dıÜt
è
_¥i_tü_cu¼’t
 = 
_pimx¹_¥i
->
TCR
;

714 ià(
_c¥Üt
) {

715 #ià
	`defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

716 
	`DIRECT_WRITE_LOW
(
_c¥Üt
, 
_c¥šmask
);

718 *
_c¥Üt
 &ğ~
_c¥šmask
;

721 
	}
}

722 
	$’dSPIT¿n§ùiÚ
(è
	`__©Œibu‹__
((
®ways_šlše
)) {

723 ià(
_c¥Üt
) {

724 #ià
	`defšed
(
__IMXRT1052__
è|| defšed(
__IMXRT1062__
)

725 
	`DIRECT_WRITE_HIGH
(
_c¥Üt
, 
_c¥šmask
);

727 *
_c¥Üt
 |ğ
_c¥šmask
;

730 
_p¥i
->
	`’dT¿n§ùiÚ
();

731 
	}
}

732 #ià
	$defšed
(
KINETISK
)

733 
	$wr™ecommªd_cÚt
(
ušt8_t
 
c
è
	`__©Œibu‹__
((
®ways_šlše
)) {

734 
_pkš‘isk_¥i
->
PUSHR
 = 
c
 | (
pcs_commªd
 << 16è| 
	`SPI_PUSHR_CTAS
(0è| 
SPI_PUSHR_CONT
;

735 
	`wa™FifoNÙFuÎ
();

736 
	}
}

737 
	$wr™ed©a8_cÚt
(
ušt8_t
 
c
è
	`__©Œibu‹__
((
®ways_šlše
)) {

738 
_pkš‘isk_¥i
->
PUSHR
 = 
c
 | (
pcs_d©a
 << 16è| 
	`SPI_PUSHR_CTAS
(0è| 
SPI_PUSHR_CONT
;

739 
	`wa™FifoNÙFuÎ
();

740 
	}
}

741 
	$wr™ed©a16_cÚt
(
ušt16_t
 
d
è
	`__©Œibu‹__
((
®ways_šlše
)) {

742 
_pkš‘isk_¥i
->
PUSHR
 = 
d
 | (
pcs_d©a
 << 16è| 
	`SPI_PUSHR_CTAS
(1è| 
SPI_PUSHR_CONT
;

743 
	`wa™FifoNÙFuÎ
();

744 
	}
}

745 
	$wr™ecommªd_Ï¡
(
ušt8_t
 
c
è
	`__©Œibu‹__
((
®ways_šlše
)) {

746 
ušt32_t
 
mü
 = 
_pkš‘isk_¥i
->
MCR
;

747 
_pkš‘isk_¥i
->
PUSHR
 = 
c
 | (
pcs_commªd
 << 16è| 
	`SPI_PUSHR_CTAS
(0è| 
SPI_PUSHR_EOQ
;

748 
	`wa™T¿nsm™Com¶‘e
(
mü
);

749 
	}
}

750 
	$wr™ed©a8_Ï¡
(
ušt8_t
 
c
è
	`__©Œibu‹__
((
®ways_šlše
)) {

751 
ušt32_t
 
mü
 = 
_pkš‘isk_¥i
->
MCR
;

752 
_pkš‘isk_¥i
->
PUSHR
 = 
c
 | (
pcs_d©a
 << 16è| 
	`SPI_PUSHR_CTAS
(0è| 
SPI_PUSHR_EOQ
;

753 
	`wa™T¿nsm™Com¶‘e
(
mü
);

754 
	}
}

755 
	$wr™ed©a16_Ï¡
(
ušt16_t
 
d
è
	`__©Œibu‹__
((
®ways_šlše
)) {

756 
ušt32_t
 
mü
 = 
_pkš‘isk_¥i
->
MCR
;

757 
_pkš‘isk_¥i
->
PUSHR
 = 
d
 | (
pcs_d©a
 << 16è| 
	`SPI_PUSHR_CTAS
(1è| 
SPI_PUSHR_EOQ
;

758 
	`wa™T¿nsm™Com¶‘e
(
mü
);

759 
	}
}

760 #–ià
defšed
(
__IMXRT1052__
è|| 
	$defšed
(
__IMXRT1062__
)

761 
	#TCR_MASK
 (
	`LPSPI_TCR_PCS
(3è| 
	`LPSPI_TCR_FRAMESZ
(31è| 
LPSPI_TCR_CONT
 | 
LPSPI_TCR_RXMSK
)

	)

762 
	$maybeUpd©eTCR
(
ušt32_t
 
»que¡ed_tü_¡©e
) {

763 ià((
_¥i_tü_cu¼’t
 & 
TCR_MASK
è!ğ
»que¡ed_tü_¡©e
) {

764 
boŞ
 
dc_¡©e_chªge
 = (
_¥i_tü_cu¼’t
 & 
	`LPSPI_TCR_PCS
(3)è!ğ(
»que¡ed_tü_¡©e
 & LPSPI_TCR_PCS(3));

765 
_¥i_tü_cu¼’t
 = (_¥i_tü_cu¼’ˆ& ~
TCR_MASK
è| 
»que¡ed_tü_¡©e
;

767 ià(!
dc_¡©e_chªge
 || !
_dıšmask
) {

768 (
_pimx¹_¥i
->
FSR
 & 0x1f))

770 
_pimx¹_¥i
->
TCR
 = 
_¥i_tü_cu¼’t
;

773 
	`wa™T¿nsm™Com¶‘e
();

774 ià(
»que¡ed_tü_¡©e
 & 
	`LPSPI_TCR_PCS
(3)è
	`DIRECT_WRITE_HIGH
(
_dıÜt
, 
_dıšmask
);

775 
	`DIRECT_WRITE_LOW
(
_dıÜt
, 
_dıšmask
);

776 
_pimx¹_¥i
->
TCR
 = 
_¥i_tü_cu¼’t
 & ~(
	`LPSPI_TCR_PCS
(3è| 
LPSPI_TCR_CONT
);

779 
	}
}

782 
	$wr™ecommªd_cÚt
(
ušt8_t
 
c
è
	`__©Œibu‹__
((
®ways_šlše
)) {

783 
	`maybeUpd©eTCR
(
_tü_dc_as£¹
 | 
	`LPSPI_TCR_FRAMESZ
(7) );

784 
_pimx¹_¥i
->
TDR
 = 
c
;

785 
³ndšg_rx_couÁ
++;

786 
	`wa™FifoNÙFuÎ
();

787 
	}
}

788 
	$wr™ed©a8_cÚt
(
ušt8_t
 
c
è
	`__©Œibu‹__
((
®ways_šlše
)) {

789 
	`maybeUpd©eTCR
(
_tü_dc_nÙ_as£¹
 | 
	`LPSPI_TCR_FRAMESZ
(7è| 
LPSPI_TCR_CONT
);

790 
_pimx¹_¥i
->
TDR
 = 
c
;

791 
³ndšg_rx_couÁ
++;

792 
	`wa™FifoNÙFuÎ
();

793 
	}
}

794 
	$wr™ed©a16_cÚt
(
ušt16_t
 
d
è
	`__©Œibu‹__
((
®ways_šlše
)) {

795 
	`maybeUpd©eTCR
(
_tü_dc_nÙ_as£¹
 | 
	`LPSPI_TCR_FRAMESZ
(15è| 
LPSPI_TCR_CONT
);

796 
_pimx¹_¥i
->
TDR
 = 
d
;

797 
³ndšg_rx_couÁ
++;

798 
	`wa™FifoNÙFuÎ
();

799 
	}
}

800 
	$wr™ecommªd_Ï¡
(
ušt8_t
 
c
è
	`__©Œibu‹__
((
®ways_šlše
)) {

801 
	`maybeUpd©eTCR
(
_tü_dc_as£¹
 | 
	`LPSPI_TCR_FRAMESZ
(7));

802 
_pimx¹_¥i
->
TDR
 = 
c
;

804 
³ndšg_rx_couÁ
++;

805 
	`wa™T¿nsm™Com¶‘e
();

806 
	}
}

807 
	$wr™ed©a8_Ï¡
(
ušt8_t
 
c
è
	`__©Œibu‹__
((
®ways_šlše
)) {

808 
	`maybeUpd©eTCR
(
_tü_dc_nÙ_as£¹
 | 
	`LPSPI_TCR_FRAMESZ
(7));

809 
_pimx¹_¥i
->
TDR
 = 
c
;

811 
³ndšg_rx_couÁ
++;

812 
	`wa™T¿nsm™Com¶‘e
();

813 
	}
}

814 
	$wr™ed©a16_Ï¡
(
ušt16_t
 
d
è
	`__©Œibu‹__
((
®ways_šlše
)) {

815 
	`maybeUpd©eTCR
(
_tü_dc_nÙ_as£¹
 | 
	`LPSPI_TCR_FRAMESZ
(15));

816 
_pimx¹_¥i
->
TDR
 = 
d
;

818 
³ndšg_rx_couÁ
++;

819 
	`wa™T¿nsm™Com¶‘e
();

820 
	}
}

822 #–ià
	$defšed
(
KINETISL
)

824 
ušt8_t
 
_dıšAs£¹ed
;

825 
ušt8_t
 
_d©a_£Á_nÙ_com¶‘ed
;

826 
	$wa™T¿nsm™Com¶‘e
() {

827 
_d©a_£Á_nÙ_com¶‘ed
) {

828 
ušt16_t
 
timeout_couÁ
 = 0xff;

829 !(
_pkš‘i¦_¥i
->
S
 & 
SPI_S_SPRF
è&& 
timeout_couÁ
--)

831 
ušt8_t
 
d
 
	`__©Œibu‹__
((
unu£d
));

832 
d
 = 
_pkš‘i¦_¥i
->
DL
;

833 
d
 = 
_pkš‘i¦_¥i
->
DH
;

834 
_d©a_£Á_nÙ_com¶‘ed
--;

836 
	}
}

837 
ušt16_t
 
	$wa™T¿nsm™Com¶‘eR‘uºLa¡
() {

838 
ušt16_t
 
d
 = 0;

839 
_d©a_£Á_nÙ_com¶‘ed
) {

840 
ušt16_t
 
timeout_couÁ
 = 0xff;

841 !(
_pkš‘i¦_¥i
->
S
 & 
SPI_S_SPRF
è&& 
timeout_couÁ
--)

843 
d
 = (
_pkš‘i¦_¥i
->
DH
 << 8è| _pkš‘i¦_¥i->
DL
;

844 
_d©a_£Á_nÙ_com¶‘ed
--;

846  
d
;

847 
	}
}

849 
	$£tCommªdMode
(è
	`__©Œibu‹__
((
®ways_šlše
)) {

850 ià(!
_dıšAs£¹ed
) {

851 
	`wa™T¿nsm™Com¶‘e
();

852 *
_dıÜt
 &ğ~
_dıšmask
;

853 
_dıšAs£¹ed
 = 1;

855 
	}
}

857 
	$£tD©aMode
(è
	`__©Œibu‹__
((
®ways_šlše
)) {

858 ià(
_dıšAs£¹ed
) {

859 
	`wa™T¿nsm™Com¶‘e
();

860 *
_dıÜt
 |ğ
_dıšmask
;

861 
_dıšAs£¹ed
 = 0;

863 
	}
}

865 
	$ouutToSPI
(
ušt8_t
 
c
) {

866 ià(
_pkš‘i¦_¥i
->
C2
 & 
SPI_C2_SPIMODE
) {

868 
	`wa™T¿nsm™Com¶‘e
();

869 
_pkš‘i¦_¥i
->
C2
 = 0;

871 !(
_pkš‘i¦_¥i
->
S
 & 
SPI_S_SPTEF
))

874 ià((
_pkš‘i¦_¥i
->
S
 & 
SPI_S_SPRF
)) {

875 
ušt8_t
 
d
 
	`__©Œibu‹__
((
unu£d
));

876 
d
 = 
_pkš‘i¦_¥i
->
DL
;

877 
_d©a_£Á_nÙ_com¶‘ed
--;

879 
_pkš‘i¦_¥i
->
DL
 = 
c
;

880 
_d©a_£Á_nÙ_com¶‘ed
++;

881 
	}
}

883 
	$ouutToSPI16
(
ušt16_t
 
d©a
) {

884 ià(!(
_pkš‘i¦_¥i
->
C2
 & 
SPI_C2_SPIMODE
)) {

886 
	`wa™T¿nsm™Com¶‘e
();

887 
_pkš‘i¦_¥i
->
C2
 = 
SPI_C2_SPIMODE
;

889 
ušt8_t
 
s
;

891 
s
 = 
_pkš‘i¦_¥i
->
S
;

894 ià((
s
 & 
SPI_S_SPRF
)) {

895 
ušt8_t
 
d
 
	`__©Œibu‹__
((
unu£d
));

896 
d
 = 
_pkš‘i¦_¥i
->
DL
;

897 
d
 = 
_pkš‘i¦_¥i
->
DH
;

898 
_d©a_£Á_nÙ_com¶‘ed
--;

901 } !(
s
 & 
SPI_S_SPTEF
è|| ( & 
SPI_S_SPRF
));

903 
_pkš‘i¦_¥i
->
DL
 = 
d©a
;

904 
_pkš‘i¦_¥i
->
DH
 = 
d©a
 >> 8;

905 
_d©a_£Á_nÙ_com¶‘ed
++;

906 
	}
}

908 
	$wr™ecommªd_cÚt
(
ušt8_t
 
c
) {

909 
	`£tCommªdMode
();

910 
	`ouutToSPI
(
c
);

911 
	}
}

912 
	$wr™ed©a8_cÚt
(
ušt8_t
 
c
) {

913 
	`£tD©aMode
();

914 
	`ouutToSPI
(
c
);

915 
	}
}

917 
	$wr™ed©a16_cÚt
(
ušt16_t
 
c
) {

918 
	`£tD©aMode
();

919 
	`ouutToSPI16
(
c
);

920 
	}
}

922 
	$wr™ecommªd_Ï¡
(
ušt8_t
 
c
) {

923 
	`£tCommªdMode
();

924 
	`ouutToSPI
(
c
);

925 
	`wa™T¿nsm™Com¶‘e
();

926 
	}
}

927 
	$wr™ed©a8_Ï¡
(
ušt8_t
 
c
) {

928 
	`£tD©aMode
();

929 
	`ouutToSPI
(
c
);

930 
	`wa™T¿nsm™Com¶‘e
();

931 
	}
}

932 
	$wr™ed©a16_Ï¡
(
ušt16_t
 
c
) {

933 
	`£tD©aMode
();

934 
	`ouutToSPI16
(
c
);

935 
	`wa™T¿nsm™Com¶‘e
();

936 
	}
}

939 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


940 
	$ş—rChªgedRªge
() {

941 
_chªged_mš_x
 = 0x7fff;

942 
_chªged_max_x
 = -1;

943 
_chªged_mš_x
 = 0x7fff;

944 
_chªged_max_y
 = -1;

945 
	}
}

947 
	$upd©eChªgedRªge
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, iÁ16_ˆ
h
)

948 
	`__©Œibu‹__
((
®ways_šlše
)) {

949 ià(
x
 < 
_chªged_mš_x
) _changed_min_x = x;

950 ià(
y
 < 
_chªged_mš_y
) _changed_min_y = y;

951 
x
 +ğ
w
 - 1;

952 
y
 +ğ
h
 - 1;

953 ià(
x
 > 
_chªged_max_x
) _changed_max_x = x;

954 ià(
y
 > 
_chªged_max_y
) _changed_max_y = y;

955 
	}
}

958 
	$upd©eChªgedRªge
(
št16_t
 
x
, iÁ16_ˆ
y
)

959 
	`__©Œibu‹__
((
®ways_šlše
)) {

960 ià(
x
 < 
_chªged_mš_x
) _changed_min_x = x;

961 ià(
y
 < 
_chªged_mš_y
) _changed_min_y = y;

962 ià(
x
 > 
_chªged_max_x
) _changed_max_x = x;

963 ià(
y
 > 
_chªged_max_y
) _changed_max_y = y;

964 
	}
}

967 
	$upd©eChªgedA»asOÆy
(
boŞ
 
upd©eChªgedOÆy
) {

968 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


969 
_upd©eChªgedA»asOÆy
 = 
upd©eChªgedOÆy
;

971 
	}
}

975 
	$HLše
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
w
, 
ušt16_t
 
cŞÜ
)

976 
	`__©Œibu‹__
((
®ways_šlše
)) {

977 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


978 ià(
_u£_fbtá
) {

979 
	`d¿wFa¡HLše
(
x
, 
y
, 
w
, 
cŞÜ
);

983 
x
 +ğ
_Üigšx
;

984 
y
 +ğ
_Üigšy
;

987 ià((
y
 < 
_di¥Ïyşy1
è|| (
x
 >ğ
_di¥Ïyşx2
è|| (y >ğ
_di¥Ïyşy2
)) ;

988 ià(
x
 < 
_di¥Ïyşx1
) {

989 
w
 = w - (
_di¥Ïyşx1
 - 
x
);

990 
x
 = 
_di¥Ïyşx1
;

992 ià((
x
 + 
w
 - 1è>ğ
_di¥Ïyşx2
) w = _displayclipx2 - x;

993 ià(
w
 < 1) ;

995 
	`£tAddr
(
x
, 
y
, x + 
w
 - 1, y);

996 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

997 dØ{ 
	`wr™ed©a16_cÚt
(
cŞÜ
); } --
w
 > 0);

998 
	}
}

999 
	$VLše
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
h
, 
ušt16_t
 
cŞÜ
)

1000 
	`__©Œibu‹__
((
®ways_šlše
)) {

1001 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


1002 ià(
_u£_fbtá
) {

1003 
	`d¿wFa¡VLše
(
x
, 
y
, 
h
, 
cŞÜ
);

1007 
x
 +ğ
_Üigšx
;

1008 
y
 +ğ
_Üigšy
;

1011 ià((
x
 < 
_di¥Ïyşx1
è|| (x >ğ
_di¥Ïyşx2
è|| (
y
 >ğ
_di¥Ïyşy2
)) ;

1012 ià(
y
 < 
_di¥Ïyşy1
) {

1013 
h
 = h - (
_di¥Ïyşy1
 - 
y
);

1014 
y
 = 
_di¥Ïyşy1
;

1016 ià((
y
 + 
h
 - 1è>ğ
_di¥Ïyşy2
) h = _displayclipy2 - y;

1017 ià(
h
 < 1) ;

1019 
	`£tAddr
(
x
, 
y
, x, y + 
h
 - 1);

1020 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

1021 dØ{ 
	`wr™ed©a16_cÚt
(
cŞÜ
); } --
h
 > 0);

1022 
	}
}

1037 
ušt16_t
 
	$®phaBËndRGB565
(
ušt32_t
 
fg
, ušt32_ˆ
bg
, 
ušt8_t
 
®pha
)

1038 
	`__©Œibu‹__
((
®ways_šlše
)) {

1039 
®pha
 = (alpha + 4) >> 3;

1040 
bg
 = (bg | (bg << 16)) & 0b00000111111000001111100000011111;

1041 
fg
 = (fg | (fg << 16)) & 0b00000111111000001111100000011111;

1042 
ušt32_t
 
»suÉ
 = ((((
fg
 - 
bg
è* 
®pha
) >> 5) + bg) & 0b00000111111000001111100000011111;

1043  (
ušt16_t
)((
»suÉ
 >> 16) |„esult);

1044 
	}
}

1048 
ušt16_t
 
	$®phaBËndRGB565P»muÉl›d
(
ušt32_t
 
fg
, ušt32_ˆ
bg
, 
ušt8_t
 
®pha
)

1049 
	`__©Œibu‹__
((
®ways_šlše
)) {

1050 
ušt32_t
 
»suÉ
 = ((((
fg
 - 
bg
è* 
®pha
) >> 5) + bg) & 0b00000111111000001111100000011111;

1051  (
ušt16_t
)((
»suÉ
 >> 16) |„esult);

1052 
	}
}

1053 
	$Pix–
(
št16_t
 
x
, iÁ16_ˆ
y
, 
ušt16_t
 
cŞÜ
)

1054 
	`__©Œibu‹__
((
®ways_šlše
)) {

1055 
x
 +ğ
_Üigšx
;

1056 
y
 +ğ
_Üigšy
;

1058 ià((
x
 < 
_di¥Ïyşx1
è|| (x >ğ
_di¥Ïyşx2
è|| (
y
 < 
_di¥Ïyşy1
è|| (y >ğ
_di¥Ïyşy2
)) ;

1060 #ifdeà
ENABLE_HX8357_FRAMEBUFFER


1061 ià(
_u£_fbtá
) {

1062 
	`upd©eChªgedRªge
(
x
, 
y
);

1063 
_pfbtá
[
y
 * 
_width
 + 
x
] = 
cŞÜ
;

1067 
	`£tAddr
(
x
, 
y
, x, y);

1068 
	`wr™ecommªd_cÚt
(
HX8357_RAMWR
);

1069 
	`wr™ed©a16_cÚt
(
cŞÜ
);

1070 
	}
}

1071 
d¿wFÚtB™s
(
boŞ
 
İaque
, 
ušt32_t
 
b™s
, ušt32_ˆ
numb™s
, 
št32_t
 
x
, iÁ32_ˆ
y
, ušt32_ˆ
»³©
);

1072 
d¿wFÚtPix–
(
ušt8_t
 
®pha
, 
ušt32_t
 
x
, ušt32_ˆ
y
);

1073 
ušt32_t
 
ãtchpix–
(cÚ¡ 
ušt8_t
 *
p
, ušt32_ˆ
šdex
, ušt32_ˆ
x
);

1076 #iâdeà
hx8357_sw­


1077 
	#hx8357_sw­
(
a
, 
b
) \

1079 
	`ty³of
(
a
è
t
 =‡; \

1080 
a
 = 
b
; \

1081 
b
 = 
t
; \

1082 }

	)

1092 #ifdeà
Adaäu™_GFX_Bu‰Ú


1093 #undeà
Adaäu™_GFX_Bu‰Ú


1095 
	#Adaäu™_GFX_Bu‰Ú
 
HX8357_Bu‰Ú


	)

1096 şas 
	cHX8357_Bu‰Ú
 {

1097 
	mpublic
:

1098 
	$HX8357_Bu‰Ú
() {

1099 
_gfx
 = 
NULL
;

1101 
	$š™Bu‰Ú
(
HX8357_t3n
 *
gfx
, 
št16_t
 
x
, iÁ16_ˆ
y
,

1102 
ušt8_t
 
w
, ušt8_ˆ
h
,

1103 
ušt16_t
 
ouše
, ušt16_ˆ
fl
, ušt16_ˆ
‹xtcŞÜ
,

1104 cÚ¡ *
Ïb–
, 
ušt8_t
 
‹xtsize_x
, ušt8_ˆ
‹xtsize_y
) {

1105 
_x
 = 
x
;

1106 
_y
 = 
y
;

1107 
_w
 = 
w
;

1108 
_h
 = 
h
;

1109 
_oušecŞÜ
 = 
ouše
;

1110 
_flcŞÜ
 = 
fl
;

1111 
_‹xtcŞÜ
 = 
‹xtcŞÜ
;

1112 
_‹xtsize_x
 = 
‹xtsize_x
;

1113 
_‹xtsize_y
 = 
‹xtsize_y
;

1114 
_gfx
 = 
gfx
;

1115 
	`¡ºıy
(
_Ïb–
, 
Ïb–
, 9);

1116 
_Ïb–
[9] = 0;

1117 
	}
}

1118 
	$d¿wBu‰Ú
(
boŞ
 
šv”‹d
 = 
çl£
) {

1119 
ušt16_t
 
fl
, 
ouše
, 
‹xt
;

1121 ià(!
šv”‹d
) {

1122 
fl
 = 
_flcŞÜ
;

1123 
ouše
 = 
_oušecŞÜ
;

1124 
‹xt
 = 
_‹xtcŞÜ
;

1126 
fl
 = 
_‹xtcŞÜ
;

1127 
ouše
 = 
_oušecŞÜ
;

1128 
‹xt
 = 
_flcŞÜ
;

1130 
_gfx
->
	`flRoundReù
(
_x
 - (
_w
 / 2), 
_y
 - (
_h
 / 2), _w, _h, 
	`mš
(_w, _hè/ 4, 
fl
);

1131 
_gfx
->
	`d¿wRoundReù
(
_x
 - (
_w
 / 2), 
_y
 - (
_h
 / 2), _w, _h, 
	`mš
(_w, _hè/ 4, 
ouše
);

1132 
_gfx
->
	`£tCursÜ
(
_x
 - 
	`¡¾’
(
_Ïb–
è* 3 * 
_‹xtsize_x
, 
_y
 - 4 * 
_‹xtsize_y
);

1133 
_gfx
->
	`£tTextCŞÜ
(
‹xt
);

1134 
_gfx
->
	`£tTextSize
(
_‹xtsize_x
, 
_‹xtsize_y
);

1135 
_gfx
->
	`´št
(
_Ïb–
);

1136 
	}
}

1138 
boŞ
 
	$cÚšs
(
št16_t
 
x
, iÁ16_ˆ
y
) {

1139 ià((
x
 < (
_x
 - 
_w
 / 2)è|| (x > (_x + _w / 2))è 
çl£
;

1140 ià((
y
 < (
_y
 - 
_h
 / 2)è|| (y > (_y + _h / 2))è 
çl£
;

1141  
Œue
;

1142 
	}
}

1144 
	$´ess
(
boŞ—n
 
p
) {

1145 
Ï¡¡©e
 = 
cu¼¡©e
;

1146 
cu¼¡©e
 = 
p
;

1147 
	}
}

1148 
boŞ
 
	$isP»s£d
() {

1149  
cu¼¡©e
;

1150 
	}
}

1151 
boŞ
 
	$ju¡P»s£d
() {

1152  (
cu¼¡©e
 && !
Ï¡¡©e
);

1153 
	}
}

1154 
boŞ
 
	$ju¡R–—£d
() {

1155  (!
cu¼¡©e
 && 
Ï¡¡©e
);

1156 
	}
}

1157 
	g´iv©e
:

1158 
HX8357_t3n
 *
_gfx
;

1159 
št16_t
 
	g_x
, 
	g_y
;

1160 
ušt16_t
 
	g_w
, 
	g_h
;

1161 
ušt8_t
 
	g_‹xtsize_x
, 
	g_‹xtsize_y
;

1162 
ušt16_t
 
	g_oušecŞÜ
, 
	g_flcŞÜ
, 
	g_‹xtcŞÜ
;

1163 
	g_Ïb–
[10];

1164 
boŞ—n
 
	gcu¼¡©e
, 
	gÏ¡¡©e
;

	@NODEBUG.h

19 
	#DPRINTF
(...)

	)

20 
	#DTRACE
()

	)

	@PocketFT8XcvrFW.ino

1 
	~"DEBUG.h
"

3 
	~<Audio.h
>

4 
	~<Wœe.h
>

5 
	~<SD.h
>

6 
	~<SPI.h
>

8 
	~"HX8357_t3n.h
"

9 
	~"TouchSü“n_I2C.h
"

10 
	~<MCP342x.h
>

11 
	~"si5351.h
"

12 
	~<SI4735.h
>

13 
	~"·tch_fuÎ.h
"

14 
	~<TimeLib.h
>

15 
	~<EEPROM.h
>

18 
	~"Proûss_DSP.h
"

19 
	~"decode_á8.h
"

20 
	~"WF_TabË.h
"

21 
	~"¬m_m©h.h
"

22 
	~"di¥Ïy.h
"

23 
	~"bu‰Ú.h
"

24 
	~"loÿtÜ.h
"

25 
	~"Œaffic_mªag”.h
"

26 
	~"pšs.h
"

28 
	~"Ardušo.h
"

29 
	~"AudioSŒ—m.h
"

30 
	~"¬m_m©h.h
"

32 
	~"cÚ¡ªts.h
"

35 
	#ARDUINOJSON_ENABLE_COMMENTS
 1

	)

36 
	~<ArdušoJsÚ.h
>

38 
	#AM_FUNCTION
 1

	)

39 
	#USB
 2

	)

45 
	#AUDIO_RECORDING_FILENAME
 "á8.¿w"

	)

49 
	#CONFIG_FILENAME
 "/cÚfig.jsÚ"

	)

50 
	sCÚfig
 {

51 
	mÿÎsign
[12];

52 
	mloÿtiÚ
[5];

53 
	mäequ’cy
;

54 
	maudioRecÜdšgDu¿tiÚ
;

55 
	m’abËAVC
;

56 } 
	gcÚfig
;

59 
	#DEFAULT_FREQUENCY
 7074

60 
	#DEFAULT_CALLSIGN
 "NOCALL"

61 
	#DEFAULT_LOCATION
 "****"

62 
	#DEFAULT_AUDIO_RECORDING_DURATION
 0UL

63 
	#DEFAULT_ENABLE_AVC
 1

64 

	)

66 
	#MINIMUM_FREQUENCY
 7000

67 
	#MAXIMUM_FREQUENCY
 7300

68 

	)

70 
HX8357_t3n
 
	gtá
 = HX8357_t3n(
PIN_CS
, 
PIN_DC
, 
PIN_RST
, 
PIN_MOSI
, 
PIN_DCLK
, 
PIN_MISO
);

71 
TouchSü“n
 
	gts
 = TouchSü“n(
PIN_XP
, 
PIN_YP
, 
PIN_XM
, 
PIN_YM
, 282);

74 
Si5351
 
	gsi5351
;

75 
SI4735
 
	gsi4735
;

78 
AudioIÅutAÇlog
 
	gadc1
;

79 
AudioRecÜdQueue
 
	gqueue1
;

80 
AudioCÚÃùiÚ
 
·tchCÜd2
(
adc1
, 
queue1
);

83 
Fe
 
	gá8Raw
 = 
NULL
;

84 
	g»cÜdSam¶eCouÁ
 = 0;

87 
q15_t
 
	gd¥_bufãr
[3 * 
šput_guÍ_size
] 
__©Œibu‹__
((
®igÃd
(4)));

88 
q15_t
 
	gd¥_ouut
[
FFT_SIZE
 * 2] 
__©Œibu‹__
((
®igÃd
(4)));

89 
q15_t
 
	gšput_guÍ
[
šput_guÍ_size
] 
__©Œibu‹__
((
®igÃd
(4)));

92 
	gStiÚ_C®l
[12];

93 
	gLoÿtÜ
[5];

95 
ušt16_t
 
	gcu¼’tF»qu’cy
;

96 
	g‘1
 = 0, 
	g‘2
 = 0;

97 cÚ¡ 
ušt16_t
 
	gsize_cÚ‹Á
 =  
ssb_·tch_cÚ‹Á
;

98 
ušt32_t
 
	gcu¼’t_time
, 
	g¡¬t_time
, 
	gá8_time
;

99 
ušt32_t
 
	gdays_äaùiÚ
, 
	ghours_äaùiÚ
, 
	gmšu‹_äaùiÚ
;

101 
ušt8_t
 
	gá8_hours
, 
	gá8_mšu‹s
, 
	gá8_£cÚds
;

103 
	gFT_8_couÁ”
, 
	gá8_m¬k”
;

106 
	gDSP_FÏg
;

109 
	gdecode_æag
;

112 
	gá8_æag
;

115 
CQ_FÏg
;

117 
	gWF_couÁ”
;

118 
	gnum_decoded_msg
;

121 
	gxm™_æag
;

124 
	gT¿nsm™_ArmÃd
;

126 
	gá8_xm™_couÁ”
;

128 
	gma¡”_decoded
;

130 
ušt16_t
 
	gcursÜ_äeq
;

131 
ušt16_t
 
	gcursÜ_lše
;

132 
	goff£t_äeq
;

133 
	gtuÃ_æag
;

135 
	glog_æag
, 
	gloggšg_Ú
;

139 
	$£tup
() {

142 
S”Ÿl
.
	`begš
(9600);

143 !
S”Ÿl
) ;

144 
	`DTRACE
();

145 ià(
C¿shR•Üt
) {

146 
S”Ÿl
.
	`´št
(
C¿shR•Üt
);

147 
	`d–ay
(5000);

151 
	`£tSyncProvid”
(
g‘T“nsy3Time
);

152 
	`d–ay
(100);

155 
	`pšMode
(
PIN_PTT
, 
OUTPUT
);

156 
	`dig™®Wr™e
(
PIN_PTT
, 
LOW
);

159 ià(!
SD
.
	`begš
(
BUILTIN_SDCARD
)) {

160 
S”Ÿl
.
	`´šn
("Unableo‡ccesshe SD card");

164 
tá
.
	`begš
(
HX8357D
);

165 
tá
.
	`flSü“n
(
HX8357_BLACK
);

166 
tá
.
	`£tTextCŞÜ
(
HX8357_YELLOW
);

167 
tá
.
	`£tRÙ©iÚ
(3);

168 
tá
.
	`£tTextSize
(2);

172 
	#EEPROMSIZE
 4284

173 
boŞ
 
ÃwCh
 = 
Œue
;

	)

174 
adr
 = 0;‡d¸< 
EEPROMSIZE
;‡dr++) {

175 ià(
EEPROM
.
	`»ad
(
adr
è!ğ0xffè
ÃwCh
 = 
çl£
;

177 ià(
ÃwCh
) {

178 
S”Ÿl
.
	`´št
("Initializing EEPROM for‚ew chip\n");

179 
	`EEPROMWr™eIÁ
(10, 0);

183 
si5351
.
	`š™
(
SI5351_CRYSTAL_LOAD_8PF
, 25000000, 0);

184 
si5351
.
	`£t_¶l_šput
(
SI5351_PLLA
, 
SI5351_PLL_INPUT_CLKIN
);

185 
si5351
.
	`£t_¶l_šput
(
SI5351_PLLB
, 
SI5351_PLL_INPUT_CLKIN
);

186 
si5351
.
	`£t_¶l
(
SI5351_PLL_FIXED
, 
SI5351_PLLA
);

187 
si5351
.
	`£t_äeq
(3276800, 
SI5351_CLK2
);

188 
si5351
.
	`ouut_’abË
(
SI5351_CLK2
, 1);

191 
št16_t
 
si4735Addr
 = 
si4735
.
	`g‘DeviûI2CAdd»ss
(
PIN_RESET
);

192 ià(
si4735Addr
 == 0) {

193 
S”Ÿl
.
	`´šn
("Si473X‚ot found!");

194 
S”Ÿl
.
	`æush
();

197 
	`DPRINTF
("ThSi473X I2C‡dd»s i 0x%2x\n", 
si4735Addr
);

201 
Fe
 
cÚfigFe
 = 
SD
.
	`İ’
(
CONFIG_FILENAME
, 
FILE_READ
);

202 ià(!
cÚfigFe
è
S”Ÿl
.
	`´štf
("uÇbËØİ’ %s\n", 
CONFIG_FILENAME
);

203 
JsÚDocum’t
 
doc
;

204 
De£rŸliz©iÚE¼Ü
 
”rÜ
 = 
	`de£rŸlizeJsÚ
(
doc
, 
cÚfigFe
);

205 ià(
”rÜ
è
S”Ÿl
.
	`´štf
("UÇbËØ»ad SD cÚfig fe, %s\n", 
CONFIG_FILENAME
);

206 
	`¡¾ıy
(
cÚfig
.
ÿÎsign
, 
doc
["ÿÎsign"] | 
DEFAULT_CALLSIGN
, (config.callsign));

207 
cÚfig
.
äequ’cy
 = 
doc
["äequ’cy"] | 
DEFAULT_FREQUENCY
;

208 
	`¡¾ıy
(
cÚfig
.
loÿtiÚ
, 
doc
["loÿtiÚ"] | 
DEFAULT_LOCATION
, (config.location));

209 
cÚfig
.
audioRecÜdšgDu¿tiÚ
 = 
doc
["audioRecÜdšgDu¿tiÚ"] | 
DEFAULT_AUDIO_RECORDING_DURATION
;

210 
cÚfig
.
’abËAVC
 = 
doc
["’abËAVC"] | 
DEFAULT_ENABLE_AVC
;

211 
cÚfigFe
.
	`şo£
();

214 
	`DPRINTF
("doc[ÿÎsign]=%s\n", 
doc
["callsign"] | "?");

215 
	`DPRINTF
("doc[äequ’cy]=%u\n", 
doc
["frequency"] | 1234);

216 
	`DPRINTF
("doc[loÿtiÚ]=%s\n", 
doc
["location"] | "?");

217 
	`DPRINTF
("doc[audioRecÜdšgDu¿tiÚ]=%ul\n", 
doc
["audioRecordingDuration"] | 1234);

218 
	`DPRINTF
("doc[’abËAVC]=%u\n", 
doc
["enableAVC"] | 42);

221 ià(
cÚfig
.
äequ’cy
 < 
MINIMUM_FREQUENCY
 || cÚfig.äequ’cy > 
MAXIMUM_FREQUENCY
) {

222 
cÚfig
.
äequ’cy
 = 
DEFAULT_FREQUENCY
;

226 
	`¡ºıy
(
StiÚ_C®l
, 
cÚfig
.
ÿÎsign
, (Station_Call));

227 
	`¡ºıy
(
LoÿtÜ
, 
cÚfig
.
loÿtiÚ
, (Locator));

230 
	`d–ay
(10);

231 
	`DPRINTF
("SSB…atch is†oading...\n");

232 
‘1
 = 
	`mlis
();

233 
	`lßdSSB
();

234 
‘2
 = 
	`mlis
();

238 
	`d–ay
(10);

239 
si4735
.
	`£tTuÃF»qu’cyAÁ’ÇC­ac™Ü
(1);

240 
	`d–ay
(10);

242 
si4735
.
	`£tSSB
(
MINIMUM_FREQUENCY
, 
MAXIMUM_FREQUENCY
, 
cÚfig
.
äequ’cy
, 1, 
USB
);

243 
	`d–ay
(10);

244 
cu¼’tF»qu’cy
 = 
si4735
.
	`g‘F»qu’cy
();

245 
si4735
.
	`£tVŞume
(50);

248 
	`di¥Ïy_v®ue
(360, 40, ()
cu¼’tF»qu’cy
);

250 
S”Ÿl
.
	`´šn
(" ");

251 
S”Ÿl
.
	`´šn
("To change Transmit Frequency Offset Touch Tu button,hen: ");

252 
S”Ÿl
.
	`´šn
("Use keyboard uo„aise, do†ower, & so save ");

253 
S”Ÿl
.
	`´šn
(" ");

256 
	`pšMode
(
PIN_RCV
, 
OUTPUT
);

257 
	`dig™®Wr™e
(
PIN_RCV
, 
HIGH
);

259 
	`š™_DSP
();

260 
	`š™®ize_cÚ¡ªts
();

261 
	`AudioMemÜy
(20);

264 ià(
cÚfig
.
audioRecÜdšgDu¿tiÚ
 > 0) {

265 ià((
á8Raw
 = 
SD
.
	`İ’
(
AUDIO_RECORDING_FILENAME
, 
FILE_WRITE
)) == 0) {

266 
S”Ÿl
.
	`´štf
("UÇbËØİ’ %s\n", 
AUDIO_RECORDING_FILENAME
);

271 
queue1
.
	`begš
();

272 
¡¬t_time
 = 
	`mlis
();

274 
	`£t_¡¬tup_äeq
();

275 
	`d–ay
(10);

276 
	`di¥Ïy_v®ue
(360, 40, ()
cu¼’tF»qu’cy
);

278 
	`»ûive_£qu’û
();

280 
	`upd©e_synchrÚiz©iÚ
();

281 
	`£t_StiÚ_CoÜdš©es
(
LoÿtÜ
);

282 
	`di¥Ïy_®l_bu‰Ús
();

283 
	`İ’_log_fe
();

285 
	`auto_sync_FT8
();

287 
	}
}

290 
	gŞdFÏgs
 = 0;

292 
	$loİ
() {

295 
ÃwFÏgs
 = (
CQ_FÏg
 << 2è| (
T¿nsm™_ArmÃd
 << 1è| (
xm™_æag
);

296 ià(
ÃwFÏgs
 !ğ
ŞdFÏgs
) {

297 
	`DPRINTF
("ÃwFÏg ğ0x%x\n", 
ÃwFÏgs
);

298 
ŞdFÏgs
 = 
ÃwFÏgs
;

301 ià(
decode_æag
 =ğ0è
	`´oûss_d©a
();

303 ià(
DSP_FÏg
 == 1) {

305 
	`´oûss_FT8_FFT
();

308 ià(
xm™_æag
 == 1) {

309 
off£t_šdex
 = 5;

312 ià(
á8_xm™_couÁ”
 >ğ
off£t_šdex
 && ft8_xmit_counter < 79 + offset_index) {

313 
	`£t_FT8_TÚe
(
tÚes
[
á8_xm™_couÁ”
 - 
off£t_šdex
]);

316 
á8_xm™_couÁ”
++;

319 ià(
á8_xm™_couÁ”
 =ğ80 + 
off£t_šdex
) {

320 
xm™_æag
 = 0;

321 
	`»ûive_£qu’û
();

322 
	`‹rmš©e_Œªsm™_¬med
();

326 
DSP_FÏg
 = 0;

327 
	`di¥Ïy_time
(360, 0);

328 
	`di¥Ïy_d©e
(360, 60);

331 ià(
decode_æag
 == 1) {

333 
num_decoded_msg
 = 
	`á8_decode
();

334 
ma¡”_decoded
 = 
num_decoded_msg
;

335 
decode_æag
 = 0;

336 ià(
T¿nsm™_ArmÃd
 =ğ1è
	`£tup_to_Œªsm™_Ú_Ãxt_DSP_FÏg
();

339 
	`upd©e_synchrÚiz©iÚ
();

342 
	`´oûss_touch
();

343 ià(
tuÃ_æag
 =ğ1è
	`´oûss_£rŸl
();

347 ià((
á8Raw
 !ğ
NULL
è&& 
»cÜdSam¶eCouÁ
 >ğ
cÚfig
.
audioRecÜdšgDu¿tiÚ
 * ()
AUDIO_SAMPLE_RATE
) {

348 
á8Raw
.
	`şo£
();

349 
á8Raw
 = 
NULL
;

350 
	`DPRINTF
("AudiØ»cÜdšg fe, %s, clo£d w™h %uÈ§m¶es\n", 
AUDIO_RECORDING_FILENAME
, 
»cÜdSam¶eCouÁ
);

353 
	}
}

357 
time_t
 
	$g‘T“nsy3Time
() {

358  
T“nsy3Clock
.
	`g‘
();

359 
	}
}

361 
	$lßdSSB
() {

362 
si4735
.
	`qu”yLib¿ryId
();

363 
si4735
.
	`·tchPow”Up
();

366 
	`d–ay
(50);

367 
si4735
.
	`dowÆßdP©ch
(
ssb_·tch_cÚ‹Á
, 
size_cÚ‹Á
);

376 
si4735
.
	`£tSSBCÚfig
(2, 1, 0, 
cÚfig
.
’abËAVC
, 0, 1);

377 
	`DPRINTF
("SI4735 AVC = %u\n", 
cÚfig
.
’abËAVC
);

378 
	}
}

382 
	$´oûss_d©a
() {

384 ià(
queue1
.
	`avaabË
(è>ğ
num_que_blocks
) {

387 
i
 = 0; i < 
num_que_blocks
; i++) {

388 
	`cİy_to_fá_bufãr
(
šput_guÍ
 + 
block_size
 * 
i
, 
queue1
.
	`»adBufãr
());

389 
queue1
.
	`ä“Bufãr
();

392 
i
 = 0; i < 
šput_guÍ_size
; i++) {

393 
d¥_bufãr
[
i
] = d¥_bufãr[˜+ 
šput_guÍ_size
];

394 
d¥_bufãr
[
i
 + 
šput_guÍ_size
] = dsp_buffer[i + 2 * input_gulp_size];

395 
d¥_bufãr
[
i
 + 2 * 
šput_guÍ_size
] = 
šput_guÍ
[i];

398 
DSP_FÏg
 = 1;

400 
	}
}

403 
	$cİy_to_fá_bufãr
(*
de¡š©iÚ
, cÚ¡ *
sourû
) {

404 cÚ¡ 
ušt16_t
 *
¤c
 = (cÚ¡ ušt16_ˆ*)
sourû
;

405 
ušt16_t
 *
d¡
 = (ušt16_ˆ*)
de¡š©iÚ
;

406 
i
 = 0; i < 
AUDIO_BLOCK_SAMPLES
; i++) {

407 *
d¡
++ = *
¤c
++;

411 ià(
á8Raw
 !ğ
NULL
) {

412 
á8Raw
.
	`wr™e
(
sourû
, 
AUDIO_BLOCK_SAMPLES
 * (
ušt16_t
));

413 
»cÜdSam¶eCouÁ
 +ğ
AUDIO_BLOCK_SAMPLES
;

414 ià(
»cÜdSam¶eCouÁ
 % ()
AUDIO_SAMPLE_RATE
 == 0) {

415 
	`DPRINTF
("Audio„ecording in…rogress...\n");

419 
	}
}

422 
	$¹c_synchrÚiz©iÚ
() {

423 
	`g‘T“nsy3Time
();

425 ià(
á8_æag
 =ğ0 && 
	`£cÚd
() % 15 == 0) {

426 
á8_æag
 = 1;

427 
FT_8_couÁ”
 = 0;

428 
á8_m¬k”
 = 1;

429 
WF_couÁ”
 = 0;

431 
	}
}

433 
	$upd©e_synchrÚiz©iÚ
() {

434 
cu¼’t_time
 = 
	`mlis
();

435 
á8_time
 = 
cu¼’t_time
 - 
¡¬t_time
;

437 
á8_hours
 = (
št8_t
)(
á8_time
 / 3600000);

438 
hours_äaùiÚ
 = 
á8_time
 % 3600000;

439 
á8_mšu‹s
 = (
št8_t
)(
hours_äaùiÚ
 / 60000);

440 
á8_£cÚds
 = (
št8_t
)((
hours_äaùiÚ
 % 60000) / 1000);

443 ià(
á8_æag
 =ğ0 && 
á8_time
 % 15000 <= 200) {

444 
á8_æag
 = 1;

445 
FT_8_couÁ”
 = 0;

446 
á8_m¬k”
 = 1;

447 
WF_couÁ”
 = 0;

449 
	}
}

452 
	$sync_FT8
() {

454 
	`£tSyncProvid”
(
g‘T“nsy3Time
);

455 
¡¬t_time
 = 
	`mlis
();

456 
á8_æag
 = 1;

457 
FT_8_couÁ”
 = 0;

458 
á8_m¬k”
 = 1;

459 
WF_couÁ”
 = 0;

460 
	}
}

464 
	$auto_sync_FT8
() {

465 
	`DTRACE
();

470 
	`DPRINTF
("Synchronizing with RTC\n");

472 (
	`£cÚd
()) % 15 != 0) ;

474 
¡¬t_time
 = 
	`mlis
();

475 
á8_æag
 = 1;

476 
FT_8_couÁ”
 = 0;

477 
á8_m¬k”
 = 1;

478 
WF_couÁ”
 = 0;

481 
	}
}

	@Process_DSP.cpp

1 
	~"DEBUG.h
"

3 
	~"HX8357_t3n.h
"

4 
	~"Proûss_DSP.h
"

5 
	~"WF_TabË.h
"

6 
	~"¬m_m©h.h
"

7 
	~"decode_á8.h
"

8 
	~"di¥Ïy.h
"

9 
	~<TimeLib.h
>

10 
	~"Œaffic_mªag”.h
"

13 
HX8357_t3n
 
tá
;

14 
q15_t
 
d¥_bufãr
[] 
__©Œibu‹__
((
®igÃd
(4)));

15 
q15_t
 
d¥_ouut
[] 
__©Œibu‹__
((
®igÃd
(4)));

16 
q15_t
 
	gwšdow_d¥_bufãr
[
FFT_SIZE
] 
__©Œibu‹__
((
®igÃd
(4)));

19 
ušt8_t
 
	gWF_šdex
[900];

20 
	gwšdow
[
FFT_SIZE
];

22 
ušt16_t
 
cursÜ_lše
;

24 
á8_æag
, 
FT_8_couÁ”
, 
á8_m¬k”
, 
decode_æag
, 
WF_couÁ”
;

25 
num_decoded_msg
;

27 
	gma¡”_off£t
, 
	goff£t_¡•
;

28 
CQ_FÏg
;

30 
q15_t
 
	gFFT_SÿË
[
FFT_SIZE
 * 2];

31 
q15_t
 
	gFFT_Magn™ude
[
FFT_SIZE
];

32 
št32_t
 
	gFFT_Mag_10
[
FFT_SIZE
 / 2];

33 
ušt8_t
 
	gFFT_Bufãr
[
FFT_SIZE
 / 2];

34 
	gmag_db
[
FFT_SIZE
 / 2 + 1];

36 
¬m_rfá_š¡ªû_q15
 
	gfá_š¡
;

37 
¬m_cfá_¿dix4_š¡ªû_q15
 
	gaux_š¡
;

39 
ušt8_t
 
	gexpÜt_fá_pow”
[
á8_msg_§m¶es
 * 
á8_bufãr
 * 4];

49 
	$š™_DSP
() {

51 
	`¬m_rfá_š™_q15
(&
fá_š¡
, 
FFT_SIZE
, 0, 1);

52 
i
 = 0; i < 
FFT_SIZE
; ++iè
wšdow
[i] = 
	`á_bÏckmª_i
(i, FFT_SIZE);

53 
off£t_¡•
 = ()
á8_bufãr
 * 4;

54 
	}
}

56 
	gmax_bš
, 
	gmax_bš_numb”
;

59 
	$á_bÏckmª_i
(
i
, 
N
) {

60 cÚ¡ 
®pha
 = 0.16f;

61 cÚ¡ 
a0
 = (1 - 
®pha
) / 2;

62 cÚ¡ 
a1
 = 1.0f / 2;

63 cÚ¡ 
a2
 = 
®pha
 / 2;

65 
x1
 = 
	`cosf
(2 * ()
M_PI
 * 
i
 / (
N
 - 1));

67 
x2
 = 2 * 
x1
 * x1 - 1;

68  
a0
 - 
a1
 * 
x1
 + 
a2
 * 
x2
;

69 
	}
}

74 
	$exŒaù_pow”
(
off£t
) {

78 
time_sub
 = 0;ime_sub <ğ
šput_guÍ_size
 / 2;ime_sub += input_gulp_size / 2) {

80 
i
 = 0; i < 
FFT_SIZE
; i++è
wšdow_d¥_bufãr
[i] = (
q15_t
)(()
d¥_bufãr
[˜+ 
time_sub
] * 
wšdow
[i]);

83 
	`¬m_rfá_q15
(&
fá_š¡
, 
wšdow_d¥_bufãr
, 
d¥_ouut
);

85 
	`¬m_shiá_q15
(&
d¥_ouut
[0], 5, &
FFT_SÿË
[0], 
FFT_SIZE
 * 2);

87 
	`¬m_cm¶x_mag_squ¬ed_q15
(&
FFT_SÿË
[0], &
FFT_Magn™ude
[0], 
FFT_SIZE
);

89 
j
 = 0; j < 
FFT_SIZE
 / 2; j++) {

90 
FFT_Mag_10
[
j
] = 10 * (
št32_t
)
FFT_Magn™ude
[j];

91 
mag_db
[
j
] = 5.0 * 
	`log
(()
FFT_Mag_10
[j] + 0.1);

95 
äeq_sub
 = 0; freq_sub < 2; ++freq_sub) {

96 
j
 = 0; j < 
á8_bufãr
; ++j) {

97 
db1
 = 
mag_db
[
j
 * 2 + 
äeq_sub
];

98 
db2
 = 
mag_db
[
j
 * 2 + 
äeq_sub
 + 1];

99 
db
 = (
db1
 + 
db2
) / 2;

101 
sÿËd
 = ()(
db
);

102 
expÜt_fá_pow”
[
off£t
] = (
sÿËd
 < 0) ? 0 : ((scaled > 255) ? 255 : scaled);

103 ++
off£t
;

107 
	}
}

110 
	$´oûss_FT8_FFT
() {

112 ià(
á8_æag
 == 1) {

114 
ma¡”_off£t
 = 
off£t_¡•
 * 
FT_8_couÁ”
;

115 
	`exŒaù_pow”
(
ma¡”_off£t
);

117 
	`upd©e_off£t_w©”çÎ
(
ma¡”_off£t
);

119 
FT_8_couÁ”
++;

120 ià(
FT_8_couÁ”
 =ğ
á8_msg_§m¶es
) {

121 
á8_æag
 = 0;

122 
decode_æag
 = 1;

125 
	}
}

130 
	$upd©e_off£t_w©”çÎ
(
off£t
) {

132 
j
 = 
á8_mš_bš
; j < 
á8_bufãr
; j++è
FFT_Bufãr
[j] = 
expÜt_fá_pow”
[j + 
off£t
];

134 
b¬
;

135 
x
 = 
á8_mš_bš
; x < 
á8_bufãr
; x++) {

136 
b¬
 = 
FFT_Bufãr
[
x
];

137 ià(
b¬
 > 63) bar = 63;

138 
WF_šdex
[
x
] = 
b¬
;

144 
k
 = 
á8_mš_bš
; k < 
á8_bufãr
; k++) {

145 
tá
.
	`d¿wPix–
(
k
 - 
á8_mš_bš
, 
WF_couÁ”
, 
WFP®‘‹
[
WF_šdex
[k]]);

146 ià(
k
 - 
á8_mš_bš
 =ğ
cursÜ_lše
è
tá
.
	`d¿wPix–
(k - ft8_mš_bš, 
WF_couÁ”
, 
HX8357_RED
);

153 ià(
num_decoded_msg
 > 0 && 
WF_couÁ”
 == 0) {

154 
	`di¥Ïy_mes§ges
(
num_decoded_msg
);

155 ià(
CQ_FÏg
 == 1) {

156 
	`£rviû_CQ
();

158 
	`Check_C®lšg_StiÚs
(
num_decoded_msg
);

161 
num_decoded_msg
 = 0;

165 
WF_couÁ”
++;

166 
	}
}

	@Process_DSP.h

2 
	~"¬m_m©h.h
"

4 
	#FFT_SIZE
 2048

	)

5 
	#num_que_blocks
 8

	)

6 
	#block_size
 128

	)

7 
	#šput_guÍ_size
 1024

	)

9 
	#á8_bufãr
 400

10 
	#á8_mš_bš
 48

	)

11 
	#FFT_ResŞutiÚ
 6.25

	)

12 
	#á8_mš_äeq
 
FFT_ResŞutiÚ
 * 
á8_mš_bš


	)

14 
	#á8_msg_§m¶es
 92

	)

16 
š™_DSP
();

17 
á_bÏckmª_i
(
i
, 
N
);

19 
´oûss_FT8_FFT
();

20 
upd©e_off£t_w©”çÎ
(
off£t
);

	@TouchScreen_I2C.cpp

1 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wunused-but-set-variable"

7 
	~"Ardušo.h
"

8 
	~"pšs_¬dušo.h
"

9 
	~<Wœe.h
>

10 
	~<MCP342x.h
>

12 
	~"DEBUG.h
"

14 #ifdeà
__AVR


15 
	~<avr/pgm¥aû.h
>

16 #–ià
defšed
(
ESP8266
)

17 
	~<pgm¥aû.h
>

19 
	~"TouchSü“n_I2C.h
"

26 
	#NUMSAMPLES
 2

	)

28 
ušt8_t
 
	gadd»ss
 = 0x69;

29 
MCP342x
 
	gadc
 = MCP342x(
add»ss
);

31 
	gTSPošt
::
	$TSPošt
() {

32 
x
 = 
y
 = 
z
 = 0;

33 
	}
}

41 
	gTSPošt
::
	$TSPošt
(
št16_t
 
x0
, iÁ16_ˆ
y0
, iÁ16_ˆ
z0
) {

42 
x
 = 
x0
;

43 
y
 = 
y0
;

44 
z
 = 
z0
;

45 
	}
}

53 
boŞ
 
	gTSPošt
::
İ”©Ü
==(
TSPošt
 
p1
) {

54  ((
p1
.
x
 =ğxè&& (p1.
y
 =ğyè&& (p1.
z
 == z));

64 
boŞ
 
	gTSPošt
::
İ”©Ü
!=(
TSPošt
 
p1
) {

65  ((
p1
.
x
 !ğxè|| (p1.
y
 !ğyè|| (p1.
z
 != z));

68 #ià(
NUMSAMPLES
 > 2)

69 
	$š£¹_sÜt
(
¬¿y
[], 
ušt8_t
 
size
) {

70 
ušt8_t
 
j
;

71 
§ve
;

73 
i
 = 1; i < 
size
; i++) {

74 
§ve
 = 
¬¿y
[
i
];

75 
j
 = 
i
; j >ğ1 && 
§ve
 < 
¬¿y
[j - 1]; j--)

76 
¬¿y
[
j
] =‡rray[j - 1];

77 
¬¿y
[
j
] = 
§ve
;

79 
	}
}

87 
TSPošt
 
	gTouchSü“n
::
	$g‘Pošt
() {

88 
x
, 
y
, 
z
;

89 
§m¶es
[
NUMSAMPLES
];

90 
ušt8_t
 
i
, 
v®id
;

92 
v®ue1
 = 0;

93 
v®ue2
 = 0;

94 
ušt8_t
 
”r
;

95 
MCP342x
::
CÚfig
 
¡©us
;

97 
v®id
 = 1;

99 
	`pšMode
(
_yp
, 
INPUT
);

100 
	`pšMode
(
_ym
, 
INPUT
);

101 
	`pšMode
(
_xp
, 
OUTPUT
);

102 
	`pšMode
(
_xm
, 
OUTPUT
);

104 
	`dig™®Wr™e
(
_xm
, 
HIGH
);

105 
	`dig™®Wr™e
(
_xp
, 
LOW
);

106 
	`d–ayMiüo£cÚds
(20);

108 
i
 = 0; i < 
NUMSAMPLES
; i++) {

110 
”r
 = 
adc
.
	`cÚv”tAndR—d
(
MCP342x
::
chªÃl1
, MCP342x::
ÚeShÙ
, MCP342x::
»sŞutiÚ12
, MCP342x::
gaš1
, 1000000, 
v®ue1
, 
¡©us
);

111 
§m¶es
[
i
] = 
v®ue1
;

114 #ià
NUMSAMPLES
 == 2

117 ià(
§m¶es
[0] - samples[1] < -4 || samples[0] - samples[1] > 4) {

118 
v®id
 = 0;

120 
§m¶es
[1] = (samples[0] + samples[1]) >> 1;

124 
y
 = 
§m¶es
[1];

127 
	`pšMode
(
_xp
, 
INPUT
);

128 
	`pšMode
(
_xm
, 
INPUT
);

129 
	`pšMode
(
_yp
, 
OUTPUT
);

130 
	`pšMode
(
_ym
, 
OUTPUT
);

132 
	`dig™®Wr™e
(
_ym
, 
LOW
);

133 
	`dig™®Wr™e
(
_yp
, 
HIGH
);

134 
	`d–ayMiüo£cÚds
(20);

137 
i
 = 0; i < 
NUMSAMPLES
; i++) {

139 
”r
 = 
adc
.
	`cÚv”tAndR—d
(
MCP342x
::
chªÃl2
, MCP342x::
ÚeShÙ
, MCP342x::
»sŞutiÚ12
, MCP342x::
gaš1
, 1000000, 
v®ue2
, 
¡©us
);

140 
§m¶es
[
i
] = 
v®ue2
;

143 #ià
NUMSAMPLES
 == 2

146 ià(
§m¶es
[0] - samples[1] < -4 || samples[0] - samples[1] > 4) {

147 
v®id
 = 0;

149 
§m¶es
[1] = (samples[0] + samples[1]) >> 1;

153 
x
 = 
§m¶es
[1];

157 ià(!
v®id
) {

158 
z
 = 0;

160 
z
 = 
x
 + 
y
;

162  
	`TSPošt
(
x
, 
y
, 
z
);

163 
	}
}

165 
	gTouchSü“n
::
	$TouchSü“n
(
ušt8_t
 
xp
, ušt8_ˆ
yp
, ušt8_ˆ
xm
, ušt8_ˆ
ym
,

166 
ušt16_t
 
rx¶©e
 = 0) {

167 
_yp
 = 
yp
;

168 
_xm
 = 
xm
;

169 
_ym
 = 
ym
;

170 
_xp
 = 
xp
;

171 
_rx¶©e
 = 
rx¶©e
;

174 
Wœe
.
	`begš
();

175 
MCP342x
::
	`g’”®C®lRe£t
();

176 
	`d–ay
(1);

178 #ià
	`defšed
(
USE_FAST_PINIO
)

179 
xp_pÜt
 = 
	`pÜtOuutRegi¡”
(
	`dig™®PšToPÜt
(
_xp
));

180 
yp_pÜt
 = 
	`pÜtOuutRegi¡”
(
	`dig™®PšToPÜt
(
_yp
));

181 
xm_pÜt
 = 
	`pÜtOuutRegi¡”
(
	`dig™®PšToPÜt
(
_xm
));

182 
ym_pÜt
 = 
	`pÜtOuutRegi¡”
(
	`dig™®PšToPÜt
(
_ym
));

184 
xp_pš
 = 
	`dig™®PšToB™Mask
(
_xp
);

185 
yp_pš
 = 
	`dig™®PšToB™Mask
(
_yp
);

186 
xm_pš
 = 
	`dig™®PšToB™Mask
(
_xm
);

187 
ym_pš
 = 
	`dig™®PšToB™Mask
(
_ym
);

190 
´essu»Th»shhŞd
 = 10;

191 
	}
}

197 
	gTouchSü“n
::
	$»adTouchX
() {

198 
	`pšMode
(
_yp
, 
INPUT
);

199 
	`pšMode
(
_ym
, 
INPUT
);

200 
	`dig™®Wr™e
(
_yp
, 
LOW
);

201 
	`dig™®Wr™e
(
_ym
, 
LOW
);

203 
	`pšMode
(
_xp
, 
OUTPUT
);

204 
	`dig™®Wr™e
(
_xp
, 
HIGH
);

205 
	`pšMode
(
_xm
, 
OUTPUT
);

206 
	`dig™®Wr™e
(
_xm
, 
LOW
);

208  (1023 - 
	`ª®ogR—d
(
_yp
));

209 
	}
}

215 
	gTouchSü“n
::
	$»adTouchY
() {

216 
	`pšMode
(
_xp
, 
INPUT
);

217 
	`pšMode
(
_xm
, 
INPUT
);

218 
	`dig™®Wr™e
(
_xp
, 
LOW
);

219 
	`dig™®Wr™e
(
_xm
, 
LOW
);

221 
	`pšMode
(
_yp
, 
OUTPUT
);

222 
	`dig™®Wr™e
(
_yp
, 
HIGH
);

223 
	`pšMode
(
_ym
, 
OUTPUT
);

224 
	`dig™®Wr™e
(
_ym
, 
LOW
);

226  (1023 - 
	`ª®ogR—d
(
_xm
));

227 
	}
}

233 
ušt16_t
 
	gTouchSü“n
::
	$´essu»
() {

235 
	`pšMode
(
_xp
, 
OUTPUT
);

236 
	`dig™®Wr™e
(
_xp
, 
LOW
);

239 
	`pšMode
(
_ym
, 
OUTPUT
);

240 
	`dig™®Wr™e
(
_ym
, 
HIGH
);

243 
	`dig™®Wr™e
(
_xm
, 
LOW
);

244 
	`pšMode
(
_xm
, 
INPUT
);

245 
	`dig™®Wr™e
(
_yp
, 
LOW
);

246 
	`pšMode
(
_yp
, 
INPUT
);

248 
z1
 = 
	`ª®ogR—d
(
_xm
);

249 
z2
 = 
	`ª®ogR—d
(
_yp
);

251 ià(
_rx¶©e
 != 0) {

253 
¹ouch
;

254 
¹ouch
 = 
z2
;

255 
¹ouch
 /ğ
z1
;

256 
¹ouch
 -= 1;

257 
¹ouch
 *ğ
	`»adTouchX
();

258 
¹ouch
 *ğ
_rx¶©e
;

259 
¹ouch
 /= 1024;

261  
¹ouch
;

263  (1023 - (
z2
 - 
z1
));

265 
	}
}

	@TouchScreen_I2C.h

6 #iâdeà
_ADAFRUIT_TOUCHSCREEN_H_


7 
	#_ADAFRUIT_TOUCHSCREEN_H_


	)

8 
	~<¡dšt.h
>

10 #ià
defšed
(
__AVR_ATmega328P__
è|| defšed(
__AVR_ATmega32U4__
) || \

11 
defšed
(
TEENSYDUINO
è|| defšed(
__AVR_ATmega2560__
) || \

12 
	$defšed
(
__AVR_ATmega4809__
)

13 vŞ©
	tušt8_t
 
	tRwReg
;

14 #–ià
	`defšed
(
ARDUINO_STM32_FEATHER
)

15 vŞ©
	tušt32
 
	tRwReg
;

16 #–ià
	`defšed
(
NRF52_SERIES
è|| defšed(
ESP32
è|| defšed(
ESP8266
) || \

17 
	$defšed
(
ARDUINO_ARCH_STM32
)

18 vŞ©
	tušt32_t
 
	tRwReg
;

20 vŞ©
	tušt32_t
 
	tRwReg
;

23 #ià
	`defšed
(
__AVR__
è|| defšed(
TEENSYDUINO
è|| defšed(
ARDUINO_ARCH_SAMD
)

29 şas 
	cTSPošt
 {

30 
public
:

31 
	`TSPošt
();

32 
	`TSPošt
(
št16_t
 
x
, iÁ16_ˆ
y
, iÁ16_ˆ
z
);

34 
boŞ
 
İ”©Ü
==(
TSPošt
);

35 
boŞ
 
İ”©Ü
!=(
TSPošt
);

37 
št16_t
 
x
,

38 
y
,

39 
z
;

43 şas 
	cTouchSü“n
 {

44 
public
:

55 
	`TouchSü“n
(
ušt8_t
 
xp
, ušt8_ˆ
yp
, ušt8_ˆ
xm
, ušt8_ˆ
ym
, 
ušt16_t
 
rx
);

62 
boŞ
 
	`isTouchšg
();

63 
ušt16_t
 
	`´essu»
();

64 
	`»adTouchY
();

65 
	`»adTouchX
();

66 
TSPošt
 
	`g‘Pošt
();

67 
št16_t
 
´essu»Th»shhŞd
;

69 
´iv©e
:

70 
ušt8_t
 
_yp
, 
_ym
, 
_xm
, 
_xp
;

71 
ušt16_t
 
_rx¶©e
;

73 #ià
	$defšed
(
USE_FAST_PINIO
)

74 vŞ©
RwReg
 *
xp_pÜt
, *
yp_pÜt
, *
xm_pÜt
, *
ym_pÜt
;

75 
RwReg
 
xp_pš
, 
xm_pš
, 
yp_pš
, 
ym_pš
;

	@WF_Table.h

8 #iâdeà
WF_TABLE_H_


9 
	#WF_TABLE_H_


	)

10 cÚ¡ 
ušt16_t
 
	gWFP®‘‹
[64] = {

	@button.cpp

2 
	~"DEBUG.h
"

3 
	~"HX8357_t3n.h
"

4 
	~"bu‰Ú.h
"

5 
	~"di¥Ïy.h
"

6 
	~"g’_á8.h
"

7 
	~"Œaffic_mªag”.h
"

8 
	~"decode_á8.h
"

10 
	~"Proûss_DSP.h
"

11 
	~<EEPROM.h
>

12 
	~"TouchSü“n_I2C.h
"

13 
	~<SI4735.h
>

14 
	~<Wœe.h
>

18 
	#TS_MINX
 132

	)

19 
	#TS_MINY
 146

	)

20 
	#TS_MAXX
 1715

	)

21 
	#TS_MAXY
 1130

	)

23 
	#MINPRESSURE
 120

	)

24 
	#PENRADIUS
 3

	)

26 
HX8357_t3n
 
tá
;

27 
TouchSü“n
 
ts
;

29 
T¿nsm™_ArmÃd
;

31 
SI4735
 
si4735
;

32 
ušt16_t
 
cu¼’tF»qu’cy
;

33 
	#USB
 2

	)

35 
ušt16_t
 
	gd¿w_x
, 
	gd¿w_y
, 
	gtouch_x
, 
	gtouch_y
;

36 
	g‹¡
;

38 
ma¡”_decoded
;

39 
sync_FT8
();

40 
ušt16_t
 
cursÜ_äeq
;

41 
tuÃ_æag
;

42 
ušt16_t
 
cursÜ_lše
;

43 
off£t_äeq
;

44 
	#á8_shiá
 6.25

	)

45 
	g¡¬t_up_off£t_äeq
;

46 
log_æag
, 
loggšg_Ú
;

48 
	gCQ_FÏg
;

49 
	gB—cÚ_S‹
;

51 
	#numBu‰Ús
 9

	)

52 
	#bu‰Ú_height
 30

	)

53 
	#bu‰Ú_lše
 290

	)

54 
	#bu‰Ú_width
 42

	)

56 
	gpos™iÚRight
 = 500;

57 
ušt32_t
 
	gÏ¡_touch
;

58 
TSPošt
 
	gpi
, 
	gpw
;

62 cÚ¡ * 
	m‹xt
;

64 
boŞ
 
	m¡©e
;

65 cÚ¡ 
ušt16_t
 
	mx
;

66 cÚ¡ 
ušt16_t
 
	my
;

67 cÚ¡ 
ušt16_t
 
	mw
;

68 cÚ¡ 
ušt16_t
 
	mh
;

69 
boŞ
 
	maùive_¡©e
;

70 } 
	tBu‰ÚSŒuù
;

75 
Bu‰ÚSŒuù
 
	gsBu‰ÚD©a
[] = {

77  
çl£
,

79  
bu‰Ú_lše
,

80  
bu‰Ú_width
,

81  
bu‰Ú_height
 },

84  
çl£
,

86  
bu‰Ú_lše
,

87  
bu‰Ú_width
,

88  
bu‰Ú_height
 },

91  
çl£
,

93  
bu‰Ú_lše
,

94  
bu‰Ú_width
,

95  
bu‰Ú_height
 },

98  
çl£
,

100  
bu‰Ú_lše
,

101  
bu‰Ú_width
,

102  
bu‰Ú_height
 },

105  
çl£
,

107  
bu‰Ú_lše
,

108  
bu‰Ú_width
,

109  
bu‰Ú_height
 },

112  
çl£
,

114  
bu‰Ú_lše
,

115  
bu‰Ú_width
,

116  
bu‰Ú_height
 },

119  
çl£
,

121  
bu‰Ú_lše
,

122  
bu‰Ú_width
,

123  
bu‰Ú_height
 },

126  
çl£
,

128  
bu‰Ú_lše
,

129  
bu‰Ú_width
,

130  
bu‰Ú_height
 },

133  
çl£
,

135  
bu‰Ú_lše
,

136  
bu‰Ú_width
,

137  
bu‰Ú_height
 }

143 
	$d¿wBu‰Ú
(
ušt16_t
 
i
) {

144 
ušt16_t
 
cŞÜ
;

145 ià(
sBu‰ÚD©a
[
i
].
¡©e
)

146 
cŞÜ
 = 
HX8357_RED
;

148 
cŞÜ
 = 
HX8357_GREEN
;

150 
tá
.
	`d¿wReù
(
sBu‰ÚD©a
[
i
].
x
, sBu‰ÚD©a[i].
y
, sBu‰ÚD©a[i].
w
, sBu‰ÚD©a[i].
h
, 
cŞÜ
);

151 
tá
.
	`£tCursÜ
(
sBu‰ÚD©a
[
i
].
x
 + 7, sBu‰ÚD©a[i].
y
 + 7);

152 
tá
.
	`£tTextCŞÜ
(
HX8357_WHITE
);

153 
tá
.
	`´št
(
sBu‰ÚD©a
[
i
].
‹xt
);

154 
	}
}

158 
	$di¥Ïy_®l_bu‰Ús
() {

159 
	`d¿wBu‰Ú
(0);

160 
	`d¿wBu‰Ú
(1);

161 
	`d¿wBu‰Ú
(2);

162 
	`d¿wBu‰Ú
(3);

163 
	`d¿wBu‰Ú
(4);

164 
	`d¿wBu‰Ú
(5);

165 
	`d¿wBu‰Ú
(6);

166 
	`d¿wBu‰Ú
(7);

167 
	`d¿wBu‰Ú
(8);

169 
i
 = 0; i < 
numBu‰Ús
; i++è
sBu‰ÚD©a
[i].
aùive_¡©e
 = 
Œue
;

170 
	}
}

173 
	$checkBu‰Ú
() {

175 
ušt8_t
 
i
 = 0; i < 
numBu‰Ús
; i++) {

176 ià(
	`‹¡Bu‰Ú
(
i
è=ğ1 && 
sBu‰ÚD©a
[i].
aùive_¡©e
) {

177 
sBu‰ÚD©a
[
i
].
¡©e
 = !sButtonData[i].state;

178 
	`d¿wBu‰Ú
(
i
);

179 
	`execu‹Bu‰Ú
(
i
);

184 
	}
}

186 
	gbu‰Ú_d–ay
 = 100;

188 
	$execu‹Bu‰Ú
(
ušt16_t
 
šdex
) {

189 
Idx
 = 0;

190 
	`DPRINTF
("execu‹Bu‰Ú(%u)\n", 
šdex
);

191 
šdex
) {

194 
	`DTRACE
();

195 ià(
sBu‰ÚD©a
[0].
¡©e
) {

196 
	`DTRACE
();

197 
CQ_FÏg
 = 1;

198 
sBu‰ÚD©a
[6].
aùive_¡©e
 = 
çl£
;

199 
B—cÚ_S‹
 = 0;

201 
	`DTRACE
();

202 
CQ_FÏg
 = 0;

203 
sBu‰ÚD©a
[6].
aùive_¡©e
 = 
Œue
;

208 
	`£t_mes§ge
(1);

209 
sBu‰ÚD©a
[1].
¡©e
 = 
Œue
;

210 
	`d¿wBu‰Ú
(1);

211 
	`d–ay
(
bu‰Ú_d–ay
);

212 
sBu‰ÚD©a
[1].
¡©e
 = 
çl£
;

213 
	`d¿wBu‰Ú
(1);

217 
	`£t_mes§ge
(2);

218 
sBu‰ÚD©a
[2].
¡©e
 = 
Œue
;

219 
	`d¿wBu‰Ú
(2);

220 
	`d–ay
(
bu‰Ú_d–ay
);

221 
sBu‰ÚD©a
[2].
¡©e
 = 
çl£
;

222 
	`d¿wBu‰Ú
(2);

226 
	`£t_mes§ge
(3);

227 
sBu‰ÚD©a
[3].
¡©e
 = 
Œue
;

228 
	`d¿wBu‰Ú
(3);

229 
	`d–ay
(
bu‰Ú_d–ay
);

230 
sBu‰ÚD©a
[3].
¡©e
 = 
çl£
;

231 
	`d¿wBu‰Ú
(3);

235 
	`ş—r_FT8_mes§ge
();

236 
sBu‰ÚD©a
[4].
¡©e
 = 
Œue
;

237 
	`d¿wBu‰Ú
(4);

238 
	`d–ay
(
bu‰Ú_d–ay
);

239 
sBu‰ÚD©a
[4].
¡©e
 = 
çl£
;

240 
	`d¿wBu‰Ú
(4);

244 ià(
sBu‰ÚD©a
[5].
¡©e
) {

245 
	`tuÃ_On_£qu’û
();

246 
tuÃ_æag
 = 1;

247 
	`d–ay
(
bu‰Ú_d–ay
);

249 
	`tuÃ_Off_£qu’û
();

250 
tuÃ_æag
 = 0;

251 
	`d–ay
(
bu‰Ú_d–ay
);

256 ià(
sBu‰ÚD©a
[6].
¡©e
) {

257 
T¿nsm™_ArmÃd
 = 1;

258 
	`d–ay
(
bu‰Ú_d–ay
);

260 
T¿nsm™_ArmÃd
 = 0;

261 
	`d–ay
(
bu‰Ú_d–ay
);

266 ià(
log_æag
 =ğ1 && 
sBu‰ÚD©a
[7].
¡©e
) {

268 
loggšg_Ú
 = 1;

269 
sBu‰ÚD©a
[7].
¡©e
 = 
Œue
;

270 
	`d¿wBu‰Ú
(7);

271 
	`d–ay
(
bu‰Ú_d–ay
);

274 
loggšg_Ú
 = 0;

275 
sBu‰ÚD©a
[7].
¡©e
 = 
çl£
;

276 
	`d¿wBu‰Ú
(7);

277 
	`d–ay
(
bu‰Ú_d–ay
);

282 
sBu‰ÚD©a
[8].
¡©e
 = 
Œue
;

283 
	`d¿wBu‰Ú
(8);

284 
	`d–ay
(
bu‰Ú_d–ay
);

285 
	`sync_FT8
();

286 
sBu‰ÚD©a
[8].
¡©e
 = 
çl£
;

287 
	`d¿wBu‰Ú
(8);

288 
	`d–ay
(
bu‰Ú_d–ay
);

302 ià(
sBu‰ÚD©a
[9].
¡©e
) {

326 
	}
}

329 
	$‹rmš©e_Œªsm™_¬med
() {

331 
T¿nsm™_ArmÃd
 = 0;

332 
	`»ûive_£qu’û
();

333 
sBu‰ÚD©a
[6].
¡©e
 = 
çl£
;

334 
	`d¿wBu‰Ú
(6);

335 
	}
}

337 
	$‹¡Bu‰Ú
(
ušt8_t
 
šdex
) {

339 ià((
d¿w_x
 > 
sBu‰ÚD©a
[
šdex
].
x
è&& (d¿w_x < sBu‰ÚD©a[šdex].x + sBu‰ÚD©a[šdex].
w
è&& (
d¿w_y
 > sBu‰ÚD©a[šdex].
y
è&& (d¿w_y < sBu‰ÚD©a[šdex].y + sBu‰ÚD©a[šdex].
h
))  1;

344 
	}
}

346 
	$check_FT8_Touch
() {

348 
FT_8_TouchIndex
;

349 
y_‹¡
;

352 ià(
d¿w_x
 < 400 && (
d¿w_y
 > 90 && draw_y < 300)) {

353 
y_‹¡
 = 
d¿w_y
 - 90;

354 
FT_8_TouchIndex
 = 
y_‹¡
 / 25;

355 ià(
FT_8_TouchIndex
 < 
ma¡”_decoded
è
	`di¥Ïy_£Ëùed_ÿÎ
(FT_8_TouchIndex);

357 
	}
}

359 
	$check_WF_Touch
() {

360 ià(
d¿w_x
 < 350 && 
d¿w_y
 < 90) {

362 
cursÜ_lše
 = 
d¿w_x
;

363 
cursÜ_äeq
 = (
ušt16_t
)(()(
cursÜ_lše
 + 
á8_mš_bš
è* 
á8_shiá
);

365 
	`£t_Xm™_F»q
();

367 
	}
}

370 
	$£t_¡¬tup_äeq
() {

371 
cursÜ_lše
 = 100;

372 
¡¬t_up_off£t_äeq
 = 
	`EEPROMR—dIÁ
(10);

373 
cursÜ_äeq
 = (
ušt16_t
)(()(
cursÜ_lše
 + 
á8_mš_bš
è* 
á8_shiá
);

374 
off£t_äeq
 = 
¡¬t_up_off£t_äeq
;

375 
	`DPRINTF
("£t_¡¬tup_äeq: s¹_up_off£t_äeq=%d, cursÜ_äeq=%d, off£t_äeq=%d\n", 
¡¬t_up_off£t_äeq
, 
cursÜ_äeq
, 
off£t_äeq
);

376 
	}
}

379 
	$´oûss_touch
() {

381 
pi
 = 
ts
.
	`g‘Pošt
();

383 ià(
pi
.
z
 > 
MINPRESSURE
) {

385 
pw
.
x
 = 
	`m­
(
pi
.x, 
TS_MINX
, 
TS_MAXX
, 0, 480);

386 
pw
.
y
 = 
	`m­
(
pi
.y, 
TS_MINY
, 
TS_MAXY
, 0, 320);

387 
tá
.
	`flCœşe
(
pw
.
x
,…w.
y
, 
PENRADIUS
, 
HX8357_YELLOW
);

389 
d¿w_x
 = 
pw
.
x
;

390 
d¿w_y
 = 
pw
.
y
;

392 
	`checkBu‰Ú
();

393 
	`check_FT8_Touch
();

394 
	`check_WF_Touch
();

396 
	}
}

400 
	$´oûss_£rŸl
() {

402 
šcomšg_by‹
;

403 ià(
S”Ÿl
.
	`avaabË
() > 0) {

404 
šcomšg_by‹
 = 
S”Ÿl
.
	`»ad
();

406 ià(
šcomšg_by‹
 =ğ117è
off£t_äeq
 = offset_freq + 10;

407 ià(
šcomšg_by‹
 =ğ100è
off£t_äeq
 = offset_freq - 10;

409 
S”Ÿl
.
	`´šn
(
off£t_äeq
);

410 
	`£t_Xm™_F»q
();

411 ià(
šcomšg_by‹
 == 115) {

412 
	`¡Üe_’cod”s
();

413 
S”Ÿl
.
	`´šn
("offset_freq stored");

416 
	}
}

420 
	$¡Üe_’cod”s
() {

422 
	`EEPROMWr™eIÁ
(10, 
off£t_äeq
);

423 
	`d–ay
(
bu‰Ú_d–ay
);

424 
‹¡
 = 
	`EEPROMR—dIÁ
(10);

425 
	}
}

429 
	$EEPROMWr™eIÁ
(
add»ss
, 
v®ue
) {

430 
ušt16_t
 
š‹º®_v®ue
 = 32768 + 
v®ue
;

432 
by‹
 
by‹1
 = 
š‹º®_v®ue
 >> 8;

433 
by‹
 
by‹2
 = 
š‹º®_v®ue
 & 0xFF;

434 
EEPROM
.
	`wr™e
(
add»ss
, 
by‹1
);

435 
EEPROM
.
	`wr™e
(
add»ss
 + 1, 
by‹2
);

436 
	}
}

438 
	$EEPROMR—dIÁ
(
add»ss
) {

439 
ušt16_t
 
by‹1
 = 
EEPROM
.
	`»ad
(
add»ss
);

440 
ušt16_t
 
by‹2
 = 
EEPROM
.
	`»ad
(
add»ss
 + 1);

441 
ušt16_t
 
š‹º®_v®ue
 = (
by‹1
 << 8 | 
by‹2
);

443  ()
š‹º®_v®ue
 - 32768;

444 
	}
}

446 
	#IOEXP16_ADDR
 0x24

	)

448 
	$LPF_S’dRegi¡”
(
ušt8_t
 
»g
, ušt8_ˆ
v®
) {

449 
Wœe
.
	`begš
();

450 
Wœe
.
	`begšT¿nsmissiÚ
(
IOEXP16_ADDR
);

451 
Wœe
.
	`wr™e
(
»g
);

452 
Wœe
.
	`wr™e
(
v®
);

453 
Wœe
.
	`’dT¿nsmissiÚ
();

454 
	}
}

456 
	$LPF_š™
() {

457 
	`LPF_S’dRegi¡”
(0x06, 0xff);

458 
	`LPF_S’dRegi¡”
(0x07, 0xff);

459 
	`LPF_S’dRegi¡”
(0x02, 0x00);

460 
	`LPF_S’dRegi¡”
(0x06, 0x00);

461 
	`LPF_S’dRegi¡”
(0x03, 0x00);

462 
	`LPF_S’dRegi¡”
(0x07, 0x00);

463 
	}
}

465 
	$LPF_wr™e
(
ušt16_t
 
d©a
) {

466 
	`LPF_S’dRegi¡”
(0x06, 0xff);

467 
	`LPF_S’dRegi¡”
(0x07, 0xff);

468 
	`LPF_S’dRegi¡”
(0x02, 
d©a
);

469 
	`LPF_S’dRegi¡”
(0x06, 0x00);

470 
	`LPF_S’dRegi¡”
(0x03, 
d©a
 >> 8);

471 
	`LPF_S’dRegi¡”
(0x07, 0x00);

472 
	}
}

474 
	$LPF_£t_Ïtch
(
ušt8_t
 
io
, 
boŞ
 
Ïtch
) {

475 
	#LATCH_TIME
 30

476 ià(
Ïtch
è{

	)

477 
	`LPF_wr™e
((1U << 
io
) | 0x0000);

478 
	`d–ay
(
LATCH_TIME
);

479 
	`LPF_wr™e
(0x0000);

481 ià(
io
 == 0xff) {

482 
	`LPF_š™
();

483 
io
 = 0; iØ!ğ16; io++è
	`LPF_£t_Ïtch
(io, 
Ïtch
);

486 
	`LPF_wr™e
((~(1U << 
io
)) | 0x0002);

487 
	`d–ay
(
LATCH_TIME
);

488 
	`LPF_wr™e
(0x0000);

491 
	}
}

493 
ušt8_t
 
	g´ev_Íf_io
 = 0xff;

495 
	$LPF_£t_Íf
(
ušt8_t
 
f
) {

496 
ušt8_t
 
Íf_io
 = (
f
 > 12) ? 3 : (f > 8) ? 5

497 : (
f
 > 6) ? 7

498 : (
f
 > 4) ? 9

500 ià(
´ev_Íf_io
 !ğ
Íf_io
) {

501 
	`LPF_£t_Ïtch
(
´ev_Íf_io
, 
çl£
);

502 
	`LPF_£t_Ïtch
(
Íf_io
, 
Œue
);

503 
´ev_Íf_io
 = 
Íf_io
;

505 
	}
}

	@button.h

2 
‹¡Bu‰Ú
(
ušt8_t
 
šdex
);

4 
d¿wBu‰Ú
(
ušt16_t
 
i
);

5 
checkBu‰Ú
();

6 
execu‹Bu‰Ú
 (
ušt16_t
 
šdex
);

8 
di¥Ïy_®l_bu‰Ús
();

10 
check_FT8_Touch
();

11 
´oûss_touch
();

13 
check_WF_Touch
();

14 
£t_¡¬tup_äeq
();

17 
‹rmš©e_Œªsm™_¬med
();

19 
´oûss_£rŸl
();

21 
EEPROMWr™eIÁ
(
add»ss
, 
v®ue
);

22 
EEPROMR—dIÁ
(
add»ss
);

24 
¡Üe_’cod”s
();

26 
EEPROMR—dIÁ
(
add»ss
);

28 
LPF_S’dRegi¡”
(
ušt8_t
 
»g
, ušt8_ˆ
v®
);

29 
LPF_š™
();

30 
LPF_wr™e
(
ušt16_t
 
d©a
);

31 
LPF_£t_Ïtch
(
ušt8_t
 
io
, 
boŞ
 
Ïtch
);

32 
LPF_£t_Íf
(
ušt8_t
 
f
);

	@constants.cpp

9 
	~"cÚ¡ªts.h
"

12 
	gND
;

13 
	gNS
;

15 
	gNN
 ;

17 
	gN
;

18 
	gK
;

20 
	gM
;

22 
	gK_BYTES
;

25 
ušt16_t
 
	gCRC_POLYNOMIAL
;

26 
	gCRC_WIDTH
;

29 
ušt8_t
 
	gtÚes
[79];

32 
	$š™®ize_cÚ¡ªts
() {

33 
ND
 = 58;

34 
NS
 = 21;

35 
NN
 = 79;

37 
N
 = 174;

38 
K
 = 91;

39 
M
 = 83;

40 
K_BYTES
 = 12;

43 
CRC_POLYNOMIAL
 = 0x2757;

44 
CRC_WIDTH
 = 14;

46 
	}
}

49 cÚ¡ 
ušt8_t
 
	gkCo¡as_m­
[7] = { 3,1,4,0,6,5,2 };

52 cÚ¡ 
ušt8_t
 
	gkG¿y_m­
[8] = { 0,1,3,2,5,6,4,7 };

55 
ušt8_t
 
	gkG’”©Ü
[83][12] = {

143 
ušt8_t
 
	gkCŞumn_Üd”
[174] = {

162 
ušt8_t
 
	gkNm
[83][7] = {

253 
ušt8_t
 
	gkMn
[174][3] = {

430 
ušt8_t
 
	gkNrw
[83] = {

	@constants.h

8 #iâdeà
CONSTANTS_H_


9 
	#CONSTANTS_H_


	)

12 
	~<¡dšt.h
>

14 
	#Œue
 1

	)

15 
	#çl£
 0

	)

17 
K_BYTES
;

18 
ušt8_t
 
tÚes
[79];

22 cÚ¡ 
ušt8_t
 
kCo¡as_m­
[7];

26 cÚ¡ 
ušt8_t
 
kG¿y_m­
[8];

31 
ušt8_t
 
kG’”©Ü
[83][12];

36 
ušt8_t
 
kCŞumn_Üd”
[174];

46 
ušt8_t
 
kNm
[83][7];

56 
ušt8_t
 
kMn
[174][3];

61 
ušt8_t
 
kNrw
[83];

63 
š™®ize_cÚ¡ªts
();

	@decode.cpp

8 
	~"DEBUG.h
"

9 
	~"decode.h
"

11 
	~<m©h.h
>

13 
	~"cÚ¡ªts.h
"

17 
	~"Proûss_DSP.h
"

21 
	~"HX8357_t3n.h
"

22 
HX8357_t3n
 
tá
;

24 
max2
(
a
, 
b
);

25 
max4
(
a
, 
b
, 
c
, 
d
);

26 
h—pify_down
(
Cªdid©e
 *
h—p
, 
h—p_size
);

27 
h—pify_up
(
Cªdid©e
 *
h—p
, 
h—p_size
);

29 
decode_symbŞ
(cÚ¡ 
ušt8_t
 *
pow”
, cÚ¡ ušt8_ˆ*
code_m­
, 
b™_idx
, *
log174
);

30 
decode_muÉi_symbŞs
(cÚ¡ 
ušt8_t
 *
pow”
, 
num_bšs
, 
n_syms
, cÚ¡ ušt8_ˆ*
code_m­
, 
b™_idx
, *
log174
);

32 
ND
;

33 
NS
;

35 
NN
 ;

37 
N
;

38 
K
;

40 
M
;

42 
K_BYTES
;

44 
	gmax_scÜe
;

46 
di¥Ïy_v®ue
(
x
, 
y
, 
v®ue
);

50 
	$fšd_sync
(cÚ¡ 
ušt8_t
 *
pow”
, 
num_blocks
, 
num_bšs
, cÚ¡ ušt8_ˆ*
sync_m­
, 
num_ÿndid©es
, 
Cªdid©e
 *
h—p
, 
mš_scÜe
) {

51 
	`DPRINTF
("num_blocks=%d,‚um_bšs=%d,‚um_ÿndid©es=%d, mš_scÜe=%d\n", 
num_blocks
,
num_bšs
,
num_ÿndid©es
,
mš_scÜe
);

52 
h—p_size
 = 0;

53 
max_scÜe
 = 0;

58 
®t
 = 0;‡lt < 4; ++alt) {

60 
time_off£t
 = -7;ime_off£ˆ< 
num_blocks
 - 
NN
 + 7; ++time_offset) {

61 
äeq_off£t
 = 
á8_mš_bš
; f»q_off£ˆ< 
num_bšs
 - 8; ++freq_offset) {

62 
scÜe
 = 0;

65 
num_symbŞs
 = 0;

66 
m
 = 0; m <= 72; m += 36) {

67 
k
 = 0; k < 7; ++k) {

69 ià(
time_off£t
 + 
k
 + 
m
 < 0) ;

70 ià(
time_off£t
 + 
k
 + 
m
 >ğ
num_blocks
) ;

72 
off£t
 = ((
time_off£t
 + 
k
 + 
m
è* 4 + 
®t
è* 
num_bšs
 + 
äeq_off£t
;

74 cÚ¡ 
ušt8_t
 *
p8
 = 
pow”
 + 
off£t
;

76 
scÜe
 +ğ8 * 
p8
[
sync_m­
[
k
]] -

77 
p8
[0] -…8[1] -…8[2] -…8[3] -

78 
p8
[4] -…8[5] -…8[6] -…8[7];

101 ++
num_symbŞs
;

104 
scÜe
 /ğ
num_symbŞs
;

106 if(
scÜe
 > 
max_scÜe
) max_score = score;

107 ià(
scÜe
 < 
mš_scÜe
) ;

111 ià(
h—p_size
 =ğ
num_ÿndid©es
 && 
scÜe
 > 
h—p
[0].score) {

112 
h—p
[0] = h—p[
h—p_size
 - 1];

113 --
h—p_size
;

115 
	`h—pify_down
(
h—p
, 
h—p_size
);

119 ià(
h—p_size
 < 
num_ÿndid©es
) {

120 
h—p
[
h—p_size
].
scÜe
 = score;

121 
h—p
[
h—p_size
].
time_off£t
 =ime_offset;

122 
h—p
[
h—p_size
].
äeq_off£t
 = freq_offset;

123 
h—p
[
h—p_size
].
time_sub
 = 
®t
 / 2;

124 
h—p
[
h—p_size
].
äeq_sub
 = 
®t
 % 2;

125 ++
h—p_size
;

127 
	`h—pify_up
(
h—p
, 
h—p_size
);

134 
	`DPRINTF
("max_scÜe=%d\n",
max_scÜe
);

135  
h—p_size
;

136 
	}
}

147 
	$exŒaù_lik–ihood
(cÚ¡ 
ušt8_t
 *
pow”
, 
num_bšs
, 
Cªdid©e
 
ÿnd
, cÚ¡ ušt8_ˆ*
code_m­
, *
log174
) {

149 
á8_off£t
 = (
ÿnd
.
time_off£t
 * 4 + cªd.
time_sub
 * 2 + cªd.
äeq_sub
è* 
num_bšs
 + cªd.
äeq_off£t
;

157 cÚ¡ 
n_syms
 = 1;

158 cÚ¡ 
n_b™s
 = 3 * 
n_syms
;

159 cÚ¡ 
n_tÚes
 = (1 << 
n_b™s
);

160 
k
 = 0; k < 
ND
; k +ğ
n_syms
) {

161 
sym_idx
 = (
k
 < 
ND
 / 2) ? (k + 7) : (k + 14);

162 
b™_idx
 = 3 * 
k
;

165 cÚ¡ 
ušt8_t
 *
ps
 = 
pow”
 + (
á8_off£t
 + 
sym_idx
 * 4 * 
num_bšs
);

167 
	`decode_symbŞ
(
ps
, 
code_m­
, 
b™_idx
, 
log174
);

171 
sum
 = 0;

172 
sum2
 = 0;

173 
šv_n
 = 1.0à/ 
N
;

174 
i
 = 0; i < 
N
; ++i) {

175 
sum
 +ğ
log174
[
i
];

176 
sum2
 +ğ
log174
[
i
] *†og174[i];

178 
v¬Ÿnû
 = (
sum2
 - 
sum
 * sum * 
šv_n
) * inv_n;

181 
nÜm_çùÜ
 = 
	`sq¹f
(16.0à/ 
v¬Ÿnû
);

182 
i
 = 0; i < 
N
; ++i) {

183 
log174
[
i
] *ğ
nÜm_çùÜ
;

185 
	}
}

188 
	$max2
(
a
, 
b
) {

189  (
a
 >ğ
b
) ?‡ : b;

190 
	}
}

193 
	$max4
(
a
, 
b
, 
c
, 
d
) {

194  
	`max2
(max2(
a
, 
b
), max2(
c
, 
d
));

195 
	}
}

198 
	$h—pify_down
(
Cªdid©e
 *
h—p
, 
h—p_size
) {

200 
cu¼’t
 = 0;

201 
Œue
) {

202 
Ïrge¡
 = 
cu¼’t
;

203 
Ëá
 = 2 * 
cu¼’t
 + 1;

204 
right
 = 
Ëá
 + 1;

206 ià(
Ëá
 < 
h—p_size
 && 
h—p
[Ëá].
scÜe
 < h—p[
Ïrge¡
].score) {

207 
Ïrge¡
 = 
Ëá
;

209 ià(
right
 < 
h—p_size
 && 
h—p
[right].
scÜe
 < h—p[
Ïrge¡
].score) {

210 
Ïrge¡
 = 
right
;

212 ià(
Ïrge¡
 =ğ
cu¼’t
) {

216 
Cªdid©e
 
tmp
 = 
h—p
[
Ïrge¡
];

217 
h—p
[
Ïrge¡
] = h—p[
cu¼’t
];

218 
h—p
[
cu¼’t
] = 
tmp
;

219 
cu¼’t
 = 
Ïrge¡
;

221 
	}
}

224 
	$h—pify_up
(
Cªdid©e
 *
h—p
, 
h—p_size
) {

226 
cu¼’t
 = 
h—p_size
 - 1;

227 
cu¼’t
 > 0) {

228 
·»Á
 = (
cu¼’t
 - 1) / 2;

229 ià(
h—p
[
cu¼’t
].
scÜe
 >ğh—p[
·»Á
].score) {

233 
Cªdid©e
 
tmp
 = 
h—p
[
·»Á
];

234 
h—p
[
·»Á
] = h—p[
cu¼’t
];

235 
h—p
[
cu¼’t
] = 
tmp
;

236 
cu¼’t
 = 
·»Á
;

238 
	}
}

242 
	$decode_symbŞ
(cÚ¡ 
ušt8_t
 *
pow”
, cÚ¡ ušt8_ˆ*
code_m­
, 
b™_idx
, *
log174
) {

245 
s2
[8];

247 
j
 = 0; j < 8; ++j) {

248 
s2
[
j
] = ()
pow”
[
code_m­
[j]];

252 
log174
[
b™_idx
 + 0] = 
	`max4
(
s2
[4], s2[5], s2[6], s2[7]) - max4(s2[0], s2[1], s2[2], s2[3]);

253 
log174
[
b™_idx
 + 1] = 
	`max4
(
s2
[2], s2[3], s2[6], s2[7]) - max4(s2[0], s2[1], s2[4], s2[5]);

254 
log174
[
b™_idx
 + 2] = 
	`max4
(
s2
[1], s2[3], s2[5], s2[7]) - max4(s2[0], s2[2], s2[4], s2[6]);

255 
	}
}

259 
	$decode_muÉi_symbŞs
(cÚ¡ 
ušt8_t
 *
pow”
, 
num_bšs
, 
n_syms
, cÚ¡ ušt8_ˆ*
code_m­
, 
b™_idx
, *
log174
) {

264 cÚ¡ 
n_b™s
 = 3 * 
n_syms
;

265 cÚ¡ 
n_tÚes
 = (1 << 
n_b™s
);

267 
s2
[
n_tÚes
];

269 
j
 = 0; j < 
n_tÚes
; ++j) {

270 
j1
 = 
j
 & 0x07;

271 ià(
n_syms
 == 1) {

272 
s2
[
j
] = ()
pow”
[
code_m­
[
j1
]];

275 
j2
 = (
j
 >> 3) & 0x07;

276 ià(
n_syms
 == 2) {

277 
s2
[
j
] = ()
pow”
[
code_m­
[
j2
]];

278 
s2
[
j
] +ğ()
pow”
[
code_m­
[
j1
] + 4 * 
num_bšs
];

281 
j3
 = (
j
 >> 6) & 0x07;

282 
s2
[
j
] = ()
pow”
[
code_m­
[
j3
]];

283 
s2
[
j
] +ğ()
pow”
[
code_m­
[
j2
] + 4 * 
num_bšs
];

284 
s2
[
j
] +ğ()
pow”
[
code_m­
[
j1
] + 8 * 
num_bšs
];

291 
ušt16_t
 
mask
;

296 
i
 = 0; i < 
n_b™s
; ++i) {

298 ià(
b™_idx
 + 
i
 >ğ
N
) {

303 
mask
 = (
n_tÚes
 >> (
i
 + 1));

304 
max_z”o
 = -1000, 
max_Úe
 = -1000;

305 
n
 = 0;‚ < 
n_tÚes
; ++n) {

306 ià(
n
 & 
mask
) {

307 
max_Úe
 = 
	`max2
(max_Úe, 
s2
[
n
]);

310 
max_z”o
 = 
	`max2
(max_z”o, 
s2
[
n
]);

314 
log174
[
b™_idx
 + 
i
] = 
max_Úe
 - 
max_z”o
;

316 
	}
}

	@decode.h

8 #iâdeà
DECODE_H_


9 
	#DECODE_H_


	)

11 
	~<¡dšt.h
>

13 
	sCªdid©e
 {

14 
št16_t
 
	mscÜe
;

15 
št16_t
 
	mtime_off£t
;

16 
št16_t
 
	mäeq_off£t
;

17 
ušt8_t
 
	mtime_sub
;

18 
ušt8_t
 
	mäeq_sub
;

19 } 
	tCªdid©e
;

28 
fšd_sync
(cÚ¡ 
ušt8_t
 *
pow”
, 
num_blocks
, 
num_bšs
, cÚ¡ ušt8_ˆ*
sync_m­
, 
num_ÿndid©es
, 
Cªdid©e
 *
h—p
, 
mš_scÜe
);

35 
exŒaù_lik–ihood
(cÚ¡ 
ušt8_t
 *
pow”
, 
num_bšs
, 
Cªdid©e
 
ÿnd
, cÚ¡ ušt8_ˆ*
code_m­
, *
log174
);

	@decode_ft8.cpp

8 
	~"DEBUG.h
"

10 
	~<¡dlib.h
>

11 
	~<¡ršg.h
>

12 
	~<¡dio.h
>

13 
	~<m©h.h
>

14 
	~<ùy³.h
>

15 
	~"g’_á8.h
"

17 
	~"uÅack.h
"

18 
	~"ldpc.h
"

19 
	~"decode.h
"

20 
	~"cÚ¡ªts.h
"

21 
	~"’code.h
"

23 
	~<TimeLib.h
>

25 
	~"Proûss_DSP.h
"

29 
	~"decode_á8.h
"

34 
	~"HX8357_t3n.h
"

35 
HX8357_t3n
 
tá
;

37 
	g”a£
[] = " ";

39 cÚ¡ 
	gkLDPC_™”©iÚs
 = 10;

40 cÚ¡ 
	gkMax_ÿndid©es
 = 20;

41 cÚ¡ 
	gkMax_decoded_mes§ges
 = 6;

42 cÚ¡ 
	gkMax_mes§ge_Ëngth
 = 20;

44 cÚ¡ 
	gkMš_scÜe
 = 40;

46 
v®id©e_loÿtÜ
(
loÿtÜ
[]);

47 
¡ršdex
(
s
[], 
t
[]);

49 
ušt32_t
 
á8_time
;

50 
ušt8_t
 
expÜt_fá_pow”
[
á8_msg_§m¶es
 * 
á8_bufãr
 * 4];

52 
ND
;

53 
NS
;

55 
NN
;

57 
N
;

58 
K
;

60 
M
;

62 
K_BYTES
;

64 
wr™e_log_d©a
(*
d©a
);

66 
Decode
 
	gÃw_decoded
[20];

68 
C®lšg_StiÚ
 
	gAnsw”_CQ
[100];

69 
CQ_StiÚ
 
	gC®lšg_CQ
[8];

71 
	gnum_ÿÎs
;

72 
	gnum_ÿÎ_checks
;

73 
	gnum_CQ_ÿÎs
;

74 
	gnum_ÿÎs_to_CQ_¡©iÚ
;

75 
	gmax_di¥Ïyed_CQ
 = 6;

76 
	gmes§ge_lim™
 = 6;

78 
	gmax_C®lšg_StiÚs
 = 6;

79 
	gnum_C®lšg_StiÚs
;

81 
StiÚ_C®l
[];

84 
StiÚ_L©™ude
, 
StiÚ_LÚg™ude
;

86 
T¬g‘_L©™ude
, 
T¬g‘_LÚg™ude
;

88 
T¬g‘_Di¡ªû
(
rg‘
[]);

90 
CQ_S‹
;

91 
B—cÚ_S‹
;

93 
T¬g‘_C®l
[7];

94 
T¬g‘_RSL
;

96 
time_t
 
g‘T“nsy3Time
();

97 
log_æag
, 
loggšg_Ú
;

99 
	$á8_decode
() {

102 
Cªdid©e
 
ÿndid©e_li¡
[
kMax_ÿndid©es
];

104 
num_ÿndid©es
 = 
	`fšd_sync
(
expÜt_fá_pow”
, 
á8_msg_§m¶es
, 
á8_bufãr
, 
kCo¡as_m­
, 
kMax_ÿndid©es
, 
ÿndid©e_li¡
, 
kMš_scÜe
);

105 
decoded
[
kMax_decoded_mes§ges
][
kMax_mes§ge_Ëngth
];

107 cÚ¡ 
fsk_dev
 = 6.25f;

110 
num_decoded
 = 0;

112 
	`DPRINTF
("num_ÿndid©es=%u\n",
num_ÿndid©es
);

114 
idx
 = 0; idx < 
num_ÿndid©es
; ++idx) {

115 
Cªdid©e
 
ÿnd
 = 
ÿndid©e_li¡
[
idx
];

116 
äeq_hz
 = (
ÿnd
.
äeq_off£t
 + cªd.
äeq_sub
 / 2.0fè* 
fsk_dev
;

118 
log174
[
N
];

119 
	`exŒaù_lik–ihood
(
expÜt_fá_pow”
, 
á8_bufãr
, 
ÿnd
, 
kG¿y_m­
, 
log174
);

122 
ušt8_t
 
¶aš
[
N
];

123 
n_”rÜs
 = 0;

124 
	`bp_decode
(
log174
, 
kLDPC_™”©iÚs
, 
¶aš
, &
n_”rÜs
);

125 
	`DPRINTF
("ÿndid©%d‚_”rÜs=%d\n",
idx
,
n_”rÜs
);

127 ià(
n_”rÜs
 > 0) ;

130 
ušt8_t
 
a91
[
K_BYTES
];

131 
	`·ck_b™s
(
¶aš
, 
K
, 
a91
);

134 
ušt16_t
 
chksum
 = ((
a91
[9] & 0x07) << 11) | (a91[10] << 3) | (a91[11] >> 5);

135 
a91
[9] &= 0xF8;

136 
a91
[10] = 0;

137 
a91
[11] = 0;

138 
ušt16_t
 
chksum2
 = 
	`üc
(
a91
, 96 - 14);

139 
	`DPRINTF
("chksum=%u chksum2=%u\n",
chksum
, 
chksum2
);

140 ià(
chksum
 !ğ
chksum2
) ;

142 
mes§ge
[
kMax_mes§ge_Ëngth
];

144 
f›ld1
[14];

145 
f›ld2
[14];

146 
f›ld3
[7];

147 
rc
 = 
	`uÅack77_f›lds
(
a91
, 
f›ld1
, 
f›ld2
, 
f›ld3
);

148 ià(
rc
 < 0) ;

150 
	`¥rštf
(
mes§ge
, "% % % ", 
f›ld1
, 
f›ld2
, 
f›ld3
);

151 
	`DPRINTF
("mes§ge='% % %s' \n", 
f›ld1
, 
f›ld2
, 
f›ld3
);

155 
boŞ
 
found
 = 
çl£
;

156 
i
 = 0; i < 
num_decoded
; ++i) {

157 ià(0 =ğ
	`¡rcmp
(
decoded
[
i
], 
mes§ge
)) {

158 
found
 = 
Œue
;

163 
¿w_RSL
;

164 
di¥Ïy_RSL
;

165 
di¡ªû
;

167 
	`g‘T“nsy3Time
();

168 
¹c_¡ršg
[10];

169 
	`¥rštf
(
¹c_¡ršg
, "%2i:%2i:%2i", 
	`hour
(), 
	`mšu‹
(), 
	`£cÚd
());

171 ià(!
found
 && 
num_decoded
 < 
kMax_decoded_mes§ges
) {

172 ià(
	`¡¾’
(
mes§ge
è< 
kMax_mes§ge_Ëngth
) {

173 
	`¡rıy
(
decoded
[
num_decoded
], 
mes§ge
);

175 
Ãw_decoded
[
num_decoded
].
sync_scÜe
 = 
ÿnd
.
scÜe
;

176 
Ãw_decoded
[
num_decoded
].
äeq_hz
 = ()freq_hz;

177 
	`¡rıy
(
Ãw_decoded
[
num_decoded
].
f›ld1
, field1);

178 
	`¡rıy
(
Ãw_decoded
[
num_decoded
].
f›ld2
, field2);

179 
	`¡rıy
(
Ãw_decoded
[
num_decoded
].
f›ld3
, field3);

180 
	`¡rıy
(
Ãw_decoded
[
num_decoded
].
decode_time
, 
¹c_¡ršg
);

182 
¿w_RSL
 = 
Ãw_decoded
[
num_decoded
].
sync_scÜe
;

183 ià(
¿w_RSL
 > 160)„aw_RSL = 160;

184 
di¥Ïy_RSL
 = (
¿w_RSL
 - 160) / 6;

185 
Ãw_decoded
[
num_decoded
].
¢r
 = 
di¥Ïy_RSL
;

187 
T¬g‘_LoÿtÜ
[] = " ";

189 
	`¡rıy
(
T¬g‘_LoÿtÜ
, 
Ãw_decoded
[
num_decoded
].
f›ld3
);

191 ià(
	`v®id©e_loÿtÜ
(
T¬g‘_LoÿtÜ
) == 1) {

192 
di¡ªû
 = 
	`T¬g‘_Di¡ªû
(
T¬g‘_LoÿtÜ
);

193 
Ãw_decoded
[
num_decoded
].
di¡ªû
 = ()distance;

195 
Ãw_decoded
[
num_decoded
].
di¡ªû
 = 0;

197 ++
num_decoded
;

203  
num_decoded
;

204 
	}
}

207 
	$di¥Ïy_mes§ges
(
decoded_mes§ges
) {

209 
mes§ge
[
kMax_mes§ge_Ëngth
];

210 
big_guÍ
[60];

212 
tá
.
	`flReù
(0, 100, 240, 140, 
HX8357_BLACK
);

214 
i
 = 0; i < 
decoded_mes§ges
 && i < 
mes§ge_lim™
; i++) {

215 
	`¥rštf
(
mes§ge
, "% % %s", 
Ãw_decoded
[
i
].
f›ld1
,‚ew_decoded[i].
f›ld2
,‚ew_decoded[i].
f›ld3
);

217 
	`¥rštf
(
big_guÍ
, "% %s", 
Ãw_decoded
[
i
].
decode_time
, 
mes§ge
);

218 
tá
.
	`£tTextCŞÜ
(
HX8357_YELLOW
, 
HX8357_BLACK
);

219 
tá
.
	`£tTextSize
(2);

220 
tá
.
	`£tCursÜ
(0, 100 + 
i
 * 25);

221 
tá
.
	`´št
(
mes§ge
);

225 
	}
}

228 
	$di¥Ïy_£Ëùed_ÿÎ
(
šdex
) {

230 
£Ëùed_¡©iÚ
[18];

231 
bÏnk
[] = " ";

232 
	`¡rıy
(
T¬g‘_C®l
, 
Ãw_decoded
[
šdex
].
f›ld2
);

233 
T¬g‘_RSL
 = 
Ãw_decoded
[
šdex
].
¢r
;

235 
	`¥rštf
(
£Ëùed_¡©iÚ
, "%7 %3i", 
T¬g‘_C®l
, 
T¬g‘_RSL
);

236 
tá
.
	`£tTextCŞÜ
(
HX8357_YELLOW
, 
HX8357_BLACK
);

237 
tá
.
	`£tTextSize
(2);

238 
tá
.
	`£tCursÜ
(360, 20);

239 
tá
.
	`´št
(
bÏnk
);

240 
tá
.
	`£tCursÜ
(360, 20);

241 
tá
.
	`´št
(
T¬g‘_C®l
);

242 
	}
}

245 
	$di¥Ïy_d‘as
(
decoded_mes§ges
) {

247 
mes§ge
[48];

251 
i
 = 0; i < 
decoded_mes§ges
 && i < 
mes§ge_lim™
; i++) {

252 
	`¥rštf
(
mes§ge
, "%7 %7 %4 %4˜%3˜%4i", 
Ãw_decoded
[
i
].
f›ld1
,‚ew_decoded[i].
f›ld2
,‚ew_decoded[i].
f›ld3
,‚ew_decoded[i].
äeq_hz
,‚ew_decoded[i].
¢r
,‚ew_decoded[i].
di¡ªû
);

260 
	}
}

262 
	$v®id©e_loÿtÜ
(
loÿtÜ
[]) {

264 
ušt8_t
 
A1
, 
A2
, 
N1
, 
N2
;

265 
ušt8_t
 
‹¡
 = 0;

267 
A1
 = 
loÿtÜ
[0] - 65;

268 
A2
 = 
loÿtÜ
[1] - 65;

269 
N1
 = 
loÿtÜ
[2] - 48;

270 
N2
 = 
loÿtÜ
[3] - 48;

272 ià(
A1
 >ğ0 && A1 <ğ17è
‹¡
++;

273 ià(
A2
 > 0 && A2 < 17è
‹¡
++;

274 ià(
N1
 >ğ0 && N1 <ğ9è
‹¡
++;

275 ià(
N2
 >ğ0 && N2 <ğ9è
‹¡
++;

277 ià(
‹¡
 == 4)  1;

280 
	}
}

285 
	$¡ršdex
(
s
[], 
t
[]) {

286 
i
, 
j
, 
k
, 
»suÉ
;

288 
»suÉ
 = -1;

290 
i
 = 0; 
s
[i] != '\0'; i++) {

291 
j
 = 
i
, 
k
 = 0; 
t
[k] !ğ'\0' && 
s
[j] ==[k]; j++, k++)

293 ià(
k
 > 0 && 
t
[k] == '\0')

294 
»suÉ
 = 
i
;

296  
»suÉ
;

297 
	}
}

301 
	$Check_C®lšg_StiÚs
(
num_decoded
) {

302 
big_guÍ
[60];

303 
mes§ge
[
kMax_mes§ge_Ëngth
];

304 
mes§ge_‹¡
 = 0;

306 
i
 = 0; i < 
num_decoded
; i++) {

307 ià(
	`¡ršdex
(
Ãw_decoded
[
i
].
f›ld1
, 
StiÚ_C®l
) >= 0) {

308 
	`¥rštf
(
mes§ge
, "% % %s", 
Ãw_decoded
[
i
].
f›ld1
,‚ew_decoded[i].
f›ld2
,‚ew_decoded[i].
f›ld3
);

310 
	`g‘T“nsy3Time
();

311 
	`¥rštf
(
big_guÍ
, "%2i/%2i/%4˜% %s", 
	`day
(), 
	`mÚth
(), 
	`y—r
(), 
Ãw_decoded
[
i
].
decode_time
, 
mes§ge
);

312 
tá
.
	`£tTextCŞÜ
(
HX8357_YELLOW
, 
HX8357_BLACK
);

313 
tá
.
	`£tTextSize
(2);

314 
tá
.
	`£tCursÜ
(240, 100 + 
i
 * 25);

315 
tá
.
	`´št
(
mes§ge
);

317 ià(
loggšg_Ú
 =ğ1è
	`wr™e_log_d©a
(
big_guÍ
);

319 
num_C®lšg_StiÚs
++;

320 
mes§ge_‹¡
 = 
i
 + 100;

323 ià(
num_C®lšg_StiÚs
 =ğ
max_C®lšg_StiÚs
) {

324 
tá
.
	`flReù
(0, 100, 240, 190, 
HX8357_BLACK
);

325 
num_C®lšg_StiÚs
 = 0;

329 ià(
mes§ge_‹¡
 > 100)  message_test - 100;

332 
	}
}

	@decode_ft8.h

8 #iâdeà
DECODE_FT8_H_


9 
	#DECODE_FT8_H_


	)

12 
á8_decode
();

16 
	mf›ld1
[14];

17 
	mf›ld2
[14];

18 
	mf›ld3
[7];

19 
	mäeq_hz
;

20 
	mdecode_time
[10];

21 
	msync_scÜe
;

22 
	m¢r
;

23 
	mdi¡ªû
;

25 } 
	tDecode
;

29 
	mdecode_time
[10];

30 
	mÿÎ
[7];

32 } 
	tC®lšg_StiÚ
;

36 
	mdecode_time
[10];

37 
	mÿÎ
[7];

38 
	mdi¡ªû
;

39 
	m¢r
;

40 
	mäeq_hz
;

41 } 
	tCQ_StiÚ
;

45 
§ve_Answ”_CQ_Li¡
();

47 
di¥Ïy_Answ”_CQ_I‹ms
();

49 
Check_C®lšg_StiÚs
(
num_decoded
 );

50 
ş—r_CQ_Li¡_box
();

51 
di¥Ïy_d‘as
(
decoded_mes§ges
);

52 
di¥Ïy_mes§ges
(
decoded_mes§ges
);

53 
ş—r_di¥Ïy_d‘as
();

54 
Check_CQ_C®lšg_StiÚs
(
num_decoded
, 
»¶y_¡©e
);

55 
Check_QSO_C®lšg_StiÚs
(
num_decoded
, 
»¶y_¡©e
);

56 
Check_CQ_StiÚs
(
num_decoded
);

58 
di¥Ïy_£Ëùed_ÿÎ
(
šdex
);

59 
´oûss_£Ëùed_CQ
();

	@display.cpp

2 
	~"HX8357_t3n.h
"

3 
	~"di¥Ïy.h
"

4 
	~<TimeLib.h
>

6 
	~<SD.h
>

7 
	~<SPI.h
>

9 
	glog_f’ame
[] = "FT8_Traffic.txt";

10 
Fe
 
	gLog_Fe
;

12 
time_t
 
g‘T“nsy3Time
();

13 
StiÚ_C®l
[];

14 
LoÿtÜ
[];

16 
log_æag
, 
loggšg_Ú
;

19 
HX8357_t3n
 
tá
;

22 
	$di¥Ïy_v®ue
(
x
, 
y
, 
v®ue
) {

23 
¡ršg
[7];

24 
	`¥rštf
(
¡ršg
, "%6i", 
v®ue
);

25 
tá
.
	`£tTextCŞÜ
(
HX8357_YELLOW
, 
HX8357_BLACK
);

26 
tá
.
	`£tTextSize
(2);

27 
tá
.
	`£tCursÜ
(
x
, 
y
);

28 
tá
.
	`´št
(
¡ršg
);

29 
	}
}

34 
	$di¥Ïy_time
(
x
, 
y
) {

35 
	`g‘T“nsy3Time
();

36 
¡ršg
[10];

37 
	`¥rštf
(
¡ršg
, "%2i:%2i:%2i", 
	`hour
(), 
	`mšu‹
(), 
	`£cÚd
());

38 
tá
.
	`£tTextCŞÜ
(
HX8357_YELLOW
, 
HX8357_BLACK
);

39 
tá
.
	`£tTextSize
(2);

40 
tá
.
	`£tCursÜ
(
x
, 
y
);

41 
tá
.
	`´št
(
¡ršg
);

42 
	}
}

44 
	$di¥Ïy_d©e
(
x
, 
y
) {

45 
	`g‘T“nsy3Time
();

46 
¡ršg
[10];

47 
	`¥rštf
(
¡ršg
, "%2˜%2˜%4i", 
	`day
(), 
	`mÚth
(), 
	`y—r
());

48 
tá
.
	`£tTextCŞÜ
(
HX8357_YELLOW
, 
HX8357_BLACK
);

49 
tá
.
	`£tTextSize
(2);

50 
tá
.
	`£tCursÜ
(
x
, 
y
);

51 
tá
.
	`´št
(
¡ršg
);

52 
	}
}

56 
	$make_f’ame
() {

57 
	`g‘T“nsy3Time
();

58 
	`¥rštf
((*)
log_f’ame
, "%2i%2i%4i%2i%2i", 
	`day
(), 
	`mÚth
(), 
	`y—r
(), 
	`hour
(), 
	`mšu‹
());

59 
tá
.
	`£tTextCŞÜ
(
HX8357_YELLOW
, 
HX8357_BLACK
);

60 
tá
.
	`£tTextSize
(2);

61 
tá
.
	`£tCursÜ
(0, 200);

62 
tá
.
	`´št
(
log_f’ame
);

63 
	}
}

66 
boŞ
 
	$İ’_log_fe
() {

68 ià(!
SD
.
	`begš
(
BUILTIN_SDCARD
)) {

69 
tá
.
	`£tTextCŞÜ
(
HX8357_YELLOW
, 
HX8357_BLACK
);

70 
tá
.
	`£tTextSize
(2);

71 
tá
.
	`£tCursÜ
(0, 200);

72 
tá
.
	`´št
("SD Card‚ot found");

73 
log_æag
 = 0;

74  
çl£
;

76 
Log_Fe
 = 
SD
.
	`İ’
("FT8_Log.txt", 
FILE_WRITE
);

79 
Log_Fe
.
	`´šn
(" ");

80 
Log_Fe
.
	`´šn
("**********************");

82 
Log_Fe
.
	`şo£
();

83 
tá
.
	`£tTextCŞÜ
(
HX8357_YELLOW
, 
HX8357_BLACK
);

84 
tá
.
	`£tTextSize
(2);

85 
tá
.
	`£tCursÜ
(0, 200);

86 
tá
.
	`´št
("FT8_Log.txt");

87 
log_æag
 = 1;

88  
Œue
;

90 
	}
}

93 
	$di¥Ïy_¡©iÚ_d©a
(
x
, 
y
) {

94 
¡ršg
[13];

95 
	`¥rštf
(
¡ršg
, "%7 %4s", 
StiÚ_C®l
, 
LoÿtÜ
);

96 
tá
.
	`£tTextCŞÜ
(
HX8357_YELLOW
, 
HX8357_BLACK
);

97 
tá
.
	`£tTextSize
(2);

98 
tá
.
	`£tCursÜ
(
x
, 
y
);

99 
tá
.
	`´št
(
¡ršg
);

100 
	}
}

103 
	$wr™e_log_d©a
(*
d©a
) {

104 
Log_Fe
 = 
SD
.
	`İ’
("FT8_Log.txt", 
FILE_WRITE
);

105 
Log_Fe
.
	`´šn
(
d©a
);

106 
Log_Fe
.
	`şo£
();

107 
	}
}

	@display.h

2 
	~<¬m_m©h.h
>

3 
	~"WSŒšg.h
"

4 
	#BLACK
 
HX8357_BLACK


	)

5 
	#WHITE
 
HX8357_WHITE


	)

6 
	#RED
 
HX8357_RED


	)

7 
	#GREEN
 
HX8357_GREEN


	)

8 
	#YELLOW
 
HX8357_YELLOW


	)

9 
	#BLUE
 
HX8357_BLUE


	)

11 
	#USB_WIDE
 0

12 
	#USB_NARROW
 1

	)

13 
	#LSB_WIDE
 2

	)

14 
	#LSB_NARROW
 3

	)

16 
di¥Ïy_v®ue
(
x
, 
y
, 
v®ue
);

17 
”a£_v®ue
(
x
, 
y
);

18 
di¥Ïy_time
(
x
, 
y
);

19 
di¥Ïy_d©e
(
x
, 
y
);

20 
di¥Ïy_¡©iÚ_d©a
(
x
, 
y
);

22 
make_f’ame
();

23 
boŞ
 
İ’_log_fe
();

24 
wr™e_log_d©a
(*
d©a
);

	@encode.cpp

9 
	~"’code.h
"

10 
	~"cÚ¡ªts.h
"

12 
	~<¡dio.h
>

14 
ND
;

15 
NS
;

17 
NN
 ;

19 
N
;

20 
K
;

22 
M
;

24 
K_BYTES
;

26 
ušt16_t
 
CRC_POLYNOMIAL
;

27 
CRC_WIDTH
;

31 
ušt8_t
 
	$·r™y8
(
ušt8_t
 
x
) {

32 
x
 ^= x >> 4;

33 
x
 ^= x >> 2;

34 
x
 ^= x >> 1;

35  (
x
) & 1;

36 
	}
}

46 
	$’code174
(cÚ¡ 
ušt8_t
 *
mes§ge
, ušt8_ˆ*
codewÜd
) {

61 
j
 = 0; j < (7 + 
N
) / 8; ++j) {

62 
codewÜd
[
j
] = (j < 
K_BYTES
è? 
mes§ge
[j] : 0;

65 
ušt8_t
 
cŞ_mask
 = (0x80 >> (
K
 % 8));

66 
ušt8_t
 
cŞ_idx
 = 
K_BYTES
 - 1;

69 
i
 = 0; i < 
M
; ++i) {

73 
ušt8_t
 
nsum
 = 0;

74 
j
 = 0; j < 
K_BYTES
; ++j) {

75 
ušt8_t
 
b™s
 = 
mes§ge
[
j
] & 
kG’”©Ü
[
i
][j];

76 
nsum
 ^ğ
	`·r™y8
(
b™s
);

79 ià(
nsum
 % 2) {

80 
codewÜd
[
cŞ_idx
] |ğ
cŞ_mask
;

83 
cŞ_mask
 >>= 1;

84 ià(
cŞ_mask
 == 0) {

85 
cŞ_mask
 = 0x80;

86 ++
cŞ_idx
;

95 
	}
}

101 
ušt16_t
 
	$üc
(
ušt8_t
 *
mes§ge
, 
num_b™s
) {

104 
ušt16_t
 
TOPBIT
 = (1 << (
CRC_WIDTH
 - 1));

111 
ušt16_t
 
»mašd”
 = 0;

112 
idx_by‹
 = 0;

115 
idx_b™
 = 0; idx_b™ < 
num_b™s
; ++idx_bit) {

116 ià(
idx_b™
 % 8 == 0) {

118 
»mašd”
 ^ğ(
mes§ge
[
idx_by‹
] << (
CRC_WIDTH
 - 8));

119 ++
idx_by‹
;

123 ià(
»mašd”
 & 
TOPBIT
) {

124 
»mašd”
 = (»mašd” << 1è^ 
CRC_POLYNOMIAL
;

127 
»mašd”
 = (remainder << 1);

131  
»mašd”
 & ((1 << 
CRC_WIDTH
) - 1);

132 
	}
}

138 
	$g’á8
(cÚ¡ 
ušt8_t
 *
·ylßd
, ušt8_ˆ*
™Úe
) {

139 
ušt8_t
 
a91
[12];

142 
i
 = 0; i < 10; i++)

143 
a91
[
i
] = 
·ylßd
[i];

146 
a91
[9] &= 0xF8;

147 
a91
[10] = 0;

148 
a91
[11] = 0;

151 
ušt16_t
 
checksum
 = 
	`üc
(
a91
, 96 - 14);

154 
a91
[9] |ğ(
ušt8_t
)(
checksum
 >> 11);

155 
a91
[10] = (
ušt8_t
)(
checksum
 >> 3);

156 
a91
[11] = (
ušt8_t
)(
checksum
 << 5);

159 
ušt8_t
 
codewÜd
[22];

160 
	`’code174
(
a91
, 
codewÜd
);

163 
i
 = 0; i < 7; ++i) {

164 
™Úe
[
i
] = 
kCo¡as_m­
[i];

165 
™Úe
[36 + 
i
] = 
kCo¡as_m­
[i];

166 
™Úe
[72 + 
i
] = 
kCo¡as_m­
[i];

169 
k
 = 7;

171 
ušt8_t
 
mask
 = 0x80;

172 
i_by‹
 = 0;

173 
j
 = 0; j < 
ND
; ++j) {

174 ià(
j
 == 29) {

175 
k
 += 7;

179 
ušt8_t
 
b™s3
 = 0;

181 ià(
codewÜd
[
i_by‹
] & 
mask
è
b™s3
 |= 4;

182 ià(0 =ğ(
mask
 >>ğ1)è{ mask = 0x80; 
i_by‹
++; }

183 ià(
codewÜd
[
i_by‹
] & 
mask
è
b™s3
 |= 2;

184 ià(0 =ğ(
mask
 >>ğ1)è{ mask = 0x80; 
i_by‹
++; }

185 ià(
codewÜd
[
i_by‹
] & 
mask
è
b™s3
 |= 1;

186 ià(0 =ğ(
mask
 >>ğ1)è{ mask = 0x80; 
i_by‹
++; }

188 
™Úe
[
k
] = 
kG¿y_m­
[
b™s3
];

189 ++
k
;

191 
	}
}

	@encode.h

3 
	~<¡dšt.h
>

10 
g’á8
(cÚ¡ 
ušt8_t
 *
·ylßd
, ušt8_ˆ*
™Úe
);

22 
’code174
(cÚ¡ 
ušt8_t
 *
mes§ge
, ušt8_ˆ*
codewÜd
);

28 
ušt16_t
 
üc
(
ušt8_t
 *
mes§ge
, 
num_b™s
);

	@gen_ft8.cpp

8 
	~<¡dlib.h
>

9 
	~<¡ršg.h
>

10 
	~<¡dio.h
>

11 
	~<m©h.h
>

12 
	~<TimeLib.h
>

14 
	~"·ck.h
"

15 
	~"’code.h
"

16 
	~"cÚ¡ªts.h
"

18 
	~"g’_á8.h
"

20 
	~<¡dio.h
>

23 
	~"HX8357_t3n.h
"

24 
HX8357_t3n
 
tá
;

26 
	~"¬m_m©h.h
"

27 
	~<¡ršg.h
>

28 
	~"decode_á8.h
"

29 
	~"di¥Ïy.h
"

30 
	~"loÿtÜ.h
"

32 
	~"Œaffic_mªag”.h
"

35 
	gYour_C®l
[] = "W5XXX";

36 
	gYour_LoÿtÜ
[] = "AA00";

38 
	g‹¡_¡©iÚ
[] = "W5BAA";

39 
	g‹¡_rg‘
[] = "W5ITU";

40 
	g‹¡_RSL
[] = "R-15";

42 
	gT¬g‘_C®l
[7];

43 
	gT¬g‘_LoÿtÜ
[5];

44 
	gT¬g‘_RSL
;

45 
	gCQ_T¬g‘_C®l
[7];

47 
	g»¶y_mes§ge
[18];

48 
	g»¶y_mes§ge_li¡
[18][8];

49 
	g»¶y_mes§ge_couÁ
;

50 
	gmes§ge
[18];

52 
log_æag
, 
loggšg_Ú
;

53 
time_t
 
g‘T“nsy3Time
();

55 
StiÚ_C®l
[];

56 
LoÿtÜ
[];

57 
	gá8_time_¡ršg
[] = "15:44:15";

59 
	gmax_di¥Ïyed_mes§ges
 = 8;

63 
	gmes§ge_¡©e
;

65 
	$£t_mes§ge
(
ušt16_t
 
šdex
) {

67 
big_guÍ
[60];

68 
ušt8_t
 
·cked
[
K_BYTES
];

69 
bÏnk
[] = " ";

70 
£v’ty_th»e
[] = "RR73";

71 
R•ly_S‹
[20];

73 
	`g‘T“nsy3Time
();

74 
¹c_¡ršg
[10];

75 
	`¥rštf
(
¹c_¡ršg
,"%2i:%2i:%2i",
	`hour
(),
	`mšu‹
(),
	`£cÚd
());

77 
	`¡rıy
(
mes§ge
, 
bÏnk
);

78 
	`ş—r_FT8_mes§ge
();

80  
šdex
 ){

82 0: 
	`¥rštf
(
mes§ge
,"% % %s", "CQ",
StiÚ_C®l
,
LoÿtÜ
);

86 1: 
	`¥rštf
(
mes§ge
,"% % %s", 
T¬g‘_C®l
,
StiÚ_C®l
,
LoÿtÜ
);

90 2: 
	`¥rštf
(
mes§ge
,"% % %3i", 
T¬g‘_C®l
,
StiÚ_C®l
,
T¬g‘_RSL
);

94 3: 
	`¥rštf
(
mes§ge
,"% % %3s", 
T¬g‘_C®l
,
StiÚ_C®l
,
£v’ty_th»e
);

99 
tá
.
	`£tTextCŞÜ
(
HX8357_WHITE
 , 
HX8357_BLACK
);

100 
tá
.
	`£tTextSize
(2);

101 
tá
.
	`£tCursÜ
(0, 260);

102 
tá
.
	`´št
(
mes§ge
);

104 
	`·ck77_1
(
mes§ge
, 
·cked
);

105 
	`g’á8
(
·cked
, 
tÚes
);

107 
mes§ge_¡©e
 = 1;

112 
	}
}

115 
	$ş—r_FT8_mes§ge
() {

117 
bÏnk
[] = " ";

119 
tá
.
	`£tTextCŞÜ
(
HX8357_YELLOW
 , 
HX8357_BLACK
);

120 
tá
.
	`£tTextSize
(2);

121 
tá
.
	`£tCursÜ
(0, 260);

122 
tá
.
	`´št
(
bÏnk
);

124 
mes§ge_¡©e
 = 0;

125 
	}
}

127 
	$ş—r_»¶y_mes§ge_box
() {

129 
tá
.
	`flReù
(0, 100, 400, 140, 
HX8357_BLACK
);

131 
	}
}

	@gen_ft8.h

8 #iâdeà
GEN_FT8_H_


9 
	#GEN_FT8_H_


	)

11 
	~"¬m_m©h.h
"

16 
ş—r_»¶y_mes§ge_box
();

18 
£t_»¶y
(
ušt16_t
 
šdex
);

19 
£t_cq
();

20 
£t_CQ_»¶y
();

22 
O³n_StiÚ_Fe
( );

23 
Wr™e_StiÚ_Fe
( );

24 
R—d_StiÚ_Fe
( );

25 
StiÚ_D©a_In™Ÿlize
();

27 
£t_mes§ge
(
ušt16_t
 
šdex
);

28 
ş—r_FT8_mes§ge
();

	@ldpc.cpp

19 
	~<¡dio.h
>

20 
	~<m©h.h
>

21 
	~<¡dlib.h
>

22 
	~"cÚ¡ªts.h
"

24 
ND
;

25 
NS
;

27 
NN
 ;

29 
N
;

30 
K
;

32 
M
;

34 
K_BYTES
;

36 
ldpc_check
(
ušt8_t
 
codewÜd
[]);

37 
ç¡_nh
(
x
);

38 
ç¡_©ªh
(
x
);

43 
	$·ck_b™s
(cÚ¡ 
ušt8_t
 
¶aš
[], 
num_b™s
, ušt8_ˆ
·cked
[]) {

44 
num_by‹s
 = (
num_b™s
 + 7) / 8;

45 
i
 = 0; i < 
num_by‹s
; ++i) {

46 
·cked
[
i
] = 0;

49 
ušt8_t
 
mask
 = 0x80;

50 
by‹_idx
 = 0;

51 
i
 = 0; i < 
num_b™s
; ++i) {

52 ià(
¶aš
[
i
]) {

53 
·cked
[
by‹_idx
] |ğ
mask
;

55 
mask
 >>= 1;

56 ià(!
mask
) {

57 
mask
 = 0x80;

58 ++
by‹_idx
;

61 
	}
}

68 
	$ldpc_decode
(
codewÜd
[], 
max_™”s
, 
ušt8_t
 
¶aš
[], *
ok
) {

69 
m
[
M
][
N
];

70 
e
[
M
][
N
];

71 
mš_”rÜs
 = 
M
;

73 
j
 = 0; j < 
M
; j++) {

74 
i
 = 0; i < 
N
; i++) {

75 
m
[
j
][
i
] = 
codewÜd
[i];

76 
e
[
j
][
i
] = 0.0f;

80 
™”
 = 0; i‹¸< 
max_™”s
; iter++) {

81 
j
 = 0; j < 
M
; j++) {

82 
ii1
 = 0; ii1 < 
kNrw
[
j
]; ii1++) {

83 
i1
 = 
kNm
[
j
][
ii1
] - 1;

84 
a
 = 1.0f;

85 
ii2
 = 0; ii2 < 
kNrw
[
j
]; ii2++) {

86 
i2
 = 
kNm
[
j
][
ii2
] - 1;

87 ià(
i2
 !ğ
i1
) {

88 
a
 *ğ
	`ç¡_nh
(-
m
[
j
][
i2
] / 2.0f);

91 
e
[
j
][
i1
] = 
	`logf
((1 - 
a
) / (1 +‡));

95 
i
 = 0; i < 
N
; i++) {

96 
l
 = 
codewÜd
[
i
];

97 
j
 = 0; j < 3; j++)

98 
l
 +ğ
e
[
kMn
[
i
][
j
] - 1][i];

99 
¶aš
[
i
] = (
l
 > 0) ? 1 : 0;

102 
”rÜs
 = 
	`ldpc_check
(
¶aš
);

104 ià(
”rÜs
 < 
mš_”rÜs
) {

106 
mš_”rÜs
 = 
”rÜs
;

108 ià(
”rÜs
 == 0) {

113 
i
 = 0; i < 
N
; i++) {

114 
ji1
 = 0; ji1 < 3; ji1++) {

115 
j1
 = 
kMn
[
i
][
ji1
] - 1;

116 
l
 = 
codewÜd
[
i
];

117 
ji2
 = 0; ji2 < 3; ji2++) {

118 ià(
ji1
 !ğ
ji2
) {

119 
j2
 = 
kMn
[
i
][
ji2
] - 1;

120 
l
 +ğ
e
[
j2
][
i
];

123 
m
[
j1
][
i
] = 
l
;

128 *
ok
 = 
mš_”rÜs
;

129 
	}
}

137 
	$ldpc_check
(
ušt8_t
 
codewÜd
[]) {

138 
”rÜs
 = 0;

140 
j
 = 0; j < 
M
; ++j) {

141 
ušt8_t
 
x
 = 0;

142 
i
 = 0; i < 
kNrw
[
j
]; ++i) {

143 
x
 ^ğ
codewÜd
[
kNm
[
j
][
i
] - 1];

145 ià(
x
 != 0) {

146 ++
”rÜs
;

149  
”rÜs
;

150 
	}
}

153 
	$bp_decode
(
codewÜd
[], 
max_™”s
, 
ušt8_t
 
¶aš
[], *
ok
) {

154 
tov
[
N
][3];

155 
toc
[
M
][7];

157 
mš_”rÜs
 = 
M
;

159 
nşa¡
 = 0;

160 
nút
 = 0;

163 
i
 = 0; i < 
M
; ++i) {

164 
j
 = 0; j < 
kNrw
[
i
]; ++j) {

165 
toc
[
i
][
j
] = 
codewÜd
[
kNm
[i][j] - 1];

169 
i
 = 0; i < 
N
; ++i) {

170 
j
 = 0; j < 3; ++j) {

171 
tov
[
i
][
j
] = 0;

175 
™”
 = 0; i‹¸< 
max_™”s
; ++iter) {

176 
zn
[
N
];

179 
i
 = 0; i < 
N
; ++i) {

180 
zn
[
i
] = 
codewÜd
[i] + 
tov
[i][0] +ov[i][1] +ov[i][2];

181 
¶aš
[
i
] = (
zn
[i] > 0) ? 1 : 0;

185 
”rÜs
 = 
	`ldpc_check
(
¶aš
);

187 ià(
”rÜs
 < 
mš_”rÜs
) {

189 
mš_”rÜs
 = 
”rÜs
;

191 ià(
”rÜs
 == 0) {

197 
i
 = 0; i < 
M
; ++i) {

198 
j
 = 0; j < 
kNrw
[
i
]; ++j) {

199 
ibj
 = 
kNm
[
i
][
j
] - 1;

200 
toc
[
i
][
j
] = 
zn
[
ibj
];

201 
kk
 = 0; kk < 3; ++kk) {

203 ià(
kMn
[
ibj
][
kk
] - 1 =ğ
i
) {

204 
toc
[
i
][
j
] -ğ
tov
[
ibj
][
kk
];

211 
i
 = 0; i < 
M
; ++i) {

212 
j
 = 0; j < 
kNrw
[
i
]; ++j) {

213 
toc
[
i
][
j
] = 
	`ç¡_nh
(-toc[i][j] / 2);

217 
i
 = 0; i < 
N
; ++i) {

218 
j
 = 0; j < 3; ++j) {

219 
ichk
 = 
kMn
[
i
][
j
] - 1;

220 
Tmn
 = 1.0f;

221 
k
 = 0; k < 
kNrw
[
ichk
]; ++k) {

222 ià(
kNm
[
ichk
][
k
] - 1 !ğ
i
) {

223 
Tmn
 *ğ
toc
[
ichk
][
k
];

226 
tov
[
i
][
j
] = 2 * 
	`ç¡_©ªh
(-
Tmn
);

231 *
ok
 = 
mš_”rÜs
;

232 
	}
}

241 
	$ç¡_nh
(
x
) {

242 ià(
x
 < -4.97f) {

245 ià(
x
 > 4.97f) {

248 
x2
 = 
x
 * x;

253 
a
 = 
x
 * (945.0à+ 
x2
 * (105.0f + x2));

254 
b
 = 945.0à+ 
x2
 * (420.0f + x2 * 15.0f);

255  
a
 / 
b
;

256 
	}
}

259 
	$ç¡_©ªh
(
x
) {

260 
x2
 = 
x
 * x;

265 
a
 = 
x
 * (945.0à+ 
x2
 * (-735.0f + x2 * 64.0f));

266 
b
 = (945.0à+ 
x2
 * (-1050.0f + x2 * 225.0f));

267  
a
 / 
b
;

268 
	}
}

271 
	$¶nh
(
x
) {

272 
isign
 = +1;

273 ià(
x
 < 0) {

274 
isign
 = -1;

275 
x
 = -x;

277 ià(
x
 < 0.8f) {

278  
isign
 * 0.83 * 
x
;

280 ià(
x
 < 1.6f) {

281  
isign
 * (0.322à* 
x
 + 0.4064f);

283 ià(
x
 < 3.0f) {

284  
isign
 * (0.0524à* 
x
 + 0.8378f);

286 ià(
x
 < 7.0f) {

287  
isign
 * (0.0012à* 
x
 + 0.9914f);

289  
isign
*0.9998f;

290 
	}
}

293 
	$¶©ªh
(
x
) {

294 
isign
 = +1;

295 ià(
x
 < 0) {

296 
isign
 = -1;

297 
x
 = -x;

299 ià(
x
 < 0.664f) {

300  
isign
 * 
x
 / 0.83f;

302 ià(
x
 < 0.9217f) {

303  
isign
 * (
x
 - 0.4064f) / 0.322f;

305 ià(
x
 < 0.9951f) {

306  
isign
 * (
x
 - 0.8378f) / 0.0524f;

308 ià(
x
 < 0.9998f) {

309  
isign
 * (
x
 - 0.9914f) / 0.0012f;

311  
isign
 * 7.0f;

312 
	}
}

	@ldpc.h

9 
ldpc_decode
(
codewÜd
[], 
max_™”s
, 
ušt8_t
 
¶aš
[], *
ok
);

11 
bp_decode
(
codewÜd
[], 
max_™”s
, 
ušt8_t
 
¶aš
[], *
ok
);

15 
·ck_b™s
(cÚ¡ 
ušt8_t
 
¶aš
[], 
num_b™s
, ušt8_ˆ
·cked
[]);

	@locator.cpp

8 
	~"loÿtÜ.h
"

9 
	~<m©h.h
>

10 
	~"¬m_m©h.h
"

12 cÚ¡ 
	gEARTH_RAD
 = 6371;

15 
´oûss_loÿtÜ
(
loÿtÜ
[]);

16 
di¡ªû
(
Ït1
, 
lÚ1
, 
Ït2
, 
lÚ2
);

17 
deg2¿d
(
deg
);

19 
	gL©™ude
, 
	gLÚg™ude
;

23 
	gStiÚ_L©™ude
, 
	gStiÚ_LÚg™ude
;

25 
	gT¬g‘_L©™ude
, 
	gT¬g‘_LÚg™ude
;

27 
T¬g‘_Di¡ªû
(
rg‘
[]);

30 
	$£t_StiÚ_CoÜdš©es
(
¡©iÚ
[]){

32 
	`´oûss_loÿtÜ
(
¡©iÚ
);

33 
StiÚ_L©™ude
 = 
L©™ude
;

34 
StiÚ_LÚg™ude
 = 
LÚg™ude
;

36 
	}
}

39 
	$T¬g‘_Di¡ªû
(
rg‘
[]) {

41 
T¬g‘_Di¡ªû
;

42 
	`´oûss_loÿtÜ
(
rg‘
);

43 
T¬g‘_L©™ude
 = 
L©™ude
;

44 
T¬g‘_LÚg™ude
 = 
LÚg™ude
;

46 
T¬g‘_Di¡ªû
 = (è
	`di¡ªû
(()
StiÚ_L©™ude
,()
StiÚ_LÚg™ude
,()
T¬g‘_L©™ude
,()
T¬g‘_LÚg™ude
);

49  
T¬g‘_Di¡ªû
;

50 
	}
}

52 
	$´oûss_loÿtÜ
(
loÿtÜ
[]) {

54 
ušt8_t
 
A1
, 
A2
, 
N1
, 
N2
;

55 
ušt8_t
 
A1_v®ue
, 
A2_v®ue
, 
N1_v®ue
, 
N2_v®ue
;

56 
L©™ude_1
, 
L©™ude_2
, 
L©™ude_3
;

57 
LÚg™ude_1
, 
LÚg™ude_2
, 
LÚg™ude_3
;

59 
A1
 = 
loÿtÜ
[0];

60 
A2
 = 
loÿtÜ
[1];

61 
N1
 = 
loÿtÜ
[2];

62 
N2
ğ
loÿtÜ
 [3];

64 
A1_v®ue
 = 
A1
-65;

65 
A2_v®ue
 = 
A2
-65;

66 
N1_v®ue
 = 
N1
- 48;

67 
N2_v®ue
 = 
N2
 - 48;

69 
L©™ude_1
 = (è
A2_v®ue
 * 10;

70 
L©™ude_2
 = (è
N2_v®ue
;

71 
L©™ude_3
 = (11.0/24.0 + 1.0/48.0) - 90.0;

72 
L©™ude
 = 
L©™ude_1
 + 
L©™ude_2
 + 
L©™ude_3
;

74 
LÚg™ude_1
 = ()
A1_v®ue
 * 20.0;

75 
LÚg™ude_2
 = ()
N1_v®ue
 * 2.0;

76 
LÚg™ude_3
 = 11.0/12.0 + 1.0/24.0;

77 
LÚg™ude
 = 
LÚg™ude_1
 + 
LÚg™ude_2
 + 
LÚg™ude_3
 - 180.0;

79 
	}
}

83 
	$di¡ªû
(
Ït1
, 
lÚ1
, 
Ït2
, 
lÚ2
) {

84 
Ït1r
 = 
	`deg2¿d
(
Ït1
);

85 
lÚ1r
 = 
	`deg2¿d
(
lÚ1
);

86 
Ït2r
 = 
	`deg2¿d
(
Ït2
);

87 
lÚ2r
 = 
	`deg2¿d
(
lÚ2
);

88  
	`acos
(
	`sš
(
Ït1r
è* sš(
Ït2r
)+
	`cos
Ö©1rè* cosÖ©2rè* cos(
lÚ2r
-
lÚ1r
)è* 
EARTH_RAD
;

89 
	}
}

93 
	$deg2¿d
(
deg
)

95  
deg
 * (
PI
 / 180.0);

96 
	}
}

	@locator.h

8 #iâdeà
LOCATOR_H_


9 
	#LOCATOR_H_


	)

12 
£t_StiÚ_CoÜdš©es
(
¡©iÚ
[]);

	@pack.cpp

8 
	~"·ck.h
"

10 
	~"‹xt.h
"

12 
	~<¡dšt.h
>

13 
	~<¡ršg.h
>

14 
	~<¡dio.h
>

19 cÚ¡ 
	gA0
[] = " 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ+-./?";

20 cÚ¡ 
	gA1
[] = " 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";

21 cÚ¡ 
	gA2
[] = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";

22 cÚ¡ 
	gA3
[] = "0123456789";

23 cÚ¡ 
	gA4
[] = " ABCDEFGHIJKLMNOPQRSTUVWXYZ";

28 
št32_t
 
	$·ck28
(cÚ¡ *
ÿÎsign
) {

32 
št32_t
 
NTOKENS
 = 2063592L;

33 
št32_t
 
MAX22
 = 4194304L;

36 ià(
	`¡¬ts_w™h
(
ÿÎsign
, "DE "))  0;

37 ià(
	`¡¬ts_w™h
(
ÿÎsign
, "QRZ "))  1;

38 ià(
	`¡¬ts_w™h
(
ÿÎsign
, "CQ "))  2;

40 ià(
	`¡¬ts_w™h
(
ÿÎsign
, "CQ_")) {

41 
Âum
 = 0, 
Æ‘
 = 0;

53 
c6
[6] = {' ', ' ', ' ', ' ', ' ', ' '};

55 
Ëngth
 = 0;

56 
ÿÎsign
[
Ëngth
] != ' ' && callsign[length] != 0) {

57 
Ëngth
++;

61 ià(
	`¡¬ts_w™h
(
ÿÎsign
, "3DA0"è&& 
Ëngth
 <= 7) {

63 
	`memıy
(
c6
, "3D0", 3);

64 
	`memıy
(
c6
 + 3, 
ÿÎsign
 + 4, 
Ëngth
 - 4);

66 ià(
	`¡¬ts_w™h
(
ÿÎsign
, "3X"è&& 
	`is_Ë‰”
(ÿÎsign[2]è&& 
Ëngth
 <= 7) {

68 
	`memıy
(
c6
, "Q", 1);

69 
	`memıy
(
c6
 + 1, 
ÿÎsign
 + 2, 
Ëngth
 - 2);

72 ià(
	`is_dig™
(
ÿÎsign
[2]è&& 
Ëngth
 <= 6) {

74 
	`memıy
(
c6
, 
ÿÎsign
, 
Ëngth
);

76 ià(
	`is_dig™
(
ÿÎsign
[1]è&& 
Ëngth
 <= 5) {

78 
	`memıy
(
c6
 + 1, 
ÿÎsign
, 
Ëngth
);

83 
i0
, 
i1
, 
i2
, 
i3
, 
i4
, 
i5
;

84 ià((
i0
 = 
	`ch¬_šdex
(
A1
, 
c6
[0])è>ğ0 && (
i1
 = ch¬_šdex(
A2
, c6[1])) >= 0 &&

85 (
i2
 = 
	`ch¬_šdex
(
A3
, 
c6
[2])è>ğ0 && (
i3
 = ch¬_šdex(
A4
, c6[3])) >= 0 &&

86 (
i4
 = 
	`ch¬_šdex
(
A4
, 
c6
[4])è>ğ0 && (
i5
 = char_index(A4, c6[5])) >= 0)

90 
št32_t
 
n28
 = 
i0
;

91 
n28
 =‚28 * 36 + 
i1
;

92 
n28
 =‚28 * 10 + 
i2
;

93 
n28
 =‚28 * 27 + 
i3
;

94 
n28
 =‚28 * 27 + 
i4
;

95 
n28
 =‚28 * 27 + 
i5
;

97  
NTOKENS
 + 
MAX22
 + 
n28
;

111 
	}
}

119 
boŞ
 
	$chkÿÎ
(cÚ¡ *
ÿÎ
, *
bc
) {

120 
Ëngth
 = 
	`¡¾’
(
ÿÎ
);

121 ià(
Ëngth
 > 11è 
çl£
;

122 ià(0 !ğ
	`¡rchr
(
ÿÎ
, '.')è 
çl£
;

123 ià(0 !ğ
	`¡rchr
(
ÿÎ
, '+')è 
çl£
;

124 ià(0 !ğ
	`¡rchr
(
ÿÎ
, '-')è 
çl£
;

125 ià(0 !ğ
	`¡rchr
(
ÿÎ
, '?')è 
çl£
;

126 ià(
Ëngth
 > 6 && 0 !ğ
	`¡rchr
(
ÿÎ
, '/')è 
çl£
;

136  
Œue
;

137 
	}
}

140 
ušt16_t
 
	$·ckgrid
(cÚ¡ *
grid4
) {

142 
ušt16_t
 
MAXGRID4
 = 32400;

144 ià(
grid4
 == 0) {

146  
MAXGRID4
 + 1;

150 ià(
	`equ®s
(
grid4
, "RRR")è 
MAXGRID4
 + 2;

151 ià(
	`equ®s
(
grid4
, "RR73")è 
MAXGRID4
 + 3;

152 ià(
	`equ®s
(
grid4
, "73")è 
MAXGRID4
 + 4;

155 ià(
	`š_¿nge
(
grid4
[0], 'A', 'R') &&

156 
	`š_¿nge
(
grid4
[1], 'A', 'R') &&

157 
	`is_dig™
(
grid4
[2]) && is_digit(grid4[3]))

160 
ušt16_t
 
igrid4
 = (
grid4
[0] - 'A');

161 
igrid4
 = igrid4 * 18 + (
grid4
[1] - 'A');

162 
igrid4
 = igrid4 * 10 + (
grid4
[2] - '0');

163 
igrid4
 = igrid4 * 10 + (
grid4
[3] - '0');

164  
igrid4
;

169 ià(
grid4
[0] == 'R') {

170 
dd
 = 
	`dd_to_št
(
grid4
 + 1, 3);

171 
ušt16_t
 
œ±
 = 35 + 
dd
;

172  (
MAXGRID4
 + 
œ±
) | 0x8000;

175 
dd
 = 
	`dd_to_št
(
grid4
, 3);

176 
ušt16_t
 
œ±
 = 35 + 
dd
;

177  (
MAXGRID4
 + 
œ±
);

180  
MAXGRID4
 + 1;

181 
	}
}

184 
	$·ck77_1
(cÚ¡ *
msg
, 
ušt8_t
 *
b77
) {

186 cÚ¡ *
s1
 = 
	`¡rchr
(
msg
, ' ');

187 ià(
s1
 == 0)  -1;

189 cÚ¡ *
ÿÎ1
 = 
msg
;

190 cÚ¡ *
ÿÎ2
 = 
s1
 + 1;

192 
št32_t
 
n28a
 = 
	`·ck28
(
ÿÎ1
);

193 
št32_t
 
n28b
 = 
	`·ck28
(
ÿÎ2
);

195 ià(
n28a
 < 0 || 
n28b
 < 0)  -1;

197 
ušt16_t
 
igrid4
;

200 cÚ¡ *
s2
 = 
	`¡rchr
(
s1
 + 1, ' ');

201 ià(
s2
 != 0) {

202 
igrid4
 = 
	`·ckgrid
(
s2
 + 1);

206 
igrid4
 = 
	`·ckgrid
(0);

209 
ušt8_t
 
i3
 = 1;

217 
n28a
 <<= 1;

218 
n28b
 <<= 1;

224 
b77
[0] = (
n28a
 >> 21);

225 
b77
[1] = (
n28a
 >> 13);

226 
b77
[2] = (
n28a
 >> 5);

227 
b77
[3] = (
ušt8_t
)(
n28a
 << 3è| (ušt8_t)(
n28b
 >> 26);

228 
b77
[4] = (
n28b
 >> 18);

229 
b77
[5] = (
n28b
 >> 10);

230 
b77
[6] = (
n28b
 >> 2);

231 
b77
[7] = (
ušt8_t
)(
n28b
 << 6è| (ušt8_t)(
igrid4
 >> 10);

232 
b77
[8] = (
igrid4
 >> 2);

233 
b77
[9] = (
ušt8_t
)(
igrid4
 << 6è| (ušt8_t)(
i3
 << 3);

236 
	}
}

239 
	$·ck‹xt77
(cÚ¡ *
‹xt
, 
ušt8_t
 *
b77
) {

240 
Ëngth
 = 
	`¡¾’
(
‹xt
);

243 *
‹xt
 == ' ' && *text != 0) {

244 ++
‹xt
;

245 --
Ëngth
;

247 
Ëngth
 > 0 && 
‹xt
[length - 1] == ' ') {

248 --
Ëngth
;

252 
i
 = 0; i < 9; ++i) {

253 
b77
[
i
] = 0;

258 
j
 = 0; j < 13; ++j) {

260 
ušt16_t
 
x
 = 0;

261 
i
 = 8; i >= 0; --i) {

262 
x
 +ğ
b77
[
i
] * (
ušt16_t
)42;

263 
b77
[
i
] = (
x
 & 0xFF);

264 
x
 >>= 8;

268 ià(
j
 < 
Ëngth
) {

269 
q
 = 
	`ch¬_šdex
(
A0
, 
‹xt
[
j
]);

270 
x
 = (
q
 > 0) ? q : 0;

273 
x
 = 0;

277 
x
 <<= 1;

280 
i
 = 8; i >= 0; --i) {

281 ià(
x
 == 0) ;

282 
x
 +ğ
b77
[
i
];

283 
b77
[
i
] = (
x
 & 0xFF);

284 
x
 >>= 8;

289 
b77
[8] &= 0xFE;

290 
b77
[9] &= 0x00;

291 
	}
}

294 
	$·ck77
(cÚ¡ *
msg
, 
ušt8_t
 *
c77
) {

296 ià(0 =ğ
	`·ck77_1
(
msg
, 
c77
)) {

309 
	`·ck‹xt77
(
msg
, 
c77
);

311 
	}
}

315 #ifdeà
UNIT_TEST


317 
	~<io¡»am
>

319 
usšg
 
Çme¥aû
 
	g¡d
;

321 
boŞ
 
	$‹¡1
() {

322 cÚ¡ *
šputs
[] = {

336 
i
 = 0; 
šputs
[i]; ++i) {

337 
št32_t
 
»suÉ
 = 
á8_v2
::
	`·ck28
(
šputs
[
i
]);

338 
	`´štf
("·ck28(\"%s\"èğ%d\n", 
šputs
[
i
], 
»suÉ
);

341  
Œue
;

342 
	}
}

344 
boŞ
 
	$‹¡2
() {

345 cÚ¡ *
šputs
[] = {

355 
i
 = 0; 
šputs
[i]; ++i) {

356 
ušt8_t
 
»suÉ
[10];

357 
rc
 = 
á8_v2
::
	`·ck77_1
(
šputs
[
i
], 
»suÉ
);

358 
	`´štf
("·ck77_1(\"%s\"èğ%d\t[", 
šputs
[
i
], 
rc
);

359 
j
 = 0; j < 10; ++j) {

360 
	`´štf
("%02x ", 
»suÉ
[
j
]);

362 
	`´štf
("]\n");

365  
Œue
;

366 
	}
}

368 
	$maš
() {

369 
	`‹¡1
();

370 
	`‹¡2
();

372 
	}
}

	@pack.h

3 
	~<¡dšt.h
>

10 
·ck77
(cÚ¡ *
msg
, 
ušt8_t
 *
c77
);

11 
·ck‹xt77
(cÚ¡ *
‹xt
, 
ušt8_t
 *
b77
);

12 
·ck77_1
(cÚ¡ *
msg
, 
ušt8_t
 *
b77
);

	@patch_full.h

22 cÚ¡ 
PROGMEM
 
ušt8_t
 
	gssb_·tch_cÚ‹Á
[] =

	@pins.h

18 
	#PIN_CS
 10

	)

19 
	#PIN_DC
 9

	)

20 
	#PIN_RST
 8

	)

21 
	#PIN_MOSI
 11

	)

22 
	#PIN_DCLK
 13

23 
	#PIN_MISO
 12

	)

26 
	#PIN_SCL
 19

	)

27 
	#PIN_SDA
 18

	)

30 
	#PIN_RESET
 20

	)

33 
	#PIN_PTT
 14

34 
	#PIN_RCV
 15

35 

	)

37 
	#PIN_YP
 38

38 
	#PIN_XM
 37

39 
	#PIN_YM
 36

40 
	#PIN_XP
 39

41 

	)

43 
	#PIN_GPSTX
 0

44 
	#PIN_GPSRX
 1

45 

	)

	@si5351.cpp

25 
	~<¡dšt.h
>

27 
	~"Ardušo.h
"

28 
	~"Wœe.h
"

29 
	~"si5351.h
"

36 
	gSi5351
::
	$Si5351
(
ušt8_t
 
i2c_addr
):

37 
	$i2c_bus_addr
(
i2c_addr
)

39 
xl_äeq
[0] = 
SI5351_XTAL_FREQ
;

42 
¶Ï_»f_osc
 = 
SI5351_PLL_INPUT_XO
;

43 
¶lb_»f_osc
 = 
SI5351_PLL_INPUT_XO
;

44 
şkš_div
 = 
SI5351_CLKIN_DIV_1
;

45 
	}
}

63 
boŞ
 
	gSi5351
::
	$š™
(
ušt8_t
 
xl_lßd_c
, 
ušt32_t
 
xo_äeq
, 
št32_t
 
cÜr
)

66 
Wœe
.
	`begš
();

69 
Wœe
.
	`begšT¿nsmissiÚ
(
i2c_bus_addr
);

70 
ušt8_t
 
»g_v®
;

71 
»g_v®
 = 
Wœe
.
	`’dT¿nsmissiÚ
();

73 if(
»g_v®
 == 0)

76 
ušt8_t
 
¡©us_»g
 = 0;

79 
¡©us_»g
 = 
	`si5351_»ad
(
SI5351_DEVICE_STATUS
);

80 } 
¡©us_»g
 >> 7 == 1);

83 
	`si5351_wr™e
(
SI5351_CRYSTAL_LOAD
, (
xl_lßd_c
 & 
SI5351_CRYSTAL_LOAD_MASK
) | 0b00010010);

86 ià(
xo_äeq
 != 0)

88 
	`£t_»f_äeq
(
xo_äeq
, 
SI5351_PLL_INPUT_XO
);

89 
	`£t_»f_äeq
(
xo_äeq
, 
SI5351_PLL_INPUT_CLKIN
);

93 
	`£t_»f_äeq
(
SI5351_XTAL_FREQ
, 
SI5351_PLL_INPUT_XO
);

94 
	`£t_»f_äeq
(
SI5351_XTAL_FREQ
, 
SI5351_PLL_INPUT_CLKIN
);

98 
	`£t_cÜ»ùiÚ
(
cÜr
, 
SI5351_PLL_INPUT_XO
);

99 
	`£t_cÜ»ùiÚ
(
cÜr
, 
SI5351_PLL_INPUT_CLKIN
);

101 
	`»£t
();

103  
Œue
;

107  
çl£
;

109 
	}
}

117 
	gSi5351
::
	$»£t
()

121 
	`si5351_wr™e
(16, 0x80);

122 
	`si5351_wr™e
(17, 0x80);

123 
	`si5351_wr™e
(18, 0x80);

124 
	`si5351_wr™e
(19, 0x80);

125 
	`si5351_wr™e
(20, 0x80);

126 
	`si5351_wr™e
(21, 0x80);

127 
	`si5351_wr™e
(22, 0x80);

128 
	`si5351_wr™e
(23, 0x80);

131 
	`si5351_wr™e
(16, 0x0c);

132 
	`si5351_wr™e
(17, 0x0c);

133 
	`si5351_wr™e
(18, 0x0c);

134 
	`si5351_wr™e
(19, 0x0c);

135 
	`si5351_wr™e
(20, 0x0c);

136 
	`si5351_wr™e
(21, 0x0c);

137 
	`si5351_wr™e
(22, 0x0c);

138 
	`si5351_wr™e
(23, 0x0c);

141 
	`£t_¶l
(
SI5351_PLL_FIXED
, 
SI5351_PLLA
);

142 
	`£t_¶l
(
SI5351_PLL_FIXED
, 
SI5351_PLLB
);

145 
¶l_assignm’t
[0] = 
SI5351_PLLA
;

146 
¶l_assignm’t
[1] = 
SI5351_PLLA
;

147 
¶l_assignm’t
[2] = 
SI5351_PLLA
;

148 
¶l_assignm’t
[3] = 
SI5351_PLLA
;

149 
¶l_assignm’t
[4] = 
SI5351_PLLA
;

150 
¶l_assignm’t
[5] = 
SI5351_PLLA
;

151 
¶l_assignm’t
[6] = 
SI5351_PLLB
;

152 
¶l_assignm’t
[7] = 
SI5351_PLLB
;

154 
	`£t_ms_sourû
(
SI5351_CLK0
, 
SI5351_PLLA
);

155 
	`£t_ms_sourû
(
SI5351_CLK1
, 
SI5351_PLLA
);

156 
	`£t_ms_sourû
(
SI5351_CLK2
, 
SI5351_PLLA
);

157 
	`£t_ms_sourû
(
SI5351_CLK3
, 
SI5351_PLLA
);

158 
	`£t_ms_sourû
(
SI5351_CLK4
, 
SI5351_PLLA
);

159 
	`£t_ms_sourû
(
SI5351_CLK5
, 
SI5351_PLLA
);

160 
	`£t_ms_sourû
(
SI5351_CLK6
, 
SI5351_PLLB
);

161 
	`£t_ms_sourû
(
SI5351_CLK7
, 
SI5351_PLLB
);

164 
	`si5351_wr™e
(
SI5351_VXCO_PARAMETERS_LOW
, 0);

165 
	`si5351_wr™e
(
SI5351_VXCO_PARAMETERS_MID
, 0);

166 
	`si5351_wr™e
(
SI5351_VXCO_PARAMETERS_HIGH
, 0);

169 
	`¶l_»£t
(
SI5351_PLLA
);

170 
	`¶l_»£t
(
SI5351_PLLB
);

173 
ušt8_t
 
i
;

174 
i
 = 0; i < 8; i++)

176 
şk_äeq
[
i
] = 0;

177 
	`ouut_’abË
((
si5351_şock
)
i
, 0);

178 
şk_fœ¡_£t
[
i
] = 
çl£
;

180 
	}
}

192 
ušt8_t
 
	gSi5351
::
	$£t_äeq
(
ušt64_t
 
äeq
, 
si5351_şock
 
şk
)

194 
Si5351RegS‘
 
ms_»g
;

195 
ušt64_t
 
¶l_äeq
;

196 
ušt8_t
 
št_mode
 = 0;

197 
ušt8_t
 
div_by_4
 = 0;

198 
ušt8_t
 
r_div
 = 0;

201 if((
ušt8_t
)
şk
 <ğ(ušt8_t)
SI5351_CLK5
)

207 if(
äeq
 > 0 && f»q < 
SI5351_CLKOUT_MIN_FREQ
 * 
SI5351_FREQ_MULT
)

209 
äeq
 = 
SI5351_CLKOUT_MIN_FREQ
 * 
SI5351_FREQ_MULT
;

213 if(
äeq
 > 
SI5351_MULTISYNTH_MAX_FREQ
 * 
SI5351_FREQ_MULT
)

215 
äeq
 = 
SI5351_MULTISYNTH_MAX_FREQ
 * 
SI5351_FREQ_MULT
;

221 if(
äeq
 > (
SI5351_MULTISYNTH_SHARE_MAX
 * 
SI5351_FREQ_MULT
))

224 
ušt8_t
 
i
;

225 
i
 = 0; i < 6; i++)

227 if(
şk_äeq
[
i
] > (
SI5351_MULTISYNTH_SHARE_MAX
 * 
SI5351_FREQ_MULT
))

229 if(
i
 !ğ(
ušt8_t
)
şk
 && 
¶l_assignm’t
[i] ==…ll_assignment[clk])

237 if(
şk_fœ¡_£t
[(
ušt8_t
)
şk
] =ğ
çl£
)

239 
	`ouut_’abË
(
şk
, 1);

240 
şk_fœ¡_£t
[(
ušt8_t
)
şk
] = 
Œue
;

244 
şk_äeq
[(
ušt8_t
)
şk
] = 
äeq
;

247 
¶l_äeq
 = 
	`muÉisyÁh_ÿlc
(
äeq
, 0, &
ms_»g
);

250 
	`£t_¶l
(
¶l_äeq
, 
¶l_assignm’t
[
şk
]);

253 
i
 = 0; i < 6; i++)

255 if(
şk_äeq
[
i
] != 0)

257 if(
¶l_assignm’t
[
i
] =ğ¶l_assignm’t[
şk
])

259 
Si5351RegS‘
 
‹mp_»g
;

260 
ušt64_t
 
‹mp_äeq
;

263 
‹mp_äeq
 = 
şk_äeq
[
i
];

264 
r_div
 = 
	`£Ëù_r_div
(&
‹mp_äeq
);

266 
	`muÉisyÁh_ÿlc
(
‹mp_äeq
, 
¶l_äeq
, &
‹mp_»g
);

269 if(
‹mp_äeq
 >ğ
SI5351_MULTISYNTH_DIVBY4_FREQ
 * 
SI5351_FREQ_MULT
)

271 
div_by_4
 = 1;

272 
št_mode
 = 1;

276 
div_by_4
 = 0;

277 
št_mode
 = 0;

281 
	`£t_ms
((
si5351_şock
)
i
, 
‹mp_»g
, 
št_mode
, 
r_div
, 
div_by_4
);

287 
	`¶l_»£t
(
¶l_assignm’t
[
şk
]);

291 
şk_äeq
[(
ušt8_t
)
şk
] = 
äeq
;

294 if(
şk_fœ¡_£t
[(
ušt8_t
)
şk
] =ğ
çl£
)

296 
	`ouut_’abË
(
şk
, 1);

297 
şk_fœ¡_£t
[(
ušt8_t
)
şk
] = 
Œue
;

301 
r_div
 = 
	`£Ëù_r_div
(&
äeq
);

304 if(
¶l_assignm’t
[
şk
] =ğ
SI5351_PLLA
)

306 
	`muÉisyÁh_ÿlc
(
äeq
, 
¶Ï_äeq
, &
ms_»g
);

310 
	`muÉisyÁh_ÿlc
(
äeq
, 
¶lb_äeq
, &
ms_»g
);

314 
	`£t_ms
(
şk
, 
ms_»g
, 
št_mode
, 
r_div
, 
div_by_4
);

328 if(
äeq
 > 0 && f»q < 
SI5351_CLKOUT67_MIN_FREQ
 * 
SI5351_FREQ_MULT
)

330 
äeq
 = 
SI5351_CLKOUT_MIN_FREQ
 * 
SI5351_FREQ_MULT
;

334 if(
äeq
 >ğ
SI5351_MULTISYNTH_DIVBY4_FREQ
 * 
SI5351_FREQ_MULT
)

336 
äeq
 = 
SI5351_MULTISYNTH_DIVBY4_FREQ
 * 
SI5351_FREQ_MULT
 - 1;

342 if(
şk
 =ğ
SI5351_CLK6
)

344 if(
şk_äeq
[7] != 0)

346 if(
¶lb_äeq
 % 
äeq
 == 0)

348 if((
¶lb_äeq
 / 
äeq
) % 2 != 0)

356 
şk_äeq
[(
ušt8_t
)
şk
] = 
äeq
;

359 
r_div
 = 
	`£Ëù_r_div_ms67
(&
äeq
);

361 
	`muÉisyÁh67_ÿlc
(
äeq
, 
¶lb_äeq
, &
ms_»g
);

375 
şk_äeq
[(
ušt8_t
)
şk
] = 
äeq
;

378 
r_div
 = 
	`£Ëù_r_div_ms67
(&
äeq
);

380 
¶l_äeq
 = 
	`muÉisyÁh67_ÿlc
(
äeq
, 0, &
ms_»g
);

382 
	`£t_¶l
(
¶l_äeq
, 
SI5351_PLLB
);

387 if(
şk_äeq
[6] != 0)

389 if(
¶lb_äeq
 % 
äeq
 == 0)

391 if((
¶lb_äeq
 / 
äeq
) % 2 != 0)

399 
şk_äeq
[(
ušt8_t
)
şk
] = 
äeq
;

402 
r_div
 = 
	`£Ëù_r_div_ms67
(&
äeq
);

404 
	`muÉisyÁh67_ÿlc
(
äeq
, 
¶lb_äeq
, &
ms_»g
);

418 
şk_äeq
[(
ušt8_t
)
şk
] = 
äeq
;

421 
r_div
 = 
	`£Ëù_r_div_ms67
(&
äeq
);

423 
¶l_äeq
 = 
	`muÉisyÁh67_ÿlc
(
äeq
, 0, &
ms_»g
);

425 
	`£t_¶l
(
¶l_äeq
, 
¶l_assignm’t
[
şk
]);

429 
div_by_4
 = 0;

430 
št_mode
 = 0;

433 
	`£t_ms
(
şk
, 
ms_»g
, 
št_mode
, 
r_div
, 
div_by_4
);

437 
	}
}

454 
ušt8_t
 
	gSi5351
::
	$£t_äeq_mªu®
(
ušt64_t
 
äeq
, ušt64_ˆ
¶l_äeq
, 
si5351_şock
 
şk
)

456 
Si5351RegS‘
 
ms_»g
;

457 
ušt8_t
 
št_mode
 = 0;

458 
ušt8_t
 
div_by_4
 = 0;

461 if(
äeq
 > 0 && f»q < 
SI5351_CLKOUT_MIN_FREQ
 * 
SI5351_FREQ_MULT
)

463 
äeq
 = 
SI5351_CLKOUT_MIN_FREQ
 * 
SI5351_FREQ_MULT
;

467 if(
äeq
 > 
SI5351_CLKOUT_MAX_FREQ
 * 
SI5351_FREQ_MULT
)

469 
äeq
 = 
SI5351_CLKOUT_MAX_FREQ
 * 
SI5351_FREQ_MULT
;

472 
ušt8_t
 
r_div
;

474 
şk_äeq
[(
ušt8_t
)
şk
] = 
äeq
;

476 
	`£t_¶l
(
¶l_äeq
, 
¶l_assignm’t
[
şk
]);

479 
	`ouut_’abË
(
şk
, 1);

482 
r_div
 = 
	`£Ëù_r_div
(&
äeq
);

485 
	`muÉisyÁh_ÿlc
(
äeq
, 
¶l_äeq
, &
ms_»g
);

488 if(
äeq
 >ğ
SI5351_MULTISYNTH_DIVBY4_FREQ
 * 
SI5351_FREQ_MULT
)

490 
div_by_4
 = 1;

491 
št_mode
 = 1;

495 
	`£t_ms
(
şk
, 
ms_»g
, 
št_mode
, 
r_div
, 
div_by_4
);

498 
	}
}

509 
	gSi5351
::
	$£t_¶l
(
ušt64_t
 
¶l_äeq
, 
si5351_¶l
 
rg‘_¶l
)

511 
Si5351RegS‘
 
¶l_»g
;

513 if(
rg‘_¶l
 =ğ
SI5351_PLLA
)

515 
	`¶l_ÿlc
(
SI5351_PLLA
, 
¶l_äeq
, &
¶l_»g
, 
»f_cÜ»ùiÚ
[
¶Ï_»f_osc
], 0);

519 
	`¶l_ÿlc
(
SI5351_PLLB
, 
¶l_äeq
, &
¶l_»g
, 
»f_cÜ»ùiÚ
[
¶lb_»f_osc
], 0);

525 
ušt8_t
 *
·¿ms
 = 
Ãw
 uint8_t[20];

526 
ušt8_t
 
i
 = 0;

527 
ušt8_t
 
‹mp
;

530 
‹mp
 = ((
¶l_»g
.
p3
 >> 8) & 0xFF);

531 
·¿ms
[
i
++] = 
‹mp
;

533 
‹mp
 = (
ušt8_t
)(
¶l_»g
.
p3
 & 0xFF);

534 
·¿ms
[
i
++] = 
‹mp
;

537 
‹mp
 = (
ušt8_t
)((
¶l_»g
.
p1
 >> 16) & 0x03);

538 
·¿ms
[
i
++] = 
‹mp
;

541 
‹mp
 = (
ušt8_t
)((
¶l_»g
.
p1
 >> 8) & 0xFF);

542 
·¿ms
[
i
++] = 
‹mp
;

544 
‹mp
 = (
ušt8_t
)(
¶l_»g
.
p1
 & 0xFF);

545 
·¿ms
[
i
++] = 
‹mp
;

548 
‹mp
 = (
ušt8_t
)((
¶l_»g
.
p3
 >> 12) & 0xF0);

549 
‹mp
 +ğ(
ušt8_t
)((
¶l_»g
.
p2
 >> 16) & 0x0F);

550 
·¿ms
[
i
++] = 
‹mp
;

553 
‹mp
 = (
ušt8_t
)((
¶l_»g
.
p2
 >> 8) & 0xFF);

554 
·¿ms
[
i
++] = 
‹mp
;

556 
‹mp
 = (
ušt8_t
)(
¶l_»g
.
p2
 & 0xFF);

557 
·¿ms
[
i
++] = 
‹mp
;

560 if(
rg‘_¶l
 =ğ
SI5351_PLLA
)

562 
	`si5351_wr™e_bulk
(
SI5351_PLLA_PARAMETERS
, 
i
, 
·¿ms
);

563 
¶Ï_äeq
 = 
¶l_äeq
;

565 if(
rg‘_¶l
 =ğ
SI5351_PLLB
)

567 
	`si5351_wr™e_bulk
(
SI5351_PLLB_PARAMETERS
, 
i
, 
·¿ms
);

568 
¶lb_äeq
 = 
¶l_äeq
;

571 
d–‘e
 
·¿ms
;

572 
	}
}

587 
	gSi5351
::
	$£t_ms
(
si5351_şock
 
şk
, 
Si5351RegS‘
 
ms_»g
, 
ušt8_t
 
št_mode
, ušt8_ˆ
r_div
, ušt8_ˆ
div_by_4
)

589 
ušt8_t
 *
·¿ms
 = 
Ãw
 uint8_t[20];

590 
ušt8_t
 
i
 = 0;

591 
ušt8_t
 
‹mp
;

592 
ušt8_t
 
»g_v®
;

595 if((
ušt8_t
)
şk
 <ğ(ušt8_t)
SI5351_CLK5
)

598 
‹mp
 = (
ušt8_t
)((
ms_»g
.
p3
 >> 8) & 0xFF);

599 
·¿ms
[
i
++] = 
‹mp
;

601 
‹mp
 = (
ušt8_t
)(
ms_»g
.
p3
 & 0xFF);

602 
·¿ms
[
i
++] = 
‹mp
;

605 
»g_v®
 = 
	`si5351_»ad
((
SI5351_CLK0_PARAMETERS
 + 2è+ (
şk
 * 8));

606 
»g_v®
 &= ~(0x03);

607 
‹mp
 = 
»g_v®
 | ((
ušt8_t
)((
ms_»g
.
p1
 >> 16) & 0x03));

608 
·¿ms
[
i
++] = 
‹mp
;

611 
‹mp
 = (
ušt8_t
)((
ms_»g
.
p1
 >> 8) & 0xFF);

612 
·¿ms
[
i
++] = 
‹mp
;

614 
‹mp
 = (
ušt8_t
)(
ms_»g
.
p1
 & 0xFF);

615 
·¿ms
[
i
++] = 
‹mp
;

618 
‹mp
 = (
ušt8_t
)((
ms_»g
.
p3
 >> 12) & 0xF0);

619 
‹mp
 +ğ(
ušt8_t
)((
ms_»g
.
p2
 >> 16) & 0x0F);

620 
·¿ms
[
i
++] = 
‹mp
;

623 
‹mp
 = (
ušt8_t
)((
ms_»g
.
p2
 >> 8) & 0xFF);

624 
·¿ms
[
i
++] = 
‹mp
;

626 
‹mp
 = (
ušt8_t
)(
ms_»g
.
p2
 & 0xFF);

627 
·¿ms
[
i
++] = 
‹mp
;

632 
‹mp
 = 
ms_»g
.
p1
;

636 
şk
)

638 
SI5351_CLK0
:

639 
	`si5351_wr™e_bulk
(
SI5351_CLK0_PARAMETERS
, 
i
, 
·¿ms
);

640 
	`£t_št
(
şk
, 
št_mode
);

641 
	`ms_div
(
şk
, 
r_div
, 
div_by_4
);

643 
SI5351_CLK1
:

644 
	`si5351_wr™e_bulk
(
SI5351_CLK1_PARAMETERS
, 
i
, 
·¿ms
);

645 
	`£t_št
(
şk
, 
št_mode
);

646 
	`ms_div
(
şk
, 
r_div
, 
div_by_4
);

648 
SI5351_CLK2
:

649 
	`si5351_wr™e_bulk
(
SI5351_CLK2_PARAMETERS
, 
i
, 
·¿ms
);

650 
	`£t_št
(
şk
, 
št_mode
);

651 
	`ms_div
(
şk
, 
r_div
, 
div_by_4
);

653 
SI5351_CLK3
:

654 
	`si5351_wr™e_bulk
(
SI5351_CLK3_PARAMETERS
, 
i
, 
·¿ms
);

655 
	`£t_št
(
şk
, 
št_mode
);

656 
	`ms_div
(
şk
, 
r_div
, 
div_by_4
);

658 
SI5351_CLK4
:

659 
	`si5351_wr™e_bulk
(
SI5351_CLK4_PARAMETERS
, 
i
, 
·¿ms
);

660 
	`£t_št
(
şk
, 
št_mode
);

661 
	`ms_div
(
şk
, 
r_div
, 
div_by_4
);

663 
SI5351_CLK5
:

664 
	`si5351_wr™e_bulk
(
SI5351_CLK5_PARAMETERS
, 
i
, 
·¿ms
);

665 
	`£t_št
(
şk
, 
št_mode
);

666 
	`ms_div
(
şk
, 
r_div
, 
div_by_4
);

668 
SI5351_CLK6
:

669 
	`si5351_wr™e
(
SI5351_CLK6_PARAMETERS
, 
‹mp
);

670 
	`ms_div
(
şk
, 
r_div
, 
div_by_4
);

672 
SI5351_CLK7
:

673 
	`si5351_wr™e
(
SI5351_CLK7_PARAMETERS
, 
‹mp
);

674 
	`ms_div
(
şk
, 
r_div
, 
div_by_4
);

678 
d–‘e
 
·¿ms
;

679 
	}
}

689 
	gSi5351
::
	$ouut_’abË
(
si5351_şock
 
şk
, 
ušt8_t
 
’abË
)

691 
ušt8_t
 
»g_v®
;

693 
»g_v®
 = 
	`si5351_»ad
(
SI5351_OUTPUT_ENABLE_CTRL
);

695 if(
’abË
 == 1)

697 
»g_v®
 &ğ~(1<<(
ušt8_t
)
şk
);

701 
»g_v®
 |ğ(1<<(
ušt8_t
)
şk
);

704 
	`si5351_wr™e
(
SI5351_OUTPUT_ENABLE_CTRL
, 
»g_v®
);

705 
	}
}

717 
	gSi5351
::
	$drive_¡»ngth
(
si5351_şock
 
şk
, 
si5351_drive
 
drive
)

719 
ušt8_t
 
»g_v®
;

720 cÚ¡ 
ušt8_t
 
mask
 = 0x03;

722 
»g_v®
 = 
	`si5351_»ad
(
SI5351_CLK0_CTRL
 + (
ušt8_t
)
şk
);

723 
»g_v®
 &ğ~(
mask
);

725 
drive
)

727 
SI5351_DRIVE_2MA
:

728 
»g_v®
 |= 0x00;

730 
SI5351_DRIVE_4MA
:

731 
»g_v®
 |= 0x01;

733 
SI5351_DRIVE_6MA
:

734 
»g_v®
 |= 0x02;

736 
SI5351_DRIVE_8MA
:

737 
»g_v®
 |= 0x03;

743 
	`si5351_wr™e
(
SI5351_CLK0_CTRL
 + (
ušt8_t
)
şk
, 
»g_v®
);

744 
	}
}

756 
	gSi5351
::
	$upd©e_¡©us
()

758 
	`upd©e_sys_¡©us
(&
dev_¡©us
);

759 
	`upd©e_št_¡©us
(&
dev_št_¡©us
);

760 
	}
}

788 
	gSi5351
::
	$£t_cÜ»ùiÚ
(
št32_t
 
cÜr
, 
si5351_¶l_šput
 
»f_osc
)

790 
»f_cÜ»ùiÚ
[(
ušt8_t
)
»f_osc
] = 
cÜr
;

793 
	`£t_¶l
(
¶Ï_äeq
, 
SI5351_PLLA
);

794 
	`£t_¶l
(
¶lb_äeq
, 
SI5351_PLLB
);

795 
	}
}

809 
	gSi5351
::
	$£t_pha£
(
si5351_şock
 
şk
, 
ušt8_t
 
pha£
)

812 
pha£
 =…hase & 0b01111111;

814 
	`si5351_wr™e
(
SI5351_CLK0_PHASE_OFFSET
 + (
ušt8_t
)
şk
, 
pha£
);

815 
	}
}

827 
št32_t
 
	gSi5351
::
	$g‘_cÜ»ùiÚ
(
si5351_¶l_šput
 
»f_osc
)

829  
»f_cÜ»ùiÚ
[(
ušt8_t
)
»f_osc
];

830 
	}
}

840 
	gSi5351
::
	$¶l_»£t
(
si5351_¶l
 
rg‘_¶l
)

842 if(
rg‘_¶l
 =ğ
SI5351_PLLA
)

844 
	`si5351_wr™e
(
SI5351_PLL_RESET
, 
SI5351_PLL_RESET_A
);

846 if(
rg‘_¶l
 =ğ
SI5351_PLLB
)

848 
	`si5351_wr™e
(
SI5351_PLL_RESET
, 
SI5351_PLL_RESET_B
);

850 
	}
}

862 
	gSi5351
::
	$£t_ms_sourû
(
si5351_şock
 
şk
, 
si5351_¶l
 
¶l
)

864 
ušt8_t
 
»g_v®
;

866 
»g_v®
 = 
	`si5351_»ad
(
SI5351_CLK0_CTRL
 + (
ušt8_t
)
şk
);

868 if(
¶l
 =ğ
SI5351_PLLA
)

870 
»g_v®
 &ğ~(
SI5351_CLK_PLL_SELECT
);

872 if(
¶l
 =ğ
SI5351_PLLB
)

874 
»g_v®
 |ğ
SI5351_CLK_PLL_SELECT
;

877 
	`si5351_wr™e
(
SI5351_CLK0_CTRL
 + (
ušt8_t
)
şk
, 
»g_v®
);

879 
¶l_assignm’t
[(
ušt8_t
)
şk
] = 
¶l
;

880 
	}
}

891 
	gSi5351
::
	$£t_št
(
si5351_şock
 
şk
, 
ušt8_t
 
’abË
)

893 
ušt8_t
 
»g_v®
;

894 
»g_v®
 = 
	`si5351_»ad
(
SI5351_CLK0_CTRL
 + (
ušt8_t
)
şk
);

896 if(
’abË
 == 1)

898 
»g_v®
 |ğ(
SI5351_CLK_INTEGER_MODE
);

902 
»g_v®
 &ğ~(
SI5351_CLK_INTEGER_MODE
);

905 
	`si5351_wr™e
(
SI5351_CLK0_CTRL
 + (
ušt8_t
)
şk
, 
»g_v®
);

924 
	}
}

936 
	gSi5351
::
	$£t_şock_pwr
(
si5351_şock
 
şk
, 
ušt8_t
 
pwr
)

938 
ušt8_t
 
»g_v®
;

939 
»g_v®
 = 
	`si5351_»ad
(
SI5351_CLK0_CTRL
 + (
ušt8_t
)
şk
);

941 if(
pwr
 == 1)

943 
»g_v®
 &= 0b01111111;

947 
»g_v®
 |= 0b10000000;

950 
	`si5351_wr™e
(
SI5351_CLK0_CTRL
 + (
ušt8_t
)
şk
, 
»g_v®
);

951 
	}
}

962 
	gSi5351
::
	$£t_şock_šv”t
(
si5351_şock
 
şk
, 
ušt8_t
 
šv
)

964 
ušt8_t
 
»g_v®
;

965 
»g_v®
 = 
	`si5351_»ad
(
SI5351_CLK0_CTRL
 + (
ušt8_t
)
şk
);

967 if(
šv
 == 1)

969 
»g_v®
 |ğ(
SI5351_CLK_INVERT
);

973 
»g_v®
 &ğ~(
SI5351_CLK_INVERT
);

976 
	`si5351_wr™e
(
SI5351_CLK0_CTRL
 + (
ušt8_t
)
şk
, 
»g_v®
);

977 
	}
}

992 
	gSi5351
::
	$£t_şock_sourû
(
si5351_şock
 
şk
, 
si5351_şock_sourû
 
¤c
)

994 
ušt8_t
 
»g_v®
;

995 
»g_v®
 = 
	`si5351_»ad
(
SI5351_CLK0_CTRL
 + (
ušt8_t
)
şk
);

998 
»g_v®
 &ğ~(
SI5351_CLK_INPUT_MASK
);

1000 
¤c
)

1002 
SI5351_CLK_SRC_XTAL
:

1003 
»g_v®
 |ğ(
SI5351_CLK_INPUT_XTAL
);

1005 
SI5351_CLK_SRC_CLKIN
:

1006 
»g_v®
 |ğ(
SI5351_CLK_INPUT_CLKIN
);

1008 
SI5351_CLK_SRC_MS0
:

1009 if(
şk
 =ğ
SI5351_CLK0
)

1014 
»g_v®
 |ğ(
SI5351_CLK_INPUT_MULTISYNTH_0_4
);

1016 
SI5351_CLK_SRC_MS
:

1017 
»g_v®
 |ğ(
SI5351_CLK_INPUT_MULTISYNTH_N
);

1023 
	`si5351_wr™e
(
SI5351_CLK0_CTRL
 + (
ušt8_t
)
şk
, 
»g_v®
);

1024 
	}
}

1038 
	gSi5351
::
	$£t_şock_di§bË
(
si5351_şock
 
şk
, 
si5351_şock_di§bË
 
dis_¡©e
)

1040 
ušt8_t
 
»g_v®
, 
»g
;

1042 ià(
şk
 >ğ
SI5351_CLK0
 && clk <ğ
SI5351_CLK3
)

1044 
»g
 = 
SI5351_CLK3_0_DISABLE_STATE
;

1046 if(
şk
 >ğ
SI5351_CLK4
 && clk <ğ
SI5351_CLK7
)

1048 
»g
 = 
SI5351_CLK7_4_DISABLE_STATE
;

1052 
»g_v®
 = 
	`si5351_»ad
(
»g
);

1054 ià(
şk
 >ğ
SI5351_CLK0
 && clk <ğ
SI5351_CLK3
)

1056 
»g_v®
 &ğ~(0b11 << (
şk
 * 2));

1057 
»g_v®
 |ğ
dis_¡©e
 << (
şk
 * 2);

1059 if(
şk
 >ğ
SI5351_CLK4
 && clk <ğ
SI5351_CLK7
)

1061 
»g_v®
 &ğ~(0b11 << ((
şk
 - 4) * 2));

1062 
»g_v®
 |ğ
dis_¡©e
 << ((
şk
 - 4) * 2);

1065 
	`si5351_wr™e
(
»g
, 
»g_v®
);

1066 
	}
}

1081 
	gSi5351
::
	$£t_şock_çnout
(
si5351_şock_çnout
 
çnout
, 
ušt8_t
 
’abË
)

1083 
ušt8_t
 
»g_v®
;

1084 
»g_v®
 = 
	`si5351_»ad
(
SI5351_FANOUT_ENABLE
);

1086 
çnout
)

1088 
SI5351_FANOUT_CLKIN
:

1089 if(
’abË
)

1091 
»g_v®
 |ğ
SI5351_CLKIN_ENABLE
;

1095 
»g_v®
 &ğ~(
SI5351_CLKIN_ENABLE
);

1098 
SI5351_FANOUT_XO
:

1099 if(
’abË
)

1101 
»g_v®
 |ğ
SI5351_XTAL_ENABLE
;

1105 
»g_v®
 &ğ~(
SI5351_XTAL_ENABLE
);

1108 
SI5351_FANOUT_MS
:

1109 if(
’abË
)

1111 
»g_v®
 |ğ
SI5351_MULTISYNTH_ENABLE
;

1115 
»g_v®
 &ğ~(
SI5351_MULTISYNTH_ENABLE
);

1120 
	`si5351_wr™e
(
SI5351_FANOUT_ENABLE
, 
»g_v®
);

1121 
	}
}

1133 
	gSi5351
::
	$£t_¶l_šput
(
si5351_¶l
 
¶l
, 
si5351_¶l_šput
 
šput
)

1135 
ušt8_t
 
»g_v®
;

1136 
»g_v®
 = 
	`si5351_»ad
(
SI5351_PLL_INPUT_SOURCE
);

1141 
¶l
)

1143 
SI5351_PLLA
:

1144 if(
šput
 =ğ
SI5351_PLL_INPUT_CLKIN
)

1146 
»g_v®
 |ğ
SI5351_PLLA_SOURCE
;

1147 
»g_v®
 |ğ
şkš_div
;

1148 
¶Ï_»f_osc
 = 
SI5351_PLL_INPUT_CLKIN
;

1152 
»g_v®
 &ğ~(
SI5351_PLLA_SOURCE
);

1153 
¶Ï_»f_osc
 = 
SI5351_PLL_INPUT_XO
;

1156 
SI5351_PLLB
:

1157 if(
šput
 =ğ
SI5351_PLL_INPUT_CLKIN
)

1159 
»g_v®
 |ğ
SI5351_PLLB_SOURCE
;

1160 
»g_v®
 |ğ
şkš_div
;

1161 
¶lb_»f_osc
 = 
SI5351_PLL_INPUT_CLKIN
;

1165 
»g_v®
 &ğ~(
SI5351_PLLB_SOURCE
);

1166 
¶lb_»f_osc
 = 
SI5351_PLL_INPUT_XO
;

1173 
	`si5351_wr™e
(
SI5351_PLL_INPUT_SOURCE
, 
»g_v®
);

1175 
	`£t_¶l
(
¶Ï_äeq
, 
SI5351_PLLA
);

1176 
	`£t_¶l
(
¶lb_äeq
, 
SI5351_PLLB
);

1177 
	}
}

1187 
	gSi5351
::
	$£t_vcxo
(
ušt64_t
 
¶l_äeq
, 
ušt8_t
 
µm
)

1189 
Si5351RegS‘
 
¶l_»g
;

1190 
ušt64_t
 
vcxo_·¿m
;

1193 if(
µm
 < 
SI5351_VCXO_PULL_MIN
)

1195 
µm
 = 
SI5351_VCXO_PULL_MIN
;

1198 if(
µm
 > 
SI5351_VCXO_PULL_MAX
)

1200 
µm
 = 
SI5351_VCXO_PULL_MAX
;

1204 
vcxo_·¿m
 = 
	`¶l_ÿlc
(
SI5351_PLLB
, 
¶l_äeq
, &
¶l_»g
, 
»f_cÜ»ùiÚ
[
¶lb_»f_osc
], 1);

1209 
ušt8_t
 *
·¿ms
 = 
Ãw
 uint8_t[20];

1210 
ušt8_t
 
i
 = 0;

1211 
ušt8_t
 
‹mp
;

1214 
‹mp
 = ((
¶l_»g
.
p3
 >> 8) & 0xFF);

1215 
·¿ms
[
i
++] = 
‹mp
;

1217 
‹mp
 = (
ušt8_t
)(
¶l_»g
.
p3
 & 0xFF);

1218 
·¿ms
[
i
++] = 
‹mp
;

1221 
‹mp
 = (
ušt8_t
)((
¶l_»g
.
p1
 >> 16) & 0x03);

1222 
·¿ms
[
i
++] = 
‹mp
;

1225 
‹mp
 = (
ušt8_t
)((
¶l_»g
.
p1
 >> 8) & 0xFF);

1226 
·¿ms
[
i
++] = 
‹mp
;

1228 
‹mp
 = (
ušt8_t
)(
¶l_»g
.
p1
 & 0xFF);

1229 
·¿ms
[
i
++] = 
‹mp
;

1232 
‹mp
 = (
ušt8_t
)((
¶l_»g
.
p3
 >> 12) & 0xF0);

1233 
‹mp
 +ğ(
ušt8_t
)((
¶l_»g
.
p2
 >> 16) & 0x0F);

1234 
·¿ms
[
i
++] = 
‹mp
;

1237 
‹mp
 = (
ušt8_t
)((
¶l_»g
.
p2
 >> 8) & 0xFF);

1238 
·¿ms
[
i
++] = 
‹mp
;

1240 
‹mp
 = (
ušt8_t
)(
¶l_»g
.
p2
 & 0xFF);

1241 
·¿ms
[
i
++] = 
‹mp
;

1244 
	`si5351_wr™e_bulk
(
SI5351_PLLB_PARAMETERS
, 
i
, 
·¿ms
);

1246 
d–‘e
 
·¿ms
;

1249 
vcxo_·¿m
 = ((vcxo_·¿m * 
µm
 * 
SI5351_VCXO_MARGIN
) / 100ULL) / 1000000ULL;

1251 
‹mp
 = (
ušt8_t
)(
vcxo_·¿m
 & 0xFF);

1252 
	`si5351_wr™e
(
SI5351_VXCO_PARAMETERS_LOW
, 
‹mp
);

1254 
‹mp
 = (
ušt8_t
)((
vcxo_·¿m
 >> 8) & 0xFF);

1255 
	`si5351_wr™e
(
SI5351_VXCO_PARAMETERS_MID
, 
‹mp
);

1257 
‹mp
 = (
ušt8_t
)((
vcxo_·¿m
 >> 16) & 0x3F);

1258 
	`si5351_wr™e
(
SI5351_VXCO_PARAMETERS_HIGH
, 
‹mp
);

1259 
	}
}

1270 
	gSi5351
::
	$£t_»f_äeq
(
ušt32_t
 
»f_äeq
, 
si5351_¶l_šput
 
»f_osc
)

1278 if(
»f_äeq
 <= 30000000UL)

1280 
xl_äeq
[(
ušt8_t
)
»f_osc
] = 
»f_äeq
;

1282 if(
»f_osc
 =ğ
SI5351_PLL_INPUT_CLKIN
)

1284 
şkš_div
 = 
SI5351_CLKIN_DIV_1
;

1287 if(
»f_äeq
 > 30000000UL &&„ef_freq <= 60000000UL)

1289 
xl_äeq
[(
ušt8_t
)
»f_osc
] = 
»f_äeq
 / 2;

1291 if(
»f_osc
 =ğ
SI5351_PLL_INPUT_CLKIN
)

1293 
şkš_div
 = 
SI5351_CLKIN_DIV_2
;

1296 if(
»f_äeq
 > 60000000UL &&„ef_freq <= 100000000UL)

1298 
xl_äeq
[(
ušt8_t
)
»f_osc
] = 
»f_äeq
 / 4;

1300 if(
»f_osc
 =ğ
SI5351_PLL_INPUT_CLKIN
)

1302 
şkš_div
 = 
SI5351_CLKIN_DIV_4
;

1311 
	}
}

1313 
ušt8_t
 
	gSi5351
::
	$si5351_wr™e_bulk
(
ušt8_t
 
addr
, ušt8_ˆ
by‹s
, ušt8_ˆ*
d©a
)

1315 
Wœe
.
	`begšT¿nsmissiÚ
(
i2c_bus_addr
);

1316 
Wœe
.
	`wr™e
(
addr
);

1317 
i
 = 0; i < 
by‹s
; i++)

1319 
Wœe
.
	`wr™e
(
d©a
[
i
]);

1321  
Wœe
.
	`’dT¿nsmissiÚ
();

1323 
	}
}

1325 
ušt8_t
 
	gSi5351
::
	$si5351_wr™e
(
ušt8_t
 
addr
, ušt8_ˆ
d©a
)

1327 
Wœe
.
	`begšT¿nsmissiÚ
(
i2c_bus_addr
);

1328 
Wœe
.
	`wr™e
(
addr
);

1329 
Wœe
.
	`wr™e
(
d©a
);

1330  
Wœe
.
	`’dT¿nsmissiÚ
();

1331 
	}
}

1333 
ušt8_t
 
	gSi5351
::
	$si5351_»ad
(
ušt8_t
 
addr
)

1335 
ušt8_t
 
»g_v®
 = 0;

1337 
Wœe
.
	`begšT¿nsmissiÚ
(
i2c_bus_addr
);

1338 
Wœe
.
	`wr™e
(
addr
);

1339 
Wœe
.
	`’dT¿nsmissiÚ
();

1341 
Wœe
.
	`»que¡From
(
i2c_bus_addr
, (
ušt8_t
)1, (ušt8_t)
çl£
);

1343 
Wœe
.
	`avaabË
())

1345 
»g_v®
 = 
Wœe
.
	`»ad
();

1348  
»g_v®
;

1349 
	}
}

1355 
ušt64_t
 
	gSi5351
::
	$¶l_ÿlc
(
si5351_¶l
 
¶l
, 
ušt64_t
 
äeq
, 
Si5351RegS‘
 *
»g
, 
št32_t
 
cÜ»ùiÚ
, 
ušt8_t
 
vcxo
)

1357 
ušt64_t
 
»f_äeq
;

1358 if(
¶l
 =ğ
SI5351_PLLA
)

1360 
»f_äeq
 = 
xl_äeq
[(
ušt8_t
)
¶Ï_»f_osc
] * 
SI5351_FREQ_MULT
;

1364 
»f_äeq
 = 
xl_äeq
[(
ušt8_t
)
¶lb_»f_osc
] * 
SI5351_FREQ_MULT
;

1367 
ušt32_t
 
a
, 
b
, 
c
, 
p1
, 
p2
, 
p3
;

1368 
ušt64_t
 
Îtmp
;

1373 
»f_äeq
 =„ef_äeq + (
št32_t
)((((((
št64_t
)
cÜ»ùiÚ
) << 31) / 1000000000LL) *„ef_freq) >> 31);

1376 ià(
äeq
 < 
SI5351_PLL_VCO_MIN
 * 
SI5351_FREQ_MULT
)

1378 
äeq
 = 
SI5351_PLL_VCO_MIN
 * 
SI5351_FREQ_MULT
;

1380 ià(
äeq
 > 
SI5351_PLL_VCO_MAX
 * 
SI5351_FREQ_MULT
)

1382 
äeq
 = 
SI5351_PLL_VCO_MAX
 * 
SI5351_FREQ_MULT
;

1386 
a
 = 
äeq
 / 
»f_äeq
;

1388 ià(
a
 < 
SI5351_PLL_A_MIN
)

1390 
äeq
 = 
»f_äeq
 * 
SI5351_PLL_A_MIN
;

1392 ià(
a
 > 
SI5351_PLL_A_MAX
)

1394 
äeq
 = 
»f_äeq
 * 
SI5351_PLL_A_MAX
;

1404 if(
vcxo
)

1406 
b
 = (((
ušt64_t
)(
äeq
 % 
»f_äeq
)) * 1000000ULL) /„ef_freq;

1407 
c
 = 1000000ULL;

1411 
b
 = (((
ušt64_t
)(
äeq
 % 
»f_äeq
)è* 
RFRAC_DENOM
) /„ef_freq;

1412 
c
 = 
b
 ? 
RFRAC_DENOM
 : 1;

1416 
p1
 = 128 * 
a
 + ((128 * 
b
è/ 
c
) - 512;

1417 
p2
 = 128 * 
b
 - 
c
 * ((128 * b) / c);

1418 
p3
 = 
c
;

1421 
Îtmp
 = 
»f_äeq
;

1422 
Îtmp
 *ğ
b
;

1423 
	`do_div
(
Îtmp
, 
c
);

1424 
äeq
 = 
Îtmp
;

1425 
äeq
 +ğ
»f_äeq
 * 
a
;

1427 
»g
->
p1
 =…1;

1428 
»g
->
p2
 =…2;

1429 
»g
->
p3
 =…3;

1431 if(
vcxo
)

1433  (
ušt64_t
)(128 * 
a
 * 1000000ULL + 
b
);

1437  
äeq
;

1439 
	}
}

1441 
ušt64_t
 
	gSi5351
::
	$muÉisyÁh_ÿlc
(
ušt64_t
 
äeq
, ušt64_ˆ
¶l_äeq
, 
Si5351RegS‘
 *
»g
)

1443 
ušt64_t
 
Îtmp
;

1444 
ušt32_t
 
a
, 
b
, 
c
, 
p1
, 
p2
, 
p3
;

1445 
ušt8_t
 
divby4
 = 0;

1446 
ušt8_t
 
»t_v®
 = 0;

1449 ià(
äeq
 > 
SI5351_MULTISYNTH_MAX_FREQ
 * 
SI5351_FREQ_MULT
)

1451 
äeq
 = 
SI5351_MULTISYNTH_MAX_FREQ
 * 
SI5351_FREQ_MULT
;

1453 ià(
äeq
 < 
SI5351_MULTISYNTH_MIN_FREQ
 * 
SI5351_FREQ_MULT
)

1455 
äeq
 = 
SI5351_MULTISYNTH_MIN_FREQ
 * 
SI5351_FREQ_MULT
;

1458 ià(
äeq
 >ğ
SI5351_MULTISYNTH_DIVBY4_FREQ
 * 
SI5351_FREQ_MULT
)

1460 
divby4
 = 1;

1463 if(
¶l_äeq
 == 0)

1467 if(
divby4
 == 0)

1469 
Îtmp
 = 
SI5351_PLL_VCO_MAX
 * 
SI5351_FREQ_MULT
;

1470 
	`do_div
(
Îtmp
, 
äeq
);

1471 if(
Îtmp
 == 5)

1473 
Îtmp
 = 4;

1475 if(
Îtmp
 == 7)

1477 
Îtmp
 = 6;

1479 
a
 = (
ušt32_t
)
Îtmp
;

1483 
a
 = 4;

1486 
b
 = 0;

1487 
c
 = 1;

1488 
¶l_äeq
 = 
a
 * 
äeq
;

1493 
»t_v®
 = 1;

1496 
a
 = 
¶l_äeq
 / 
äeq
;

1498 ià(
a
 < 
SI5351_MULTISYNTH_A_MIN
)

1500 
äeq
 = 
¶l_äeq
 / 
SI5351_MULTISYNTH_A_MIN
;

1502 ià(
a
 > 
SI5351_MULTISYNTH_A_MAX
)

1504 
äeq
 = 
¶l_äeq
 / 
SI5351_MULTISYNTH_A_MAX
;

1507 
b
 = (
¶l_äeq
 % 
äeq
 * 
RFRAC_DENOM
) / freq;

1508 
c
 = 
b
 ? 
RFRAC_DENOM
 : 1;

1512 ià(
divby4
 == 1)

1514 
p3
 = 1;

1515 
p2
 = 0;

1516 
p1
 = 0;

1520 
p1
 = 128 * 
a
 + ((128 * 
b
è/ 
c
) - 512;

1521 
p2
 = 128 * 
b
 - 
c
 * ((128 * b) / c);

1522 
p3
 = 
c
;

1525 
»g
->
p1
 =…1;

1526 
»g
->
p2
 =…2;

1527 
»g
->
p3
 =…3;

1529 if(
»t_v®
 == 0)

1531  
¶l_äeq
;

1535  
äeq
;

1537 
	}
}

1539 
ušt64_t
 
	gSi5351
::
	$muÉisyÁh67_ÿlc
(
ušt64_t
 
äeq
, ušt64_ˆ
¶l_äeq
, 
Si5351RegS‘
 *
»g
)

1543 
ušt32_t
 
a
;

1544 
ušt64_t
 
Îtmp
;

1547 if(
äeq
 > 
SI5351_MULTISYNTH67_MAX_FREQ
 * 
SI5351_FREQ_MULT
)

1549 
äeq
 = 
SI5351_MULTISYNTH67_MAX_FREQ
 * 
SI5351_FREQ_MULT
;

1551 if(
äeq
 < 
SI5351_MULTISYNTH_MIN_FREQ
 * 
SI5351_FREQ_MULT
)

1553 
äeq
 = 
SI5351_MULTISYNTH_MIN_FREQ
 * 
SI5351_FREQ_MULT
;

1556 if(
¶l_äeq
 == 0)

1560 
Îtmp
 = (
SI5351_PLL_VCO_MAX
 * 
SI5351_FREQ_MULT
) - 100000000UL;

1561 
	`do_div
(
Îtmp
, 
äeq
);

1562 
a
 = (
ušt32_t
)
Îtmp
;

1565 if(
a
 % 2 != 0)

1567 
a
++;

1571 if(
a
 < 
SI5351_MULTISYNTH_A_MIN
)

1573 
a
 = 
SI5351_MULTISYNTH_A_MIN
;

1575 if(
a
 > 
SI5351_MULTISYNTH67_A_MAX
)

1577 
a
 = 
SI5351_MULTISYNTH67_A_MAX
;

1580 
¶l_äeq
 = 
a
 * 
äeq
;

1583 if(
¶l_äeq
 > (
SI5351_PLL_VCO_MAX
 * 
SI5351_FREQ_MULT
))

1585 
a
 -= 2;

1586 
¶l_äeq
 = 
a
 * 
äeq
;

1588 if(
¶l_äeq
 < (
SI5351_PLL_VCO_MIN
 * 
SI5351_FREQ_MULT
))

1590 
a
 += 2;

1591 
¶l_äeq
 = 
a
 * 
äeq
;

1594 
»g
->
p1
 = (
ušt8_t
)
a
;

1595 
»g
->
p2
 = 0;

1596 
»g
->
p3
 = 0;

1597  
¶l_äeq
;

1602 if(
¶l_äeq
 % 
äeq
)

1609 
a
 = 
¶l_äeq
 / 
äeq
;

1612 if(
a
 < 
SI5351_MULTISYNTH_A_MIN
 ||‡ > 
SI5351_MULTISYNTH67_A_MAX
)

1619 
»g
->
p1
 = (
ušt8_t
)
a
;

1620 
»g
->
p2
 = 0;

1621 
»g
->
p3
 = 0;

1626 
	}
}

1628 
	gSi5351
::
	$upd©e_sys_¡©us
(
Si5351Stus
 *
¡©us
)

1630 
ušt8_t
 
»g_v®
 = 0;

1632 
»g_v®
 = 
	`si5351_»ad
(
SI5351_DEVICE_STATUS
);

1635 
¡©us
->
SYS_INIT
 = (
»g_v®
 >> 7) & 0x01;

1636 
¡©us
->
LOL_B
 = (
»g_v®
 >> 6) & 0x01;

1637 
¡©us
->
LOL_A
 = (
»g_v®
 >> 5) & 0x01;

1638 
¡©us
->
LOS
 = (
»g_v®
 >> 4) & 0x01;

1639 
¡©us
->
REVID
 = 
»g_v®
 & 0x03;

1640 
	}
}

1642 
	gSi5351
::
	$upd©e_št_¡©us
(
Si5351IÁStus
 *
št_¡©us
)

1644 
ušt8_t
 
»g_v®
 = 0;

1646 
»g_v®
 = 
	`si5351_»ad
(
SI5351_INTERRUPT_STATUS
);

1649 
št_¡©us
->
SYS_INIT_STKY
 = (
»g_v®
 >> 7) & 0x01;

1650 
št_¡©us
->
LOL_B_STKY
 = (
»g_v®
 >> 6) & 0x01;

1651 
št_¡©us
->
LOL_A_STKY
 = (
»g_v®
 >> 5) & 0x01;

1652 
št_¡©us
->
LOS_STKY
 = (
»g_v®
 >> 4) & 0x01;

1653 
	}
}

1655 
	gSi5351
::
	$ms_div
(
si5351_şock
 
şk
, 
ušt8_t
 
r_div
, ušt8_ˆ
div_by_4
)

1657 
ušt8_t
 
»g_v®
 = 0;

1658 
ušt8_t
 
»g_addr
 = 0;

1660 
şk
)

1662 
SI5351_CLK0
:

1663 
»g_addr
 = 
SI5351_CLK0_PARAMETERS
 + 2;

1665 
SI5351_CLK1
:

1666 
»g_addr
 = 
SI5351_CLK1_PARAMETERS
 + 2;

1668 
SI5351_CLK2
:

1669 
»g_addr
 = 
SI5351_CLK2_PARAMETERS
 + 2;

1671 
SI5351_CLK3
:

1672 
»g_addr
 = 
SI5351_CLK3_PARAMETERS
 + 2;

1674 
SI5351_CLK4
:

1675 
»g_addr
 = 
SI5351_CLK4_PARAMETERS
 + 2;

1677 
SI5351_CLK5
:

1678 
»g_addr
 = 
SI5351_CLK5_PARAMETERS
 + 2;

1680 
SI5351_CLK6
:

1681 
»g_addr
 = 
SI5351_CLK6_7_OUTPUT_DIVIDER
;

1683 
SI5351_CLK7
:

1684 
»g_addr
 = 
SI5351_CLK6_7_OUTPUT_DIVIDER
;

1688 
»g_v®
 = 
	`si5351_»ad
(
»g_addr
);

1690 if(
şk
 <ğ(
ušt8_t
)
SI5351_CLK5
)

1693 
»g_v®
 &= ~(0x7c);

1695 if(
div_by_4
 == 0)

1697 
»g_v®
 &ğ~(
SI5351_OUTPUT_CLK_DIVBY4
);

1701 
»g_v®
 |ğ(
SI5351_OUTPUT_CLK_DIVBY4
);

1704 
»g_v®
 |ğ(
r_div
 << 
SI5351_OUTPUT_CLK_DIV_SHIFT
);

1706 if(
şk
 =ğ
SI5351_CLK6
)

1709 
»g_v®
 &= ~(0x07);

1711 
»g_v®
 |ğ
r_div
;

1713 if(
şk
 =ğ
SI5351_CLK7
)

1716 
»g_v®
 &= ~(0x70);

1718 
»g_v®
 |ğ(
r_div
 << 
SI5351_OUTPUT_CLK_DIV_SHIFT
);

1721 
	`si5351_wr™e
(
»g_addr
, 
»g_v®
);

1722 
	}
}

1724 
ušt8_t
 
	gSi5351
::
	$£Ëù_r_div
(
ušt64_t
 *
äeq
)

1726 
ušt8_t
 
r_div
 = 
SI5351_OUTPUT_CLK_DIV_1
;

1729 if((*
äeq
 >ğ
SI5351_CLKOUT_MIN_FREQ
 * 
SI5351_FREQ_MULT
) && (*freq < SI5351_CLKOUT_MIN_FREQ * SI5351_FREQ_MULT * 2))

1731 
r_div
 = 
SI5351_OUTPUT_CLK_DIV_128
;

1732 *
äeq
 *= 128ULL;

1734 if((*
äeq
 >ğ
SI5351_CLKOUT_MIN_FREQ
 * 
SI5351_FREQ_MULT
 * 2) && (*freq < SI5351_CLKOUT_MIN_FREQ * SI5351_FREQ_MULT * 4))

1736 
r_div
 = 
SI5351_OUTPUT_CLK_DIV_64
;

1737 *
äeq
 *= 64ULL;

1739 if((*
äeq
 >ğ
SI5351_CLKOUT_MIN_FREQ
 * 
SI5351_FREQ_MULT
 * 4) && (*freq < SI5351_CLKOUT_MIN_FREQ * SI5351_FREQ_MULT * 8))

1741 
r_div
 = 
SI5351_OUTPUT_CLK_DIV_32
;

1742 *
äeq
 *= 32ULL;

1744 if((*
äeq
 >ğ
SI5351_CLKOUT_MIN_FREQ
 * 
SI5351_FREQ_MULT
 * 8) && (*freq < SI5351_CLKOUT_MIN_FREQ * SI5351_FREQ_MULT * 16))

1746 
r_div
 = 
SI5351_OUTPUT_CLK_DIV_16
;

1747 *
äeq
 *= 16ULL;

1749 if((*
äeq
 >ğ
SI5351_CLKOUT_MIN_FREQ
 * 
SI5351_FREQ_MULT
 * 16) && (*freq < SI5351_CLKOUT_MIN_FREQ * SI5351_FREQ_MULT * 32))

1751 
r_div
 = 
SI5351_OUTPUT_CLK_DIV_8
;

1752 *
äeq
 *= 8ULL;

1754 if((*
äeq
 >ğ
SI5351_CLKOUT_MIN_FREQ
 * 
SI5351_FREQ_MULT
 * 32) && (*freq < SI5351_CLKOUT_MIN_FREQ * SI5351_FREQ_MULT * 64))

1756 
r_div
 = 
SI5351_OUTPUT_CLK_DIV_4
;

1757 *
äeq
 *= 4ULL;

1759 if((*
äeq
 >ğ
SI5351_CLKOUT_MIN_FREQ
 * 
SI5351_FREQ_MULT
 * 64) && (*freq < SI5351_CLKOUT_MIN_FREQ * SI5351_FREQ_MULT * 128))

1761 
r_div
 = 
SI5351_OUTPUT_CLK_DIV_2
;

1762 *
äeq
 *= 2ULL;

1765  
r_div
;

1766 
	}
}

1768 
ušt8_t
 
	gSi5351
::
	$£Ëù_r_div_ms67
(
ušt64_t
 *
äeq
)

1770 
ušt8_t
 
r_div
 = 
SI5351_OUTPUT_CLK_DIV_1
;

1773 if((*
äeq
 >ğ
SI5351_CLKOUT67_MIN_FREQ
 * 
SI5351_FREQ_MULT
) && (*freq < SI5351_CLKOUT67_MIN_FREQ * SI5351_FREQ_MULT * 2))

1775 
r_div
 = 
SI5351_OUTPUT_CLK_DIV_128
;

1776 *
äeq
 *= 128ULL;

1778 if((*
äeq
 >ğ
SI5351_CLKOUT67_MIN_FREQ
 * 
SI5351_FREQ_MULT
 * 2) && (*freq < SI5351_CLKOUT67_MIN_FREQ * SI5351_FREQ_MULT * 4))

1780 
r_div
 = 
SI5351_OUTPUT_CLK_DIV_64
;

1781 *
äeq
 *= 64ULL;

1783 if((*
äeq
 >ğ
SI5351_CLKOUT67_MIN_FREQ
 * 
SI5351_FREQ_MULT
 * 4) && (*freq < SI5351_CLKOUT67_MIN_FREQ * SI5351_FREQ_MULT * 8))

1785 
r_div
 = 
SI5351_OUTPUT_CLK_DIV_32
;

1786 *
äeq
 *= 32ULL;

1788 if((*
äeq
 >ğ
SI5351_CLKOUT67_MIN_FREQ
 * 
SI5351_FREQ_MULT
 * 8) && (*freq < SI5351_CLKOUT67_MIN_FREQ * SI5351_FREQ_MULT * 16))

1790 
r_div
 = 
SI5351_OUTPUT_CLK_DIV_16
;

1791 *
äeq
 *= 16ULL;

1793 if((*
äeq
 >ğ
SI5351_CLKOUT67_MIN_FREQ
 * 
SI5351_FREQ_MULT
 * 16) && (*freq < SI5351_CLKOUT67_MIN_FREQ * SI5351_FREQ_MULT * 32))

1795 
r_div
 = 
SI5351_OUTPUT_CLK_DIV_8
;

1796 *
äeq
 *= 8ULL;

1798 if((*
äeq
 >ğ
SI5351_CLKOUT67_MIN_FREQ
 * 
SI5351_FREQ_MULT
 * 32) && (*freq < SI5351_CLKOUT67_MIN_FREQ * SI5351_FREQ_MULT * 64))

1800 
r_div
 = 
SI5351_OUTPUT_CLK_DIV_4
;

1801 *
äeq
 *= 4ULL;

1803 if((*
äeq
 >ğ
SI5351_CLKOUT67_MIN_FREQ
 * 
SI5351_FREQ_MULT
 * 64) && (*freq < SI5351_CLKOUT67_MIN_FREQ * SI5351_FREQ_MULT * 128))

1805 
r_div
 = 
SI5351_OUTPUT_CLK_DIV_2
;

1806 *
äeq
 *= 2ULL;

1809  
r_div
;

1810 
	}
}

	@si5351.h

29 #iâdeà
SI5351_H_


30 
	#SI5351_H_


	)

32 
	~"Ardušo.h
"

33 
	~"Wœe.h
"

34 
	~<¡dšt.h
>

38 
	#SI5351_BUS_BASE_ADDR
 0x60

	)

39 
	#SI5351_XTAL_FREQ
 25000000

	)

40 
	#SI5351_PLL_FIXED
 80000000000ULL

	)

41 
	#SI5351_FREQ_MULT
 100ULL

	)

42 
	#SI5351_DEFAULT_CLK
 1000000000ULL

	)

44 
	#SI5351_PLL_VCO_MIN
 600000000

	)

45 
	#SI5351_PLL_VCO_MAX
 900000000

	)

46 
	#SI5351_MULTISYNTH_MIN_FREQ
 500000

	)

47 
	#SI5351_MULTISYNTH_DIVBY4_FREQ
 150000000

	)

48 
	#SI5351_MULTISYNTH_MAX_FREQ
 225000000

	)

49 
	#SI5351_MULTISYNTH_SHARE_MAX
 100000000

	)

50 
	#SI5351_MULTISYNTH_SHARE_MIN
 1024000

	)

51 
	#SI5351_MULTISYNTH67_MAX_FREQ
 
SI5351_MULTISYNTH_DIVBY4_FREQ


	)

52 
	#SI5351_CLKOUT_MIN_FREQ
 4000

	)

53 
	#SI5351_CLKOUT_MAX_FREQ
 
SI5351_MULTISYNTH_MAX_FREQ


	)

54 
	#SI5351_CLKOUT67_MS_MIN
 
SI5351_PLL_VCO_MIN
 / 
SI5351_MULTISYNTH67_A_MAX


	)

55 
	#SI5351_CLKOUT67_MIN_FREQ
 
SI5351_CLKOUT67_MS_MIN
 / 128

	)

56 
	#SI5351_CLKOUT67_MAX_FREQ
 
SI5351_MULTISYNTH67_MAX_FREQ


	)

58 
	#SI5351_PLL_A_MIN
 15

	)

59 
	#SI5351_PLL_A_MAX
 90

	)

60 
	#SI5351_PLL_B_MAX
 (
SI5351_PLL_C_MAX
-1)

	)

61 
	#SI5351_PLL_C_MAX
 1048575

	)

62 
	#SI5351_MULTISYNTH_A_MIN
 6

	)

63 
	#SI5351_MULTISYNTH_A_MAX
 1800

	)

64 
	#SI5351_MULTISYNTH67_A_MAX
 254

	)

65 
	#SI5351_MULTISYNTH_B_MAX
 (
SI5351_MULTISYNTH_C_MAX
-1)

	)

66 
	#SI5351_MULTISYNTH_C_MAX
 1048575

	)

67 
	#SI5351_MULTISYNTH_P1_MAX
 ((1<<18)-1)

	)

68 
	#SI5351_MULTISYNTH_P2_MAX
 ((1<<20)-1)

	)

69 
	#SI5351_MULTISYNTH_P3_MAX
 ((1<<20)-1)

	)

70 
	#SI5351_VCXO_PULL_MIN
 30

	)

71 
	#SI5351_VCXO_PULL_MAX
 240

	)

72 
	#SI5351_VCXO_MARGIN
 103

	)

74 
	#SI5351_DEVICE_STATUS
 0

	)

75 
	#SI5351_INTERRUPT_STATUS
 1

	)

76 
	#SI5351_INTERRUPT_MASK
 2

	)

77 
	#SI5351_STATUS_SYS_INIT
 (1<<7)

	)

78 
	#SI5351_STATUS_LOL_B
 (1<<6)

	)

79 
	#SI5351_STATUS_LOL_A
 (1<<5)

	)

80 
	#SI5351_STATUS_LOS
 (1<<4)

	)

81 
	#SI5351_OUTPUT_ENABLE_CTRL
 3

	)

82 
	#SI5351_OEB_PIN_ENABLE_CTRL
 9

	)

83 
	#SI5351_PLL_INPUT_SOURCE
 15

	)

84 
	#SI5351_CLKIN_DIV_MASK
 (3<<6)

	)

85 
	#SI5351_CLKIN_DIV_1
 (0<<6)

	)

86 
	#SI5351_CLKIN_DIV_2
 (1<<6)

	)

87 
	#SI5351_CLKIN_DIV_4
 (2<<6)

	)

88 
	#SI5351_CLKIN_DIV_8
 (3<<6)

	)

89 
	#SI5351_PLLB_SOURCE
 (1<<3)

	)

90 
	#SI5351_PLLA_SOURCE
 (1<<2)

	)

92 
	#SI5351_CLK0_CTRL
 16

	)

93 
	#SI5351_CLK1_CTRL
 17

	)

94 
	#SI5351_CLK2_CTRL
 18

	)

95 
	#SI5351_CLK3_CTRL
 19

	)

96 
	#SI5351_CLK4_CTRL
 20

	)

97 
	#SI5351_CLK5_CTRL
 21

	)

98 
	#SI5351_CLK6_CTRL
 22

	)

99 
	#SI5351_CLK7_CTRL
 23

	)

100 
	#SI5351_CLK_POWERDOWN
 (1<<7)

	)

101 
	#SI5351_CLK_INTEGER_MODE
 (1<<6)

	)

102 
	#SI5351_CLK_PLL_SELECT
 (1<<5)

	)

103 
	#SI5351_CLK_INVERT
 (1<<4)

	)

104 
	#SI5351_CLK_INPUT_MASK
 (3<<2)

	)

105 
	#SI5351_CLK_INPUT_XTAL
 (0<<2)

	)

106 
	#SI5351_CLK_INPUT_CLKIN
 (1<<2)

	)

107 
	#SI5351_CLK_INPUT_MULTISYNTH_0_4
 (2<<2)

	)

108 
	#SI5351_CLK_INPUT_MULTISYNTH_N
 (3<<2)

	)

109 
	#SI5351_CLK_DRIVE_STRENGTH_MASK
 (3<<0)

	)

110 
	#SI5351_CLK_DRIVE_STRENGTH_2MA
 (0<<0)

	)

111 
	#SI5351_CLK_DRIVE_STRENGTH_4MA
 (1<<0)

	)

112 
	#SI5351_CLK_DRIVE_STRENGTH_6MA
 (2<<0)

	)

113 
	#SI5351_CLK_DRIVE_STRENGTH_8MA
 (3<<0)

	)

115 
	#SI5351_CLK3_0_DISABLE_STATE
 24

	)

116 
	#SI5351_CLK7_4_DISABLE_STATE
 25

	)

117 
	#SI5351_CLK_DISABLE_STATE_MASK
 3

	)

118 
	#SI5351_CLK_DISABLE_STATE_LOW
 0

	)

119 
	#SI5351_CLK_DISABLE_STATE_HIGH
 1

	)

120 
	#SI5351_CLK_DISABLE_STATE_FLOAT
 2

	)

121 
	#SI5351_CLK_DISABLE_STATE_NEVER
 3

	)

123 
	#SI5351_PARAMETERS_LENGTH
 8

	)

124 
	#SI5351_PLLA_PARAMETERS
 26

	)

125 
	#SI5351_PLLB_PARAMETERS
 34

	)

126 
	#SI5351_CLK0_PARAMETERS
 42

	)

127 
	#SI5351_CLK1_PARAMETERS
 50

	)

128 
	#SI5351_CLK2_PARAMETERS
 58

	)

129 
	#SI5351_CLK3_PARAMETERS
 66

	)

130 
	#SI5351_CLK4_PARAMETERS
 74

	)

131 
	#SI5351_CLK5_PARAMETERS
 82

	)

132 
	#SI5351_CLK6_PARAMETERS
 90

	)

133 
	#SI5351_CLK7_PARAMETERS
 91

	)

134 
	#SI5351_CLK6_7_OUTPUT_DIVIDER
 92

	)

135 
	#SI5351_OUTPUT_CLK_DIV_MASK
 (7 << 4)

	)

136 
	#SI5351_OUTPUT_CLK6_DIV_MASK
 (7 << 0)

	)

137 
	#SI5351_OUTPUT_CLK_DIV_SHIFT
 4

	)

138 
	#SI5351_OUTPUT_CLK_DIV6_SHIFT
 0

	)

139 
	#SI5351_OUTPUT_CLK_DIV_1
 0

	)

140 
	#SI5351_OUTPUT_CLK_DIV_2
 1

	)

141 
	#SI5351_OUTPUT_CLK_DIV_4
 2

	)

142 
	#SI5351_OUTPUT_CLK_DIV_8
 3

	)

143 
	#SI5351_OUTPUT_CLK_DIV_16
 4

	)

144 
	#SI5351_OUTPUT_CLK_DIV_32
 5

	)

145 
	#SI5351_OUTPUT_CLK_DIV_64
 6

	)

146 
	#SI5351_OUTPUT_CLK_DIV_128
 7

	)

147 
	#SI5351_OUTPUT_CLK_DIVBY4
 (3<<2)

	)

149 
	#SI5351_SSC_PARAM0
 149

	)

150 
	#SI5351_SSC_PARAM1
 150

	)

151 
	#SI5351_SSC_PARAM2
 151

	)

152 
	#SI5351_SSC_PARAM3
 152

	)

153 
	#SI5351_SSC_PARAM4
 153

	)

154 
	#SI5351_SSC_PARAM5
 154

	)

155 
	#SI5351_SSC_PARAM6
 155

	)

156 
	#SI5351_SSC_PARAM7
 156

	)

157 
	#SI5351_SSC_PARAM8
 157

	)

158 
	#SI5351_SSC_PARAM9
 158

	)

159 
	#SI5351_SSC_PARAM10
 159

	)

160 
	#SI5351_SSC_PARAM11
 160

	)

161 
	#SI5351_SSC_PARAM12
 161

	)

163 
	#SI5351_VXCO_PARAMETERS_LOW
 162

	)

164 
	#SI5351_VXCO_PARAMETERS_MID
 163

	)

165 
	#SI5351_VXCO_PARAMETERS_HIGH
 164

	)

167 
	#SI5351_CLK0_PHASE_OFFSET
 165

	)

168 
	#SI5351_CLK1_PHASE_OFFSET
 166

	)

169 
	#SI5351_CLK2_PHASE_OFFSET
 167

	)

170 
	#SI5351_CLK3_PHASE_OFFSET
 168

	)

171 
	#SI5351_CLK4_PHASE_OFFSET
 169

	)

172 
	#SI5351_CLK5_PHASE_OFFSET
 170

	)

174 
	#SI5351_PLL_RESET
 177

	)

175 
	#SI5351_PLL_RESET_B
 (1<<7)

	)

176 
	#SI5351_PLL_RESET_A
 (1<<5)

	)

178 
	#SI5351_CRYSTAL_LOAD
 183

	)

179 
	#SI5351_CRYSTAL_LOAD_MASK
 (3<<6)

	)

180 
	#SI5351_CRYSTAL_LOAD_0PF
 (0<<6)

	)

181 
	#SI5351_CRYSTAL_LOAD_6PF
 (1<<6)

	)

182 
	#SI5351_CRYSTAL_LOAD_8PF
 (2<<6)

	)

183 
	#SI5351_CRYSTAL_LOAD_10PF
 (3<<6)

	)

185 
	#SI5351_FANOUT_ENABLE
 187

	)

186 
	#SI5351_CLKIN_ENABLE
 (1<<7)

	)

187 
	#SI5351_XTAL_ENABLE
 (1<<6)

	)

188 
	#SI5351_MULTISYNTH_ENABLE
 (1<<4)

	)

194 
	#RFRAC_DENOM
 1000000ULL

	)

212 
	#do_div
(
n
,
ba£
) ({ \

213 
ušt64_t
 
__ba£
 = (
ba£
); \

214 
ušt64_t
 
__»m
; \

215 
__»m
 = ((
ušt64_t
)(
n
)è% 
__ba£
; \

216 (
n
èğ((
ušt64_t
)Ò)è/ 
__ba£
; \

217 
__»m
; \

218 })

	)

238 
	esi5351_şock
 {
	mSI5351_CLK0
, 
	mSI5351_CLK1
, 
	mSI5351_CLK2
, 
	mSI5351_CLK3
,

239 
	mSI5351_CLK4
, 
	mSI5351_CLK5
, 
	mSI5351_CLK6
, 
	mSI5351_CLK7
};

241 
	esi5351_¶l
 {
	mSI5351_PLLA
, 
	mSI5351_PLLB
};

243 
	esi5351_drive
 {
	mSI5351_DRIVE_2MA
, 
	mSI5351_DRIVE_4MA
, 
	mSI5351_DRIVE_6MA
, 
	mSI5351_DRIVE_8MA
};

245 
	esi5351_şock_sourû
 {
	mSI5351_CLK_SRC_XTAL
, 
	mSI5351_CLK_SRC_CLKIN
, 
	mSI5351_CLK_SRC_MS0
, 
	mSI5351_CLK_SRC_MS
};

247 
	esi5351_şock_di§bË
 {
	mSI5351_CLK_DISABLE_LOW
, 
	mSI5351_CLK_DISABLE_HIGH
, 
	mSI5351_CLK_DISABLE_HI_Z
, 
	mSI5351_CLK_DISABLE_NEVER
};

249 
	esi5351_şock_çnout
 {
	mSI5351_FANOUT_CLKIN
, 
	mSI5351_FANOUT_XO
, 
	mSI5351_FANOUT_MS
};

251 
	esi5351_¶l_šput
 {
	mSI5351_PLL_INPUT_XO
, 
	mSI5351_PLL_INPUT_CLKIN
};

255 
	sSi5351RegS‘


257 
ušt32_t
 
	mp1
;

258 
ušt32_t
 
	mp2
;

259 
ušt32_t
 
	mp3
;

262 
	sSi5351Stus


264 
ušt8_t
 
	mSYS_INIT
;

265 
ušt8_t
 
	mLOL_B
;

266 
ušt8_t
 
	mLOL_A
;

267 
ušt8_t
 
	mLOS
;

268 
ušt8_t
 
	mREVID
;

271 
	sSi5351IÁStus


273 
ušt8_t
 
	mSYS_INIT_STKY
;

274 
ušt8_t
 
	mLOL_B_STKY
;

275 
ušt8_t
 
	mLOL_A_STKY
;

276 
ušt8_t
 
	mLOS_STKY
;

279 şas 
	cSi5351


281 
	mpublic
:

282 
Si5351
(
ušt8_t
 
i2c_addr
 = 
SI5351_BUS_BASE_ADDR
);

283 
boŞ
 
š™
(
ušt8_t
, 
ušt32_t
, 
št32_t
);

284 
»£t
();

285 
ušt8_t
 
£t_äeq
(
ušt64_t
, 
si5351_şock
);

286 
ušt8_t
 
£t_äeq_mªu®
(
ušt64_t
, ušt64_t, 
si5351_şock
);

287 
£t_¶l
(
ušt64_t
, 
si5351_¶l
);

288 
£t_ms
(
si5351_şock
, 
Si5351RegS‘
, 
ušt8_t
, uint8_t, uint8_t);

289 
ouut_’abË
(
si5351_şock
, 
ušt8_t
);

290 
drive_¡»ngth
(
si5351_şock
, 
si5351_drive
);

291 
upd©e_¡©us
();

292 
£t_cÜ»ùiÚ
(
št32_t
, 
si5351_¶l_šput
);

293 
£t_pha£
(
si5351_şock
, 
ušt8_t
);

294 
št32_t
 
g‘_cÜ»ùiÚ
(
si5351_¶l_šput
);

295 
¶l_»£t
(
si5351_¶l
);

296 
£t_ms_sourû
(
si5351_şock
, 
si5351_¶l
);

297 
£t_št
(
si5351_şock
, 
ušt8_t
);

298 
£t_şock_pwr
(
si5351_şock
, 
ušt8_t
);

299 
£t_şock_šv”t
(
si5351_şock
, 
ušt8_t
);

300 
£t_şock_sourû
(
si5351_şock
, 
si5351_şock_sourû
);

301 
£t_şock_di§bË
(
si5351_şock
, 
si5351_şock_di§bË
);

302 
£t_şock_çnout
(
si5351_şock_çnout
, 
ušt8_t
);

303 
£t_¶l_šput
(
si5351_¶l
, 
si5351_¶l_šput
);

304 
£t_vcxo
(
ušt64_t
, 
ušt8_t
);

305 
£t_»f_äeq
(
ušt32_t
, 
si5351_¶l_šput
);

306 
ušt8_t
 
si5351_wr™e_bulk
(uint8_t, uint8_t, uint8_t *);

307 
ušt8_t
 
si5351_wr™e
(uint8_t, uint8_t);

308 
ušt8_t
 
si5351_»ad
(uint8_t);

309 
Si5351Stus
 
	mdev_¡©us
 = {.
SYS_INIT
 = 0, .
	mLOL_B
 = 0, .
	mLOL_A
 = 0,

310 .
	mLOS
 = 0, .
	mREVID
 = 0};

311 
Si5351IÁStus
 
	gdev_št_¡©us
 = {.
SYS_INIT_STKY
 = 0, .
	gLOL_B_STKY
 = 0,

312 .
	gLOL_A_STKY
 = 0, .
	gLOS_STKY
 = 0};

313 
si5351_¶l
 
	g¶l_assignm’t
[8];

314 
ušt64_t
 
	gşk_äeq
[8];

315 
ušt64_t
 
	g¶Ï_äeq
;

316 
ušt64_t
 
	g¶lb_äeq
;

317 
si5351_¶l_šput
 
	g¶Ï_»f_osc
;

318 
si5351_¶l_šput
 
	g¶lb_»f_osc
;

319 
ušt32_t
 
	gxl_äeq
[2];

320 
	g´iv©e
:

321 
ušt64_t
 
¶l_ÿlc
(
si5351_¶l
, ušt64_t, 
Si5351RegS‘
 *, 
št32_t
, 
ušt8_t
);

322 
ušt64_t
 
muÉisyÁh_ÿlc
(ušt64_t, ušt64_t, 
Si5351RegS‘
 *);

323 
ušt64_t
 
muÉisyÁh67_ÿlc
(ušt64_t, ušt64_t, 
Si5351RegS‘
 *);

324 
upd©e_sys_¡©us
(
Si5351Stus
 *);

325 
upd©e_št_¡©us
(
Si5351IÁStus
 *);

326 
ms_div
(
si5351_şock
, 
ušt8_t
, uint8_t);

327 
ušt8_t
 
£Ëù_r_div
(
ušt64_t
 *);

328 
ušt8_t
 
£Ëù_r_div_ms67
(
ušt64_t
 *);

329 
št32_t
 
	g»f_cÜ»ùiÚ
[2];

330 
ušt8_t
 
	gşkš_div
;

331 
ušt8_t
 
	gi2c_bus_addr
;

332 
boŞ
 
	gşk_fœ¡_£t
[8];

	@text.cpp

1 
	~"‹xt.h
"

3 
	~<¡ršg.h
>

9 cÚ¡ * 
	$Œim_äÚt
(cÚ¡ *
¡r
) {

11 *
¡r
 == ' ') {

12 
¡r
++;

14  
¡r
;

15 
	}
}

17 
	$Œim_back
(*
¡r
) {

19 
idx
 = 
	`¡¾’
(
¡r
) - 1;

20 
idx
 >ğ0 && 
¡r
[idx] == ' ') {

21 
¡r
[
idx
--] = '\0';

23 
	}
}

27 * 
	$Œim
(*
¡r
) {

28 
¡r
 = (*)
	`Œim_äÚt
(str);

29 
	`Œim_back
(
¡r
);

31  
¡r
;

32 
	}
}

34 
	$to_uµ”
(
c
) {

35  (
c
 >= 'a' && c <= 'z') ? (c - 'a' + 'A') : c;

36 
	}
}

38 
boŞ
 
	$is_dig™
(
c
) {

39  (
c
 >= '0') && (c <= '9');

40 
	}
}

42 
boŞ
 
	$is_Ë‰”
(
c
) {

43  ((
c
 >= 'A') && (c <= 'Z')) || ((c >= 'a') && (c <= 'z'));

44 
	}
}

46 
boŞ
 
	$is_¥aû
(
c
) {

47  (
c
 == ' ');

48 
	}
}

50 
boŞ
 
	$š_¿nge
(
c
, 
mš
, 
max
) {

51  (
c
 >ğ
mš
è&& (ø<ğ
max
);

52 
	}
}

54 
boŞ
 
	$¡¬ts_w™h
(cÚ¡ *
¡ršg
, cÚ¡ *
´efix
) {

55  0 =ğ
	`memcmp
(
¡ršg
, 
´efix
, 
	`¡¾’
(prefix));

56 
	}
}

58 
boŞ
 
	$equ®s
(cÚ¡ *
¡ršg1
, cÚ¡ *
¡ršg2
) {

59  0 =ğ
	`¡rcmp
(
¡ršg1
, 
¡ršg2
);

60 
	}
}

63 
	$ch¬_šdex
(cÚ¡ *
¡ršg
, 
c
) {

64 
i
 = 0; *
¡ršg
; ++i, ++string) {

65 ià(
c
 =ğ*
¡ršg
) {

66  
i
;

70 
	}
}

76 
	$fmtmsg
(*
msg_out
, cÚ¡ *
msg_š
) {

77 
c
;

78 
Ï¡_out
 = 0;

79  (
c
 = *
msg_š
) ) {

80 ià(
c
 !ğ' ' || 
Ï¡_out
 != ' ') {

81 
Ï¡_out
 = 
	`to_uµ”
(
c
);

82 *
msg_out
 = 
Ï¡_out
;

83 ++
msg_out
;

85 ++
msg_š
;

87 *
msg_out
 = 0;

88 
	}
}

92 
	$dd_to_št
(cÚ¡ *
¡r
, 
Ëngth
) {

93 
»suÉ
 = 0;

94 
boŞ
 
Ãg©ive
;

95 
i
;

96 ià(
¡r
[0] == '-') {

97 
Ãg©ive
 = 
Œue
;

98 
i
 = 1;

101 
Ãg©ive
 = 
çl£
;

102 
i
 = (
¡r
[0] == '+') ? 1 : 0;

105 
i
 < 
Ëngth
) {

106 ià(
¡r
[
i
] == 0) ;

107 ià(!
	`is_dig™
(
¡r
[
i
])) ;

108 
»suÉ
 *= 10;

109 
»suÉ
 +ğ(
¡r
[
i
] - '0');

110 ++
i
;

113  
Ãg©ive
 ? -
»suÉ
 :„esult;

114 
	}
}

118 
	$št_to_dd
(*
¡r
, 
v®ue
, 
width
, 
boŞ
 
fuÎ_sign
) {

119 ià(
v®ue
 < 0) {

120 *
¡r
 = '-';

121 ++
¡r
;

122 
v®ue
 = -value;

124 ià(
fuÎ_sign
) {

125 *
¡r
 = '+';

126 ++
¡r
;

129 
divisÜ
 = 1;

130 
i
 = 0; i < 
width
 - 1; ++i) {

131 
divisÜ
 *= 10;

134 
divisÜ
 >= 1) {

135 
dig™
 = 
v®ue
 / 
divisÜ
;

137 *
¡r
 = '0' + 
dig™
;

138 ++
¡r
;

140 
v®ue
 -ğ
dig™
 * 
divisÜ
;

141 
divisÜ
 /= 10;

143 *
¡r
 = 0;

144 
	}
}

153 
	$ch¬n
(
c
, 
bË_idx
) {

154 ià(
bË_idx
 != 2 &&able_idx != 3) {

155 ià(
c
 == 0)  ' ';

156 
c
 -= 1;

158 ià(
bË_idx
 != 4) {

159 ià(
c
 < 10)  '0' + c;

160 
c
 -= 10;

162 ià(
bË_idx
 != 3) {

163 ià(
c
 < 26)  'A' + c;

164 
c
 -= 26;

167 ià(
bË_idx
 == 0) {

168 ià(
c
 < 5)  "+-./?" [c];

170 ià(
bË_idx
 == 5) {

171 ià(
c
 == 0)  '/';

175 
	}
}

178 
	$nch¬
(
c
, 
bË_idx
) {

179 
n
 = 0;

180 ià(
bË_idx
 != 2 &&able_idx != 3) {

181 ià(
c
 =ğ' 'è 
n
 + 0;

182 
n
 += 1;

184 ià(
bË_idx
 != 4) {

185 ià(
c
 >ğ'0' && c <ğ'9'è 
n
 + (c - '0');

186 
n
 += 10;

188 ià(
bË_idx
 != 3) {

189 ià(
c
 >ğ'A' && c <ğ'Z'è 
n
 + (c - 'A');

190 
n
 += 26;

193 ià(
bË_idx
 == 0) {

194 ià(
c
 =ğ'+'è 
n
 + 0;

195 ià(
c
 =ğ'-'è 
n
 + 1;

196 ià(
c
 =ğ'.'è 
n
 + 2;

197 ià(
c
 =ğ'/'è 
n
 + 3;

198 ià(
c
 =ğ'?'è 
n
 + 4;

200 ià(
bË_idx
 == 5) {

201 ià(
c
 =ğ'/'è 
n
 + 0;

206 
	}
}

	@text.h

1 #´agm¨
Úû


6 cÚ¡ * 
Œim_äÚt
(cÚ¡ *
¡r
);

7 
Œim_back
(*
¡r
);

8 * 
Œim
(*
¡r
);

10 
to_uµ”
(
c
);

11 
boŞ
 
is_dig™
(
c
);

12 
boŞ
 
is_Ë‰”
(
c
);

13 
boŞ
 
is_¥aû
(
c
);

14 
boŞ
 
š_¿nge
(
c
, 
mš
, 
max
);

15 
boŞ
 
¡¬ts_w™h
(cÚ¡ *
¡ršg
, cÚ¡ *
´efix
);

16 
boŞ
 
equ®s
(cÚ¡ *
¡ršg1
, cÚ¡ *
¡ršg2
);

18 
ch¬_šdex
(cÚ¡ *
¡ršg
, 
c
);

23 
fmtmsg
(*
msg_out
, cÚ¡ *
msg_š
);

26 
dd_to_št
(cÚ¡ *
¡r
, 
Ëngth
);

29 
št_to_dd
(*
¡r
, 
v®ue
, 
width
, 
boŞ
 
fuÎ_sign
);

31 
ch¬n
(
c
, 
bË_idx
);

32 
nch¬
(
c
, 
bË_idx
);

	@traffic_manager.cpp

1 
	~"DEBUG.h
"

2 
	~"si5351.h
"

3 
	~"Œaffic_mªag”.h
"

4 
	~"di¥Ïy.h
"

5 
	~"decode_á8.h
"

6 
	~"g’_á8.h
"

7 
	~"bu‰Ú.h
"

8 
	~"pšs.h
"

9 
	~<SI4735.h
>

11 
	#FT8_TONE_SPACING
 625

	)

13 
Si5351
 
si5351
;

14 
SI4735
 
si4735
;

15 
ušt16_t
 
cu¼’tF»qu’cy
;

16 
xm™_æag
, 
á8_xm™_couÁ”
, 
T¿nsm™_ArmÃd
;

18 
ušt16_t
 
cursÜ_äeq
;

19 
ušt16_t
 
cursÜ_lše
;

21 
CQ_FÏg
;

22 
B—cÚ_S‹
;

23 
num_decoded_msg
;

25 
off£t_äeq
;

27 
ušt64_t
 
	gF_LÚg
, 
	gF_FT8
, 
	gF_Off£t
;

30 
	$Œªsm™_£qu’û
() {

32 
	`DPRINTF
("%s\n",
__FUNCTION__
);

35 
	`pšMode
(
PIN_RCV
, 
OUTPUT
);

36 
	`dig™®Wr™e
(
PIN_RCV
, 
LOW
);

39 
	`£t_Xm™_F»q
();

40 
si5351
.
	`£t_äeq
(
F_LÚg
, 
SI5351_CLK0
);

41 
si4735
.
	`£tVŞume
(35);

42 
si5351
.
	`drive_¡»ngth
(
SI5351_CLK0
, 
SI5351_DRIVE_8MA
);

43 
si5351
.
	`ouut_’abË
(
SI5351_CLK0
, 1);

44 
	`pšMode
(
PIN_PTT
, 
OUTPUT
);

45 
	`dig™®Wr™e
(
PIN_PTT
, 
HIGH
);

46 
	}
}

49 
	$»ûive_£qu’û
() {

51 
	`DPRINTF
("%s\n",
__FUNCTION__
);

54 
si5351
.
	`ouut_’abË
(
SI5351_CLK0
, 0);

55 
	`pšMode
(
PIN_PTT
, 
OUTPUT
);

56 
	`dig™®Wr™e
(
PIN_PTT
, 
LOW
);

59 
	`pšMode
(
PIN_RCV
, 
OUTPUT
);

60 
	`dig™®Wr™e
(
PIN_RCV
, 
HIGH
);

61 
si4735
.
	`£tVŞume
(50);

62 
	`ş—r_FT8_mes§ge
();

63 
	}
}

67 
	$tuÃ_On_£qu’û
() {

68 
	`£t_Xm™_F»q
();

69 
si5351
.
	`£t_äeq
(
F_LÚg
, 
SI5351_CLK0
);

70 
si4735
.
	`£tVŞume
(35);

71 
si5351
.
	`ouut_’abË
(
SI5351_CLK0
, 1);

72 
	`pšMode
(
PIN_PTT
, 
OUTPUT
);

73 
	`dig™®Wr™e
(
PIN_PTT
, 
HIGH
);

74 
	}
}

76 
	$tuÃ_Off_£qu’û
() {

77 
si5351
.
	`ouut_’abË
(
SI5351_CLK0
, 0);

78 
	`pšMode
(
PIN_PTT
, 
OUTPUT
);

79 
	`dig™®Wr™e
(
PIN_PTT
, 
LOW
);

80 
si4735
.
	`£tVŞume
(50);

81 
	}
}

85 
	$£t_Xm™_F»q
() {

89 
F_LÚg
 = (
ušt64_t
)((
cu¼’tF»qu’cy
 * 1000 + 
cursÜ_äeq
 + 
off£t_äeq
) * 100);

90 
	`DPRINTF
("% cu¼’tF»qu’cy=%u, cursÜ_äeq=%u, off£t_äeq=%u, F_LÚg=%Îu\n", 
__FUNCTION__
, 
cu¼’tF»qu’cy
, 
cursÜ_äeq
, 
off£t_äeq
, 
F_LÚg
);

92 
si5351
.
	`£t_äeq
(
F_LÚg
, 
SI5351_CLK0
);

93 
	}
}

97 
	$£t_FT8_TÚe
(
ušt8_t
 
á8_tÚe
) {

98 
F_FT8
 = 
F_LÚg
 + 
	`ušt64_t
(
á8_tÚe
è* 
FT8_TONE_SPACING
;

99 
si5351
.
	`£t_äeq
(
F_FT8
, 
SI5351_CLK0
);

100 
	}
}

104 
	$£tup_to_Œªsm™_Ú_Ãxt_DSP_FÏg
() {

105 
	`DPRINTF
("%x\n",
__FUNCTION__
);

106 
á8_xm™_couÁ”
 = 0;

107 
	`Œªsm™_£qu’û
();

108 
	`£t_Xm™_F»q
();

109 
xm™_æag
 = 1;

110 
	}
}

114 
	$£rviû_CQ
() {

116 
	`DPRINTF
("%s, B—cÚ_¡©e=%u\n",
__FUNCTION__
, 
B—cÚ_S‹
);

118 
»ûive_šdex
;

120 
B—cÚ_S‹
) {

123 
B—cÚ_S‹
 = 1;

127 
»ûive_šdex
 = 
	`Check_C®lšg_StiÚs
(
num_decoded_msg
);

129 ià(
»ûive_šdex
 >= 0) {

130 
	`di¥Ïy_£Ëùed_ÿÎ
(
»ûive_šdex
);

131 
	`£t_mes§ge
(2);

133 
	`£t_mes§ge
(0);

134 
T¿nsm™_ArmÃd
 = 1;

135 
B—cÚ_S‹
 = 2;

140 
»ûive_šdex
 = 
	`Check_C®lšg_StiÚs
(
num_decoded_msg
);

142 ià(
»ûive_šdex
 >= 0) {

143 
	`di¥Ïy_£Ëùed_ÿÎ
(
»ûive_šdex
);

144 
	`£t_mes§ge
(3);

145 
T¿nsm™_ArmÃd
 = 1;

148 
B—cÚ_S‹
 = 0;

164 
	}
}

	@traffic_manager.h

4 
Œªsm™_£qu’û
();

6 
»ûive_£qu’û
();

8 
£t_Xm™_F»q
();

10 
£t_FT8_TÚe
Ğ
ušt8_t
 
á8_tÚe
);

12 
£tup_to_Œªsm™_Ú_Ãxt_DSP_FÏg
();

14 
tuÃ_On_£qu’û
();

16 
tuÃ_Off_£qu’û
();

18 
£rviû_CQ
 ();

	@unpack.cpp

1 
	~"uÅack.h
"

2 
	~"‹xt.h
"

4 
	~<¡ršg.h
>

10 cÚ¡ 
ušt32_t
 
	gMAX22
 = 4194304L;

11 cÚ¡ 
ušt32_t
 
	gNTOKENS
 = 2063592L;

12 cÚ¡ 
ušt16_t
 
	gMAXGRID4
 = 32400L;

17 
	$uÅack28
(
ušt32_t
 
n28
, 
ušt8_t
 

, ušt8_ˆ
i3
, *
»suÉ
) {

19 ià(
n28
 < 
NTOKENS
) {

20 ià(
n28
 <= 2) {

21 ià(
n28
 =ğ0è
	`¡rıy
(
»suÉ
, "DE");

22 ià(
n28
 =ğ1è
	`¡rıy
(
»suÉ
, "QRZ");

23 ià(
n28
 =ğ2è
	`¡rıy
(
»suÉ
, "CQ");

26 ià(
n28
 <= 1002) {

28 
	`¡rıy
(
»suÉ
, "CQ ");

29 
	`št_to_dd
(
»suÉ
 + 3, 
n28
 - 3, 3, 
Œue
);

32 ià(
n28
 <= 532443L) {

34 
ušt32_t
 
n
 = 
n28
 - 1003;

35 
¯¯
[5];

37 
¯¯
[4] = '\0';

38 
i
 = 3; ; --i) {

39 
¯¯
[
i
] = 
	`ch¬n
(
n
 % 27, 4);

40 ià(
i
 == 0) ;

41 
n
 /= 27;

44 
	`¡rıy
(
»suÉ
, "CQ ");

45 
	`¡rÿt
(
»suÉ
, 
	`Œim_äÚt
(
¯¯
));

52 
n28
 =‚28 - 
NTOKENS
;

53 ià(
n28
 < 
MAX22
) {

58 
»suÉ
[0] = '<';

59 
	`št_to_dd
(
»suÉ
 + 1, 
n28
, 7, 
Œue
);

60 
»suÉ
[8] = '>';

61 
»suÉ
[9] = '\0';

66 
ušt32_t
 
n
 = 
n28
 - 
MAX22
;

68 
ÿÎsign
[7];

69 
ÿÎsign
[6] = '\0';

70 
ÿÎsign
[5] = 
	`ch¬n
(
n
 % 27, 4);

71 
n
 /= 27;

72 
ÿÎsign
[4] = 
	`ch¬n
(
n
 % 27, 4);

73 
n
 /= 27;

74 
ÿÎsign
[3] = 
	`ch¬n
(
n
 % 27, 4);

75 
n
 /= 27;

76 
ÿÎsign
[2] = 
	`ch¬n
(
n
 % 10, 3);

77 
n
 /= 10;

78 
ÿÎsign
[1] = 
	`ch¬n
(
n
 % 36, 2);

79 
n
 /= 36;

80 
ÿÎsign
[0] = 
	`ch¬n
(
n
 % 37, 1);

83 
	`¡rıy
(
»suÉ
, 
	`Œim
(
ÿÎsign
));

84 ià(
	`¡¾’
(
»suÉ
) == 0)  -1;

87 ià(

) {

88 ià(
i3
 == 1) {

89 
	`¡rÿt
(
»suÉ
, "/R");

91 ià(
i3
 == 2) {

92 
	`¡rÿt
(
»suÉ
, "/P");

97 
	}
}

100 
	$uÅack_ty³1
(cÚ¡ 
ušt8_t
 *
a77
, ušt8_ˆ
i3
, *
f›ld1
, *
f›ld2
, *
f›ld3
) {

101 
ušt32_t
 
n28a
, 
n28b
;

102 
ušt16_t
 
igrid4
;

103 
ušt8_t
 
œ
;

108 
n28a
 = (
a77
[0] << 21);

109 
n28a
 |ğ(
a77
[1] << 13);

110 
n28a
 |ğ(
a77
[2] << 5);

111 
n28a
 |ğ(
a77
[3] >> 3);

112 
n28b
 = ((
a77
[3] & 0x07) << 26);

113 
n28b
 |ğ(
a77
[4] << 18);

114 
n28b
 |ğ(
a77
[5] << 10);

115 
n28b
 |ğ(
a77
[6] << 2);

116 
n28b
 |ğ(
a77
[7] >> 6);

117 
œ
 = ((
a77
[7] & 0x20) >> 5);

118 
igrid4
 = ((
a77
[7] & 0x1F) << 10);

119 
igrid4
 |ğ(
a77
[8] << 2);

120 
igrid4
 |ğ(
a77
[9] >> 6);

123 ià(
	`uÅack28
(
n28a
 >> 1,‚28¨& 0x01, 
i3
, 
f›ld1
) < 0) {

126 ià(
	`uÅack28
(
n28b
 >> 1,‚28b & 0x01, 
i3
, 
f›ld2
) < 0) {

139 ià(
igrid4
 <ğ
MAXGRID4
) {

141 *
d¡
 = 
f›ld3
;

142 
ušt16_t
 
n
 = 
igrid4
;

143 ià(
œ
 > 0) {

145 
d¡
 = 
	`¡pıy
(dst, "R ");

148 
d¡
[4] = '\0';

149 
d¡
[3] = '0' + (
n
 % 10);

150 
n
 /= 10;

151 
d¡
[2] = '0' + (
n
 % 10);

152 
n
 /= 10;

153 
d¡
[1] = 'A' + (
n
 % 18);

154 
n
 /= 18;

155 
d¡
[0] = 'A' + (
n
 % 18);

161 
œ±
 = 
igrid4
 - 
MAXGRID4
;

164 ià(
œ±
 =ğ1è
f›ld3
[0] = '\0';

165 ià(
œ±
 =ğ2è
	`¡rıy
(
f›ld3
, "RRR");

166 ià(
œ±
 =ğ3è
	`¡rıy
(
f›ld3
, "RR73");

167 ià(
œ±
 =ğ4è
	`¡rıy
(
f›ld3
, "73");

168 ià(
œ±
 >= 5) {

169 *
d¡
 = 
f›ld3
;

171 ià(
œ
 > 0) {

172 *
d¡
++ = 'R';

174 
	`št_to_dd
(
d¡
, 
œ±
 - 35, 2, 
Œue
);

181 
	}
}

184 
	$uÅack_‹xt
(cÚ¡ 
ušt8_t
 *
a71
, *
‹xt
) {

186 
ušt8_t
 
b71
[9];

188 
ušt8_t
 
ÿ¼y
 = 0;

189 
i
 = 0; i < 9; ++i) {

190 
b71
[
i
] = 
ÿ¼y
 | (
a71
[i] >> 1);

191 
ÿ¼y
 = (
a71
[
i
] & 1) ? 0x80 : 0;

194 
c14
[14];

195 
c14
[13] = 0;

196 
idx
 = 12; idx >= 0; --idx) {

198 
ušt16_t
 
»m
 = 0;

199 
i
 = 0; i < 9; ++i) {

200 
»m
 = (»m << 8è| 
b71
[
i
];

201 
b71
[
i
] = 
»m
 / 42;

202 
»m
 =„em % 42;

204 
c14
[
idx
] = 
	`ch¬n
(
»m
, 0);

207 
	`¡rıy
(
‹xt
, 
	`Œim
(
c14
));

209 
	}
}

212 
	$uÅack_‹Ëm‘ry
(cÚ¡ 
ušt8_t
 *
a71
, *
‹Ëm‘ry
) {

213 
ušt8_t
 
b71
[9];

216 
ušt8_t
 
ÿ¼y
 = 0;

217 
i
 = 0; i < 9; ++i) {

218 
b71
[
i
] = (
ÿ¼y
 << 7è| (
a71
[i] >> 1);

219 
ÿ¼y
 = (
a71
[
i
] & 0x01);

223 
i
 = 0; i < 9; ++i) {

224 
ušt8_t
 
nibbË1
 = (
b71
[
i
] >> 4);

225 
ušt8_t
 
nibbË2
 = (
b71
[
i
] & 0x0F);

226 
c1
 = (
nibbË1
 > 9) ? (nibble1 - 10 + 'A') :‚ibble1 + '0';

227 
c2
 = (
nibbË2
 > 9) ? (nibble2 - 10 + 'A') :‚ibble2 + '0';

228 
‹Ëm‘ry
[
i
 * 2] = 
c1
;

229 
‹Ëm‘ry
[
i
 * 2 + 1] = 
c2
;

232 
‹Ëm‘ry
[18] = '\0';

234 
	}
}

239 
	$uÅack_nÚ¡ªd¬d
(cÚ¡ 
ušt8_t
 *
a77
, *
f›ld1
, *
f›ld2
, *
f›ld3
)

246 
ušt32_t
 
n12
, 
iæ
, 
Ä±
, 
icq
;

247 
ušt64_t
 
n58
;

248 
n12
 = (
a77
[0] << 4);

249 
n12
 |ğ(
a77
[1] >> 4);

251 
n58
 = ((
ušt64_t
)(
a77
[1] & 0x0F) << 54);

252 
n58
 |ğ((
ušt64_t
)
a77
[2] << 46);

253 
n58
 |ğ((
ušt64_t
)
a77
[3] << 38);

254 
n58
 |ğ((
ušt64_t
)
a77
[4] << 30);

255 
n58
 |ğ((
ušt64_t
)
a77
[5] << 22);

256 
n58
 |ğ((
ušt64_t
)
a77
[6] << 14);

257 
n58
 |ğ((
ušt64_t
)
a77
[7] << 6);

258 
n58
 |ğ((
ušt64_t
)
a77
[8] >> 2);

260 
iæ
 = (
a77
[8] >> 1) & 0x01;

261 
Ä±
 = ((
a77
[8] & 0x01) << 1);

262 
Ä±
 |ğ(
a77
[9] >> 7);

263 
icq
 = ((
a77
[9] >> 6) & 0x01);

265 
c11
[12];

266 
c11
[11] = '\0';

268 
i
 = 10; ; --i) {

269 
c11
[
i
] = 
	`ch¬n
(
n58
 % 38, 5);

270 ià(
i
 == 0) ;

271 
n58
 /= 38;

274 
ÿÎ_3
[15];

277 
ÿÎ_3
[0] = '<';

278 
	`št_to_dd
(
ÿÎ_3
 + 1, 
n12
, 4, 
Œue
);

279 
ÿÎ_3
[5] = '>';

280 
ÿÎ_3
[6] = '\0';

282 * 
ÿÎ_1
 = (
iæ
è? 
c11
 : 
ÿÎ_3
;

283 * 
ÿÎ_2
 = (
iæ
è? 
ÿÎ_3
 : 
c11
;

286 ià(
icq
 == 0) {

287 
	`¡rıy
(
f›ld1
, 
	`Œim
(
ÿÎ_1
));

288 ià(
Ä±
 == 1)

289 
	`¡rıy
(
f›ld3
, "RRR");

290 ià(
Ä±
 == 2)

291 
	`¡rıy
(
f›ld3
, "RR73");

292 ià(
Ä±
 == 3)

293 
	`¡rıy
(
f›ld3
, "73");

295 
f›ld3
[0] = '\0';

298 
	`¡rıy
(
f›ld1
, "CQ");

299 
f›ld3
[0] = '\0';

301 
	`¡rıy
(
f›ld2
, 
	`Œim
(
ÿÎ_2
));

304 
	}
}

306 
	$uÅack77_f›lds
(cÚ¡ 
ušt8_t
 *
a77
, *
f›ld1
, *
f›ld2
, *
f›ld3
) {

307 
ušt8_t
 
n3
, 
i3
;

310 
n3
 = ((
a77
[8] << 2) & 0x04) | ((a77[9] >> 6) & 0x03);

311 
i3
 = (
a77
[9] >> 3) & 0x07;

313 
f›ld1
[0] = 
f›ld2
[0] = 
f›ld3
[0] = '\0';

315 ià(
i3
 =ğ0 && 
n3
 == 0) {

317  
	`uÅack_‹xt
(
a77
, 
f›ld1
);

329 ià(
i3
 =ğ0 && 
n3
 == 5) {

331  
	`uÅack_‹Ëm‘ry
(
a77
, 
f›ld1
);

333 ià(
i3
 == 1 || i3 == 2) {

335  
	`uÅack_ty³1
(
a77
, 
i3
, 
f›ld1
, 
f›ld2
, 
f›ld3
);

340 ià(
i3
 == 4) {

344  
	`uÅack_nÚ¡ªd¬d
(
a77
, 
f›ld1
, 
f›ld2
, 
f›ld3
);

352 
	}
}

354 
	$uÅack77
(cÚ¡ 
ušt8_t
 *
a77
, *
mes§ge
) {

355 
f›ld1
[14];

356 
f›ld2
[14];

357 
f›ld3
[7];

358 
rc
 = 
	`uÅack77_f›lds
(
a77
, 
f›ld1
, 
f›ld2
, 
f›ld3
);

359 ià(
rc
 < 0) „c;

361 *
d¡
 = 
mes§ge
;

364 
d¡
 = 
	`¡pıy
(d¡, 
f›ld1
);

365 *
d¡
++ = ' ';

366 
d¡
 = 
	`¡pıy
(d¡, 
f›ld2
);

367 *
d¡
++ = ' ';

368 
d¡
 = 
	`¡pıy
(d¡, 
f›ld3
);

369 *
d¡
 = '\0';

372 
	}
}

	@unpack.h

1 #´agm¨
Úû


3 
	~<¡dšt.h
>

10 
uÅack77_f›lds
(cÚ¡ 
ušt8_t
 *
a77
, *
f›ld1
, *
f›ld2
, *
f›ld3
);

13 
uÅack77
(cÚ¡ 
ušt8_t
 *
a77
, *
mes§ge
);

	@
1
.
0
41
489
AudioStream6400.h
DEBUG.h
HX8357_t3n.cpp
HX8357_t3n.h
NODEBUG.h
PocketFT8XcvrFW.ino
Process_DSP.cpp
Process_DSP.h
TouchScreen_I2C.cpp
TouchScreen_I2C.h
WF_Table.h
button.cpp
button.h
constants.cpp
constants.h
decode.cpp
decode.h
decode_ft8.cpp
decode_ft8.h
display.cpp
display.h
encode.cpp
encode.h
gen_ft8.cpp
gen_ft8.h
ldpc.cpp
ldpc.h
locator.cpp
locator.h
pack.cpp
pack.h
patch_full.h
pins.h
si5351.cpp
si5351.h
text.cpp
text.h
traffic_manager.cpp
traffic_manager.h
unpack.cpp
unpack.h
